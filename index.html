<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>MINIMARKET LA ESQUINA DEL AHORRO â€” TiendaSmart (MÃ³vil)</title>

  <!-- Tailwind simple CDN for quick prototyping -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- OpenCV.js (WASM) -->
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>

  <!-- Quagga fallback -->
  <script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root { --bg:#0f172a; --card:#0f172a; --muted:#9ca3af; }
    [data-theme="light"]{ --bg:#f8fafc; --card:#fff; --muted:#6b7280; color-scheme: light; }
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: var(--bg); margin:0; color: #0b1220; }
    /* App container */
    .app { max-width:900px; margin:0 auto; padding-bottom:88px; }
    /* Global backdrop */
    #global-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); z-index: 40; display: none; opacity: 0; transition: opacity .18s; }
    #global-backdrop.visible{ display:block; opacity:1; }
    /* Modal */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; overflow:auto; }
    .modal.visible { display:flex; }
    .modal .modal-content { width:100%; max-width:720px; border-radius:14px; box-shadow: 0 12px 40px rgba(2,6,23,0.4); padding:1rem; background:var(--card); color:inherit; }
    /* On small screens make modals full screen to feel native */
    @media (max-width:640px){
      .modal .modal-content { width:100%; height:100%; border-radius:0; padding:1rem 0 80px 0; display:flex; flex-direction:column; }
    }
    /* overlay canvas */
    #overlay-canvas { position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:20; }
    .scan-guide { position:absolute; left:50%; top:50%; width:64%; height:28%; transform:translate(-50%,-50%); border:2px dashed rgba(255,255,255,0.6); border-radius:8px; pointer-events:none; z-index:30; }
    /* bottom bar */
    .bottom-bar { position: fixed; left:0; right:0; bottom:0; z-index:60; display:flex; gap:8px; padding:10px; background:linear-gradient(0deg, rgba(0,0,0,0.06), transparent); justify-content:center; }
    /* login overlay improvements */
    .login-card { max-width:420px; width:100%; border-radius:12px; padding:16px; box-shadow: 0 12px 40px rgba(2,6,23,0.4); background:var(--card); }
    /* header user */
    .user-pill { background: linear-gradient(90deg,#06b6d4,#60a5fa); color:white; padding:6px 10px; border-radius:999px; font-weight:600; font-size:12px; }
  </style>
</head>
<body data-theme="light">
  <!-- backdrop -->
  <div id="global-backdrop" aria-hidden="true"></div>

  <div class="app mx-auto px-4">
    <!-- Top area: logo + user -->
    <div class="flex items-center justify-between py-4">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-lg bg-gradient-to-r from-green-400 to-blue-500 flex items-center justify-center shadow-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3h2l.4 2M7 13h10l-1.2 6H6L5 13z"/></svg>
        </div>
        <div>
          <div class="text-sm font-semibold">MINIMARKET</div>
          <div class="text-xs text-gray-500">La Esquina del Ahorro</div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <div id="current-user" class="user-pill hidden"></div>
        <button id="btn-logout" class="text-sm px-3 py-2 border rounded hidden">Salir</button>
        <button id="btn-theme" class="text-sm px-3 py-2 border rounded">Modo</button>
      </div>
    </div>

    <!-- Responsible small banner -->
    <div id="responsible-banner" class="mb-3 p-3 rounded shadow-sm bg-white flex items-center justify-between">
      <div>
        <div class="text-xs text-gray-600">Encargado del dÃ­a</div>
        <div id="responsible-display" class="font-medium">â€”</div>
      </div>
      <div class="flex gap-2 items-center">
        <input id="responsible-date" type="date" class="px-2 py-1 rounded border bg-white">
        <input id="responsible-name" placeholder="Nombre encargado" class="px-2 py-1 rounded border w-40 bg-white">
        <button id="save-responsible" class="px-3 py-1 bg-indigo-600 text-white rounded">Guardar</button>
      </div>
    </div>

    <!-- Search -->
    <div class="mb-3">
      <input id="search" type="search" placeholder="Buscar producto o cÃ³digo..." class="w-full px-4 py-3 rounded-lg shadow-sm border bg-white" />
    </div>

    <!-- Inventory list (mobile-friendly rows) -->
    <div id="inventory-list" class="space-y-2 mb-20">
      <!-- dynamically populated -->
    </div>

    <!-- Charts (small) -->
    <div class="mb-4 grid grid-cols-2 gap-3">
      <div class="bg-white rounded-lg p-2 shadow"><canvas id="chart-sales" height="120"></canvas></div>
      <div class="bg-white rounded-lg p-2 shadow"><canvas id="chart-stock" height="120"></canvas></div>
    </div>

  </div>

  <!-- Bottom action bar (mobile) -->
  <div class="bottom-bar">
    <button id="open-add-product" class="flex-1 px-4 py-3 rounded-lg bg-green-500 text-white font-semibold">+ Producto</button>
    <button id="open-scan" class="flex-1 px-4 py-3 rounded-lg bg-yellow-500 text-white font-semibold">Escanear</button>
    <button id="open-quick-sale" class="flex-1 px-4 py-3 rounded-lg bg-red-600 text-white font-semibold">Venta</button>
    <button id="open-clients" class="flex-1 px-4 py-3 rounded-lg bg-indigo-600 text-white font-semibold">Clientes</button>
  </div>

  <!-- ====== MODALES (reducidos en markup, modal-content adaptada para mÃ³vil) ====== -->

  <!-- Product modal -->
  <div id="modal-product" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-content mx-3">
      <div class="flex justify-between items-center px-3 py-2 border-b">
        <h4 class="text-lg font-semibold">Producto</h4>
        <button class="text-xl" data-close-modal>âœ•</button>
      </div>
      <form id="form-product" class="p-3 space-y-3 overflow-auto">
        <input type="hidden" id="product-id">
        <input id="product-name" placeholder="Nombre" required class="w-full px-3 py-3 rounded border bg-white">
        <div class="flex gap-2">
          <input id="product-category" placeholder="CategorÃ­a" class="flex-1 px-3 py-3 rounded border bg-white">
          <input id="product-price" placeholder="Precio" type="number" step="0.01" class="w-28 px-3 py-3 rounded border bg-white">
        </div>
        <div class="flex gap-2">
          <input id="product-barcode" placeholder="CÃ³digo de barras" class="flex-1 px-3 py-3 rounded border bg-white">
          <input id="product-stock" placeholder="Stock" type="number" class="w-24 px-3 py-3 rounded border bg-white">
        </div>
        <div class="flex gap-2">
          <button type="button" data-close-modal class="flex-1 px-4 py-3 border rounded">Cancelar</button>
          <button type="submit" class="flex-1 px-4 py-3 bg-green-600 text-white rounded">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Scanner modal -->
  <div id="modal-scan" class="modal scanner-modal" role="dialog" aria-hidden="true">
    <div class="modal-content">
      <div class="flex justify-between items-center px-3 py-2">
        <h4 class="text-lg font-semibold text-white">EscÃ¡ner</h4>
        <div class="flex gap-2">
          <button id="toggle-torch" class="px-3 py-2 rounded hidden">ðŸ”¦</button>
          <button data-close-modal class="text-xl">âœ•</button>
        </div>
      </div>
      <div id="video-wrap" class="relative bg-black flex-1">
        <video id="video" autoplay muted playsinline style="width:100%; height:60vh; object-fit:cover;"></video>
        <canvas id="overlay-canvas"></canvas>
        <div class="scan-guide"></div>
      </div>
      <div class="p-3 bg-white">
        <input id="scanned-code" class="w-full px-3 py-2 rounded border mb-2" placeholder="CÃ³digo detectado">
        <div class="flex gap-2">
          <button id="fill-product" class="flex-1 px-3 py-3 bg-indigo-600 text-white rounded">Buscar/Editar</button>
          <button id="quick-sell-detected" class="flex-1 px-3 py-3 bg-red-600 text-white rounded">Vender</button>
          <button id="stop-camera" class="px-3 py-3 border rounded">Detener</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick sale modal -->
  <div id="modal-quick-sale" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-content mx-3">
      <div class="flex justify-between items-center px-3 py-2 border-b">
        <h4 class="text-lg font-semibold">Venta rÃ¡pida</h4>
        <button data-close-modal class="text-xl">âœ•</button>
      </div>
      <form id="form-quick-sale" class="p-3 space-y-3 overflow-auto">
        <input id="quick-search" placeholder="Buscar o pegar cÃ³digo..." class="w-full px-3 py-3 rounded border bg-white" />
        <div class="flex gap-2">
          <select id="quick-product" class="flex-1 px-3 py-3 border rounded bg-white"></select>
          <input id="quick-qty" type="number" min="1" value="1" class="w-24 px-3 py-3 border rounded bg-white">
        </div>
        <div class="flex gap-2 items-center">
          <label class="text-sm">Pago</label>
          <select id="quick-payment" class="px-3 py-2 rounded border">
            <option value="EFECTIVO">EFECTIVO</option>
            <option value="YAPE">YAPE</option>
            <option value="A_CREDITO">A CREDITO</option>
          </select>
          <input id="quick-customer" placeholder="Nombre cliente (si A CREDITO)" class="flex-1 px-3 py-2 border rounded bg-white">
        </div>
        <div class="flex justify-between items-center">
          <div>Total: <span id="quick-total">0.00</span></div>
          <div class="flex gap-2">
            <button type="button" id="quick-add-cart" class="px-3 py-2 border rounded">Agregar</button>
            <button type="submit" class="px-3 py-2 bg-red-600 text-white rounded">Cobrar</button>
          </div>
        </div>
        <div>
          <h5 class="text-sm font-medium">Carrito</h5>
          <div id="quick-cart" class="space-y-2 mt-2"></div>
        </div>
      </form>
    </div>
  </div>

  <!-- Clients -->
  <div id="modal-clients" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-content mx-3">
      <div class="flex justify-between items-center px-3 py-2 border-b">
        <h4 class="text-lg font-semibold">Clientes (A CREDITO)</h4>
        <button data-close-modal class="text-xl">âœ•</button>
      </div>
      <div class="p-3 overflow-auto">
        <div class="flex gap-2 mb-3">
          <input id="client-name" placeholder="Nuevo cliente (nombre)" class="flex-1 px-3 py-2 border rounded bg-white">
          <button id="add-client" class="px-3 py-2 bg-green-600 text-white rounded">Agregar</button>
        </div>
        <div id="clients-list" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <!-- Report modal -->
  <div id="modal-report" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-content mx-3">
      <div class="flex justify-between items-center px-3 py-2 border-b">
        <h4 class="text-lg font-semibold">Reporte â€” Imprimir</h4>
        <button data-close-modal class="text-xl">âœ•</button>
      </div>
      <div class="p-3">
        <div class="grid grid-cols-2 gap-2 mb-3">
          <div><label class="text-xs">Desde</label><input id="report-from" type="date" class="w-full px-2 py-2 border rounded"></div>
          <div><label class="text-xs">Hasta</label><input id="report-to" type="date" class="w-full px-2 py-2 border rounded"></div>
        </div>
        <div class="flex gap-2 justify-end mb-3">
          <button id="btn-generate-report" class="px-3 py-2 bg-indigo-600 text-white rounded">Generar vista</button>
          <button id="btn-print-report" class="px-3 py-2 bg-gray-800 text-white rounded">Imprimir</button>
        </div>
        <div id="report-preview" class="max-h-64 overflow-auto text-sm"></div>
      </div>
    </div>
  </div>

  <!-- ====== LOGIN overlay (mandatory at start if not logged) ====== -->
  <div id="modal-login" class="modal visible" role="dialog" aria-hidden="false" style="background: linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.6));">
    <div class="login-card mx-auto">
      <h2 class="text-xl font-semibold mb-2">Ingresar â€” TiendaSmart</h2>
      <p class="text-sm text-gray-400 mb-4">Ingresa credenciales para continuar en la app</p>
      <form id="form-login" class="space-y-3">
        <input id="login-user" placeholder="Usuario" class="w-full px-3 py-3 rounded border" autofocus>
        <input id="login-pass" placeholder="ContraseÃ±a" type="password" class="w-full px-3 py-3 rounded border">
        <div class="flex gap-2">
          <button type="submit" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded font-semibold">Entrar</button>
          <button type="button" id="login-guest" class="flex-1 px-4 py-3 border rounded">Demo</button>
        </div>
        <p class="text-xs text-gray-500 mt-2">Usuario por defecto: <strong>LISMAGALY</strong> â€” ContraseÃ±a: <strong>latiendadelahorro</strong></p>
      </form>
    </div>
  </div>

  <!-- ====== APP SCRIPT (complete) ====== -->
  <script>
  /* ---------------------------
     Helpers & IndexedDB wrapper
     --------------------------- */
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const uid = () => 'id-' + Math.random().toString(36).slice(2,9);
  const money = v => Number(v||0).toFixed(2);
  const todayYMD = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };
  const localYMDFromISO = iso => { const d=new Date(iso); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };
  function debounce(fn, wait=200){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

  const DB_NAME='TiendaSmartDB', DB_VERSION=6;
  let db;
  function openDB(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB_NAME, DB_VERSION); r.onupgradeneeded = e=>{ const idb=e.target.result; if(!idb.objectStoreNames.contains('products')) idb.createObjectStore('products',{keyPath:'id'}); if(!idb.objectStoreNames.contains('sales')) idb.createObjectStore('sales',{keyPath:'id'}); if(!idb.objectStoreNames.contains('movements')) idb.createObjectStore('movements',{keyPath:'id'}); if(!idb.objectStoreNames.contains('customers')) idb.createObjectStore('customers',{keyPath:'name'}); if(!idb.objectStoreNames.contains('responsibles')) idb.createObjectStore('responsibles',{keyPath:'date'}); }; r.onsuccess = e=>{ db = e.target.result; res(db); }; r.onerror = e=>rej(e); }); }
  const store = (name,mode='readonly') => db.transaction(name, mode).objectStore(name);
  const put = (name,item) => new Promise((res,rej)=>{ const rq=store(name,'readwrite').put(item); rq.onsuccess=()=>res(item); rq.onerror=e=>rej(e); });
  const add = (name,item) => new Promise((res,rej)=>{ const rq=store(name,'readwrite').add(item); rq.onsuccess=()=>res(item); rq.onerror=e=>rej(e); });
  const all = (name) => new Promise((res,rej)=>{ const rq=store(name,'readonly').getAll(); rq.onsuccess=()=>res(rq.result||[]); rq.onerror=e=>rej(e); });
  const get = (name,key) => new Promise((res,rej)=>{ const rq=store(name,'readonly').get(key); rq.onsuccess=()=>res(rq.result); rq.onerror=e=>rej(e); });
  const remove = (name,key) => new Promise((res,rej)=>{ const rq=store(name,'readwrite').delete(key); rq.onsuccess=()=>res(); rq.onerror=e=>rej(e); });

  /* ---------------------------
     Authentication (client-only)
     --------------------------- */
  const AUTH_USER = 'LISMAGALY';
  const AUTH_PASS = 'latiendadelahorro';
  const AUTH_KEY = 'ts_user';

  function showLogin(){ const modal = $('#modal-login'); modal.classList.add('visible'); modal.setAttribute('aria-hidden','false'); }
  function hideLogin(){ const modal = $('#modal-login'); modal.classList.remove('visible'); modal.setAttribute('aria-hidden','true'); }
  function isAuthenticated(){ return !!localStorage.getItem(AUTH_KEY); }
  function setAuthenticated(username){ localStorage.setItem(AUTH_KEY, username); $('#current-user').textContent = username; $('#current-user').classList.remove('hidden'); $('#btn-logout').classList.remove('hidden'); }
  function clearAuth(){ localStorage.removeItem(AUTH_KEY); $('#current-user').classList.add('hidden'); $('#btn-logout').classList.add('hidden'); }

  $('#form-login').onsubmit = (e) => {
    e.preventDefault();
    const u = $('#login-user').value.trim();
    const p = $('#login-pass').value;
    if (u === AUTH_USER && p === AUTH_PASS){
      setAuthenticated(u); hideLogin(); startAppAfterAuth();
    } else {
      alert('Credenciales invÃ¡lidas.');
    }
  };
  $('#login-guest').onclick = ()=>{
    // demo/guest quick access (not secure) - set a demo user
    setAuthenticated('GUEST'); hideLogin(); startAppAfterAuth();
  };

  $('#btn-logout').onclick = ()=>{
    if(!confirm('Cerrar sesiÃ³n?')) return;
    clearAuth();
    location.reload();
  };

  /* If not authenticated, show login overlay */
  if (!isAuthenticated()) {
    showLogin();
  } else {
    // show user pill
    $('#current-user').textContent = localStorage.getItem(AUTH_KEY);
    $('#current-user').classList.remove('hidden');
    $('#btn-logout').classList.remove('hidden');
  }

  /* ---------------------------
     App code (only start after auth)
     --------------------------- */
  let appStarted = false;
  async function startAppAfterAuth(){
    if (appStarted) return;
    appStarted = true;
    try{
      await openDB();
      await ensureSeed();
      await refreshAll();
      // Prompt responsible for today if not set
      const today = todayYMD(); const r = await get('responsibles', today).catch(()=>null);
      if(!r){
        const name = prompt(`No hay encargado registrado para hoy (${today}). Ingresa su nombre (opcional):`);
        if(name !== null && name.trim() !== '') await put('responsibles', { date: today, name: name.trim() });
      }
    }catch(err){
      console.error('startApp error', err);
    }
  }

  async function ensureSeed(){
    const products = await all('products');
    if(products.length === 0){
      const seed = [
        { id: uid(), name:'Coca Cola 500ml', category:'Bebidas', price:10.99, barcode:'7758753103282', stock:48, createdAt: new Date().toISOString() },
        { id: uid(), name:'Agua San Luis 625ml', category:'Bebidas', price:3.50, barcode:'7752482381011', stock:32, createdAt: new Date().toISOString() }
      ];
      for(const p of seed) await put('products', p);
    }
  }

  /* ---------------------------
     State & UI refresh functions
     --------------------------- */
  const state = { products: [], sales: [], customers: [], responsibles: [] };

  async function refreshAll(){
    state.products = await all('products');
    state.sales = await all('sales');
    state.customers = await all('customers');
    state.responsibles = await all('responsibles');
    renderInventoryMobile();
    renderIncomeSelects();
    renderQuickSelect();
    renderClients();
    updateCharts();
    updateResponsibleBanner();
  }

  /* ---------------------------
     Mobile Inventory rendering (card rows)
     --------------------------- */
  const inventoryList = $('#inventory-list');
  function renderInventoryMobile(filter=''){
    const q = (filter||'').trim().toLowerCase();
    inventoryList.innerHTML = '';
    state.products.forEach((p, i) => {
      if (q && !(p.name.toLowerCase().includes(q) || (p.barcode||'').includes(q) || (p.barcode||'').replace(/\D/g,'').includes(q.replace(/\D/g,'')))) return;
      const card = document.createElement('div');
      card.className = 'bg-white rounded-lg p-3 shadow flex items-center justify-between';
      card.innerHTML = `
        <div>
          <div class="font-medium">${p.name}</div>
          <div class="text-xs text-gray-500">${p.category || ''} â€¢ ${p.barcode || ''}</div>
          <div class="text-sm text-gray-700 mt-1">S/ ${money(p.price)} Â· Stock: ${p.stock || 0}</div>
        </div>
        <div class="flex flex-col items-end gap-2">
          <div class="flex flex-col gap-2">
            <button data-id="${p.id}" class="px-3 py-2 rounded bg-red-500 text-white sell-btn">Vender</button>
            <button data-id="${p.id}" class="px-3 py-2 rounded border income-btn">+Stock</button>
            <button data-id="${p.id}" class="px-3 py-2 rounded border edit-btn">Editar</button>
          </div>
        </div>
      `;
      inventoryList.appendChild(card);
    });

    // attach listeners
    $$('.sell-btn').forEach(b => b.onclick = (e) => quickSellPrompt(b.dataset.id));
    $$('.income-btn').forEach(b => b.onclick = (e) => openIncomeFor(b.dataset.id));
    $$('.edit-btn').forEach(b => b.onclick = (e) => openProductModal(state.products.find(x=>x.id===b.dataset.id)));
  }

  /* ---------------------------
     Modal manager (global-backdrop)
     --------------------------- */
  const globalBackdrop = document.getElementById('global-backdrop');
  let currentOpenModal = null;
  async function _stopCameraSafe(){ try{ if(typeof stopCamera === 'function') await stopCamera(); }catch(e){ console.warn('stopCamera error', e); } }

  function showModal(modalId, { focusSelector } = {}) {
    // avoid opening modals when login is visible
    if (!isAuthenticated()) return;
    if (currentOpenModal && currentOpenModal !== modalId) closeModal(currentOpenModal);
    const modal = document.getElementById(modalId); if(!modal) return;
    globalBackdrop.classList.add('visible'); globalBackdrop.setAttribute('aria-hidden','false');
    modal.classList.add('visible'); modal.setAttribute('aria-hidden','false');
    document.documentElement.style.overflow='hidden'; document.body.style.overflow='hidden';
    currentOpenModal = modalId;
    setTimeout(()=>{ if(focusSelector){ const el = modal.querySelector(focusSelector); if(el) el.focus(); return; } const first = modal.querySelector('input, button, select, textarea'); if(first) first.focus(); },120);
  }

  async function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) { globalBackdrop.classList.remove('visible'); document.documentElement.style.overflow=''; document.body.style.overflow=''; currentOpenModal = null; return; }
    if (modal.classList.contains('scanner-modal')) await _stopCameraSafe();
    modal.classList.remove('visible'); modal.setAttribute('aria-hidden','true');
    setTimeout(()=>{ const anyVisible = Array.from(document.querySelectorAll('.modal')).some(m=>m.classList.contains('visible')); if(!anyVisible){ globalBackdrop.classList.remove('visible'); globalBackdrop.setAttribute('aria-hidden','true'); document.documentElement.style.overflow=''; document.body.style.overflow=''; currentOpenModal = null; } else { const remaining = document.querySelector('.modal.visible'); if(remaining) currentOpenModal = remaining.id; } },120);
  }

  globalBackdrop.addEventListener('click', async ()=>{ if(!currentOpenModal) return; await closeModal(currentOpenModal); });
  document.addEventListener('keydown', async e=>{ if(e.key==='Escape' && currentOpenModal) await closeModal(currentOpenModal); });
  document.addEventListener('click', e=>{ const btn = e.target.closest('[data-close-modal]'); if(!btn) return; const modal = btn.closest('.modal'); if(!modal) return; closeModal(modal.id); });

  /* ---------------------------
     Product modal logic
     --------------------------- */
  $('#open-add-product').addEventListener('click', ()=> openProductModal());
  function openProductModal(product){
    if(!isAuthenticated()) return alert('Inicia sesiÃ³n');
    $('#form-product').reset(); $('#product-id').value='';
    if(product){ $('#product-id').value = product.id; $('#product-name').value = product.name; $('#product-category').value = product.category||''; $('#product-price').value = product.price||0; $('#product-barcode').value = product.barcode||''; $('#product-stock').value = product.stock||0; }
    showModal('modal-product', { focusSelector:'#product-name' });
  }
  $('#form-product').onsubmit = async e => {
    e.preventDefault();
    const id = $('#product-id').value || uid();
    const prod = {
      id,
      name: $('#product-name').value.trim(),
      category: $('#product-category').value.trim(),
      price: Number($('#product-price').value)||0,
      barcode: $('#product-barcode').value.trim(),
      stock: Number($('#product-stock').value)||0,
      createdAt: new Date().toISOString()
    };
    await put('products', prod);
    closeModal('modal-product'); await refreshAll();
  };

  /* ---------------------------
     Income (stock)
     --------------------------- */
  $('#open-income').onclick = ()=> { renderIncomeSelects(); showModal('modal-income'); };
  function renderIncomeSelects(){ const sel = $('#income-product'); if(!sel) return; sel.innerHTML=''; state.products.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=`${p.name} â€” Stock: ${p.stock||0}`; sel.appendChild(o); }); }
  function openIncomeFor(productId){ renderIncomeSelects(); $('#income-product').value = productId; showModal('modal-income'); }
  $('#form-income').onsubmit = async e=>{ e.preventDefault(); const pid = $('#income-product').value; const qty = Number($('#income-qty').value)||0; const p = state.products.find(x=>x.id===pid); p.stock = (p.stock||0) + qty; await put('products', p); await add('movements', { id:uid(), type:'income', productId:pid, qty, date: new Date().toISOString() }); closeModal('modal-income'); await refreshAll(); };

  /* ---------------------------
     Quick sale (modal)
     --------------------------- */
  $('#open-quick-sale').onclick = ()=> { renderQuickSelect(); showModal('modal-quick-sale'); };
  function renderQuickSelect(){ const sel = $('#quick-product'); sel.innerHTML=''; state.products.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=`${p.name} (stock ${p.stock||0})`; sel.appendChild(o); }); updateQuickTotal(); }
  $('#quick-search').oninput = debounce(function(){ const v=this.value.trim().toLowerCase(); if(!v) return; const digits = v.replace(/\D/g,''); let found=null; if(digits.length>0) found = state.products.find(p => (p.barcode||'').replace(/\D/g,'').endsWith(digits) || (p.barcode||'')===v); if(!found) found = state.products.find(p => p.name.toLowerCase().includes(v)); if(found) $('#quick-product').value = found.id; updateQuickTotal(); },160);
  function updateQuickTotal(){ const pid = $('#quick-product').value; const qty = Number($('#quick-qty').value)||0; const p = state.products.find(x=>x.id===pid); $('#quick-total').textContent = money(p ? p.price * qty : 0); }
  $('#quick-product').onchange = updateQuickTotal; $('#quick-qty').oninput = updateQuickTotal;
  const quickCart = [];
  $('#quick-add-cart').onclick = function(){ const pid = $('#quick-product').value; const qty = Number($('#quick-qty').value)||1; const p = state.products.find(x=>x.id===pid); if(!p) return alert('Selecciona un producto'); quickCart.push({ productId: pid, qty, price: p.price }); renderQuickCart(); };
  function renderQuickCart(){ const el = $('#quick-cart'); el.innerHTML=''; quickCart.forEach((it, idx)=>{ const p = state.products.find(x=>x.id===it.productId); const d = document.createElement('div'); d.className = 'flex justify-between items-center'; d.innerHTML = `<div>${p.name} x ${it.qty}</div><div>${money(it.qty*it.price)} <button data-idx="${idx}" class="ml-2 text-sm text-red-600 btn-remove-quick">Quitar</button></div>`; el.appendChild(d); }); $$('.btn-remove-quick').forEach(b=> b.onclick = ()=> { quickCart.splice(Number(b.dataset.idx),1); renderQuickCart(); }); }
  $('#form-quick-sale').onsubmit = async function(e){ e.preventDefault(); if(quickCart.length===0) return alert('Agregar productos'); const customer = $('#quick-customer').value.trim(); const payment = $('#quick-payment').value; for(const it of quickCart){ const p = state.products.find(x=>x.id===it.productId); p.stock = (p.stock||0) - it.qty; await put('products', p); await add('movements', { id:uid(), type:'sale', productId: it.productId, qty: it.qty, date: new Date().toISOString() }); } const total = quickCart.reduce((s,i)=>s + i.qty*i.price,0); const date = new Date().toISOString(); const respDate = ($('#responsible-date').value) ? $('#responsible-date').value : todayYMD(); const responsibleObj = await get('responsibles', respDate).catch(()=>null); const responsibleName = (responsibleObj && responsibleObj.name) ? responsibleObj.name : ($('#responsible-name').value.trim()||''); const sale = { id:uid(), items: quickCart.slice(), total, date, customerName: customer || null, paid: (payment!=='A_CREDITO'), paymentType: payment, responsible: responsibleName }; await add('sales', sale); if(payment === 'A_CREDITO' && customer){ const existing = await get('customers', customer).catch(()=>null); const prev = existing && existing.balance ? existing.balance : 0; await put('customers', { name: customer, balance: prev + total, lastSale: date }); } quickCart.length = 0; closeModal('modal-quick-sale'); await refreshAll(); };

  /* quickSellPrompt for immediate sale */
  async function quickSellPrompt(productId){
    const qtyStr = prompt('Cantidad a vender (rÃ¡pido):', '1'); if (!qtyStr) return;
    const qty = Math.max(1, Number(qtyStr));
    const payment = prompt('Tipo pago: EFECTIVO, YAPE o A_CREDITO', 'EFECTIVO') || 'EFECTIVO';
    let customerName = null;
    if(payment.toUpperCase() === 'A_CREDITO') customerName = prompt('Nombre del cliente:') || null;
    const prod = state.products.find(p => p.id === productId); if(!prod) return alert('Producto no encontrado');
    prod.stock = (prod.stock||0) - qty; await put('products', prod);
    await add('movements', { id:uid(), type:'sale', productId, qty, date: new Date().toISOString() });
    const total = qty * prod.price;
    const date = new Date().toISOString();
    const respDate = ($('#responsible-date').value) ? $('#responsible-date').value : todayYMD();
    const responsibleObj = await get('responsibles', respDate).catch(()=>null);
    const responsibleName = (responsibleObj && responsibleObj.name) ? responsibleObj.name : ($('#responsible-name').value.trim()||'');
    await add('sales', { id:uid(), items:[{ productId, qty, price: prod.price }], total, date, customerName, paid: (payment.toUpperCase()!=='A_CREDITO'), paymentType: payment.toUpperCase(), responsible: responsibleName });
    if(payment.toUpperCase()==='A_CREDITO' && customerName){ const existing = await get('customers', customerName).catch(()=>null); const prev = existing && existing.balance ? existing.balance : 0; await put('customers', { name: customerName, balance: prev + total, lastSale: date }); }
    await refreshAll();
  }

  /* ---------------------------
     Clients modal (A CREDITO)
     --------------------------- */
  $('#open-clients').onclick = ()=> { showModal('modal-clients'); };
  $('#add-client').onclick = async ()=> {
    const name = $('#client-name').value.trim(); if(!name) return alert('Ingresa nombre');
    const existing = await get('customers', name).catch(()=>null); if(existing) return alert('Cliente ya existe');
    await put('customers', { name, balance: 0, createdAt: new Date().toISOString() }); $('#client-name').value=''; await refreshAll(); showModal('modal-clients');
  };
  async function renderClients(){
    const el = $('#clients-list'); el.innerHTML=''; const clients = state.customers || [];
    if(!clients.length) el.innerHTML = '<div class="text-sm text-gray-600">No hay clientes registrados.</div>';
    for(const c of clients){
      const d = document.createElement('div'); d.className='p-2 border rounded flex justify-between items-center bg-white';
      d.innerHTML = `<div><div class="font-medium">${c.name}</div><div class="text-xs text-gray-500">Saldo: S/ ${money(c.balance||0)}</div></div>
        <div class="flex gap-2"><button data-name="${c.name}" class="px-3 py-2 border rounded btn-abono">Abono</button><button data-name="${c.name}" class="px-3 py-2 bg-green-600 text-white rounded btn-saldar">Saldar</button></div>`;
      el.appendChild(d);
    }
    $$('.btn-abono').forEach(b=> b.onclick = async ()=>{ const name=b.dataset.name; const amt = Number(prompt(`Abono para ${name} - monto:`, '0'))||0; if(amt<=0) return; const c = await get('customers', name); const newBal = (c.balance||0) - amt; await put('customers', { name, balance: newBal < 0 ? 0 : newBal, lastPayment: new Date().toISOString() }); alert('Abono registrado'); await refreshAll(); });
    $$('.btn-saldar').forEach(b=> b.onclick = async ()=>{ const name=b.dataset.name; if(!confirm(`Â¿Saldar cuenta de ${name}? Esto pondrÃ¡ su saldo a 0.`)) return; await put('customers',{ name, balance: 0, lastPayment: new Date().toISOString() }); alert('Cuenta saldada'); await refreshAll(); });
  }

  /* ---------------------------
     Responsible handling
     --------------------------- */
  $('#save-responsible').onclick = async ()=>{
    const date = $('#responsible-date').value; const name = $('#responsible-name').value.trim();
    if(!date) return alert('Selecciona fecha');
    const existing = await get('responsibles', date).catch(()=>null);
    if(existing && existing.name && existing.name !== name){ if(!confirm(`Ya existe un responsable para ${date}: "${existing.name}". Â¿Sobrescribir?`)) return; }
    await put('responsibles', { date, name }); alert('Responsable guardado'); await refreshAll();
  };
  async function updateResponsibleBanner(){ const today = todayYMD(); $('#responsible-date').value = today; const r = await get('responsibles', today).catch(()=>null); if(r && r.name){ $('#responsible-display').textContent = `${r.name} (${today})`; $('#responsible-name').value = r.name; } else { $('#responsible-display').textContent = 'Sin encargado asignado para hoy'; $('#responsible-name').value = ''; } }

  /* ---------------------------
     Charts (small)
     --------------------------- */
  let chartSales, chartStock;
  function updateCharts(){
    const salesData = state.sales.slice(-8).map(s=>({ x: new Date(s.date).toLocaleString(), y: s.total }));
    const ctxS = $('#chart-sales')?.getContext('2d'); if(ctxS){ if(chartSales) chartSales.destroy(); chartSales = new Chart(ctxS, { type:'bar', data:{ labels: salesData.map(s=>s.x), datasets:[{ label:'Ventas', data: salesData.map(s=>s.y) }]}, options:{ responsive:true } }); }
    const stockData = state.products.slice().sort((a,b)=>b.stock-a.stock).slice(0,6);
    const ctxSt = $('#chart-stock')?.getContext('2d'); if(ctxSt){ if(chartStock) chartStock.destroy(); chartStock = new Chart(ctxSt, { type:'pie', data:{ labels: stockData.map(p=>p.name), datasets:[{ label:'Stock', data: stockData.map(p=>p.stock) }]}, options:{ responsive:true } }); }
  }

  /* ---------------------------
     Reports (preview/print)
     --------------------------- */
  $('#open-report-modal')?.addEventListener('click', ()=> showModal('modal-report'));
  $('#btn-generate-report')?.addEventListener('click', async ()=> { const from = $('#report-from').value; const to = $('#report-to').value; if(!from||!to) return alert('Selecciona rango'); const { previewHtml } = await buildReportHTML(from,to); $('#report-preview').innerHTML = previewHtml; });
  $('#btn-print-report')?.addEventListener('click', async ()=> { const from = $('#report-from').value; const to = $('#report-to').value; if(!from||!to) return alert('Selecciona rango'); const { printableHtml } = await buildReportHTML(from,to); const w = window.open('', '_blank'); w.document.open(); w.document.write(printableHtml); w.document.close(); setTimeout(()=> w.print(), 600); });
  async function buildReportHTML(from, to){
    const salesAll = await all('sales');
    const sales = salesAll.filter(s => { const d = localYMDFromISO(s.date); return d>=from && d<=to; }).sort((a,b)=>a.date.localeCompare(b.date));
    const company='MINIMARKET LA ESQUINA DEL AHORRO';
    const responsibles = await all('responsibles'); const respMap={}; responsibles.forEach(r=> respMap[r.date]=r.name);
    let totalAll=0; let rows='';
    for(const s of sales){ const d = new Date(s.date).toLocaleString(); const resp = s.responsible || respMap[s.date.slice(0,10)] || ''; totalAll += Number(s.total||0); const customer = s.customerName ? `${s.customerName}${s.paid? '':' (A CREDITO)'}` : (s.paid? 'Contado':'A CREDITO'); const payment = s.paymentType || (s.paid? 'EFECTIVO':'A_CREDITO'); let itemsHtml = '<ul style="margin:0;padding-left:16px;">'; for(const it of s.items){ const p = state.products.find(x=>x.id===it.productId); itemsHtml += `<li>${p? p.name : it.productId} â€” ${it.qty} x ${money(it.price)} = ${money(it.qty*it.price)}</li>`; } itemsHtml += '</ul>'; rows += `<tr><td style="padding:8px">${d}</td><td style="padding:8px">${s.id}</td><td style="padding:8px">${customer}</td><td style="padding:8px">${resp}</td><td style="padding:8px">${payment}</td><td style="padding:8px">${itemsHtml}</td><td style="padding:8px;text-align:right">${money(s.total)}</td></tr>`; }
    const fiadas = sales.filter(s => s.paid === false || (s.paymentType && s.paymentType.toUpperCase()==='A_CREDITO'));
    let fiadasRows=''; for(const f of fiadas){ const d = new Date(f.date).toLocaleString(); fiadasRows += `<tr><td style="padding:8px">${d}</td><td style="padding:8px">${f.id}</td><td style="padding:8px">${f.customerName||'Sin nombre'}</td><td style="padding:8px">${f.responsible||''}</td><td style="padding:8px">${money(f.total)}</td></tr>`; }
    const previewHtml = `<div><div style="display:flex;justify-content:space-between;align-items:center;"><div><h2>${company}</h2><div style="color:#666">Reporte de ventas</div></div><div style="text-align:right"><div>Generado: ${new Date().toLocaleString()}</div><div>Periodo: ${from} â†’ ${to}</div></div></div><hr style="margin:12px 0;border:none;border-top:2px solid #222"><table style="width:100%;border-collapse:collapse"><thead><tr><th>Fecha</th><th>ID</th><th>Cliente</th><th>Encargado</th><th>Pago</th><th>Items</th><th style="text-align:right">Total</th></tr></thead><tbody>${rows || '<tr><td colspan="7" style="padding:12px;text-align:center;color:#666">No hay ventas en este periodo</td></tr>'}</tbody></table><div style="margin-top:12px;text-align:right;font-weight:bold">Total perÃ­odo: ${money(totalAll)}</div>${fiadas.length ? `<hr style="margin:12px 0"><h4>Ventas por cobrar (A CREDITO)</h4><table style="width:100%;border-collapse:collapse;"><thead><tr><th>Fecha</th><th>ID</th><th>Cliente</th><th>Encargado</th><th>Monto</th></tr></thead><tbody>${fiadasRows}</tbody></table>` : ''}</div>`;
    const printableHtml = `<!doctype html><html><head><meta charset="utf-8"><title>Reporte ${from} - ${to}</title><style>body{font-family:Arial,Helvetica,sans-serif;font-size:13px;color:#111;margin:0;padding:16px}th{background:#f3f4f6;padding:8px;text-align:left}td{padding:8px;border-bottom:1px solid #ddd;vertical-align:top}</style></head><body>${previewHtml}</body></html>`;
    return { previewHtml, printableHtml };
  }

  /* ---------------------------
     Export/Import
     --------------------------- */
  $('#btn-export')?.addEventListener('click', async ()=>{ const data = { products: await all('products'), sales: await all('sales'), movements: await all('movements'), customers: await all('customers'), responsibles: await all('responsibles') }; const blob = new Blob([JSON.stringify(data,null,2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'tienda-smart-export.json'; a.click(); URL.revokeObjectURL(url); });
  $('#btn-import')?.addEventListener('click', ()=>{ const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange = async ()=>{ const f = inp.files[0]; if(!f) return; const txt = await f.text(); const obj = JSON.parse(txt); if(obj.products) for(const p of obj.products) await put('products', p); if(obj.sales) for(const s of obj.sales) await put('sales', s); if(obj.movements) for(const m of obj.movements) await put('movements', m); if(obj.customers) for(const c of obj.customers) await put('customers', c); if(obj.responsibles) for(const r of obj.responsibles) await put('responsibles', r); await refreshAll(); }; inp.click(); });

  /* ---------------------------
     SCANNER: OpenCV (WASM) preprocess + BarcodeDetector + Quagga fallback
     --------------------------- */
  let cvReady=false, awaitingCvInit=false;
  if(window.cv && cv['onRuntimeInitialized']){ awaitingCvInit=true; cv['onRuntimeInitialized'] = ()=>{ cvReady=true; awaitingCvInit=false; console.info('OpenCV ready'); }; } else if(window.cv){ cvReady=true; }

  const video = $('#video'); let videoStream=null, currentVideoTrack=null;
  let detectionLoop=false, quaggaActive=false, readBuffer=[];
  const READ_CONFIRM=4, READ_WINDOW_MS=2200;
  let overlayCanvas = $('#overlay-canvas'); let overlayCtx = overlayCanvas ? overlayCanvas.getContext('2d') : null;

  function resizeOverlay(){ overlayCanvas = $('#overlay-canvas'); if(!overlayCanvas) return; overlayCanvas.width = video.clientWidth; overlayCanvas.height = video.clientHeight; overlayCtx = overlayCanvas.getContext('2d'); }
  function clearOverlay(){ if(!overlayCtx) resizeOverlay(); overlayCtx.clearRect(0,0,overlayCanvas.width, overlayCanvas.height); }

  function pushRead(code){ const now = Date.now(); readBuffer = readBuffer.filter(r=> now - r.t < READ_WINDOW_MS); readBuffer.push({ code, t: now }); const last = readBuffer.slice(-READ_CONFIRM); if(last.length >= READ_CONFIRM && last.every(x=> x.code === last[0].code)) return last[0].code; return null; }

  async function startCameraHighRes(){
    try{
      const constraints = { audio:false, video:{ facingMode:{ ideal:'environment' }, width:{ ideal:1920 }, height:{ ideal:1080 }, advanced:[{ focusMode:'continuous' }] } };
      videoStream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = videoStream; currentVideoTrack = videoStream.getVideoTracks()[0];
      const caps = currentVideoTrack.getCapabilities ? currentVideoTrack.getCapabilities() : {};
      if(caps && caps.torch) $('#toggle-torch').classList.remove('hidden'); else $('#toggle-torch').classList.add('hidden');
      await video.play(); resizeOverlay();
    }catch(err){ console.warn('startCameraHighRes', err); alert('No se pudo acceder a la cÃ¡mara. Revisa permisos o usa https/localhost.'); throw err; }
  }

  async function captureProcessedFrame(){
    const w = video.videoWidth || 1280, h = video.videoHeight || 720;
    const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.filter = 'contrast(140%) brightness(105%) saturate(115%)';
    ctx.drawImage(video, 0, 0, w, h);

    if(cvReady){
      try{
        let src = cv.imread(canvas);
        let gray = new cv.Mat(); cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
        let blurred = new cv.Mat(); cv.bilateralFilter(gray, blurred, 9, 75, 75, cv.BORDER_DEFAULT);
        let clahe = new cv.Mat();
        try{ let claheObj = new cv.CLAHE(3.0, new cv.Size(8,8)); claheObj.apply(blurred, clahe); claheObj.delete(); }catch(x){ cv.equalizeHist(blurred, clahe); }
        let thresh = new cv.Mat(); cv.adaptiveThreshold(clahe, thresh, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 47, 10);
        let kernel = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(3,3));
        cv.morphologyEx(thresh, thresh, cv.MORPH_CLOSE, kernel);
        let out = new cv.Mat(); cv.cvtColor(thresh, out, cv.COLOR_GRAY2RGBA);
        cv.imshow(canvas, out);
        src.delete(); gray.delete(); blurred.delete(); clahe.delete(); thresh.delete(); kernel.delete(); out.delete();
        const bitmap = await createImageBitmap(canvas);
        return bitmap;
      }catch(err){
        console.warn('OpenCV error', err);
        return await createImageBitmap(canvas);
      }
    } else {
      return await createImageBitmap(canvas);
    }
  }

  function computeROI(bitmap){ const bw = bitmap.width, bh = bitmap.height; const w = Math.floor(bw * 0.6), h = Math.floor(bh * 0.28); const sx = Math.floor((bw-w)/2), sy = Math.floor((bh-h)/2); return { sx, sy, sw: w, sh: h }; }

  async function startBarcodeDetection(){
    if(!isAuthenticated()) return;
    $('#scanned-code').value=''; readBuffer=[];
    if(awaitingCvInit){ console.info('Esperando OpenCV...'); while(awaitingCvInit) await new Promise(r=>setTimeout(r,100)); }
    try{
      if('BarcodeDetector' in window){
        const detector = new BarcodeDetector({ formats: ['ean_13','code_128','upc_e','upc_a','ean_8'] });
        await startCameraHighRes();
        detectionLoop = true;
        while(detectionLoop){
          if(!video || video.readyState < 2){ await new Promise(r=>setTimeout(r,100)); continue; }
          try{
            const bitmap = await captureProcessedFrame();
            const roi = computeROI(bitmap);
            const cropped = await createImageBitmap(bitmap, roi.sx, roi.sy, roi.sw, roi.sh);
            const barcodes = await detector.detect(cropped);
            clearOverlay(); drawROI(roi);
            if(barcodes && barcodes.length>0){
              const candidate = (barcodes[0].rawValue || '').trim();
              const confirmed = pushRead(candidate);
              if(confirmed){ $('#scanned-code').value = confirmed; showConfirmation(confirmed); await new Promise(r=>setTimeout(r,900)); }
            }
            bitmap.close(); cropped.close();
          }catch(err){
            console.warn('BarcodeDetector loop error', err); detectionLoop = false; fallbackQuagga(); break;
          }
          await new Promise(r=>setTimeout(r,80));
        }
        return;
      } else {
        fallbackQuagga();
      }
    }catch(err){ console.warn('startBarcodeDetection error', err); fallbackQuagga(); }
  }

  function drawROI(roi){ if(!overlayCtx) resizeOverlay(); const scaleX = overlayCanvas.width / (video.videoWidth || 1); const scaleY = overlayCanvas.height / (video.videoHeight || 1); overlayCtx.strokeStyle='rgba(0,255,100,0.9)'; overlayCtx.lineWidth=3; overlayCtx.strokeRect(roi.sx*scaleX, roi.sy*scaleY, roi.sw*scaleX, roi.sh*scaleY); }
  function showConfirmation(text){ if(!overlayCtx) resizeOverlay(); overlayCtx.font='20px monospace'; overlayCtx.fillStyle='rgba(0,0,0,0.6)'; const x=10, y=30; const w = overlayCtx.measureText(text).width + 20; overlayCtx.fillRect(x, y-22, w, 28); overlayCtx.fillStyle='white'; overlayCtx.fillText(text, x+8, y); }

  function fallbackQuagga(){ startCameraHighRes().then(()=>{ if(!window.Quagga) return alert('Quagga fallback no disponible'); quaggaActive=true; Quagga.init({ inputStream:{ name:'Live', type:'LiveStream', target:'#video', constraints:{ facingMode:'environment', width:1280, height:720 } }, locator:{ patchSize:'large', halfSample:false }, decoder:{ readers:['ean_reader','ean_8_reader','code_128_reader','upc_reader','upc_e_reader'] }, locate:true }, err=>{ if(err){ console.error('Quagga init', err); return; } Quagga.start(); }); Quagga.onProcessed(result=>{ clearOverlay(); if(!result) return; if(result.boxes) result.boxes.filter(b=>b!==result.box).forEach(b=> drawPath(b,'rgba(255,255,255,0.2)')); if(result.box) drawPath(result.box,'lime'); }); Quagga.onDetected(data=>{ const code = data && data.codeResult && data.codeResult.code; if(code){ const confirmed = pushRead(code); if(confirmed){ $('#scanned-code').value = confirmed; try{ Quagga.stop(); }catch(e){} } } }); function drawPath(path, color){ if(!overlayCtx) resizeOverlay(); overlayCtx.strokeStyle = color; overlayCtx.lineWidth = 3; overlayCtx.beginPath(); overlayCtx.moveTo(path[0].x, path[0].y); for(let i=1;i<path.length;i++) overlayCtx.lineTo(path[i].x, path[i].y); overlayCtx.closePath(); overlayCtx.stroke(); } }).catch(e=>console.warn('fallbackQuagga camera fail', e)); }

  async function stopCamera(){ detectionLoop = false; if(quaggaActive && window.Quagga){ try{ Quagga.stop(); }catch(e){} quaggaActive=false; } if(videoStream) videoStream.getTracks().forEach(t=>t.stop()); video.srcObject = null; videoStream = null; currentVideoTrack = null; clearOverlay(); readBuffer = []; }

  $('#open-scan').onclick = ()=> { if(!isAuthenticated()) return showLogin(); showModal('modal-scan'); startBarcodeDetection().catch(()=>{}); };
  $('#stop-camera').onclick = async ()=> { await stopCamera(); };
  $('#toggle-torch').onclick = async ()=>{ if(!currentVideoTrack) return alert('CÃ¡mara no activada'); try{ const caps = currentVideoTrack.getCapabilities(); if(!caps.torch) return alert('Linterna no soportada'); await currentVideoTrack.applyConstraints({ advanced: [{ torch: true }] }); }catch(e){ console.warn('torch', e); alert('Linterna no soportada'); } };

  $('#fill-product').onclick = ()=> { const code = $('#scanned-code').value.trim(); if(!code) return alert('No hay cÃ³digo detectado'); const p = findProductByCode(code); if(p) openProductModal(p); else { $('#product-barcode').value = code; openProductModal(); } };
  $('#quick-sell-detected').onclick = async ()=>{ const code = $('#scanned-code').value.trim(); if(!code) return alert('No hay cÃ³digo detectado'); const p = findProductByCode(code); if(!p){ if(!confirm('Producto no encontrado. Â¿Crear nuevo?')) return; $('#product-barcode').value = code; openProductModal(); return; } const qty = Number(prompt('Cantidad a vender (rÃ¡pido):','1')) || 1; const payment = prompt('Tipo pago: EFECTIVO, YAPE o A_CREDITO', 'EFECTIVO') || 'EFECTIVO'; let customer = null; if(payment.toUpperCase()==='A_CREDITO') customer = prompt('Nombre del cliente:') || null; p.stock = (p.stock||0) - qty; await put('products', p); await add('movements', { id:uid(), type:'sale', productId: p.id, qty, date: new Date().toISOString() }); const total = qty * p.price; const date = new Date().toISOString(); const respDate = ($('#responsible-date').value) ? $('#responsible-date').value : todayYMD(); const responsibleObj = await get('responsibles', respDate).catch(()=>null); const responsibleName = (responsibleObj && responsibleObj.name) ? responsibleObj.name : ($('#responsible-name').value.trim()||''); await add('sales', { id:uid(), items:[{ productId: p.id, qty, price: p.price }], total, date, customerName: customer, paid: (payment.toUpperCase()!=='A_CREDITO'), paymentType: payment.toUpperCase(), responsible: responsibleName }); if(payment.toUpperCase()==='A_CREDITO' && customer){ const existing = await get('customers', customer).catch(()=>null); const prev = existing && existing.balance ? existing.balance : 0; await put('customers', { name: customer, balance: prev + total, lastSale: date }); } alert('Venta rÃ¡pida registrada'); await refreshAll(); };

  function findProductByCode(code){
    const norm = (code||'').replace(/\D/g,'');
    let p = state.products.find(x => (x.barcode||'') === code || (x.barcode||'').replace(/\D/g,'') === norm);
    if(!p && norm.length>6) p = state.products.find(x => (x.barcode||'').replace(/\D/g,'').endsWith(norm));
    return p;
  }

  /* ---------------------------
     Init bindings and final touches
     --------------------------- */
  (function initBindings(){
    // theme toggle
    $('#btn-theme').onclick = ()=> { const cur = document.body.getAttribute('data-theme') || 'light'; document.body.setAttribute('data-theme', cur === 'light' ? 'dark' : 'light'); };
    // search input
    $('#search').oninput = debounce(e => renderInventoryMobile(e.target.value), 160);

    // if already authenticated, start app
    if(isAuthenticated()){
      $('#current-user').textContent = localStorage.getItem(AUTH_KEY); $('#current-user').classList.remove('hidden'); $('#btn-logout').classList.remove('hidden');
      startAppAfterAuth();
    }
    // ensure overlay backdrop click closes modals is handled above
    window.addEventListener('resize', ()=>{ try{ resizeOverlay(); }catch(e){} });
  })();

  </script>
</body>
</html>

