<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>MINIMARKET LA ESQUINA DEL AHORRO â€” TiendaSmart</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Fuse.js (bÃºsqueda rÃ¡pida/difusa) -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

<!-- SheetJS (XLSX import/export) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<!-- Quagga fallback -->
<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- html2canvas + jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Firebase compat (opcional) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<style>
  :root{ --bg:#f2f6fb; --card:#fff; --muted:#6b7280; }
  [data-theme="dark"]{ --bg:#061025; --card:#0b1622; --muted:#9ca3af; color-scheme:dark; }
  body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:var(--bg); -webkit-user-select:none; user-select:none; }
  .app{ max-width:980px; margin:0 auto; padding:18px; padding-bottom:140px; }
  .bottom-bar{ position:fixed; left:0; right:0; bottom:0; z-index:60; display:flex; gap:8px; padding:12px; background:linear-gradient(0deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95)); box-shadow:0 -6px 18px rgba(2,6,23,0.06); }
  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:60; padding:12px; }
  .modal.visible{ display:flex; }
  .modal .content{ width:100%; max-width:900px; border-radius:12px; background:var(--card); padding:12px; box-shadow:0 12px 40px rgba(2,6,23,0.12); }
  @media(max-width:640px){ .modal .content{ width:100%; height:100%; border-radius:0; padding:6px; } }
  .suggestions{ position:absolute; background:white; border:1px solid #e5e7eb; width:100%; max-height:260px; overflow:auto; z-index:90; border-radius:8px; }
  .suggestion-item{ padding:10px; cursor:pointer; }
  .suggestion-item:hover, .suggestion-item.active{ background:#f3f4f6; }
  #overlay-canvas{ position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:20; }
  .scan-guide{ position:absolute; left:50%; top:50%; width:66%; height:28%; transform:translate(-50%,-50%); border:2px dashed rgba(255,255,255,0.7); border-radius:8px; pointer-events:none; z-index:30; }
  @media print{
    body *{ visibility:hidden; }
    .print-area, .print-area *{ visibility:visible; }
    .print-area{ position: absolute; left:0; top:0; width:100%; }
  }
</style>
</head>
<body data-theme="light">

<!-- backdrop -->
<div id="backdrop" class="fixed inset-0 bg-black/50 z-40 hidden"></div>

<div class="app">
  <!-- header -->
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-3">
      <div class="w-12 h-12 rounded-lg bg-gradient-to-r from-green-500 to-blue-500 flex items-center justify-center text-white shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3h2l.4 2M7 13h10l-1.2 6H6L5 13z"/></svg>
      </div>
      <div>
        <div class="text-sm font-semibold">MINIMARKET</div>
        <div class="text-xs text-gray-500">La Esquina del Ahorro</div>
      </div>
    </div>

    <div class="flex items-center gap-2">
      <div id="mode-label" class="text-xs text-gray-600">Modo: <strong id="mode-state">LOCAL</strong></div>
      <div id="current-user" class="hidden px-3 py-1 rounded-full text-sm bg-indigo-600 text-white"></div>
      <button id="btn-logout" class="hidden px-3 py-2 border rounded text-sm">Salir</button>
      <button id="btn-open-report" class="px-3 py-2 border rounded text-sm">Reportes</button>
    </div>
  </div>

  <!-- encargado -->
  <div class="mb-3 p-3 rounded-lg shadow bg-white flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div>
      <div class="text-xs text-gray-600">Encargado del dÃ­a</div>
      <div id="responsible-display" class="font-medium">â€”</div>
    </div>
    <div class="flex gap-2 items-center">
      <input id="responsible-date" type="date" class="px-2 py-1 rounded border bg-white">
      <input id="responsible-name" placeholder="Nombre encargado" class="px-2 py-1 rounded border w-48 bg-white">
      <button id="save-responsible" class="px-3 py-1 bg-indigo-600 text-white rounded">Guardar</button>
    </div>
  </div>

  <!-- controls: import/export/sync -->
  <div class="mb-3 flex flex-wrap gap-2">
    <button id="btn-export-csv" class="px-3 py-2 bg-gray-800 text-white rounded">Exportar (CSV/XLSX)</button>
    <button id="btn-import" class="px-3 py-2 border rounded">Importar (CSV/XLSX)</button>
    <input id="file-import" type="file" accept=".csv,.xlsx" class="hidden">
    <button id="btn-sync-toggle" class="px-3 py-2 border rounded">Sincronizar (Off)</button>
  </div>

  <!-- search -->
  <div class="relative mb-3">
    <input id="search" type="search" placeholder="Buscar producto por nombre, categorÃ­a o cÃ³digo..." class="w-full px-4 py-3 rounded-lg shadow border bg-white" autocomplete="off">
    <div id="search-suggestions" class="suggestions hidden"></div>
  </div>

  <!-- inventory list -->
  <div id="inventory-list" class="space-y-3 mb-28"></div>

  <!-- small charts -->
  <div class="grid grid-cols-2 gap-3 mb-6">
    <div class="bg-white rounded-lg p-2 shadow"><canvas id="chart-sales" height="120"></canvas></div>
    <div class="bg-white rounded-lg p-2 shadow"><canvas id="chart-stock" height="120"></canvas></div>
  </div>
</div>

<!-- bottom bar -->
<div class="bottom-bar">
  <button id="open-add-product" class="flex-1 px-4 py-3 rounded-lg bg-green-500 text-white font-semibold">+ Producto</button>
  <button id="open-scan" class="flex-1 px-4 py-3 rounded-lg bg-yellow-500 text-white font-semibold">Escanear</button>
  <button id="open-quick-sale" class="flex-1 px-4 py-3 rounded-lg bg-red-600 text-white font-semibold">Venta</button>
  <button id="open-clients" class="flex-1 px-4 py-3 rounded-lg bg-indigo-600 text-white font-semibold">Clientes</button>
</div>

<!-- ---------- MODALES (product, scan, quick sale, income, sale, clients, reports, login) ---------- -->
<!-- PRODUCT -->
<div id="modal-product" class="modal" aria-hidden="true">
  <div class="content">
    <div class="flex justify-between items-center pb-2 border-b">
      <h4 class="text-lg font-semibold">Producto</h4>
      <button data-close-modal class="text-xl">âœ•</button>
    </div>
    <form id="form-product" class="p-3 space-y-3">
      <input type="hidden" id="product-id">
      <input id="product-name" placeholder="Nombre" required class="w-full px-3 py-3 rounded border bg-white text-lg">
      <div class="flex gap-2">
        <input id="product-category" placeholder="CategorÃ­a" class="flex-1 px-3 py-3 rounded border bg-white">
        <input id="product-price" placeholder="Precio" type="number" step="0.01" class="w-28 px-3 py-3 rounded border bg-white">
      </div>
      <div class="flex gap-2">
        <input id="product-barcode" placeholder="CÃ³digo de barras" class="flex-1 px-3 py-3 rounded border bg-white">
        <input id="product-stock" placeholder="Stock" type="number" class="w-24 px-3 py-3 rounded border bg-white">
      </div>
      <div class="flex gap-2">
        <button type="button" data-close-modal class="flex-1 px-4 py-3 border rounded">Cancelar</button>
        <button type="submit" class="flex-1 px-4 py-3 bg-green-600 text-white rounded">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- SCANNER -->
<div id="modal-scan" class="modal scanner-modal" aria-hidden="true">
  <div class="content">
    <div class="flex justify-between items-center pb-2 bg-black text-white">
      <h4 class="text-lg font-semibold">EscÃ¡ner</h4>
      <div class="flex gap-2">
        <button id="toggle-torch" class="px-3 py-2 rounded hidden">ðŸ”¦</button>
        <button data-close-modal class="text-xl">âœ•</button>
      </div>
    </div>
    <div id="video-wrap" class="relative bg-black" style="height:55vh;">
      <video id="video" autoplay muted playsinline style="width:100%;height:100%;object-fit:cover;"></video>
      <canvas id="overlay-canvas"></canvas>
      <div class="scan-guide"></div>
    </div>
    <div class="p-3 bg-white">
      <input id="scanned-code" class="w-full px-3 py-2 rounded border mb-2" placeholder="CÃ³digo detectado">
      <div class="flex gap-2">
        <button id="fill-product" class="flex-1 px-3 py-2 bg-indigo-600 text-white rounded">Buscar/Editar</button>
        <button id="quick-sell-detected" class="flex-1 px-3 py-2 bg-red-600 text-white rounded">Vender</button>
        <button id="stop-camera" class="px-3 py-2 border rounded">Detener</button>
      </div>
    </div>
  </div>
</div>

<!-- QUICK SALE -->
<div id="modal-quick-sale" class="modal" aria-hidden="true">
  <div class="content">
    <div class="flex justify-between items-center pb-2 border-b">
      <h4 class="text-lg font-semibold">Venta rÃ¡pida</h4>
      <button data-close-modal class="text-xl">âœ•</button>
    </div>
    <form id="form-quick-sale" class="p-3 space-y-3 relative">
      <div class="relative">
        <input id="quick-search" placeholder="Buscar por nombre o cÃ³digo (escribe para ver sugerencias)" class="w-full px-3 py-3 rounded border bg-white text-lg" autocomplete="off">
        <div id="quick-suggestions" class="suggestions hidden"></div>
      </div>
      <div class="flex gap-2">
        <select id="quick-product" class="flex-1 px-3 py-3 border rounded bg-white text-lg"></select>
        <input id="quick-qty" type="number" min="1" value="1" class="w-28 px-3 py-3 border rounded bg-white text-lg">
      </div>
      <div class="flex gap-2 items-center">
        <label class="text-sm">Pago</label>
        <select id="quick-payment" class="px-3 py-2 rounded border">
          <option value="EFECTIVO">EFECTIVO</option>
          <option value="YAPE">YAPE</option>
          <option value="A_CREDITO">A CREDITO</option>
        </select>
        <input id="quick-customer" placeholder="Nombre cliente (si A CREDITO)" class="flex-1 px-3 py-2 border rounded bg-white">
      </div>
      <div class="flex justify-between items-center">
        <div>Total: <span id="quick-total" class="font-semibold">0.00</span></div>
        <div class="flex gap-2">
          <button type="button" id="quick-add-cart" class="px-3 py-2 border rounded">Agregar</button>
          <button type="submit" class="px-3 py-2 bg-red-600 text-white rounded">Cobrar</button>
        </div>
      </div>
      <div>
        <h5 class="text-sm font-medium">Carrito</h5>
        <div id="quick-cart" class="space-y-2 mt-2"></div>
      </div>
    </form>
  </div>
</div>

<!-- INCOME -->
<div id="modal-income" class="modal" aria-hidden="true">
  <div class="content">
    <div class="flex justify-between items-center pb-2 border-b">
      <h4 class="text-lg font-semibold">Registrar ingreso (stock)</h4>
      <button data-close-modal class="text-xl">âœ•</button>
    </div>
    <form id="form-income" class="p-3 space-y-3">
      <select id="income-product" class="w-full px-3 py-2 border rounded"></select>
      <input id="income-qty" type="number" min="1" value="1" class="w-full px-3 py-2 border rounded">
      <div class="flex justify-end gap-2">
        <button type="button" data-close-modal class="px-3 py-2 border rounded">Cancelar</button>
        <button type="submit" class="px-3 py-2 bg-blue-600 text-white rounded">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- SALE (detailed) -->
<div id="modal-sale" class="modal" aria-hidden="true">
  <div class="content">
    <div class="flex justify-between items-center pb-2 border-b">
      <h4 class="text-lg font-semibold">Registrar Venta</h4>
      <button data-close-modal class="text-xl">âœ•</button>
    </div>
    <form id="form-sale" class="p-3 space-y-3">
      <div class="flex gap-2">
        <input id="sale-customer" placeholder="Cliente (opcional)" class="flex-1 px-3 py-2 border rounded bg-white">
        <select id="sale-payment" class="px-3 py-2 border rounded">
          <option value="EFECTIVO">EFECTIVO</option>
          <option value="YAPE">YAPE</option>
          <option value="A_CREDITO">A CREDITO</option>
        </select>
      </div>
      <div id="sale-items" class="space-y-2"></div>
      <div class="flex justify-between items-center">
        <button id="add-sale-item" type="button" class="px-3 py-2 border rounded">Agregar producto</button>
        <div>Total: <span id="sale-total">0.00</span></div>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" data-close-modal class="px-3 py-2 border rounded">Cancelar</button>
        <button type="submit" class="px-3 py-2 bg-red-600 text-white rounded">Vender</button>
      </div>
    </form>
  </div>
</div>

<!-- CLIENTS -->
<div id="modal-clients" class="modal" aria-hidden="true">
  <div class="content">
    <div class="flex justify-between items-center pb-2 border-b">
      <h4 class="text-lg font-semibold">Clientes (A CREDITO)</h4>
      <button data-close-modal class="text-xl">âœ•</button>
    </div>
    <div class="p-3">
      <div class="flex gap-2 mb-3">
        <input id="client-name" placeholder="Nuevo cliente (nombre)" class="flex-1 px-3 py-2 border rounded bg-white">
        <button id="add-client" class="px-3 py-2 bg-green-600 text-white rounded">Agregar</button>
      </div>
      <div id="clients-list" class="space-y-2 max-h-80 overflow-auto"></div>
    </div>
  </div>
</div>

<!-- REPORTS -->
<div id="modal-reports" class="modal" aria-hidden="true">
  <div class="content">
    <div class="flex justify-between items-center pb-2 border-b">
      <h4 class="text-lg font-semibold">Reportes</h4>
      <button data-close-modal class="text-xl">âœ•</button>
    </div>
    <div class="p-3">
      <div class="flex gap-2 mb-3">
        <button id="tab-sales-day" class="px-3 py-2 bg-indigo-600 text-white rounded">Ventas (dÃ­a)</button>
        <button id="tab-sales-range" class="px-3 py-2 border rounded">Ventas por rango</button>
        <button id="tab-inventory" class="px-3 py-2 border rounded">Inventario</button>
      </div>

      <div id="tab-content-day" class="tab-content">
        <div class="grid grid-cols-2 gap-2 mb-3">
          <div><label class="text-xs">Fecha</label><input id="report-day-date" type="date" class="w-full px-2 py-2 border rounded"></div>
          <div class="flex items-end gap-2">
            <button id="btn-generate-day" class="px-3 py-2 bg-indigo-600 text-white rounded">Vista</button>
            <button id="btn-download-day" class="px-3 py-2 bg-gray-800 text-white rounded">Descargar PDF</button>
            <button id="btn-print-day" class="px-3 py-2 border rounded">Imprimir</button>
          </div>
        </div>
        <div id="report-preview-day" class="bg-white p-2 rounded max-h-80 overflow-auto"></div>
      </div>

      <div id="tab-content-range" class="tab-content hidden">
        <div class="grid grid-cols-2 gap-2 mb-3">
          <div><label class="text-xs">Desde</label><input id="report-from" type="date" class="w-full px-2 py-2 border rounded"></div>
          <div><label class="text-xs">Hasta</label><input id="report-to" type="date" class="w-full px-2 py-2 border rounded"></div>
        </div>
        <div class="flex gap-2 mb-3 justify-end">
          <button id="btn-generate-range" class="px-3 py-2 bg-indigo-600 text-white rounded">Generar</button>
          <button id="btn-download-range" class="px-3 py-2 bg-gray-800 text-white rounded">Descargar PDF</button>
          <button id="btn-print-range" class="px-3 py-2 border rounded">Imprimir</button>
        </div>
        <div id="report-preview-range" class="bg-white p-2 rounded max-h-80 overflow-auto"></div>
      </div>

      <div id="tab-content-inv" class="tab-content hidden">
        <div class="flex gap-2 mb-3 justify-end">
          <button id="btn-generate-inv" class="px-3 py-2 bg-indigo-600 text-white rounded">Generar inventario</button>
          <button id="btn-download-inv" class="px-3 py-2 bg-gray-800 text-white rounded">Descargar PDF</button>
          <button id="btn-print-inv" class="px-3 py-2 border rounded">Imprimir</button>
        </div>
        <div id="report-preview-inv" class="bg-white p-2 rounded max-h-80 overflow-auto"></div>
      </div>
    </div>
  </div>
</div>

<!-- LOGIN -->
<div id="modal-login" class="modal visible" aria-hidden="false" style="background:linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.6));">
  <div class="content" style="max-width:480px">
    <div class="p-4">
      <h2 class="text-xl font-semibold mb-2">Ingresar â€” TiendaSmart</h2>
      <p class="text-sm text-gray-500 mb-4">Usuario: <strong>LIZ</strong> â€” ContraseÃ±a: <strong>MAGALY</strong></p>
      <form id="form-login" class="space-y-3">
        <input id="login-user" placeholder="Usuario" class="w-full px-3 py-3 rounded border" autofocus />
        <input id="login-pass" placeholder="ContraseÃ±a" type="password" class="w-full px-3 py-3 rounded border" />
        <div class="flex gap-2">
          <button type="submit" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded font-semibold">Entrar</button>
          <button type="button" id="login-guest" class="flex-1 px-4 py-3 border rounded">Demo</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- SCRIPT -->
<script>
/* ----------------------------
  CONFIG FIREBASE (OPCIONAL)
  Pega tu firebaseConfig aquÃ­ para habilitar CLOUD sync.
  Ejemplo:
  const FIREBASE_CONFIG = {
    apiKey: "...",
    authDomain: "...",
    databaseURL: "https://...firebaseio.com",
    projectId: "...",
    storageBucket: "...",
    messagingSenderId: "...",
    appId: "..."
  };
---------------------------- */
const FIREBASE_CONFIG = null; // <-- pega tu configuraciÃ³n si deseas sincronizar

// ----------------- Helpers -----------------
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const uid = () => 'id-' + Math.random().toString(36).slice(2,9);
const money = v => Number(v||0).toFixed(2);
const todayYMD = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };
function debounce(fn,t=150){ let to; return (...a)=>{ clearTimeout(to); to=setTimeout(()=>fn(...a),t); }; }

// IndexedDB wrapper
const DB_NAME='TiendaSmartDB', DB_VERSION=12;
let db;
function openDB(){ return new Promise((res,rej)=>{ const req=indexedDB.open(DB_NAME,DB_VERSION); req.onupgradeneeded = e => {
  const idb = e.target.result;
  if(!idb.objectStoreNames.contains('products')) idb.createObjectStore('products',{keyPath:'id'});
  if(!idb.objectStoreNames.contains('sales')) idb.createObjectStore('sales',{keyPath:'id'});
  if(!idb.objectStoreNames.contains('movements')) idb.createObjectStore('movements',{keyPath:'id'});
  if(!idb.objectStoreNames.contains('customers')) idb.createObjectStore('customers',{keyPath:'name'});
  if(!idb.objectStoreNames.contains('responsibles')) idb.createObjectStore('responsibles',{keyPath:'date'});
}; req.onsuccess = e => { db = e.target.result; res(db); }; req.onerror = e => rej(e); }); }
const store = (name,mode='readonly') => db.transaction(name, mode).objectStore(name);
const put = (name, item) => new Promise((res,rej)=>{ const rq = store(name,'readwrite').put(item); rq.onsuccess = ()=> res(item); rq.onerror = e => rej(e); });
const add = (name, item) => new Promise((res,rej)=>{ const rq = store(name,'readwrite').add(item); rq.onsuccess = ()=> res(item); rq.onerror = e => rej(e); });
const all = (name) => new Promise((res,rej)=>{ const rq = store(name,'readonly').getAll(); rq.onsuccess = ()=> res(rq.result || []); rq.onerror = e => rej(e); });
const get = (name,key) => new Promise((res,rej)=>{ const rq = store(name,'readonly').get(key); rq.onsuccess = ()=> res(rq.result); rq.onerror = e => rej(e); });
const del = (name,key) => new Promise((res,rej)=>{ const rq = store(name,'readwrite').delete(key); rq.onsuccess = ()=> res(); rq.onerror = e => rej(e); });

// Auth
const AUTH_USER='LIZ', AUTH_PASS='MAGALY', AUTH_KEY='ts_user';
function isAuthenticated(){ return !!localStorage.getItem(AUTH_KEY); }
function setAuthenticated(u){ localStorage.setItem(AUTH_KEY,u); $('#current-user').textContent = u; $('#current-user').classList.remove('hidden'); $('#btn-logout').classList.remove('hidden'); }
function clearAuth(){ localStorage.removeItem(AUTH_KEY); $('#current-user').classList.add('hidden'); $('#btn-logout').classList.add('hidden'); }

$('#form-login').addEventListener('submit', e => {
  e.preventDefault();
  const u = $('#login-user').value.trim(), p = $('#login-pass').value;
  if(u === AUTH_USER && p === AUTH_PASS){ setAuthenticated(u); closeLogin(); initApp(); } else alert('Credenciales invÃ¡lidas');
});
$('#login-guest').addEventListener('click', ()=>{ setAuthenticated('GUEST'); closeLogin(); initApp(); });
$('#btn-logout').addEventListener('click', ()=>{ if(confirm('Cerrar sesiÃ³n?')){ clearAuth(); location.reload(); }});
function closeLogin(){ const m = $('#modal-login'); m.classList.remove('visible'); m.setAttribute('aria-hidden','true'); }

// modal manager
const backdrop = $('#backdrop'); let currentModal = null;
function showModal(id){ if(!isAuthenticated() && id !== 'modal-login') return showLogin(); if(currentModal && currentModal !== id) closeModal(currentModal); const m = $('#'+id); if(!m) return; m.classList.add('visible'); m.setAttribute('aria-hidden','false'); backdrop.classList.remove('hidden'); currentModal = id; setTimeout(()=>{ const el = m.querySelector('input, button, select, textarea'); if(el) el.focus(); },60); }
async function closeModal(id){ const m = $('#'+id); if(!m) return; if(m.classList.contains('scanner-modal')) await stopCamera(); m.classList.remove('visible'); m.setAttribute('aria-hidden','true'); currentModal = null; backdrop.classList.add('hidden'); }
function showLogin(){ const m = $('#modal-login'); m.classList.add('visible'); m.setAttribute('aria-hidden','false'); backdrop.classList.remove('hidden'); }

// state
const STATE = { products:[], sales:[], customers:[], responsibles:[] };

// Fuse indices
let fuseMain = null, fuseQuick = null;
function rebuildFuses(){
  const list = STATE.products.map(p=> ({ id:p.id, name:p.name, barcode:p.barcode||'', category:p.category||'' }));
  fuseMain = new Fuse(list, { keys:['name','barcode','category'], threshold:0.35, minMatchCharLength:2 });
  fuseQuick = new Fuse(list, { keys:['name','barcode'], threshold:0.30, minMatchCharLength:1 });
}

// refresh all
async function refreshAll(){
  STATE.products = await all('products');
  STATE.sales = await all('sales');
  STATE.customers = await all('customers');
  STATE.responsibles = await all('responsibles');
  rebuildFuses();
  renderInventory();
  renderIncomeSelects();
  renderQuickSelect();
  renderClients();
  updateCharts();
  updateResponsibleBanner();
}

/* ----------------------
   INVENTORY RENDER
   ---------------------- */
const inventoryList = $('#inventory-list');
function renderInventory(filter = ''){
  inventoryList.innerHTML = '';
  const q = (filter||'').trim();
  let list = STATE.products.slice();

  if(q.length){
    // 1) fast substring exact matches (startsWith or contains) prioritized
    const qLower = q.toLowerCase();
    const starts = list.filter(p=> p.name.toLowerCase().startsWith(qLower) || (p.barcode||'').includes(q));
    const contains = list.filter(p=> !starts.includes(p) && (p.name.toLowerCase().includes(qLower) || (p.category||'').toLowerCase().includes(qLower) || (p.barcode||'').includes(q)));
    list = starts.concat(contains);
    // 2) if still empty or short, use fuse as fallback
    if(list.length < 1 && fuseMain) {
      const r = fuseMain.search(q, { limit: 250 });
      list = r.map(x => STATE.products.find(p=>p.id === x.item.id)).filter(Boolean);
    }
  }

  for(const p of list){
    const low = (p.stock||0) <= 5;
    const card = document.createElement('div'); card.className = 'bg-white rounded-lg p-3 shadow flex justify-between items-center';
    card.innerHTML = `
      <div>
        <div class="font-medium">${escapeHtml(p.name)}${low ? ' <span style="color:#b91c1c;font-weight:600"> â€¢ STOCK BAJO</span>':''}</div>
        <div class="text-xs text-gray-500">${escapeHtml(p.category||'')} â€¢ ${escapeHtml(p.barcode||'')}</div>
        <div class="text-sm text-gray-700 mt-1">S/ ${money(p.price)} Â· Stock: ${p.stock||0}</div>
      </div>
      <div class="flex flex-col gap-2">
        <button class="px-3 py-2 bg-red-500 text-white rounded sell-btn" data-id="${p.id}">Vender</button>
        <button class="px-3 py-2 border rounded income-btn" data-id="${p.id}">+Stock</button>
        <button class="px-3 py-2 border rounded edit-btn" data-id="${p.id}">Editar</button>
      </div>
    `;
    inventoryList.appendChild(card);
  }

  $$('.sell-btn').forEach(b => b.onclick = ()=> quickSellPrompt(b.dataset.id));
  $$('.income-btn').forEach(b => b.onclick = ()=> openIncomeFor(b.dataset.id));
  $$('.edit-btn').forEach(b => b.onclick = ()=> openProductModal(STATE.products.find(x=>x.id===b.dataset.id)));
}

/* ----------------------
   PRODUCT modal
   ---------------------- */
$('#open-add-product').addEventListener('click', ()=> openProductModal());
function openProductModal(product){
  $('#form-product').reset(); $('#product-id').value = '';
  if(product){
    $('#product-id').value = product.id;
    $('#product-name').value = product.name;
    $('#product-category').value = product.category||'';
    $('#product-price').value = product.price||0;
    $('#product-barcode').value = product.barcode||'';
    $('#product-stock').value = product.stock||0;
  }
  showModal('modal-product');
}
$('#form-product').addEventListener('submit', async e=>{
  e.preventDefault();
  const id = $('#product-id').value || uid();
  const prod = {
    id,
    name: $('#product-name').value.trim(),
    category: $('#product-category').value.trim(),
    price: Number($('#product-price').value)||0,
    barcode: $('#product-barcode').value.trim(),
    stock: Number($('#product-stock').value)||0,
    createdAt: new Date().toISOString()
  };
  await put('products', prod);
  await refreshAll();
  if(cloudEnabled) pushProductsToCloud();
  closeModal('modal-product');
});

/* ----------------------
   INCOME
   ---------------------- */
function renderIncomeSelects(){ const sel = $('#income-product'); if(!sel) return; sel.innerHTML=''; STATE.products.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=`${p.name} â€” Stock: ${p.stock||0}`; sel.appendChild(o); }); }
function openIncomeFor(productId){ renderIncomeSelects(); $('#income-product').value = productId; showModal('modal-income'); }
$('#form-income').addEventListener('submit', async e => { e.preventDefault(); const pid = $('#income-product').value; const qty = Number($('#income-qty').value)||0; const p = STATE.products.find(x=>x.id===pid); p.stock = (p.stock||0) + qty; await put('products', p); await add('movements', { id: uid(), type:'income', productId:pid, qty, date: new Date().toISOString() }); await refreshAll(); if(cloudEnabled) pushProductsToCloud(); closeModal('modal-income'); });

/* ----------------------
   SALES (detailed + quick)
   ---------------------- */
// Sale form helpers (detailed sale)
function addSaleItemRow(productId=''){ const row=document.createElement('div'); row.className='grid grid-cols-12 gap-2 items-center'; row.innerHTML = `<select class="col-span-6 px-2 py-1 border sale-product"></select><input type="number" class="col-span-2 px-2 py-1 border sale-qty" value="1" min="1"><input type="number" step="0.01" class="col-span-2 px-2 py-1 border sale-price" placeholder="Precio"><button type="button" class="col-span-2 px-2 py-1 border sale-remove">Quitar</button>`; $('#sale-items').appendChild(row); fillSaleRow(row, productId); }
function fillSaleRow(row, productId){
  const sel = row.querySelector('.sale-product'); sel.innerHTML=''; STATE.products.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=`${p.name} (stock ${p.stock||0})`; sel.appendChild(o); });
  if(productId) sel.value = productId;
  const price = row.querySelector('.sale-price'); const qty = row.querySelector('.sale-qty');
  sel.onchange = ()=>{ const p = STATE.products.find(x=>x.id===sel.value); price.value = p ? p.price : ''; updateSaleTotal(); };
  price.oninput = updateSaleTotal; qty.oninput = updateSaleTotal;
  row.querySelector('.sale-remove').onclick = ()=>{ row.remove(); updateSaleTotal(); };
}
$('#add-sale-item').addEventListener('click', ()=> addSaleItemRow());
function updateSaleTotal(){ let t=0; document.querySelectorAll('#sale-items > div').forEach(r=>{ const q=Number(r.querySelector('.sale-qty').value)||0; const p=Number(r.querySelector('.sale-price').value)||0; t += q*p; }); $('#sale-total').textContent = money(t); }
$('#form-sale').addEventListener('submit', async e=>{
  e.preventDefault();
  const customer = $('#sale-customer').value.trim(); const payment = $('#sale-payment').value;
  const items = [];
  document.querySelectorAll('#sale-items > div').forEach(r=>{ const pid = r.querySelector('.sale-product').value; const qty = Number(r.querySelector('.sale-qty').value)||0; const price = Number(r.querySelector('.sale-price').value)||0; if(qty>0) items.push({ productId: pid, qty, price }); });
  if(items.length===0) return alert('Agregar al menos un producto');
  for(const it of items){ const p = STATE.products.find(x=>x.id===it.productId); p.stock = (p.stock||0) - it.qty; await put('products', p); await add('movements', { id: uid(), type:'sale', productId: it.productId, qty: it.qty, date: new Date().toISOString() }); }
  const total = items.reduce((s,i)=>s + i.qty*i.price,0); const date = new Date().toISOString();
  const respDate = ($('#responsible-date').value) ? $('#responsible-date').value : todayYMD();
  const respObj = await get('responsibles', respDate).catch(()=>null);
  const responsibleName = (respObj && respObj.name) ? respObj.name : ($('#responsible-name').value.trim()||'');
  const sale = { id: uid(), items, total, date, customerName: customer||null, paid: (payment!=='A_CREDITO'), paymentType: payment, responsible: responsibleName };
  await add('sales', sale);
  if(payment === 'A_CREDITO' && customer){ const existing = await get('customers', customer).catch(()=>null); const prev = existing && existing.balance ? existing.balance : 0; await put('customers', { name: customer, balance: prev + total, lastSale: date }); }
  await refreshAll(); if(cloudEnabled) pushSalesToCloud(); closeModal('modal-sale');
});

/* ----------------------
   QUICK SALE improved search & UX
   ---------------------- */
$('#open-quick-sale').addEventListener('click', ()=> { renderQuickSelect(); showModal('modal-quick-sale'); });
function renderQuickSelect(){ const sel = $('#quick-product'); sel.innerHTML=''; STATE.products.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=`${p.name} (stock ${p.stock||0})`; sel.appendChild(o); }); updateQuickTotal(); rebuildQuickFuse(); }
$('#quick-product').addEventListener('change', updateQuickTotal);
$('#quick-qty').addEventListener('input', updateQuickTotal);
function updateQuickTotal(){ const pid = $('#quick-product').value; const qty = Number($('#quick-qty').value)||0; const p = STATE.products.find(x=>x.id===pid); $('#quick-total').textContent = money(p ? p.price * qty : 0); }

let quickFuse = null;
function rebuildQuickFuse(){ const list = STATE.products.map(p => ({ id: p.id, name: p.name, barcode: p.barcode || '' })); quickFuse = new Fuse(list, { keys:['name','barcode'], threshold:0.3, minMatchCharLength:1 }); }

$('#quick-search').addEventListener('input', debounce(function(){
  const q = this.value.trim();
  showQuickSuggestions(q);
  // if an exact barcode typed, auto-select
  if(/^\d{6,}$/.test(q)){
    const p = STATE.products.find(p => (p.barcode||'').replace(/\D/g,'').endsWith(q) || (p.barcode||'') === q);
    if(p) $('#quick-product').value = p.id;
  }
  updateQuickTotal();
},120));

function showQuickSuggestions(q){
  const box = $('#quick-suggestions'); box.innerHTML=''; box.classList.add('hidden');
  if(!q) return;
  // 1) startsWith and contains prioritized
  const qLower = q.toLowerCase();
  const starts = STATE.products.filter(p => p.name.toLowerCase().startsWith(qLower) || (p.barcode||'').includes(q)).slice(0,8);
  let items = starts;
  if(items.length < 1 && quickFuse){
    const res = quickFuse.search(q, { limit: 10 });
    items = res.map(r => STATE.products.find(p=>p.id===r.item.id)).filter(Boolean);
  }
  if(items.length===0) return;
  items.forEach(p=>{
    const div = document.createElement('div'); div.className='suggestion-item'; div.innerHTML = `<div class="font-medium">${p.name}</div><div class="text-xs text-gray-500">${p.barcode||''} â€¢ ${p.category||''}</div>`;
    div.onclick = ()=>{ $('#quick-product').value = p.id; $('#quick-search').value = ''; box.classList.add('hidden'); updateQuickTotal(); };
    box.appendChild(div);
  });
  box.classList.remove('hidden');
}

// quick cart
const quickCart = [];
$('#quick-add-cart').addEventListener('click', function(){
  const pid = $('#quick-product').value; const qty = Number($('#quick-qty').value)||1; const p = STATE.products.find(x=>x.id===pid); if(!p) return alert('Selecciona un producto'); quickCart.push({ productId: pid, qty, price: p.price }); renderQuickCart();
});
function renderQuickCart(){ const el = $('#quick-cart'); el.innerHTML=''; quickCart.forEach((it,idx)=>{ const p = STATE.products.find(x=>x.id===it.productId); const d=document.createElement('div'); d.className='flex justify-between items-center'; d.innerHTML = `<div>${p.name} x ${it.qty}</div><div>${money(it.qty*it.price)} <button data-idx="${idx}" class="ml-2 text-sm text-red-600 btn-remove-quick">Quitar</button></div>`; el.appendChild(d); }); $$('.btn-remove-quick').forEach(b=> b.onclick = ()=> { quickCart.splice(Number(b.dataset.idx),1); renderQuickCart(); }); }
$('#form-quick-sale').addEventListener('submit', async function(e){
  e.preventDefault();
  if(quickCart.length===0) return alert('Agregar productos');
  const customer = $('#quick-customer').value.trim();
  const payment = $('#quick-payment').value;
  for(const it of quickCart){ const p = STATE.products.find(x=>x.id===it.productId); p.stock = (p.stock||0) - it.qty; await put('products', p); await add('movements', { id: uid(), type:'sale', productId: it.productId, qty: it.qty, date: new Date().toISOString() }); }
  const total = quickCart.reduce((s,i)=>s + i.qty*i.price,0); const date = new Date().toISOString();
  const respDate = ($('#responsible-date').value) ? $('#responsible-date').value : todayYMD();
  const respObj = await get('responsibles', respDate).catch(()=>null);
  const responsibleName = (respObj && respObj.name) ? respObj.name : ($('#responsible-name').value.trim()||'');
  const sale = { id: uid(), items: quickCart.slice(), total, date, customerName: customer||null, paid: (payment!=='A_CREDITO'), paymentType: payment, responsible: responsibleName };
  await add('sales', sale);
  if(payment === 'A_CREDITO' && customer){ const existing = await get('customers', customer).catch(()=>null); const prev = existing && existing.balance ? existing.balance : 0; await put('customers', { name: customer, balance: prev + total, lastSale: date }); }
  quickCart.length = 0; await refreshAll(); if(cloudEnabled) pushSalesToCloud(); closeModal('modal-quick-sale');
});

/* ----------------------
   CLIENTS
   ---------------------- */
$('#open-clients').addEventListener('click', ()=> showModal('modal-clients'));
$('#add-client').addEventListener('click', async ()=> {
  const name = $('#client-name').value.trim(); if(!name) return alert('Ingresa nombre'); const existing = await get('customers', name).catch(()=>null);
  if(existing) return alert('Cliente ya existe'); await put('customers', { name, balance:0, createdAt: new Date().toISOString() }); $('#client-name').value=''; await refreshAll(); if(cloudEnabled) pushCustomersToCloud();
});
async function renderClients(){
  const el = $('#clients-list'); el.innerHTML=''; const clients = STATE.customers || [];
  if(!clients.length) el.innerHTML = '<div class="text-sm text-gray-600">No hay clientes registrados.</div>';
  for(const c of clients){ const d=document.createElement('div'); d.className='p-2 border rounded bg-white flex justify-between items-center'; d.innerHTML = `<div><div class="font-medium">${c.name}</div><div class="text-xs text-gray-500">Saldo: S/ ${money(c.balance||0)}</div></div><div class="flex gap-2"><button data-name="${c.name}" class="px-3 py-2 border rounded btn-abono">Abono</button><button data-name="${c.name}" class="px-3 py-2 bg-green-600 text-white rounded btn-saldar">Saldar</button></div>`; el.appendChild(d); }
  $$('.btn-abono').forEach(b=> b.onclick = async ()=>{ const name=b.dataset.name; const amt = Number(prompt(`Abono para ${name} - monto:`, '0'))||0; if(amt<=0) return; const c = await get('customers', name); const newBal = (c.balance||0) - amt; await put('customers', { name, balance: newBal < 0 ? 0 : newBal, lastPayment: new Date().toISOString() }); alert('Abono registrado'); await refreshAll(); if(cloudEnabled) pushCustomersToCloud(); });
  $$('.btn-saldar').forEach(b=> b.onclick = async ()=>{ const name=b.dataset.name; if(!confirm(`Â¿Saldar cuenta de ${name}? Esto pondrÃ¡ su saldo a 0.`)) return; await put('customers',{ name, balance:0, lastPayment:new Date().toISOString() }); alert('Cuenta saldada'); await refreshAll(); if(cloudEnabled) pushCustomersToCloud(); });
}

/* ----------------------
   RESPONSIBLE one-per-day
   ---------------------- */
$('#save-responsible').addEventListener('click', async ()=>{
  const date = $('#responsible-date').value; const name = $('#responsible-name').value.trim();
  if(!date) return alert('Selecciona fecha'); const existing = await get('responsibles', date).catch(()=>null);
  if(existing && existing.name && existing.name !== name){ if(!confirm(`Ya existe un responsable para ${date}: "${existing.name}". Â¿Sobrescribir?`)) return; }
  await put('responsibles', { date, name }); alert('Responsable guardado'); await refreshAll(); if(cloudEnabled) pushResponsiblesToCloud();
});
async function updateResponsibleBanner(){ const today = todayYMD(); $('#responsible-date').value = today; const r = await get('responsibles', today).catch(()=>null); if(r && r.name){ $('#responsible-display').textContent = `${r.name} (${today})`; $('#responsible-name').value = r.name; } else { $('#responsible-display').textContent = 'Sin encargado asignado para hoy'; $('#responsible-name').value = ''; } }

/* ----------------------
   CHARTS
   ---------------------- */
let chartSales, chartStock;
function updateCharts(){
  try{
    const salesData = STATE.sales.slice(-8).map(s=>({ x:new Date(s.date).toLocaleString(), y:s.total }));
    const ctxS = $('#chart-sales').getContext('2d'); if(chartSales) chartSales.destroy();
    chartSales = new Chart(ctxS, { type:'bar', data:{ labels:salesData.map(s=>s.x), datasets:[{ label:'Ventas', data:salesData.map(s=>s.y) }]}, options:{ responsive:true }});
    const stockData = STATE.products.slice().sort((a,b)=>b.stock-a.stock).slice(0,6);
    const ctxSt = $('#chart-stock').getContext('2d'); if(chartStock) chartStock.destroy();
    chartStock = new Chart(ctxSt, { type:'pie', data:{ labels:stockData.map(p=>p.name), datasets:[{ label:'Stock', data:stockData.map(p=>p.stock) }]}, options:{ responsive:true }});
  }catch(e){ console.warn('updateCharts', e); }
}

/* ----------------------
   REPORTS & PDF (A4) - reutilizables
   ---------------------- */
async function buildDailyReportHTML(date){
  const allSales = await all('sales');
  const daySales = allSales.filter(s => new Date(s.date).toISOString().slice(0,10) === date).sort((a,b)=>a.date.localeCompare(b.date));
  const creditSales = daySales.filter(s => s.paymentType === 'A_CREDITO' || !s.paid);
  let rows=''; let total=0;
  for(const s of daySales){
    total += Number(s.total||0);
    const t = new Date(s.date).toLocaleTimeString();
    const payment = s.paymentType || (s.paid ? 'EFECTIVO' : 'A_CREDITO');
    const items = s.items.map(it => { const p = STATE.products.find(pp=>pp.id===it.productId); return `${p ? p.name : it.productId} (${it.qty} x S/ ${money(it.price)})`; }).join('<br>');
    rows += `<tr><td style="padding:6px;border-bottom:1px solid #eee">${t}</td><td style="padding:6px;border-bottom:1px solid #eee">${s.id}</td><td style="padding:6px;border-bottom:1px solid #eee">${s.customerName||'-'}</td><td style="padding:6px;border-bottom:1px solid #eee">${s.responsible||'-'}</td><td style="padding:6px;border-bottom:1px solid #eee">${payment}</td><td style="padding:6px;border-bottom:1px solid #eee">${items}</td><td style="padding:6px;border-bottom:1px solid #eee;text-align:right">S/ ${money(s.total)}</td></tr>`;
  }
  const r = await get('responsibles', date).catch(()=>null); const responsibleName = r && r.name ? r.name : '';
  const creditRows = creditSales.map(s=>{ const t=new Date(s.date).toLocaleTimeString(); const items = s.items.map(it=>{ const p=STATE.products.find(pp=>pp.id===it.productId); return `${p? p.name : it.productId} (${it.qty} x S/ ${money(it.price)})`; }).join('<br>'); return `<tr><td style="padding:6px;border-bottom:1px solid #eee">${t}</td><td style="padding:6px;border-bottom:1px solid #eee">${s.id}</td><td style="padding:6px;border-bottom:1px solid #eee">${s.customerName||'-'}</td><td style="padding:6px;border-bottom:1px solid #eee">${s.responsible||'-'}</td><td style="padding:6px;border-bottom:1px solid #eee">${s.paymentType||'A_CREDITO'}</td><td style="padding:6px;border-bottom:1px solid #eee">${items}</td><td style="padding:6px;border-bottom:1px solid #eee;text-align:right">S/ ${money(s.total)}</td></tr>`; }).join('');
  const html = `<div style="padding:8mm;font-family:Arial,Helvetica,sans-serif;color:#111"><div style="display:flex;justify-content:space-between"><div><h1 style="margin:0;font-size:18px">MINIMARKET LA ESQUINA DEL AHORRO</h1><div style="font-size:12px">Reporte del dia: <strong>${date}</strong></div></div><div style="font-size:12px;text-align:right">Generado: ${new Date().toLocaleString()}<br>Encargado: ${responsibleName || '-'}</div></div><hr style="margin:8px 0"><h3 style="margin-bottom:6px">Ventas del dÃ­a</h3><table style="width:100%;border-collapse:collapse;font-size:12px;margin-bottom:8px"><thead><tr><th style="background:#f3f4f6;padding:6px;text-align:left">Hora</th><th style="background:#f3f4f6;padding:6px;text-align:left">ID</th><th style="background:#f3f4f6;padding:6px;text-align:left">Cliente</th><th style="background:#f3f4f6;padding:6px;text-align:left">Encargado</th><th style="background:#f3f4f6;padding:6px;text-align:left">Pago</th><th style="background:#f3f4f6;padding:6px;text-align:left">Items</th><th style="background:#f3f4f6;padding:6px;text-align:right">Total</th></tr></thead><tbody>${rows || '<tr><td colspan="7" style="padding:12px;text-align:center;color:#666">No hay ventas para esta fecha</td></tr>'}</tbody></table><div style="text-align:right;font-weight:bold;margin-bottom:12px">Total (dÃ­a): S/ ${money(total)}</div><hr style="margin:8px 0"><h3 style="margin-bottom:6px">Ventas por cobrar (A CREDITO)</h3><table style="width:100%;border-collapse:collapse;font-size:12px;margin-bottom:8px"><thead><tr><th style="background:#f3f4f6;padding:6px;text-align:left">Hora</th><th style="background:#f3f4f6;padding:6px;text-align:left">ID</th><th style="background:#f3f4f6;padding:6px;text-align:left">Cliente</th><th style="background:#f3f4f6;padding:6px;text-align:left">Encargado</th><th style="background:#f3f4f6;padding:6px;text-align:left">Pago</th><th style="background:#f3f4f6;padding:6px;text-align:left">Items</th><th style="background:#f3f4f6;padding:6px;text-align:right">Total</th></tr></thead><tbody>${creditRows.length ? creditRows : '<tr><td colspan="7" style="padding:12px;text-align:center;color:#666">No hay ventas por cobrar</td></tr>'}</tbody></table><div style="font-size:11px;color:#666;margin-top:10px">Reporte generado por TiendaSmart â€” MINIMARK

