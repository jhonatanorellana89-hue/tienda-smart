<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>MINIMARKET LA ESQUINA DEL AHORRO — TiendaSmart (Móvil)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Firebase compat (rellena config más abajo) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    :root{ --bg:#f3f4f6; --card:#fff; --muted:#6b7280; --accent:#06b6d4; }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);-webkit-user-select:none;user-select:none}
    .app{min-height:100vh;display:flex;flex-direction:column;overflow:hidden}
    header.mobile-top{height:64px;display:flex;align-items:center;padding:6px 10px;gap:8px;background:linear-gradient(90deg,#06b6d4,#3b82f6);color:white}
    header .brand{display:flex;gap:8px;align-items:center}
    main.content{flex:1;overflow:auto;padding:8px;box-sizing:border-box}
    .card{background:var(--card);border-radius:10px;padding:10px;box-shadow:0 6px 20px rgba(2,6,23,0.04);margin-bottom:8px;border:1px solid #e6e6e6}
    .card-bordered{border:2px solid rgba(15,23,42,0.04)}
    .search-row{display:flex;gap:8px}
    .search-row input[type="search"]{flex:1;padding:10px;border-radius:12px;border:1px solid #d1d5db;background:white}
    .big-btn{padding:10px;border-radius:10px;min-height:44px;font-weight:700;display:flex;align-items:center;justify-content:center}
    .action-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    .inventory-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(180deg,#fff,#fafafa);border:1px solid #d1d5db;margin-bottom:8px}
    .inventory-item .meta{font-size:15px;font-weight:700}
    .inventory-item .sub{font-size:12px;color:var(--muted)}
    .fixed-bottom{position:fixed;left:0;right:0;bottom:0;padding:8px;background:linear-gradient(180deg,rgba(255,255,255,0.98),rgba(255,255,255,0.98));box-shadow:0 -8px 30px rgba(2,6,23,0.06);display:flex;gap:8px;align-items:center;justify-content:space-between}
    .fixed-bottom .btn{flex:1;margin:0 6px;padding:10px;border-radius:10px;text-align:center;border:1px solid #d1d5db;background:white}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:12px;z-index:80;background:rgba(0,0,0,0.45)}
    .modal.visible{display:flex}
    .modal .modal-card{width:100%;max-width:420px;border-radius:12px;overflow:hidden;display:flex;flex-direction:column}
    video#video{width:100%;height:100%;object-fit:cover;border-radius:6px}
    canvas#overlay-canvas{position:absolute;left:0;top:0;pointer-events:none}
    .suggestions{position:absolute;background:white;border:1px solid #e5e7eb;border-radius:8px;max-height:240px;overflow:auto;z-index:90;width:calc(100% - 24px)}
    .small-muted{font-size:12px;color:var(--muted)}
    .bordered-element{border:1px solid #cbd5e1;border-radius:8px;padding:6px}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:80px;background:#111;color:white;padding:8px 14px;border-radius:8px;z-index:120;display:none}
    .toast.show{display:block}
    /* sticky footer for modals so Save is always visible */
    .modal-footer{margin-top:auto;padding:10px;border-top:1px solid #eee;background:linear-gradient(180deg,rgba(255,255,255,0.98),rgba(255,255,255,0.98));display:flex;gap:8px}
    @media(min-width:420px){ .app{max-width:420px;margin:0 auto} }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="TiendaSmart móvil">
    <header class="mobile-top">
      <div class="brand">
        <div style="width:44px;height:44px;border-radius:8px;background:linear-gradient(180deg,#10b981,#3b82f6);display:flex;align-items:center;justify-content:center;color:white">TS</div>
        <div style="line-height:1">
          <div style="font-size:14px;font-weight:700">MINIMARKET LA ESQUINA DEL AHORRO</div>
          <div class="small-muted">TiendaSmart — Móvil</div>
        </div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <div id="cloud-label" class="small-muted" style="color:white">desconectado</div>
        <button id="btn-open-reports" class="big-btn bg-white text-slate-700">Reportes</button>
        <button id="btn-sync-toggle" class="big-btn bg-black text-white" title="Sincronización Cloud">Cloud OFF</button>
      </div>
    </header>

    <main class="content" id="app-content">
      <div class="card card-bordered">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div>
            <div class="small-muted">Encargado del día</div>
            <div id="responsible-display" style="font-weight:700">—</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="responsible-date" type="date" class="px-3 py-2 rounded border bg-white small-muted"/>
            <input id="responsible-name" placeholder="Nombre encargado" class="px-3 py-2 rounded border w-36" />
            <!-- Guardar ahora visible dentro de la tarjeta -->
            <button id="save-responsible" class="bg-indigo-600 text-white px-3 py-2 rounded">Guardar</button>
          </div>
        </div>
      </div>

      <div class="card card-bordered">
        <div class="search-row">
          <input id="search" type="search" placeholder="Buscar producto o código..." />
        </div>
        <div class="action-grid mt-3">
          <button id="btn-add-product" class="big-btn bg-green-500 text-white">+ Producto</button>
          <button id="btn-open-scan" class="big-btn bg-yellow-400 text-white">Escanear</button>
          <button id="btn-open-quick" class="big-btn bg-red-600 text-white">Venta Rápida</button>
          <button id="btn-open-clients" class="big-btn bg-indigo-700 text-white">Clientes</button>
        </div>
      </div>

      <div id="inventory-list" class="mb-24"></div>

      <div class="card small-muted">
        La app sincroniza con Firestore en la colección <code>stores/{storeId}/</code>. (Rellena configuración Firebase en el código). Las ventas e inventario se mantienen localmente y se sincronizan cuando Cloud está activado.
      </div>
    </main>

    <div class="fixed-bottom">
      <button id="btn-import-xlsx" class="btn">Importar</button>
      <button id="btn-export-xlsx" class="btn">Exportar</button>
      <button id="btn-open-tools" class="btn">Herramientas</button>
    </div>
    <input id="file-xlsx" type="file" accept=".xlsx,.xls" class="hidden" />

    <!-- PRODUCT modal -->
    <div id="modal-product" class="modal" aria-hidden="true">
      <div class="modal-card card p-0">
        <div style="padding:12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee">
          <div style="font-weight:700">Producto</div>
          <button data-close class="text-xl">✕</button>
        </div>
        <form id="form-product" style="padding:12px;display:flex;flex-direction:column;gap:8px">
          <input type="hidden" id="product-id" />
          <input id="product-name" placeholder="Nombre" required class="w-full px-3 py-2 border rounded" />
          <div style="display:flex;gap:8px;">
            <input id="product-category" placeholder="Categoría" class="flex-1 px-3 py-2 border rounded" />
            <input id="product-price" placeholder="Precio" type="number" step="0.01" class="w-24 px-3 py-2 border rounded" />
          </div>
          <div style="display:flex;gap:8px;">
            <input id="product-barcode" placeholder="Código de barras" class="flex-1 px-3 py-2 border rounded" />
            <input id="product-stock" placeholder="Stock" type="number" class="w-24 px-3 py-2 border rounded" />
          </div>
        </form>
        <div class="modal-footer">
          <button data-close type="button" class="px-3 py-2 border rounded">Cancelar</button>
          <button id="btn-save-product" type="button" class="px-3 py-2 bg-green-600 text-white rounded">Guardar</button>
        </div>
      </div>
    </div>

    <!-- SCAN modal -->
    <div id="modal-scan" class="modal" aria-hidden="true">
      <div class="modal-card card p-0">
        <div style="background:#000;color:white;padding:12px;display:flex;justify-content:space-between;align-items:center">
          <div>Escáner</div>
          <button data-close class="text-xl" style="color:white">✕</button>
        </div>
        <div style="padding:10px;display:flex;flex-direction:column;gap:8px">
          <div class="bordered-element" id="scanner-container" style="height:260px;position:relative">
            <video id="video"></video>
            <canvas id="overlay-canvas"></canvas>
            <div id="scanner-status" class="small-muted mt-2">Presiona iniciar para activar la cámara (HTTPS requerido)</div>
          </div>
          <div style="display:flex;gap:8px">
            <button id="btn-start-scan" class="px-3 py-2 bg-indigo-600 text-white rounded flex-1">Iniciar</button>
            <button id="btn-stop-scan" class="px-3 py-2 border rounded flex-1">Detener</button>
            <button id="btn-scan-search" class="px-3 py-2 border rounded flex-1">Buscar</button>
          </div>
          <div id="scan-result" style="display:none" class="bordered-element"></div>
        </div>
        <div class="modal-footer">
          <button data-close type="button" class="px-3 py-2 border rounded">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- QUICK SALE modal -->
    <div id="modal-quick" class="modal" aria-hidden="true">
      <div class="modal-card card p-0">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #eee">
          <div style="font-weight:700">Venta Rápida</div>
          <button data-close class="text-xl">✕</button>
        </div>
        <div style="padding:12px;display:flex;flex-direction:column;gap:8px">
          <div class="mb-2 small-muted">Puedes escanear o buscar producto y vincularlo a la venta</div>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="quick-barcode" placeholder="Código o buscar..." class="flex-1 px-3 py-2 border rounded" />
            <button id="quick-scan-btn" class="px-3 py-2 bg-yellow-400 rounded">Escanear</button>
            <button id="quick-search-btn" class="px-3 py-2 border rounded">Buscar</button>
          </div>
          <div id="quick-product-summary" style="margin-top:8px;display:none" class="bordered-element"></div>
        </div>
        <div class="modal-footer">
          <button data-close type="button" class="px-3 py-2 border rounded">Cancelar</button>
          <button id="btn-save-sale" class="px-3 py-2 bg-red-600 text-white rounded">Registrar Venta</button>
        </div>
      </div>
    </div>

    <!-- REPORT modal -->
    <div id="modal-reports" class="modal" aria-hidden="true">
      <div class="modal-card card p-3" style="max-width:520px">
        <div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:700">Reportes</div><button data-close class="text-xl">✕</button></div>
        <div id="reports-content" style="margin-top:10px;max-height:60vh;overflow:auto"></div>
      </div>
    </div>

    <div id="toast" class="toast"></div>
  </div>

  <script>
    // Config: rellena con tu Firebase config y storeId. Ejemplo:
    const FIREBASE_CONFIG = {
      apiKey: "REPLACE_ME",
      authDomain: "REPLACE_ME",
      projectId: "REPLACE_ME",
      // ...rest
    }
    const STORE_ID = 'MAGALY'; // colección: stores/MAGALY/inventory

    // Keys
    const DB = { inventoryKey: 'ts_inventory_v3', salesKey: 'ts_sales_v3', responsibleKey: 'ts_responsible_v1' }

    // Firestore
    let firebaseApp = null; let db = null; let cloudEnabled = false; let listening = false;

    function initFirebase(){
      if(firebaseApp) return; try{ firebaseApp = firebase.initializeApp(FIREBASE_CONFIG); db = firebase.firestore(); console.log('Firebase initialized'); }
      catch(e){ console.error('Firebase init error', e); }
    }

    function enableCloud(enable){
      cloudEnabled = !!enable; document.getElementById('btn-sync-toggle').textContent = cloudEnabled ? 'Cloud ON' : 'Cloud OFF';
      document.getElementById('cloud-label').textContent = cloudEnabled ? 'conectado' : 'desconectado';
      if(cloudEnabled){ initFirebase(); startCloudListeners(); pushAllLocalToCloud(); }
      else stopCloudListeners();
    }

    // Start real-time listeners (inventory and sales) -- merge remote changes into localStorage
    function startCloudListeners(){
      if(!db || listening) return; listening = true;
      const invRef = db.collection('stores').doc(STORE_ID).collection('inventory');
      const salesRef = db.collection('stores').doc(STORE_ID).collection('sales');

      invRef.onSnapshot(snapshot=>{
        const inv = loadInventory();
        snapshot.docChanges().forEach(change=>{
          const doc = change.doc.data(); doc.id = change.doc.id;
          if(change.type === 'removed'){
            // remove from local
            const idx = inv.findIndex(i=>i.id===doc.id); if(idx>=0) inv.splice(idx,1);
          } else {
            const idx = inv.findIndex(i=>i.id===doc.id);
            if(idx>=0) inv[idx] = doc; else inv.push(doc);
          }
        });
        saveInventory(inv); renderInventory();
      }, err=>console.error('inv listener',err));

      salesRef.onSnapshot(snapshot=>{
        const sales = loadSales();
        snapshot.docChanges().forEach(change=>{
          const doc = change.doc.data(); doc.id = change.doc.id;
          if(change.type === 'removed'){ const idx=sales.findIndex(s=>s.id===doc.id); if(idx>=0) sales.splice(idx,1); }
          else { const idx=sales.findIndex(s=>s.id===doc.id); if(idx>=0) sales[idx]=doc; else sales.push(doc); }
        });
        saveSales(sales); renderReports();
      }, err=>console.error('sales listener',err));
    }

    function stopCloudListeners(){ listening=false; /* can't easily detach without saved refs in compat; reload is cheap */ }

    // Push local data to cloud (simple: overwrite docs by id)
    async function pushAllLocalToCloud(){ if(!db) return; const inv=loadInventory(); const sales=loadSales();
      const invRef = db.collection('stores').doc(STORE_ID).collection('inventory');
      const salesRef = db.collection('stores').doc(STORE_ID).collection('sales');
      try{
        for(const it of inv){ const id = it.id || generateId(); await invRef.doc(String(id)).set(it); }
        for(const s of sales){ const id = s.id || generateId(); await salesRef.doc(String(id)).set(s); }
        console.log('Pushed local to cloud')
      } catch(e){ console.error('pushAllLocalToCloud',e) }
    }

    // Utilities
    function loadInventory(){ try{return JSON.parse(localStorage.getItem(DB.inventoryKey) || '[]')}catch(e){return []} }
    function saveInventory(arr){ localStorage.setItem(DB.inventoryKey, JSON.stringify(arr)); if(cloudEnabled) pushInventoryToCloud(arr); }
    function loadSales(){ try{return JSON.parse(localStorage.getItem(DB.salesKey) || '[]')}catch(e){return []} }
    function saveSales(arr){ localStorage.setItem(DB.salesKey, JSON.stringify(arr)); if(cloudEnabled) pushSalesToCloud(arr); }
    function saveResponsible(obj){ localStorage.setItem(DB.responsibleKey, JSON.stringify(obj)) }
    function loadResponsible(){ try{return JSON.parse(localStorage.getItem(DB.responsibleKey) || 'null')}catch(e){return null} }

    function generateId(){ return 'id_'+Date.now()+Math.floor(Math.random()*9999) }

    async function pushInventoryToCloud(arr){ if(!db) return; const invRef = db.collection('stores').doc(STORE_ID).collection('inventory');
      try{ for(const it of arr){ const id = it.id || generateId(); await invRef.doc(String(id)).set(it); } } catch(e){console.error('pushInventoryToCloud',e)} }
    async function pushSalesToCloud(arr){ if(!db) return; const salesRef = db.collection('stores').doc(STORE_ID).collection('sales');
      try{ for(const s of arr){ const id = s.id || generateId(); await salesRef.doc(String(id)).set(s); } } catch(e){console.error('pushSalesToCloud',e)} }

    // UI helpers
    function showToast(msg, time=1600){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), time) }

    document.addEventListener('DOMContentLoaded', ()=>{ bindUI(); renderInventory(); renderReports(); loadResponsibleToUI(); })

    function bindUI(){
      document.getElementById('btn-add-product').addEventListener('click', ()=>openProductModal())
      document.getElementById('btn-open-scan').addEventListener('click', ()=>openModal('modal-scan'))
      document.getElementById('btn-open-quick').addEventListener('click', ()=>openModal('modal-quick'))
      document.getElementById('btn-open-reports').addEventListener('click', ()=>openModal('modal-reports'))

      document.querySelectorAll('[data-close]').forEach(b=>b.addEventListener('click', ()=>closeAllModals()))

      document.getElementById('btn-save-product').addEventListener('click', ()=>{ saveProductFromForm(); closeAllModals(); })

      document.getElementById('quick-search-btn').addEventListener('click', quickSearch)
      document.getElementById('quick-scan-btn').addEventListener('click', ()=>{ openModal('modal-scan'); startScannerForQuick(); })
      document.getElementById('btn-save-sale').addEventListener('click', saveQuickSale)

      document.getElementById('btn-start-scan').addEventListener('click', startScanner)
      document.getElementById('btn-stop-scan').addEventListener('click', stopScanner)
      document.getElementById('btn-scan-search').addEventListener('click', ()=>{ const el = document.getElementById('scan-result'); if(el.dataset.code) manualScanSearch(el.dataset.code) })

      document.getElementById('search').addEventListener('input', e=>{ const q=e.target.value.trim(); renderInventory(q) })

      document.getElementById('btn-import-xlsx').addEventListener('click', ()=>document.getElementById('file-xlsx').click())
      document.getElementById('file-xlsx').addEventListener('change', handleXlsxImport)
      document.getElementById('btn-export-xlsx').addEventListener('click', exportXlsx)
      document.getElementById('btn-sync-toggle').addEventListener('click', ()=>{ if(!cloudEnabled){ initFirebase(); enableCloud(true); } else enableCloud(false) })

      document.getElementById('save-responsible').addEventListener('click', ()=>{ const d=document.getElementById('responsible-date').value; const n=document.getElementById('responsible-name').value.trim(); const obj={date:d,name:n}; saveResponsible(obj); document.getElementById('responsible-display').textContent = `${n} · ${d}`; showToast('Responsable guardado') })
    }

    // INVENTORY RENDER
    function renderInventory(filter=''){
      const list=document.getElementById('inventory-list'); list.innerHTML='';
      const inv = loadInventory(); const q = (filter||'').toLowerCase();
      const items = inv.filter(it=>!q || (it.name && it.name.toLowerCase().includes(q)) || (it.barcode && it.barcode.includes(q)) );
      if(items.length===0){ list.innerHTML = '<div class="card">No se encontraron productos. Puedes <button id="empty-add" class="text-indigo-600">registrar uno</button>.</div>'
        setTimeout(()=>{ const b=document.getElementById('empty-add'); if(b) b.addEventListener('click', ()=>openProductModal()) }, 30); return }
      // render fast using fragment
      const frag = document.createDocumentFragment();
      for(const it of items){
        const node = document.createElement('div'); node.className='inventory-item';
        node.innerHTML = `<div>
            <div class="meta">${escapeHtml(it.name||'—')}</div>
            <div class="sub">${escapeHtml(it.category||'')} · stock: ${it.stock ?? 0} · ${it.barcode||'sin código'}</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="px-2 py-1 border rounded edit-btn">Editar</button>
            <button class="px-2 py-1 bg-yellow-400 rounded sell-btn">Vender</button>
          </div>`;
        node.querySelector('.edit-btn').addEventListener('click', ()=>openProductModal(it))
        node.querySelector('.sell-btn').addEventListener('click', ()=>openQuickWithProduct(it))
        frag.appendChild(node)
      }
      list.appendChild(frag)
    }

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&"'<>]/g, c=>({"&":"&amp;","\"":"&quot;","'":"&#39;","<":"&lt;",">":"&gt;"})[c]) }

    // PRODUCT modal logic
    function openProductModal(product=null){ openModal('modal-product'); if(product){ document.getElementById('product-id').value = product.id || product.barcode || Date.now(); document.getElementById('product-name').value = product.name||''; document.getElementById('product-category').value = product.category||''; document.getElementById('product-price').value = product.price||''; document.getElementById('product-barcode').value = product.barcode||''; document.getElementById('product-stock').value = product.stock||0; } else { document.getElementById('product-id').value=''; document.getElementById('product-name').value=''; document.getElementById('product-category').value=''; document.getElementById('product-price').value=''; document.getElementById('product-barcode').value=''; document.getElementById('product-stock').value=0; } }

    function saveProductFromForm(){
      const inv = loadInventory();
      const idField = document.getElementById('product-id').value || String(Date.now());
      const item = { id: idField, name: document.getElementById('product-name').value.trim(), category: document.getElementById('product-category').value.trim(), price: parseFloat(document.getElementById('product-price').value) || 0, barcode: document.getElementById('product-barcode').value.trim(), stock: parseInt(document.getElementById('product-stock').value) || 0 }
      const idx = inv.findIndex(i=>i.id===item.id || (i.barcode && i.barcode === item.barcode));
      if(idx>=0) inv[idx] = item; else inv.push(item);
      saveInventory(inv); renderInventory(); showToast('Producto guardado')
    }

    // Quick sale
    function openQuickWithProduct(product){ openModal('modal-quick'); document.getElementById('quick-barcode').value = product.barcode || product.id || ''; fillQuickProductSummary(product); }
    function fillQuickProductSummary(product){ const s = document.getElementById('quick-product-summary'); if(!product){ s.style.display='none'; return } s.style.display='block'; s.innerHTML = `<div style="font-weight:700">${escapeHtml(product.name||'—')}</div><div class="small-muted">Precio: ${product.price||0} · Stock: ${product.stock||0} · Código: ${product.barcode||'—'}</div>`; document.getElementById('quick-barcode').dataset.linked = product.id || product.barcode || '' }

    function quickSearch(){ const q=document.getElementById('quick-barcode').value.trim(); if(!q){ showToast('Ingrese código o nombre'); return } const inv = loadInventory(); const found = inv.find(i=> (i.barcode && i.barcode === q) || (i.id && i.id === q) || (i.name && i.name.toLowerCase()===q.toLowerCase()) ); if(found){ fillQuickProductSummary(found); showToast('Producto vinculado'); } else { if(confirm('Producto no encontrado. ¿Deseas registrar este código como nuevo producto?')){ openProductModal({ barcode: q, name: '', stock:0 }); } } }

    function saveQuickSale(){ const q=document.getElementById('quick-barcode').value.trim(); if(!q){ showToast('Ingrese o escanee un producto'); return } const inv = loadInventory(); let product = inv.find(i=> (i.barcode && i.barcode === q) || (i.id && i.id === q) ); if(!product){ if(confirm('Producto no registrado. ¿Registrar ahora?')){ openProductModal({ barcode:q }); return } product = { id: 'unknown_'+Date.now(), name: q, price:0, barcode:q, stock:0 } }
      const sales = loadSales(); const sale = { id: 'sale_'+Date.now(), productId: product.id, name: product.name, barcode: product.barcode, price: product.price||0, qty: 1, ts: new Date().toISOString() }
      sales.push(sale); saveSales(sales);
      if(product.stock!==undefined){ product.stock = Math.max(0,(product.stock||0)-1); const idx=inv.findIndex(i=>i.id===product.id); if(idx>=0) inv[idx]=product; saveInventory(inv); }
      renderInventory(); renderReports(); closeAllModals(); showToast('Venta registrada') }

    // REPORTS
    function renderReports(){ const c=document.getElementById('reports-content'); const sales=loadSales(); if(!c) return; if(sales.length===0){ c.innerHTML='<div>No hay ventas registradas aún.</div>'; return } c.innerHTML = sales.slice().reverse().map(s=>`<div style="padding:8px;border-bottom:1px solid #eee"><div style="font-weight:700">${escapeHtml(s.name||'—')}</div><div class="small-muted">${s.qty} · ${s.barcode||''} · ${new Date(s.ts).toLocaleString()}</div></div>`).join('') }

    // MODALS
    function openModal(id){ document.getElementById(id).classList.add('visible'); document.getElementById(id).setAttribute('aria-hidden','false'); }
    function closeAllModals(){ document.querySelectorAll('.modal.visible').forEach(m=>{ m.classList.remove('visible'); m.setAttribute('aria-hidden','true'); }); stopScanner(); quickScannerMode=false }

    // SCANNER (Quagga) with options: Register, Search, Sell
    let quaggaRunning = false; let quickScannerMode = false;
    function startScanner(){ const status = document.getElementById('scanner-status'); if(!navigator.mediaDevices){ status.textContent='Tu navegador no soporta cámara.'; return } status.textContent='Iniciando cámara...'; try{ Quagga.init({ inputStream: { name: 'Live', type: 'LiveStream', target: document.getElementById('scanner-container'), constraints: { facingMode: 'environment' } }, decoder: { readers: ['ean_reader','upc_reader','code_128_reader','ean_8_reader'] }, locate: true }, function(err){ if(err){ console.error(err); status.textContent='Error iniciando escáner (revisa HTTPS o permisos)'; return } Quagga.start(); quaggaRunning=true; status.textContent='Escaneando...'; }); Quagga.onDetected(onBarcodeDetected); } catch(e){ console.error('startScanner',e); status.textContent='Error inicializando escáner'; } }
    function stopScanner(){ if(quaggaRunning){ try{ Quagga.stop(); }catch(e){} quaggaRunning=false } }

    function startScannerForQuick(){ quickScannerMode = true; openModal('modal-scan'); startScanner(); }

    function onBarcodeDetected(result){ if(!result || !result.codeResult) return; const code = result.codeResult.code; if(window._lastDetected === code) return; window._lastDetected = code; setTimeout(()=>window._lastDetected=null,1200);
      showToast('Código detectado: '+code,1200);
      const inv = loadInventory(); const found = inv.find(i=>i.barcode===code || i.id===code);
      // update scan-result panel
      const panel = document.getElementById('scan-result'); panel.style.display='block'; panel.dataset.code = code; panel.innerHTML = `<div style="font-weight:700">Código: ${code}</div><div class="small-muted">${found ? ('Producto: '+found.name) : 'No encontrado'}</div><div style="margin-top:6px;display:flex;gap:6px"><button id="scan-reg-btn" class="px-2 py-1 bg-green-600 text-white rounded">Registrar</button><button id="scan-search-btn" class="px-2 py-1 border rounded">Buscar</button><button id="scan-sell-btn" class="px-2 py-1 bg-yellow-400 rounded">Vender</button></div>`;
      // bind buttons
      setTimeout(()=>{
        document.getElementById('scan-reg-btn').addEventListener('click', ()=>{ stopScanner(); openProductModal({ barcode: code, name:'', stock:0 }); });
        document.getElementById('scan-search-btn').addEventListener('click', ()=>{ stopScanner(); manualScanSearch(code); });
        document.getElementById('scan-sell-btn').addEventListener('click', ()=>{ stopScanner(); if(found){ openQuickWithProduct(found); openModal('modal-quick'); } else { if(confirm('Producto no encontrado. ¿Registrar y vender?')) openProductModal({ barcode: code, name:'', stock:0 }); } });
        if(quickScannerMode && found){ document.getElementById('quick-barcode').value = code; fillQuickProductSummary(found); quickScannerMode=false; closeAllModals(); openModal('modal-quick'); }
      }, 100)
    }

    function manualScanSearch(code){ const inv = loadInventory(); const found = inv.find(i=>i.barcode===code || i.id===code); if(found){ fillQuickProductSummary(found); closeAllModals(); openModal('modal-quick'); } else { if(confirm('Código no encontrado. ¿Registrar producto?')) openProductModal({ barcode: code, name:'', stock:0 }); } }

    // IMPORT / EXPORT XLSX
    function handleXlsxImport(e){ const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = function(ev){ const data = new Uint8Array(ev.target.result); const workbook = XLSX.read(data, { type: 'array' }); // expect sheet 'inventory'
        const sheet = workbook.Sheets[workbook.SheetNames[0]]; const rows = XLSX.utils.sheet_to_json(sheet); // map to inventory
        const inv = loadInventory(); for(const r of rows){ const item = { id: r.id || r.barcode || generateId(), name: r.name || r.Nombre || '', category: r.category || r.Categoria || '', price: parseFloat(r.price||r.Precio||0)||0, barcode: String(r.barcode||r.Codigo||''), stock: parseInt(r.stock||r.Stock||0)||0 }; const idx = inv.findIndex(i=>i.id===item.id || (i.barcode && i.barcode===item.barcode)); if(idx>=0) inv[idx]=item; else inv.push(item); }
        saveInventory(inv); renderInventory(); showToast('Importación completada'); if(cloudEnabled) pushAllLocalToCloud(); }
      reader.readAsArrayBuffer(f); e.target.value=''; }

    function exportXlsx(){ const inv = loadInventory(); const sales = loadSales(); const wb = XLSX.utils.book_new(); const ws1 = XLSX.utils.json_to_sheet(inv); const ws2 = XLSX.utils.json_to_sheet(sales); XLSX.utils.book_append_sheet(wb, ws1, 'inventory'); XLSX.utils.book_append_sheet(wb, ws2, 'sales'); const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'}); const blob = new Blob([wbout], {type:'application/octet-stream'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `ts_export_${Date.now()}.xlsx`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); showToast('Exportado XLSX'); }

    // Cloud push helpers already above

    // Load responsible into UI
    function loadResponsibleToUI(){ const r = loadResponsible(); if(r){ document.getElementById('responsible-date').value = r.date || ''; document.getElementById('responsible-name').value = r.name || ''; document.getElementById('responsible-display').textContent = `${r.name||''} · ${r.date||''}` } }

    // small safe fallback if Quagga missing
    if(typeof Quagga === 'undefined'){ console.warn('Quagga no disponible. El escáner solo funcionará si se carga correctamente.'); }

    // expose for debugging
    window._ts = { loadInventory, saveInventory, loadSales, saveSales, enableCloud, initFirebase, pushAllLocalToCloud }
  </script>
</body>
</html>
