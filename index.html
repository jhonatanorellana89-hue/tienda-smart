<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <!-- Mantener la pantalla "quieta" (sin zoom) -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>MINIMARKET LA ESQUINA DEL AHORRO â€” TiendaSmart</title>

  <!-- Tailwind (prototype) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- OpenCV.js (WASM) - opcional -->
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>

  <!-- Quagga fallback -->
  <script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- html2canvas + jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root { --bg:#f8fafc; --card:#fff; --muted:#6b7280; }
    [data-theme="dark"]{ --bg:#071029; --card:#0f1724; --muted:#9ca3af; color-scheme:dark; }
    html,body{ height:100%; touch-action: manipulation; -ms-touch-action: manipulation; -webkit-user-select:none; -ms-user-select:none; user-select:none; }
    body{ background:var(--bg); font-family:Inter,system-ui,Segoe UI,Roboto,Arial; margin:0; color:#0b1220; -webkit-tap-highlight-color: transparent; }
    .app{ max-width:920px; margin:0 auto; padding-bottom:120px; }
    #global-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.45); backdrop-filter:blur(2px); z-index:40; display:none; opacity:0; transition:opacity .18s; }
    #global-backdrop.visible{ display:block; opacity:1; }

    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50; padding:1rem; overflow:auto; -webkit-overflow-scrolling:touch; }
    .modal.visible{ display:flex; }
    .modal .modal-content{ width:100%; max-width:760px; border-radius:12px; box-shadow:0 12px 40px rgba(2,6,23,0.25); padding:1rem; background:var(--card); color:inherit; }
    @media(max-width:640px){ .modal .modal-content{ width:100%; height:100%; border-radius:0; padding:0; display:flex; flex-direction:column; } }

    #overlay-canvas{ position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:20; }
    .scan-guide{ position:absolute; left:50%; top:50%; width:64%; height:28%; transform:translate(-50%,-50%); border:2px dashed rgba(255,255,255,0.6); border-radius:8px; pointer-events:none; z-index:30; }

    .bottom-bar{ position:fixed; left:0; right:0; bottom:0; z-index:60; display:flex; gap:8px; padding:10px; background:linear-gradient(0deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95)); box-shadow:0 -6px 18px rgba(2,6,23,0.06); }
    .inv-card{ background:var(--card); border-radius:12px; padding:12px; box-shadow:0 6px 18px rgba(2,6,23,0.06); display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .print-table th{ background:#f3f4f6; padding:8px; text-align:left; }
    .print-table td{ padding:8px; border-bottom:1px solid #e5e7eb; vertical-align:top; }
    input, select, button, textarea { -webkit-touch-callout: none; -webkit-user-select: none; user-select:none; }
  </style>
</head>
<body data-theme="light">
  <div id="global-backdrop" aria-hidden="true"></div>

  <div class="app px-4">
    <div class="flex items-center justify-between py-4">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-lg bg-gradient-to-r from-green-400 to-blue-500 flex items-center justify-center text-white shadow-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3h2l.4 2M7 13h10l-1.2 6H6L5 13z"/></svg>
        </div>
        <div>
          <div class="text-sm font-semibold">MINIMARKET</div>
          <div class="text-xs text-gray-500">La Esquina del Ahorro</div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <div id="current-user" class="hidden px-3 py-1 rounded-full text-sm bg-gradient-to-r from-indigo-500 to-pink-500 text-white"></div>
        <button id="btn-logout" class="hidden px-3 py-2 border rounded text-sm">Salir</button>
        <button id="btn-theme" class="px-3 py-2 border rounded text-sm">Modo</button>
        <button id="btn-open-report" class="px-3 py-2 border rounded text-sm">Reportes</button>
      </div>
    </div>

    <!-- Responsible -->
    <div class="mb-3 p-3 rounded shadow-sm bg-white flex items-center justify-between">
      <div>
        <div class="text-xs text-gray-600">Encargado del dÃ­a</div>
        <div id="responsible-display" class="font-medium">â€”</div>
      </div>
      <div class="flex gap-2 items-center">
        <input id="responsible-date" type="date" class="px-2 py-1 rounded border bg-white">
        <input id="responsible-name" placeholder="Nombre encargado" class="px-2 py-1 rounded border w-40 bg-white">
        <button id="save-responsible" class="px-3 py-1 bg-indigo-600 text-white rounded">Guardar</button>
      </div>
    </div>

    <div class="mb-3">
      <input id="search" type="search" placeholder="Buscar producto o cÃ³digo..." class="w-full px-4 py-3 rounded-lg shadow-sm border bg-white" />
    </div>

    <div id="inventory-list" class="space-y-3 mb-28"></div>

    <div class="grid grid-cols-2 gap-3 mb-6">
      <div class="bg-white rounded-lg p-2 shadow"><canvas id="chart-sales" height="120"></canvas></div>
      <div class="bg-white rounded-lg p-2 shadow"><canvas id="chart-stock" height="120"></canvas></div>
    </div>
  </div>

  <div class="bottom-bar">
    <button id="open-add-product" class="flex-1 px-4 py-3 rounded-lg bg-green-500 text-white font-semibold">+ Producto</button>
    <button id="open-scan" class="flex-1 px-4 py-3 rounded-lg bg-yellow-500 text-white font-semibold">Escanear</button>
    <button id="open-quick-sale" class="flex-1 px-4 py-3 rounded-lg bg-red-600 text-white font-semibold">Venta</button>
    <button id="open-clients" class="flex-1 px-4 py-3 rounded-lg bg-indigo-600 text-white font-semibold">Clientes</button>
  </div>

  <!-- MODALES (idÃ©nticos a versiones anteriores, omitido aquÃ­ por brevedad en comentario) -->
  <!-- Product, Scanner, Quick Sale, Income, Sale, Clients, Reports, Login -->
  <!-- (El cÃ³digo real a continuaciÃ³n incluye todos esos modales tal como necesitas) -->

  <!-- Product modal -->
  <div id="modal-product" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-content mx-3">
      <div class="flex justify-between items-center px-3 py-2 border-b">
        <h4 class="text-lg font-semibold">Producto</h4>
        <button data-close-modal class="text-xl">âœ•</button>
      </div>
      <form id="form-product" class="p-3 space-y-3 overflow-auto">
        <input type="hidden" id="product-id">
        <input id="product-name" placeholder="Nombre" required class="w-full px-3 py-3 rounded border bg-white">
        <div class="flex gap-2">
          <input id="product-category" placeholder="CategorÃ­a" class="flex-1 px-3 py-3 rounded border bg-white">
          <input id="product-price" placeholder="Precio" type="number" step="0.01" class="w-28 px-3 py-3 rounded border bg-white">
        </div>
        <div class="flex gap-2">
          <input id="product-barcode" placeholder="CÃ³digo de barras" class="flex-1 px-3 py-3 rounded border bg-white">
          <input id="product-stock" placeholder="Stock" type="number" class="w-24 px-3 py-3 rounded border bg-white">
        </div>
        <div class="flex gap-2">
          <button type="button" data-close-modal class="flex-1 px-4 py-3 border rounded">Cancelar</button>
          <button type="submit" class="flex-1 px-4 py-3 bg-green-600 text-white rounded">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Scanner modal -->
  <div id="modal-scan" class="modal scanner-modal" role="dialog" aria-hidden="true">
    <div class="modal-content">
      <div class="flex justify-between items-center px-3 py-2">
        <h4 class="text-lg font-semibold text-white">EscÃ¡ner</h4>
        <div class="flex gap-2">
          <button id="toggle-torch" class="px-3 py-2 rounded hidden">ðŸ”¦</button>
          <button data-close-modal class="text-xl">âœ•</button>
        </div>
      </div>
      <div id="video-wrap" class="relative bg-black" style="height:55vh;">
        <video id="video" autoplay muted playsinline style="width:100%; height:100%; object-fit:cover;"></video>
        <canvas id="overlay-canvas"></canvas>
        <div class="scan-guide"></div>
      </div>
      <div class="p-3 bg-white">
        <input id="scanned-code" class="w-full px-3 py-2 rounded border mb-2" placeholder="CÃ³digo detectado">
        <div class="flex gap-2">
          <button id="fill-product" class="flex-1 px-3 py-2 bg-indigo-600 text-white rounded">Buscar/Editar</button>
          <button id="quick-sell-detected" class="flex-1 px-3 py-2 bg-red-600 text-white rounded">Vender</button>
          <button id="stop-camera" class="px-3 py-2 border rounded">Detener</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick sale -->
  <div id="modal-quick-sale" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-content mx-3">
      <div class="flex justify-between items-center px-3 py-2 border-b">
        <h4 class="text-lg font-semibold">Venta rÃ¡pida</h4>
        <button data-close-modal class="text-xl">âœ•</button>
      </div>
      <form id="form-quick-sale" class="p-3 space-y-3 overflow-auto">
        <input id="quick-search" placeholder="Buscar o pegar cÃ³digo..." class="w-full px-3 py-3 rounded border bg-white" />
        <div class="flex gap-2">
          <select id="quick-product" class="flex-1 px-3 py-3 border rounded bg-white"></select>
          <input id="quick-qty" type="number" min="1" value="1" class="w-24 px-3 py-3 border rounded bg-white">
        </div>
        <div class="flex gap-2 items-center">
          <label class="text-sm">Pago</label>
          <select id="quick-payment" class="px-3 py-2 rounded border">
            <option value="EFECTIVO">EFECTIVO</option>
            <option value="YAPE">YAPE</option>
            <option value="A_CREDITO">A CREDITO</option>
          </select>
          <input id="quick-customer" placeholder="Nombre cliente (si A CREDITO)" class="flex-1 px-3 py-2 border rounded bg-white">
        </div>
        <div class="flex justify-between items-center">
          <div>Total: <span id="quick-total">0.00</span></div>
          <div class="flex gap-2">
            <button type="button" id="quick-add-cart" class="px-3 py-2 border rounded">Agregar</button>
            <button type="submit" class="px-3 py-2 bg-red-600 text-white rounded">Cobrar</button>
          </div>
        </div>
        <div>
          <h5 class="text-sm font-medium">Carrito</h5>
          <div id="quick-cart" class="space-y-2 mt-2"></div>
        </div>
      </form>
    </div>
  </div>

  <!-- Income -->
  <div id="modal-income" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-content mx-3">
      <div class="flex justify-between items-center px-3 py-2 border-b">
        <h4 class="text-lg font-semibold">Registrar ingreso (stock)</h4>
        <button data-close-modal class="text-xl">âœ•</button>
      </div>
      <form id="form-income" class="p-3 space-y-3 overflow-auto">
        <select id="income-product" class="w-full px-3 py-2 border rounded"></select>
        <input id="income-qty" type="number" min="1" value="1" class="w-full px-3 py-2 border rounded">
        <div class="flex justify-end gap-2">
          <button type="button" data-close-modal class="px-3 py-2 border rounded">Cancelar</button>
          <button type="submit" class="px-3 py-2 bg-blue-600 text-white rounded">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Sale (detailed) -->
  <div id="modal-sale" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-content mx-3">
      <div class="flex justify-between items-center px-3 py-2 border-b">
        <h4 class="text-lg font-semibold">Registrar Venta</h4>
        <button data-close-modal class="text-xl">âœ•</button>
      </div>
      <form id="form-sale" class="p-3 space-y-3 overflow-auto">
        <div class="flex gap-2">
          <input id="sale-customer" placeholder="Cliente (opcional)" class="flex-1 px-3 py-2 border rounded bg-white">
          <select id="sale-payment" class="px-3 py-2 border rounded">
            <option value="EFECTIVO">EFECTIVO</option>
            <option value="YAPE">YAPE</option>
            <option value="A_CREDITO">A CREDITO</option>
          </select>
        </div>
        <div id="sale-items" class="space-y-2"></div>
        <div class="flex justify-between items-center">
          <button id="add-sale-item" type="button" class="px-3 py-2 border rounded">Agregar producto</button>
          <div>Total: <span id="sale-total">0.00</span></div>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" data-close-modal class="px-3 py-2 border rounded">Cancelar</button>
          <button type="submit" class="px-3 py-2 bg-red-600 text-white rounded">Vender</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Clients -->
  <div id="modal-clients" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-content mx-3">
      <div class="flex justify-between items-center px-3 py-2 border-b">
        <h4 class="text-lg font-semibold">Clientes (A CREDITO)</h4>
        <button data-close-modal class="text-xl">âœ•</button>
      </div>
      <div class="p-3 overflow-auto">
        <div class="flex gap-2 mb-3">
          <input id="client-name" placeholder="Nuevo cliente (nombre)" class="flex-1 px-3 py-2 border rounded bg-white">
          <button id="add-client" class="px-3 py-2 bg-green-600 text-white rounded">Agregar</button>
        </div>
        <div id="clients-list" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <!-- Reports -->
  <div id="modal-reports" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-content mx-3">
      <div class="flex justify-between items-center px-3 py-2 border-b">
        <h4 class="text-lg font-semibold">Reportes</h4>
        <button data-close-modal class="text-xl">âœ•</button>
      </div>
      <div class="p-3 overflow-auto">
        <div class="flex gap-2 mb-3">
          <button id="tab-sales-range" class="px-3 py-2 bg-indigo-600 text-white rounded">Ventas por rango</button>
          <button id="tab-sales-day" class="px-3 py-2 border rounded">Ventas por dÃ­a</button>
          <button id="tab-inventory" class="px-3 py-2 border rounded">Inventario</button>
        </div>

        <div id="tab-content-sales-range" class="tab-content">
          <div class="grid grid-cols-2 gap-2 mb-3">
            <div><label class="text-xs">Desde</label><input id="report-from" type="date" class="w-full px-2 py-2 border rounded"></div>
            <div><label class="text-xs">Hasta</label><input id="report-to" type="date" class="w-full px-2 py-2 border rounded"></div>
          </div>
          <div class="flex gap-2 mb-3 justify-end">
            <button id="btn-generate-range" class="px-3 py-2 bg-indigo-600 text-white rounded">Generar vista</button>
            <button id="btn-pdf-range" class="px-3 py-2 bg-gray-800 text-white rounded">Generar PDF (A4)</button>
          </div>
          <div id="report-preview-range" class="max-h-80 overflow-auto text-sm bg-white p-2 rounded"></div>
        </div>

        <div id="tab-content-sales-day" class="tab-content hidden">
          <div class="grid grid-cols-2 gap-2 mb-3">
            <div><label class="text-xs">Desde</label><input id="day-from" type="date" class="w-full px-2 py-2 border rounded"></div>
            <div><label class="text-xs">Hasta</label><input id="day-to" type="date" class="w-full px-2 py-2 border rounded"></div>
          </div>
          <div class="flex gap-2 mb-3 justify-end">
            <button id="btn-generate-day" class="px-3 py-2 bg-indigo-600 text-white rounded">Generar resumen</button>
            <button id="btn-pdf-day" class="px-3 py-2 bg-gray-800 text-white rounded">Generar PDF (A4)</button>
          </div>
          <div id="report-preview-day" class="max-h-80 overflow-auto text-sm bg-white p-2 rounded"></div>
          <div class="mt-3 bg-white rounded p-2 shadow"><canvas id="chart-daily-sales" height="120"></canvas></div>
        </div>

        <div id="tab-content-inventory" class="tab-content hidden">
          <div class="flex gap-2 mb-3 justify-end">
            <button id="btn-generate-inv" class="px-3 py-2 bg-indigo-600 text-white rounded">Generar inventario</button>
            <button id="btn-pdf-inv" class="px-3 py-2 bg-gray-800 text-white rounded">Generar PDF (A4)</button>
          </div>
          <div id="report-preview-inv" class="max-h-80 overflow-auto text-sm bg-white p-2 rounded"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="modal-login" class="modal visible" role="dialog" aria-hidden="false" style="background: linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.6));">
    <div class="modal-content mx-3" style="max-width:480px;">
      <div class="p-4">
        <h2 class="text-xl font-semibold mb-2">Ingresar â€” TiendaSmart</h2>
        <p class="text-sm text-gray-500 mb-4">Usuario: <strong>lis</strong> â€” ContraseÃ±a: <strong>magaly</strong></p>
        <form id="form-login" class="space-y-3">
          <input id="login-user" placeholder="Usuario" class="w-full px-3 py-3 rounded border" autofocus>
          <input id="login-pass" placeholder="ContraseÃ±a" type="password" class="w-full px-3 py-3 rounded border">
          <div class="flex gap-2">
            <button type="submit" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded font-semibold">Entrar</button>
            <button type="button" id="login-guest" class="flex-1 px-4 py-3 border rounded">Demo</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // helpers
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const uid = () => 'id-' + Math.random().toString(36).slice(2,9);
    const money = v => Number(v||0).toFixed(2);
    const todayYMD = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };
    const localYMDFromISO = iso => { const d = new Date(iso); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };
    function debounce(fn, wait=200){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

    // IndexedDB simple wrapper
    const DB_NAME='TiendaSmartDB', DB_VERSION=9;
    let db;
    function openDB(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB_NAME, DB_VERSION); r.onupgradeneeded = e=>{ const idb=e.target.result; if(!idb.objectStoreNames.contains('products')) idb.createObjectStore('products',{keyPath:'id'}); if(!idb.objectStoreNames.contains('sales')) idb.createObjectStore('sales',{keyPath:'id'}); if(!idb.objectStoreNames.contains('movements')) idb.createObjectStore('movements',{keyPath:'id'}); if(!idb.objectStoreNames.contains('customers')) idb.createObjectStore('customers',{keyPath:'name'}); if(!idb.objectStoreNames.contains('responsibles')) idb.createObjectStore('responsibles',{keyPath:'date'}); }; r.onsuccess=e=>{ db=e.target.result; res(db); }; r.onerror=e=>rej(e); }); }
    const store = (name,mode='readonly') => db.transaction(name, mode).objectStore(name);
    const put = (name,item) => new Promise((res,rej)=>{ const rq = store(name,'readwrite').put(item); rq.onsuccess=()=>res(item); rq.onerror=e=>rej(e); });
    const add = (name,item) => new Promise((res,rej)=>{ const rq = store(name,'readwrite').add(item); rq.onsuccess=()=>res(item); rq.onerror=e=>rej(e); });
    const all = (name) => new Promise((res,rej)=>{ const rq = store(name,'readonly').getAll(); rq.onsuccess=()=>res(rq.result||[]); rq.onerror=e=>rej(e); });
    const get = (name,key) => new Promise((res,rej)=>{ const rq = store(name,'readonly').get(key); rq.onsuccess=()=>res(rq.result); rq.onerror=e=>rej(e); });

    // Auth
    const AUTH_USER='lis', AUTH_PASS='magaly', AUTH_KEY='ts_user';
    function isAuthenticated(){ return !!localStorage.getItem(AUTH_KEY); }
    function setAuthenticated(name){ localStorage.setItem(AUTH_KEY, name); $('#current-user').textContent = name; $('#current-user').classList.remove('hidden'); $('#btn-logout').classList.remove('hidden'); }
    function clearAuth(){ localStorage.removeItem(AUTH_KEY); $('#current-user').classList.add('hidden'); $('#btn-logout').classList.add('hidden'); }

    $('#form-login').addEventListener('submit', e => {
      e.preventDefault();
      const u = $('#login-user').value.trim(); const p = $('#login-pass').value;
      if(u === AUTH_USER && p === AUTH_PASS){ setAuthenticated(u); closeLogin(); initApp(); } else { alert('Credenciales invÃ¡lidas'); }
    });
    $('#login-guest').addEventListener('click', ()=>{ setAuthenticated('GUEST'); closeLogin(); initApp(); });
    $('#btn-logout').addEventListener('click', ()=>{ if(confirm('Cerrar sesiÃ³n?')) { clearAuth(); location.reload(); } });
    function closeLogin(){ const m=$('#modal-login'); m.classList.remove('visible'); m.setAttribute('aria-hidden','true'); }

    // modal manager
    const globalBackdrop = $('#global-backdrop');
    let currentOpenModal = null;
    async function _stopCameraSafe(){ try{ if(typeof stopCamera === 'function') await stopCamera(); }catch(e){ console.warn('stopCamera', e); } }
    function showModal(id, { focusSelector } = {}){
      if(!isAuthenticated() && id !== 'modal-login') return showLogin();
      if(currentOpenModal && currentOpenModal !== id) closeModal(currentOpenModal);
      const modal = document.getElementById(id); if(!modal) return;
      globalBackdrop.classList.add('visible'); globalBackdrop.setAttribute('aria-hidden','false');
      modal.classList.add('visible'); modal.setAttribute('aria-hidden','false');
      document.documentElement.style.overflow='hidden'; document.body.style.overflow='hidden';
      currentOpenModal = id;
      setTimeout(()=>{ if(focusSelector){ const el = modal.querySelector(focusSelector); if(el) el.focus(); return; } const first = modal.querySelector('input, button, select, textarea'); if(first) first.focus(); }, 80);
    }
    async function closeModal(id){
      const modal = document.getElementById(id);
      if(!modal){ globalBackdrop.classList.remove('visible'); document.documentElement.style.overflow=''; document.body.style.overflow=''; currentOpenModal = null; return; }
      if(modal.classList.contains('scanner-modal')) await _stopCameraSafe();
      modal.classList.remove('visible'); modal.setAttribute('aria-hidden','true');
      setTimeout(()=>{ const any = Array.from(document.querySelectorAll('.modal')).some(m=>m.classList.contains('visible')); if(!any){ globalBackdrop.classList.remove('visible'); globalBackdrop.setAttribute('aria-hidden','true'); document.documentElement.style.overflow=''; document.body.style.overflow=''; currentOpenModal=null; } else { const rem = document.querySelector('.modal.visible'); if(rem) currentOpenModal = rem.id; } }, 120);
    }
    globalBackdrop.addEventListener('click', async ()=>{ if(!currentOpenModal) return; await closeModal(currentOpenModal); });
    document.addEventListener('keydown', async e=>{ if(e.key==='Escape' && currentOpenModal) await closeModal(currentOpenModal); });
    document.addEventListener('click', e=>{ const btn = e.target.closest('[data-close-modal]'); if(!btn) return; const modal = btn.closest('.modal'); if(!modal) return; closeModal(modal.id); });
    function showLogin(){ const m = $('#modal-login'); m.classList.add('visible'); m.setAttribute('aria-hidden','false'); }

    // state
    const state = { products:[], sales:[], customers:[], responsibles:[] };

    async function refreshAll(){
      state.products = await all('products');
      state.sales = await all('sales');
      state.customers = await all('customers');
      state.responsibles = await all('responsibles');
      renderInventoryMobile();
      renderIncomeSelects();
      renderQuickSelect();
      renderClients();
      updateCharts();
      updateResponsibleBanner();
    }

    // Inventory UI
    const inventoryList = $('#inventory-list');
    function renderInventoryMobile(filter=''){
      const q = (filter||'').trim().toLowerCase();
      inventoryList.innerHTML = '';
      state.products.forEach(p=>{
        if(q && !(p.name.toLowerCase().includes(q) || (p.barcode||'').includes(q) || (p.barcode||'').replace(/\D/g,'').includes(q.replace(/\D/g,'')))) return;
        const low = (p.stock||0) <= 5;
        const div = document.createElement('div'); div.className='inv-card';
        div.innerHTML = `
          <div>
            <div class="font-medium">${p.name}${low? ' <span style="color:#b91c1c;font-weight:600"> â€¢ STOCK BAJO</span>':''}</div>
            <div class="text-xs text-gray-500">${p.category||''} â€¢ ${p.barcode||''}</div>
            <div class="text-sm text-gray-700 mt-1">S/ ${money(p.price)} Â· Stock: ${p.stock||0}</div>
          </div>
          <div class="flex flex-col gap-2 items-end">
            <button class="px-3 py-2 bg-red-500 text-white rounded sell-btn" data-id="${p.id}">Vender</button>
            <button class="px-3 py-2 border rounded income-btn" data-id="${p.id}">+Stock</button>
            <button class="px-3 py-2 border rounded edit-btn" data-id="${p.id}">Editar</button>
          </div>`;
        inventoryList.appendChild(div);
      });
      $$('.sell-btn').forEach(b=> b.onclick = ()=> quickSellPrompt(b.dataset.id));
      $$('.income-btn').forEach(b=> b.onclick = ()=> openIncomeFor(b.dataset.id));
      $$('.edit-btn').forEach(b=> b.onclick = ()=> openProductModal(state.products.find(x=>x.id===b.dataset.id)));
    }

    // Product modal logic
    $('#open-add-product').addEventListener('click', ()=> openProductModal());
    function openProductModal(product){
      if(!isAuthenticated()) return showLogin();
      $('#form-product').reset(); $('#product-id').value = '';
      if(product){ $('#product-id').value = product.id; $('#product-name').value = product.name; $('#product-category').value = product.category||''; $('#product-price').value = product.price||0; $('#product-barcode').value = product.barcode||''; $('#product-stock').value = product.stock||0; }
      showModal('modal-product', { focusSelector:'#product-name' });
    }
    $('#form-product').addEventListener('submit', async e => {
      e.preventDefault();
      const id = $('#product-id').value || uid();
      const prod = { id, name: $('#product-name').value.trim(), category: $('#product-category').value.trim(), price: Number($('#product-price').value)||0, barcode: $('#product-barcode').value.trim(), stock: Number($('#product-stock').value)||0, createdAt: new Date().toISOString() };
      await put('products', prod);
      await refreshAll();
      closeModal('modal-product');
    });

    // Income
    function renderIncomeSelects(){ const sel = $('#income-product'); if(!sel) return; sel.innerHTML=''; state.products.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=`${p.name} â€” Stock: ${p.stock||0}`; sel.appendChild(o); }); }
    function openIncomeFor(productId){ renderIncomeSelects(); $('#income-product').value = productId; showModal('modal-income'); }
    $('#form-income').addEventListener('submit', async e => { e.preventDefault(); const pid = $('#income-product').value; const qty = Number($('#income-qty').value)||0; const p = state.products.find(x=>x.id===pid); p.stock = (p.stock||0) + qty; await put('products', p); await add('movements', { id:uid(), type:'income', productId:pid, qty, date:new Date().toISOString() }); await refreshAll(); closeModal('modal-income'); });

    // Sale (detailed)
    function addSaleItemRow(productId=''){ const row=document.createElement('div'); row.className='grid grid-cols-12 gap-2 items-center'; row.innerHTML = `<select class="col-span-6 px-2 py-1 border sale-product"></select><input type="number" class="col-span-2 px-2 py-1 border sale-qty" value="1" min="1"><input type="number" step="0.01" class="col-span-2 px-2 py-1 border sale-price" placeholder="Precio"><button type="button" class="col-span-2 px-2 py-1 border sale-remove">Quitar</button>`; $('#sale-items').appendChild(row); fillSaleRow(row, productId); }
    function fillSaleRow(row, productId){ const sel = row.querySelector('.sale-product'); sel.innerHTML=''; state.products.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=`${p.name} (stock ${p.stock||0})`; sel.appendChild(o); }); if(productId) sel.value = productId; const price = row.querySelector('.sale-price'); const qty = row.querySelector('.sale-qty'); sel.onchange = ()=>{ const p = state.products.find(x=>x.id===sel.value); price.value = p ? p.price : ''; updateSaleTotal(); }; price.oninput = updateSaleTotal; qty.oninput = updateSaleTotal; row.querySelector('.sale-remove').onclick = ()=>{ row.remove(); updateSaleTotal(); }; }
    $('#add-sale-item').addEventListener('click', ()=> addSaleItemRow());
    function updateSaleTotal(){ let t=0; document.querySelectorAll('#sale-items > div').forEach(r=>{ const q=Number(r.querySelector('.sale-qty').value)||0; const p=Number(r.querySelector('.sale-price').value)||0; t += q*p; }); $('#sale-total').textContent = money(t); }
    $('#form-sale').addEventListener('submit', async e => {
      e.preventDefault();
      const customer = $('#sale-customer').value.trim(); const payment = $('#sale-payment').value;
      const items = []; document.querySelectorAll('#sale-items > div').forEach(r=>{ const pid = r.querySelector('.sale-product').value; const qty = Number(r.querySelector('.sale-qty').value)||0; const price = Number(r.querySelector('.sale-price').value)||0; if(qty>0) items.push({ productId: pid, qty, price }); });
      if(items.length===0) return alert('Agregar al menos un producto');
      for(const it of items){ const p = state.products.find(x=>x.id===it.productId); p.stock = (p.stock||0) - it.qty; await put('products', p); await add('movements', { id:uid(), type:'sale', productId: it.productId, qty: it.qty, date: new Date().toISOString() }); }
      const total = items.reduce((s,i)=>s + i.qty*i.price,0); const date = new Date().toISOString();
      const respDate = ($('#responsible-date').value) ? $('#responsible-date').value : todayYMD();
      const responsibleObj = await get('responsibles', respDate).catch(()=>null);
      const responsibleName = (responsibleObj && responsibleObj.name) ? responsibleObj.name : ($('#responsible-name').value.trim()||'');
      const sale = { id:uid(), items, total, date, customerName: customer || null, paid: (payment!=='A_CREDITO'), paymentType: payment, responsible: responsibleName };
      await add('sales', sale);
      if(payment === 'A_CREDITO' && customer){ const existing = await get('customers', customer).catch(()=>null); const prev = existing && existing.balance ? existing.balance : 0; await put('customers', { name: customer, balance: prev + total, lastSale: date }); }
      await refreshAll(); closeModal('modal-sale');
    });

    // Quick sale
    $('#open-quick-sale').addEventListener('click', ()=> { renderQuickSelect(); showModal('modal-quick-sale'); });
    function renderQuickSelect(){ const sel = $('#quick-product'); sel.innerHTML=''; state.products.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=`${p.name} (stock ${p.stock||0})`; sel.appendChild(o); }); updateQuickTotal(); }
    $('#quick-search').addEventListener('input', debounce(function(){ const v=this.value.trim().toLowerCase(); if(!v) return; const digits = v.replace(/\D/g,''); let found=null; if(digits.length>0) found = state.products.find(p => (p.barcode||'').replace(/\D/g,'').endsWith(digits) || (p.barcode||'')===v); if(!found) found = state.products.find(p => p.name.toLowerCase().includes(v)); if(found) $('#quick-product').value = found.id; updateQuickTotal(); },160));
    function updateQuickTotal(){ const pid = $('#quick-product').value; const qty = Number($('#quick-qty').value)||0; const p = state.products.find(x=>x.id===pid); $('#quick-total').textContent = money(p ? p.price * qty : 0); }
    $('#quick-product').addEventListener('change', updateQuickTotal); $('#quick-qty').addEventListener('input', updateQuickTotal);
    const quickCart = [];
    $('#quick-add-cart').addEventListener('click', function(){ const pid = $('#quick-product').value; const qty = Number($('#quick-qty').value)||1; const p = state.products.find(x=>x.id===pid); if(!p) return alert('Selecciona un producto'); quickCart.push({ productId: pid, qty, price: p.price }); renderQuickCart(); });
    function renderQuickCart(){ const el = $('#quick-cart'); el.innerHTML=''; quickCart.forEach((it,idx)=>{ const p = state.products.find(x=>x.id===it.productId); const d=document.createElement('div'); d.className='flex justify-between items-center'; d.innerHTML = `<div>${p.name} x ${it.qty}</div><div>${money(it.qty*it.price)} <button data-idx="${idx}" class="ml-2 text-sm text-red-600 btn-remove-quick">Quitar</button></div>`; el.appendChild(d); }); $$('.btn-remove-quick').forEach(b=> b.onclick = ()=> { quickCart.splice(Number(b.dataset.idx),1); renderQuickCart(); }); }
    $('#form-quick-sale').addEventListener('submit', async function(e){ e.preventDefault(); if(quickCart.length===0) return alert('Agregar productos'); const customer = $('#quick-customer').value.trim(); const payment = $('#quick-payment').value; for(const it of quickCart){ const p = state.products.find(x=>x.id===it.productId); p.stock = (p.stock||0) - it.qty; await put('products', p); await add('movements', { id:uid(), type:'sale', productId: it.productId, qty: it.qty, date:new Date().toISOString() }); } const total = quickCart.reduce((s,i)=>s + i.qty*i.price,0); const date = new Date().toISOString(); const respDate = ($('#responsible-date').value) ? $('#responsible-date').value : todayYMD(); const responsibleObj = await get('responsibles', respDate).catch(()=>null); const responsibleName = (responsibleObj && responsibleObj.name) ? responsibleObj.name : ($('#responsible-name').value.trim()||''); const sale = { id:uid(), items: quickCart.slice(), total, date, customerName: customer || null, paid: (payment!=='A_CREDITO'), paymentType: payment, responsible: responsibleName }; await add('sales', sale); if(payment === 'A_CREDITO' && customer){ const existing = await get('customers', customer).catch(()=>null); const prev = existing && existing.balance ? existing.balance : 0; await put('customers', { name: customer, balance: prev + total, lastSale: date }); } quickCart.length=0; await refreshAll(); closeModal('modal-quick-sale'); });

    // Clients
    $('#open-clients').addEventListener('click', ()=> showModal('modal-clients'));
    $('#add-client').addEventListener('click', async ()=> { const name = $('#client-name').value.trim(); if(!name) return alert('Ingresa nombre'); const existing = await get('customers', name).catch(()=>null); if(existing) return alert('Cliente ya existe'); await put('customers', { name, balance:0, createdAt:new Date().toISOString() }); $('#client-name').value=''; await refreshAll(); showModal('modal-clients'); });
    async function renderClients(){ const el = $('#clients-list'); el.innerHTML=''; const clients = state.customers || []; if(!clients.length) el.innerHTML = '<div class="text-sm text-gray-600">No hay clientes registrados.</div>'; for(const c of clients){ const d = document.createElement('div'); d.className='p-2 border rounded bg-white flex justify-between items-center'; d.innerHTML = `<div><div class="font-medium">${c.name}</div><div class="text-xs text-gray-500">Saldo: S/ ${money(c.balance||0)}</div></div><div class="flex gap-2"><button data-name="${c.name}" class="px-3 py-2 border rounded btn-abono">Abono</button><button data-name="${c.name}" class="px-3 py-2 bg-green-600 text-white rounded btn-saldar">Saldar</button></div>`; el.appendChild(d); } $$('.btn-abono').forEach(b=> b.onclick = async ()=>{ const name=b.dataset.name; const amt = Number(prompt(`Abono para ${name} - monto:`, '0'))||0; if(amt<=0) return; const c = await get('customers', name); const newBal = (c.balance||0) - amt; await put('customers', { name, balance: newBal < 0 ? 0 : newBal, lastPayment:new Date().toISOString() }); alert('Abono registrado'); await refreshAll(); }); $$('.btn-saldar').forEach(b=> b.onclick = async ()=>{ const name=b.dataset.name; if(!confirm(`Â¿Saldar cuenta de ${name}? Esto pondrÃ¡ su saldo a 0.`)) return; await put('customers',{ name, balance:0, lastPayment:new Date().toISOString() }); alert('Cuenta saldada'); await refreshAll(); }); }

    // Responsible
    $('#save-responsible').addEventListener('click', async ()=> { const date = $('#responsible-date').value; const name = $('#responsible-name').value.trim(); if(!date) return alert('Selecciona fecha'); const existing = await get('responsibles', date).catch(()=>null); if(existing && existing.name && existing.name !== name){ if(!confirm(`Ya existe un responsable para ${date}: "${existing.name}". Â¿Sobrescribir?`)) return; } await put('responsibles', { date, name }); alert('Responsable guardado'); await refreshAll(); });
    async function updateResponsibleBanner(){ const today = todayYMD(); $('#responsible-date').value = today; const r = await get('responsibles', today).catch(()=>null); if(r && r.name){ $('#responsible-display').textContent = `${r.name} (${today})`; $('#responsible-name').value = r.name; } else { $('#responsible-display').textContent = 'Sin encargado asignado para hoy'; $('#responsible-name').value = ''; } }

    // Charts
    let chartSales, chartStock, chartDailySales;
    function updateCharts(){
      try{
        const salesData = state.sales.slice(-8).map(s=>({ x:new Date(s.date).toLocaleString(), y:s.total }));
        const ctxS = $('#chart-sales').getContext('2d'); if(chartSales) chartSales.destroy();
        chartSales = new Chart(ctxS, { type:'bar', data:{ labels:salesData.map(s=>s.x), datasets:[{ label:'Ventas', data:salesData.map(s=>s.y) }]}, options:{ responsive:true }});
        const stockData = state.products.slice().sort((a,b)=>b.stock-a.stock).slice(0,6);
        const ctxSt = $('#chart-stock').getContext('2d'); if(chartStock) chartStock.destroy();
        chartStock = new Chart(ctxSt, { type:'pie', data:{ labels:stockData.map(p=>p.name), datasets:[{ label:'Stock', data:stockData.map(p=>p.stock) }]}, options:{ responsive:true }});
      }catch(e){ console.warn('updateCharts', e); }
    }

    // REPORTS: include Ventas por cobrar in range
    async function generateSalesRange(from, to){
      const salesAll = await all('sales');
      const list = salesAll.filter(s=>{ const d = localYMDFromISO(s.date); return d >= from && d <= to; }).sort((a,b)=>a.date.localeCompare(b.date));
      let total = 0; let rows='';
      const creditRows = [];
      for(const s of list){
        const d = new Date(s.date).toLocaleString();
        total += Number(s.total||0);
        const payment = s.paymentType || (s.paid? 'EFECTIVO':'A_CREDITO');
        const items = s.items.map(it=>{ const p = state.products.find(x=>x.id===it.productId); return `${p? p.name : it.productId} (${it.qty} x ${money(it.price)})`; }).join('<br>');
        rows += `<tr><td class="print-td">${d}</td><td class="print-td">${s.id}</td><td class="print-td">${s.customerName || '-'}</td><td class="print-td">${s.responsible || '-'}</td><td class="print-td">${payment}</td><td class="print-td">${items}</td><td class="print-td" style="text-align:right">${money(s.total)}</td></tr>`;
        if((s.paymentType === 'A_CREDITO') || (!s.paid && s.paymentType !== 'EFECTIVO' && s.paymentType !== 'YAPE')) {
          creditRows.push({ sale: s, d, items });
        }
      }

      // responsible today (or use first responsible in range)
      const respObj = await get('responsibles', from).catch(()=>null);
      const responsibleName = (respObj && respObj.name) ? respObj.name : (await get('responsibles', todayYMD()).catch(()=>null) || {}).name || '';

      const creditHtml = creditRows.length ? creditRows.map(c=>`<tr><td class="print-td">${c.d}</td><td class="print-td">${c.sale.id}</td><td class="print-td">${c.sale.customerName || '-'}</td><td class="print-td">${c.sale.responsible || '-'}</td><td class="print-td">${c.sale.paymentType || 'A_CREDITO'}</td><td class="print-td">${c.items}</td><td class="print-td" style="text-align:right">${money(c.sale.total)}</td></tr>`).join('') : '<tr><td colspan="7" style="padding:12px;text-align:center;color:#666">No hay ventas por cobrar</td></tr>';

      const html = `
        <div class="report-wrapper" style="padding:6mm;font-family:Arial,Helvetica,sans-serif;color:#111">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <div>
              <h2 style="margin:0">MINIMARKET LA ESQUINA DEL AHORRO</h2>
              <div style="font-size:12px;margin-top:4px">Reporte de ventas</div>
            </div>
            <div style="font-size:12px;text-align:right">
              Periodo: ${from} â†’ ${to}<br>
              Generado: ${new Date().toLocaleString()}<br>
              Encargado: ${responsibleName || '-'}
            </div>
          </div>
          <hr style="margin:6px 0">
          <h4 style="margin:6px 0">Ventas</h4>
          <table style="width:100%;border-collapse:collapse;font-size:12px">
            <thead>
              <tr><th style="background:#f3f4f6;padding:6px;text-align:left">Fecha</th><th style="background:#f3f4f6;padding:6px;text-align:left">ID</th><th style="background:#f3f4f6;padding:6px;text-align:left">Cliente</th><th style="background:#f3f4f6;padding:6px;text-align:left">Encargado</th><th style="background:#f3f4f6;padding:6px;text-align:left">Pago</th><th style="background:#f3f4f6;padding:6px;text-align:left">Items</th><th style="background:#f3f4f6;padding:6px;text-align:right">Total</th></tr>
            </thead>
            <tbody>
              ${rows || '<tr><td colspan="7" style="padding:12px;text-align:center;color:#666">No hay ventas</td></tr>'}
            </tbody>
          </table>
          <div style="text-align:right;font-weight:bold;margin-top:8px">Total perÃ­odo: S/ ${money(total)}</div>

          <hr style="margin:8px 0">

          <h4 style="margin:6px 0">Ventas por cobrar (A CREDITO)</h4>
          <table style="width:100%;border-collapse:collapse;font-size:12px">
            <thead>
              <tr><th style="background:#f3f4f6;padding:6px;text-align:left">Fecha</th><th style="background:#f3f4f6;padding:6px;text-align:left">ID</th><th style="background:#f3f4f6;padding:6px;text-align:left">Cliente</th><th style="background:#f3f4f6;padding:6px;text-align:left">Encargado</th><th style="background:#f3f4f6;padding:6px;text-align:left">Pago</th><th style="background:#f3f4f6;padding:6px;text-align:left">Items</th><th style="background:#f3f4f6;padding:6px;text-align:right">Total</th></tr>
            </thead>
            <tbody>
              ${creditHtml}
            </tbody>
          </table>
        </div>`;
      return { html, list, total };
    }

    async function generateSalesByDay(from,to){
      const salesAll = await all('sales');
      const filtered = salesAll.filter(s=>{ const d = localYMDFromISO(s.date); return d>=from && d<=to; });
      const map = {};
      for(const s of filtered){ const day = localYMDFromISO(s.date); if(!map[day]) map[day] = { total:0, count:0 }; map[day].total += Number(s.total||0); map[day].count += 1; }
      const days = Object.keys(map).sort();
      let rows=''; let grand=0;
      for(const d of days){ rows += `<tr><td class="print-td">${d}</td><td class="print-td">${map[d].count}</td><td class="print-td" style="text-align:right">${money(map[d].total)}</td></tr>`; grand += map[d].total; }
      const html = `
        <div style="padding:6mm;font-family:Arial,Helvetica,sans-serif;color:#111">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <div>
              <h2 style="margin:0">MINIMARKET LA ESQUINA DEL AHORRO</h2>
              <div style="font-size:12px;margin-top:4px">Ventas por dÃ­a</div>
            </div>
            <div style="font-size:12px;text-align:right">
              Periodo: ${from} â†’ ${to}<br>
              Generado: ${new Date().toLocaleString()}
            </div>
          </div>
          <hr style="margin:6px 0">
          <table style="width:100%;border-collapse:collapse;font-size:12px">
            <thead><tr><th style="background:#f3f4f6;padding:6px;text-align:left">Fecha</th><th style="background:#f3f4f6;padding:6px;text-align:left">Cantidad ventas</th><th style="background:#f3f4f6;padding:6px;text-align:right">Total (S/)</th></tr></thead>
            <tbody>${rows || '<tr><td colspan="3" style="padding:12px;text-align:center;color:#666">No hay ventas</td></tr>'}</tbody>
          </table>
          <div style="text-align:right;font-weight:bold;margin-top:8px">Total perÃ­odo: S/ ${money(grand)}</div>
        </div>`;
      const chartData = { labels: days, values: days.map(d=>map[d].total) };
      return { html, chartData, days };
    }

    async function generateInventoryReport(){
      const products = await all('products');
      let rows=''; let lowCount=0;
      products.sort((a,b)=>a.name.localeCompare(b.name));
      for(const p of products){ const low = (p.stock||0) <= 5; if(low) lowCount++; rows += `<tr><td class="print-td">${p.name}</td><td class="print-td">${p.category||''}</td><td class="print-td">${p.barcode||''}</td><td class="print-td" style="text-align:right">${p.stock||0}</td><td class="print-td" style="text-align:right">${money(p.price)}</td></tr>`; }
      const html = `
        <div style="padding:6mm;font-family:Arial,Helvetica,sans-serif;color:#111">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <div>
              <h2 style="margin:0">MINIMARKET LA ESQUINA DEL AHORRO</h2>
              <div style="font-size:12px;margin-top:4px">Reporte de inventario</div>
            </div>
            <div style="font-size:12px;text-align:right">Generado: ${new Date().toLocaleString()}</div>
          </div>
          <hr style="margin:6px 0">
          <div style="margin:8px 0">Productos: ${products.length} â€¢ Stocks bajos: ${lowCount}</div>
          <table style="width:100%;border-collapse:collapse;font-size:12px">
            <thead><tr><th style="background:#f3f4f6;padding:6px;text-align:left">Nombre</th><th style="background:#f3f4f6;padding:6px;text-align:left">CategorÃ­a</th><th style="background:#f3f4f6;padding:6px;text-align:left">CÃ³digo</th><th style="background:#f3f4f6;padding:6px;text-align:right">Stock</th><th style="background:#f3f4f6;padding:6px;text-align:right">Precio</th></tr></thead>
            <tbody>${rows || '<tr><td colspan="5" style="padding:12px;text-align:center;color:#666">No hay productos</td></tr>'}</tbody>
          </table>
        </div>`;
      return { html, products };
    }

    // Convert HTML (element or html string) to A4 PDF with paging
    async function generatePDFfromHTML(htmlContentOrElement, filename){
      // Create an element wrapper if string provided
      let element;
      if(typeof htmlContentOrElement === 'string'){
        element = document.createElement('div');
        element.style.width = '800px'; // fixed width for consistent rendering
        element.innerHTML = htmlContentOrElement;
      } else {
        element = htmlContentOrElement;
      }

      // Render using html2canvas with high scale for quality
      const scale = 2; // increase for sharper text
      const canvas = await html2canvas(element, { scale: scale, useCORS: true, logging:false });
      const imgData = canvas.toDataURL('image/png');

      // A4 dimensions in mm
      const pdf = new jspdf.jsPDF('p','mm','a4');
      const pageWidthMM = 210;
      const pageHeightMM = 297;
      const marginMM = 10;
      const usableWidthMM = pageWidthMM - marginMM*2;

      // compute image real height in mm
      // image width in px = canvas.width
      // ratio mm/px = usableWidthMM / canvas.width
      const imgWidthMM = usableWidthMM;
      const pxToMm = imgWidthMM / canvas.width;
      const imgHeightMMTotal = canvas.height * pxToMm;

      if(imgHeightMMTotal <= (pageHeightMM - marginMM*2)){
        // single page
        pdf.addImage(imgData, 'PNG', marginMM, marginMM, imgWidthMM, imgHeightMMTotal);
        pdf.save(filename);
      } else {
        // multi-page: slice canvas vertically
        const pxPerPage = Math.floor((pageHeightMM - marginMM*2) / pxToMm); // height in px per page
        let remainingHeight = canvas.height;
        let position = 0;
        let page = 0;
        while(remainingHeight > 0){
          const sliceHeight = Math.min(pxPerPage, remainingHeight);
          // create temp canvas for slice
          const tmpCanvas = document.createElement('canvas');
          tmpCanvas.width = canvas.width;
          tmpCanvas.height = sliceHeight;
          const tctx = tmpCanvas.getContext('2d');
          tctx.drawImage(canvas, 0, position, canvas.width, sliceHeight, 0, 0, canvas.width, sliceHeight);
          const sliceData = tmpCanvas.toDataURL('image/png');
          const sliceHeightMM = sliceHeight * pxToMm;
          if(page > 0) pdf.addPage();
          pdf.addImage(sliceData, 'PNG', marginMM, marginMM, imgWidthMM, sliceHeightMM);
          remainingHeight -= sliceHeight;
          position += sliceHeight;
          page++;
        }
        pdf.save(filename);
      }
    }

    // UI: tabs
    $('#tab-sales-range').addEventListener('click', ()=> showTab('sales-range'));
    $('#tab-sales-day').addEventListener('click', ()=> showTab('sales-day'));
    $('#tab-inventory').addEventListener('click', ()=> showTab('inventory'));
    function showTab(name){
      $$('.tab-content').forEach(el=> el.classList.add('hidden'));
      $('#tab-content-sales-range').classList.toggle('hidden', name !== 'sales-range');
      $('#tab-content-sales-day').classList.toggle('hidden', name !== 'sales-day');
      $('#tab-content-inventory').classList.toggle('hidden', name !== 'inventory');
      $('#tab-sales-range').classList.toggle('bg-indigo-600', name==='sales-range'); $('#tab-sales-range').classList.toggle('text-white', name==='sales-range');
      $('#tab-sales-day').classList.toggle('bg-indigo-600', name==='sales-day'); $('#tab-sales-day').classList.toggle('text-white', name==='sales-day');
      $('#tab-inventory').classList.toggle('bg-indigo-600', name==='inventory'); $('#tab-inventory').classList.toggle('text-white', name==='inventory');
    }

    // Range generate & PDF
    $('#btn-generate-range').addEventListener('click', async ()=> {
      const from = $('#report-from').value; const to = $('#report-to').value; if(!from||!to) return alert('Selecciona rango');
      const { html } = await generateSalesRange(from,to);
      $('#report-preview-range').innerHTML = html;
    });
    $('#btn-pdf-range').addEventListener('click', async ()=> {
      const from = $('#report-from').value; const to = $('#report-to').value; if(!from||!to) return alert('Selecciona rango');
      const { html } = await generateSalesRange(from,to);
      const wrapper = document.createElement('div'); wrapper.style.width='800px'; wrapper.innerHTML = html;
      await generatePDFfromHTML(wrapper, `Reporte_Ventas_${from}_a_${to}.pdf`);
    });

    // Day generate & PDF
    $('#btn-generate-day').addEventListener('click', async ()=> {
      const from = $('#day-from').value; const to = $('#day-to').value; if(!from||!to) return alert('Selecciona rango');
      const { html, chartData } = await generateSalesByDay(from,to);
      $('#report-preview-day').innerHTML = html;
      try{ const ctx = $('#chart-daily-sales').getContext('2d'); if(chartDailySales) chartDailySales.destroy(); chartDailySales = new Chart(ctx, { type:'line', data:{ labels: chartData.labels, datasets:[{ label:'Ventas por dÃ­a', data: chartData.values, fill:true }]}, options:{ responsive:true } }); }catch(e){ console.warn('chart daily', e); }
    });
    $('#btn-pdf-day').addEventListener('click', async ()=> {
      const from = $('#day-from').value; const to = $('#day-to').value; if(!from||!to) return alert('Selecciona rango');
      const { html } = await generateSalesByDay(from,to);
      const wrapper = document.createElement('div'); wrapper.style.width='800px'; wrapper.innerHTML = html;
      await generatePDFfromHTML(wrapper, `Reporte_VentasPorDia_${from}_a_${to}.pdf`);
    });

    // Inventory generate & PDF
    $('#btn-generate-inv').addEventListener('click', async ()=> { const { html } = await generateInventoryReport(); $('#report-preview-inv').innerHTML = html; });
    $('#btn-pdf-inv').addEventListener('click', async ()=> { const { html } = await generateInventoryReport(); const wrapper = document.createElement('div'); wrapper.style.width='800px'; wrapper.innerHTML = html; await generatePDFfromHTML(wrapper, `Reporte_Inventario_${new Date().toISOString().slice(0,10)}.pdf`); });

    $('#btn-open-report').addEventListener('click', ()=> { showModal('modal-reports'); showTab('sales-range'); });

    /* ===============
       Scanner (OpenCV + BarcodeDetector + Quagga fallback)
       =============== */
    let cvReady=false, awaitingCvInit=false;
    if(window.cv && cv['onRuntimeInitialized']){ awaitingCvInit=true; cv['onRuntimeInitialized']=()=>{ cvReady=true; awaitingCvInit=false; console.info('OpenCV ready'); }; } else if(window.cv){ cvReady=true; }
    const video = $('#video'); let videoStream=null, currentVideoTrack=null;
    let detectionLoop=false, quaggaActive=false, readBuffer=[];
    const READ_CONFIRM=4, READ_WINDOW_MS=2200;
    let overlayCanvas = $('#overlay-canvas'); let overlayCtx = overlayCanvas ? overlayCanvas.getContext('2d') : null;
    function resizeOverlay(){ overlayCanvas = $('#overlay-canvas'); if(!overlayCanvas) return; overlayCanvas.width = video.clientWidth; overlayCanvas.height = video.clientHeight; overlayCtx = overlayCanvas.getContext('2d'); }
    function clearOverlay(){ if(!overlayCtx) resizeOverlay(); overlayCtx && overlayCtx.clearRect(0,0,overlayCanvas.width, overlayCanvas.height); }
    function pushRead(code){ const now = Date.now(); readBuffer = readBuffer.filter(r=> now - r.t < READ_WINDOW_MS); readBuffer.push({ code, t: now }); const last = readBuffer.slice(-READ_CONFIRM); if(last.length >= READ_CONFIRM && last.every(x=> x.code === last[0].code)) return last[0].code; return null; }

    async function startCameraHighRes(){
      try{
        const constraints = { audio:false, video:{ facingMode:{ ideal:'environment' }, width:{ ideal:1920 }, height:{ ideal:1080 }, advanced:[{ focusMode:'continuous' }] } };
        videoStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = videoStream; currentVideoTrack = videoStream.getVideoTracks()[0];
        const caps = currentVideoTrack.getCapabilities ? currentVideoTrack.getCapabilities() : {};
        if(caps && caps.torch) $('#toggle-torch').classList.remove('hidden'); else $('#toggle-torch').classList.add('hidden');
        await video.play(); resizeOverlay();
      }catch(err){ console.warn('startCameraHighRes', err); alert('No se pudo acceder a la cÃ¡mara. Ver permisos o abrir en https/localhost.'); throw err; }
    }

    async function captureProcessedFrame(){
      const w = video.videoWidth || 1280, h = video.videoHeight || 720;
      const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d'); ctx.filter = 'contrast(140%) brightness(105%) saturate(115%)'; ctx.drawImage(video, 0, 0, w, h);
      if(cvReady){
        try{
          let src = cv.imread(canvas);
          let gray = new cv.Mat(); cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
          let blurred = new cv.Mat(); cv.bilateralFilter(gray, blurred, 9, 75, 75, cv.BORDER_DEFAULT);
          let clahe = new cv.Mat();
          try{ let claheObj = new cv.CLAHE(3.0, new cv.Size(8,8)); claheObj.apply(blurred, clahe); claheObj.delete(); }catch(x){ cv.equalizeHist(blurred, clahe); }
          let thresh = new cv.Mat(); cv.adaptiveThreshold(clahe, thresh, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 47, 10);
          let kernel = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(3,3)); cv.morphologyEx(thresh, thresh, cv.MORPH_CLOSE, kernel);
          let out = new cv.Mat(); cv.cvtColor(thresh, out, cv.COLOR_GRAY2RGBA); cv.imshow(canvas, out);
          src.delete(); gray.delete(); blurred.delete(); clahe.delete(); thresh.delete(); kernel.delete(); out.delete();
          const bitmap = await createImageBitmap(canvas); return bitmap;
        }catch(err){ console.warn('OpenCV processing error', err); return await createImageBitmap(canvas); }
      } else {
        return await createImageBitmap(canvas);
      }
    }

    function computeROI(bitmap){ const bw = bitmap.width, bh = bitmap.height; const w = Math.floor(bw * 0.6), h = Math.floor(bh * 0.28); const sx = Math.floor((bw-w)/2), sy = Math.floor((bh-h)/2); return { sx, sy, sw: w, sh: h }; }

    async function startBarcodeDetection(){
      if(!isAuthenticated()) return showLogin();
      $('#scanned-code').value=''; readBuffer=[];
      if(awaitingCvInit){ while(awaitingCvInit) await new Promise(r=>setTimeout(r,100)); }
      try{
        if('BarcodeDetector' in window){
          const detector = new BarcodeDetector({ formats: ['ean_13','code_128','upc_e','upc_a','ean_8'] });
          await startCameraHighRes();
          detectionLoop = true;
          while(detectionLoop){
            if(!video || video.readyState < 2){ await new Promise(r=>setTimeout(r,100)); continue; }
            try{
              const bitmap = await captureProcessedFrame();
              const roi = computeROI(bitmap);
              const cropped = await createImageBitmap(bitmap, roi.sx, roi.sy, roi.sw, roi.sh);
              const barcodes = await detector.detect(cropped);
              clearOverlay(); drawROI(roi);
              if(barcodes && barcodes.length>0){
                const candidate = (barcodes[0].rawValue || '').trim();
                const confirmed = pushRead(candidate);
                if(confirmed){ $('#scanned-code').value = confirmed; showConfirmation(confirmed); await new Promise(r=>setTimeout(r,900)); }
              }
              bitmap.close(); cropped.close();
            }catch(err){
              console.warn('BarcodeDetector loop error', err); detectionLoop=false; fallbackQuagga(); break;
            }
            await new Promise(r=>setTimeout(r,80));
          }
          return;
        } else {
          fallbackQuagga();
        }
      }catch(err){ console.warn('startBarcodeDetection', err); fallbackQuagga(); }
    }

    function drawROI(roi){ if(!overlayCtx) resizeOverlay(); const scaleX = overlayCanvas.width / (video.videoWidth || 1); const scaleY = overlayCanvas.height / (video.videoHeight || 1); overlayCtx.strokeStyle='rgba(0,255,100,0.9)'; overlayCtx.lineWidth=3; overlayCtx.strokeRect(roi.sx*scaleX, roi.sy*scaleY, roi.sw*scaleX, roi.sh*scaleY); }
    function showConfirmation(text){ if(!overlayCtx) resizeOverlay(); overlayCtx.font='20px monospace'; overlayCtx.fillStyle='rgba(0,0,0,0.6)'; const x=10, y=30; const w = overlayCtx.measureText(text).width + 20; overlayCtx.fillRect(x, y-22, w, 28); overlayCtx.fillStyle='white'; overlayCtx.fillText(text, x+8, y); }

    function fallbackQuagga(){
      startCameraHighRes().then(()=>{
        if(!window.Quagga) return alert('Quagga fallback no disponible');
        quaggaActive = true;
        Quagga.init({
          inputStream:{ name:'Live', type:'LiveStream', target:'#video', constraints:{ facingMode:'environment', width:1280, height:720 } },
          locator:{ patchSize:'large', halfSample:false },
          decoder:{ readers:['ean_reader','ean_8_reader','code_128_reader','upc_reader','upc_e_reader'] },
          locate:true
        }, err=>{ if(err){ console.error('Quagga init', err); return; } Quagga.start(); });

        Quagga.onProcessed(result=>{
          clearOverlay();
          if(!result) return;
          if(result.boxes) result.boxes.filter(b=>b!==result.box).forEach(b=> drawPath(b,'rgba(255,255,255,0.2)'));
          if(result.box) drawPath(result.box,'lime');
        });

        Quagga.onDetected(data=>{
          const code = data && data.codeResult && data.codeResult.code;
          if(code){
            const confirmed = pushRead(code);
            if(confirmed){ $('#scanned-code').value = confirmed; try{ Quagga.stop(); }catch(e){} }
          }
        });

        function drawPath(path,color){ if(!overlayCtx) resizeOverlay(); overlayCtx.strokeStyle=color; overlayCtx.lineWidth=3; overlayCtx.beginPath(); overlayCtx.moveTo(path[0].x, path[0].y); for(let i=1;i<path.length;i++) overlayCtx.lineTo(path[i].x, path[i].y); overlayCtx.closePath(); overlayCtx.stroke(); }
      }).catch(e=>console.warn('fallbackQuagga camera fail', e));
    }

    async function stopCamera(){ detectionLoop=false; if(quaggaActive && window.Quagga){ try{ Quagga.stop(); }catch(e){} quaggaActive=false; } if(videoStream) videoStream.getTracks().forEach(t=>t.stop()); video.srcObject = null; videoStream=null; currentVideoTrack=null; clearOverlay(); readBuffer=[]; }

    // scanner buttons/events
    $('#open-scan').addEventListener('click', ()=> { if(!isAuthenticated()) return showLogin(); showModal('modal-scan'); startBarcodeDetection().catch(()=>{}); });
    $('#stop-camera').addEventListener('click', async ()=> stopCamera());
    $('#toggle-torch').addEventListener('click', async ()=> { if(!currentVideoTrack) return alert('CÃ¡mara no activada'); try{ const caps = currentVideoTrack.getCapabilities(); if(!caps.torch) return alert('Linterna no soportada'); await currentVideoTrack.applyConstraints({ advanced:[{ torch:true }] }); }catch(e){ console.warn('torch', e); alert('Linterna no soportada'); } });
    $('#fill-product').addEventListener('click', ()=> { const code = $('#scanned-code').value.trim(); if(!code) return alert('No hay cÃ³digo detectado'); const p = findProductByCode(code); if(p) openProductModal(p); else { $('#product-barcode').value = code; openProductModal(); } });
    $('#quick-sell-detected').addEventListener('click', async ()=> { const code = $('#scanned-code').value.trim(); if(!code) return alert('No hay cÃ³digo detectado'); const p = findProductByCode(code); if(!p){ if(!confirm('Producto no encontrado. Â¿Crear nuevo?')) return; $('#product-barcode').value = code; openProductModal(); return; } const qty = Number(prompt('Cantidad a vender (rÃ¡pido):','1'))||1; const payment = prompt('Tipo pago: EFECTIVO, YAPE o A_CREDITO','EFECTIVO') || 'EFECTIVO'; let customer=null; if(payment.toUpperCase()==='A_CREDITO') customer = prompt('Nombre del cliente:') || null; p.stock=(p.stock||0)-qty; await put('products', p); await add('movements', { id:uid(), type:'sale', productId:p.id, qty, date:new Date().toISOString() }); const total = qty * p.price; const date = new Date().toISOString(); const respDate = ($('#responsible-date').value) ? $('#responsible-date').value : todayYMD(); const responsibleObj = await get('responsibles', respDate).catch(()=>null); const responsibleName = (responsibleObj && responsibleObj.name) ? responsibleObj.name : ($('#responsible-name').value.trim()||''); await add('sales', { id:uid(), items:[{ productId:p.id, qty, price:p.price }], total, date, customerName: customer, paid: (payment.toUpperCase()!=='A_CREDITO'), paymentType: payment.toUpperCase(), responsible: responsibleName }); if(payment.toUpperCase()==='A_CREDITO' && customer){ const existing = await get('customers', customer).catch(()=>null); const prev = existing && existing.balance ? existing.balance : 0; await put('customers', { name: customer, balance: prev + total, lastSale: date }); } alert('Venta rÃ¡pida registrada'); await refreshAll(); });

    function findProductByCode(code){
      const norm = (code||'').replace(/\D/g,'');
      let p = state.products.find(x => (x.barcode||'') === code || (x.barcode||'').replace(/\D/g,'') === norm);
      if(!p && norm.length>6) p = state.products.find(x => (x.barcode||'').replace(/\D/g,'').endsWith(norm));
      return p;
    }

    // Quick sell from inventory
    async function quickSellPrompt(productId){
      const qtyStr = prompt('Cantidad a vender (rÃ¡pido):','1'); if(!qtyStr) return;
      const qty = Math.max(1, Number(qtyStr));
      const payment = prompt('Tipo pago: EFECTIVO, YAPE o A_CREDITO','EFECTIVO') || 'EFECTIVO';
      let customerName = null; if(payment.toUpperCase()==='A_CREDITO') customerName = prompt('Nombre del cliente:') || null;
      const prod = state.products.find(p=>p.id===productId); if(!prod) return alert('Producto no encontrado');
      prod.stock = (prod.stock||0) - qty; await put('products', prod);
      await add('movements', { id:uid(), type:'sale', productId, qty, date:new Date().toISOString() });
      const total = qty * prod.price; const date = new Date().toISOString();
      const respDate = ($('#responsible-date').value) ? $('#responsible-date').value : todayYMD();
      const responsibleObj = await get('responsibles', respDate).catch(()=>null);
      const responsibleName = (responsibleObj && responsibleObj.name) ? responsibleObj.name : ($('#responsible-name').value.trim()||'');
      await add('sales', { id:uid(), items:[{ productId, qty, price: prod.price }], total, date, customerName, paid: (payment.toUpperCase()!=='A_CREDITO'), paymentType: payment.toUpperCase(), responsible: responsibleName });
      if(payment.toUpperCase()==='A_CREDITO' && customerName){ const existing = await get('customers', customerName).catch(()=>null); const prev = existing && existing.balance ? existing.balance : 0; await put('customers', { name: customerName, balance: prev + total, lastSale: date }); }
      await refreshAll();
    }

    // Init app and seed
    async function initApp(){
      await openDB();
      const products = await all('products');
      if(products.length===0){
        const seed = [
          { id:uid(), name:'Coca Cola 500ml', category:'Bebidas', price:10.99, barcode:'7758753103282', stock:48, createdAt:new Date().toISOString() },
          { id:uid(), name:'Agua San Luis 625ml', category:'Bebidas', price:3.50, barcode:'7752482381011', stock:32, createdAt:new Date().toISOString() }
        ];
        for(const p of seed) await put('products', p);
      }
      await refreshAll();
      const today = todayYMD(); const r = await get('responsibles', today).catch(()=>null);
      if(!r){ const name = prompt(`No hay encargado registrado para hoy (${today}). Ingresa su nombre (opcional):`); if(name !== null && name.trim() !== '') await put('responsibles', { date: today, name: name.trim() }); }
      updateResponsibleBanner();
      showTab('sales-range');
      $('#search').addEventListener('input', debounce(e => renderInventoryMobile(e.target.value), 180));
      window.addEventListener('resize', ()=>{ try{ resizeOverlay(); }catch(e){} });
    }

    if(isAuthenticated()){ $('#current-user').textContent = localStorage.getItem(AUTH_KEY); $('#current-user').classList.remove('hidden'); $('#btn-logout').classList.remove('hidden'); closeLogin(); initApp(); }

  }); // DOMContentLoaded
  </script>
</body>
</html>

