<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>MINIMARKET LA ESQUINA DEL AHORRO — TiendaSmart (Producción)</title>

<!-- Tailwind + lucide (icons) -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<!-- Utilities: XLSX, html2canvas, jsPDF -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Quagga fallback -->
<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700;800&family=Work+Sans:wght@300;400;500;600;700&display=swap');
  :root{
    --primary:#0f766e;
    --primary-2:#0b3b38;
    --accent:#f59e0b;
    --success:#16a34a;
    --danger:#ef4444;
    --bg:#f5f7fb;
    --card:#ffffff;
    --maxw:420px;
    --ring:rgba(15,118,110,0.18);
    --shadow:0 12px 30px rgba(15,23,42,0.10);
  }
  *{box-sizing:border-box}
  body{
    font-family:'Work Sans', system-ui, -apple-system, Segoe UI, sans-serif;
    background:
      radial-gradient(900px 400px at 8% -10%, rgba(13,148,136,0.14), transparent 60%),
      radial-gradient(700px 350px at 92% -15%, rgba(245,158,11,0.14), transparent 55%),
      var(--bg);
    margin:0;
    color:#0f172a;
    -webkit-font-smoothing:antialiased;
  }
  body:before{
    content:'';
    position:fixed;
    inset:-30% -10% auto -10%;
    height:220px;
    background: linear-gradient(90deg, rgba(255,255,255,0.0), rgba(255,255,255,0.55), rgba(255,255,255,0.0));
    opacity:0.35;
    pointer-events:none;
    z-index:0;
  }
  .app-shell{
    position:relative;
    z-index:1;
    max-width:var(--maxw);
    margin:0 auto;
    min-height:100vh;
    display:flex;
    flex-direction:column;
    padding-bottom:120px;
  }
  header{
    position:sticky;
    top:0;
    z-index:60;
    background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
    backdrop-filter:blur(10px);
    padding:12px;
    border-bottom:1px solid rgba(15,23,42,0.06);
    display:flex;
    align-items:center;
    justify-content:space-between;
  }
  .app-title{
    font-family:'Sora', sans-serif;
    font-size:11px;
    font-weight:700;
    letter-spacing:0.16em;
    color:#64748b;
  }
  .app-sub{
    margin:0;
    font-family:'Sora', sans-serif;
    font-weight:800;
    font-size:18px;
  }
  .card{
    background:var(--card);
    border-radius:14px;
    padding:12px;
    box-shadow:var(--shadow);
    border:1px solid #eef2f7;
    margin-bottom:12px;
  }
  .stat-hero{
    background:linear-gradient(180deg, var(--primary), var(--primary-2));
    color:#fff;
    border:none;
  }
  .stat-card{
    background:rgba(255,255,255,0.9);
  }
  .input-pro{
    width:100%;
    padding:10px;
    border-radius:12px;
    border:1px solid #e6e8eb;
    background:#fff;
    outline:none;
    transition:border-color .15s ease, box-shadow .15s ease;
  }
  .input-pro:focus{
    border-color:var(--primary);
    box-shadow:0 0 0 4px var(--ring);
  }
  .btn-primary{
    background:linear-gradient(180deg, var(--primary), var(--primary-2));
    color:white;
    padding:10px;
    border-radius:12px;
    font-weight:700;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    box-shadow:0 10px 18px rgba(15,118,110,0.25);
  }
  .modal{
    position:fixed;
    inset:0;
    background:rgba(3,7,18,0.45);
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
    z-index:100;
  }
  .modal.visible{display:flex}
  .modal-sheet{
    width:100%;
    max-width:760px;
    background:white;
    border-radius:16px;
    padding:16px;
    max-height:calc(100dvh - 40px);
    overflow:auto;
    box-shadow:0 18px 60px rgba(2,6,23,0.18);
  }
  .modal.visible .modal-sheet{animation:pop .18s ease}
  .bottom-nav{
    position:fixed;
    left:0;
    right:0;
    bottom:0;
    display:flex;
    justify-content:space-around;
    padding:10px 12px;
    background:rgba(255,255,255,0.96);
    border-top:1px solid rgba(15,23,42,0.06);
    z-index:80;
    backdrop-filter:blur(8px);
  }
  .nav-btn{display:flex;flex-direction:column;align-items:center;font-size:12px}
  .dropdown-suggestions{
    position:absolute;
    background:white;
    border:1px solid #eef2ff;
    width:100%;
    max-height:240px;
    overflow:auto;
    border-radius:10px;
    z-index:200;
    box-shadow:0 12px 30px rgba(15,23,42,0.12);
  }
  .suggestion-item{padding:8px;border-radius:8px;cursor:pointer}
  .suggestion-item:hover{background:#f1f5f9}
  .toast{position:fixed;left:50%;transform:translateX(-50%);top:18px;z-index:120}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #f1f5f9;font-size:13px}
  .small-muted{font-size:12px;color:#6b7280}
  .status-dot{width:10px;height:10px;border-radius:999px;display:inline-block}
  .pay-btn{font-weight:700;transition:all .15s ease}
  .pay-btn.active{
    border-color:var(--primary) !important;
    background:rgba(15,118,110,0.12) !important;
    box-shadow:inset 0 0 0 1px var(--primary), 0 6px 14px rgba(15,118,110,0.18);
  }
  .qty-input{
    width:72px;
    text-align:center;
    padding:6px 8px;
  }

  .stock-summary{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .stock-chip{
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid #e2e8f0;
    background:#fff;
  }
  .stock-chip.stock-out{border-color:#fecaca;color:#b91c1c;background:#fff5f5}
  .stock-chip.stock-low{border-color:#fde68a;color:#92400e;background:#fffbeb}
  .stock-section{padding:10px}
  .stock-title{
    font-size:11px;
    font-weight:700;
    letter-spacing:0.12em;
    text-transform:uppercase;
    color:#64748b;
    margin-bottom:8px;
  }
  .stock-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    padding:8px;
    border-radius:10px;
    background:#f8fafc;
    border:1px solid #eef2f7;
    margin-bottom:6px;
  }
  .stock-badge{
    min-width:34px;
    text-align:center;
    font-weight:800;
    border-radius:999px;
    padding:4px 8px;
  }
  .stock-badge.out{background:#fee2e2;color:#b91c1c}
  .stock-badge.low{background:#fef3c7;color:#92400e}
  .stock-empty{text-align:center;color:#64748b}

  @keyframes rise{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  @keyframes pop{from{opacity:.7;transform:scale(.98)}to{opacity:1;transform:scale(1)}}
  .card{animation:rise .25s ease both}

  @media (max-width:420px){
    :root{--maxw:100vw}
    .modal-sheet{border-radius:14px;padding:12px}
  }
</style>
</head>
<body>

<div class="app-shell">

  <!-- Header -->
  <header>
    <div>
      <div class="app-title">MINIMARKET</div>
      <p class="app-sub">LA ESQUINA DEL AHORRO</p>
    </div>
    <div class="flex items-center gap-3">
      <div id="cloud-status" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100">
        <span id="dot" class="status-dot" style="background:#ef4444"></span>
        <span id="cloud-text" class="small-muted">Desconectado</span>
      </div>
      <button id="btn-gestion" class="px-3 py-2 bg-white rounded-lg border small-muted">GESTIÓN</button>
      <button id="btn-open-clients" class="px-3 py-2 bg-white rounded-lg border small-muted">CLIENTES</button>
      <button id="btn-sync" class="px-3 py-2 bg-white rounded-lg border small-muted">SYNC</button>
    </div>
  </header>

  <!-- Main content (home tab default) -->
  <main id="tab-home" class="px-4 pt-6">
    <div class="grid grid-cols-2 gap-3">
      <div class="card stat-hero">
        <div class="small-muted">Ventas Hoy</div>
        <div style="font-weight:800;font-size:22px" id="stat-ventas">S/ 0.00</div>
        <div class="small-muted mt-2">Resumen del día</div>
      </div>
      <div class="card stat-card">
        <div class="small-muted">Transacciones</div>
        <div style="font-weight:800;font-size:22px" id="stat-count">0</div>
        <div class="small-muted mt-2">POS activo</div>
      </div>
    </div>

    <div class="mt-4">
      <div class="small-muted uppercase font-bold text-xs mb-2">Acciones rápidas</div>
      <div class="grid grid-cols-4 gap-3">
        <button onclick="openModal('modal-sale')" class="flex flex-col items-center gap-2">
          <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center text-indigo-600"><i data-lucide="shopping-cart"></i></div>
          <span class="small-muted">Vender</span>
        </button>
        <button onclick="openModal('modal-product')" class="flex flex-col items-center gap-2">
          <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center text-emerald-600"><i data-lucide="package-plus"></i></div>
          <span class="small-muted">Producto</span>
        </button>
        <button onclick="switchTab('reports')" class="flex flex-col items-center gap-2">
          <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center text-amber-600"><i data-lucide="file-text"></i></div>
          <span class="small-muted">Reportes</span>
        </button>
        <button onclick="exportCombinedXLSX()" class="flex flex-col items-center gap-2">
          <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center text-slate-600"><i data-lucide="download"></i></div>
          <span class="small-muted">Exportar</span>
        </button>
      </div>
    </div>

    <div class="mt-4">
      <div class="flex justify-between items-center mb-2">
        <div class="small-muted uppercase font-bold text-xs">Alertas de stock</div>
        <button onclick="switchTab('inventory')" class="small-muted">Ver inventario</button>
      </div>
      <div id="low-stock-container"></div>
    </div>

  </main>

  <!-- Inventory tab -->
  <main id="tab-inventory" class="hidden px-4 pt-6">
    <div class="flex gap-2">
      <div class="relative flex-1">
        <i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-slate-400"></i>
        <input id="search-inv" class="input-pro pl-10" placeholder="Buscar producto (nombre o código)...">
        <div id="inv-suggestions" class="dropdown-suggestions hidden"></div>
      </div>
      <button onclick="startScanner()" class="bg-white p-3 rounded-xl border"><i data-lucide="scan-barcode" class="w-5 h-5 text-indigo-600"></i></button>
    </div>
    <div id="inventory-list" class="mt-4"></div>
  </main>

  <!-- Reports tab -->
  <main id="tab-reports" class="hidden px-4 pt-6">
    <h2 class="font-bold text-lg mb-3">Reportes</h2>
    <div class="card">
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="small-muted">Desde</label>
          <input type="date" id="rep-from" class="input-pro mt-1">
        </div>
        <div>
          <label class="small-muted">Hasta</label>
          <input type="date" id="rep-to" class="input-pro mt-1">
        </div>
      </div>
      <div class="flex gap-2 mt-3">
        <button onclick="previewReportRange()" class="btn-primary">Vista previa</button>
        <button onclick="exportReportRangeBothXLSX()" class="px-3 py-2 border rounded">Exportar XLSX</button>
        <button onclick="downloadReportPDF()" class="px-3 py-2 border rounded">Exportar PDF (A4)</button>
      </div>
    </div>
    <div id="report-summary" class="mt-4"></div>
  </main>

  <!-- bottom navigation -->
  <nav class="bottom-nav">
    <button onclick="switchTab('home')" class="nav-btn" data-tab="home"><i data-lucide="layout-grid"></i><span>Inicio</span></button>
    <button onclick="switchTab('inventory')" class="nav-btn" data-tab="inventory"><i data-lucide="box"></i><span>Stock</span></button>
    <button onclick="openModal('modal-sale')" class="nav-btn"><div class="w-14 h-14 bg-indigo-600 rounded-2xl text-white flex items-center justify-center -mt-6 shadow-lg"><i data-lucide="plus"></i></div><span>Vender</span></button>
    <button onclick="switchTab('reports')" class="nav-btn" data-tab="reports"><i data-lucide="bar-chart-big"></i><span>Reportes</span></button>
    <button onclick="logout()" class="nav-btn"><i data-lucide="log-out"></i><span>Salir</span></button>
  </nav>
</div>

<!-- MODALS: sale, product, scan, clients, gestion, login (definitions below) -->

<!-- Modal: Sale (POS) -->
<div id="modal-sale" class="modal" aria-hidden="true">
  <div class="modal-sheet" role="dialog" aria-modal="true" aria-labelledby="modal-sale-title">
    <div class="flex justify-between items-center mb-3">
      <h3 id="modal-sale-title" class="font-bold text-lg">Nueva Venta</h3>
      <button onclick="closeModal('modal-sale')"><i data-lucide="x"></i></button>
    </div>

    <div>
      <div class="relative">
        <i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-slate-400"></i>
        <input id="pos-search" class="input-pro pl-10" placeholder="Escribe o escanea producto... (coincide por letras)" aria-label="buscar producto">
        <div id="pos-suggestions" class="dropdown-suggestions hidden"></div>
      </div>

      <div id="pos-cart" class="mt-3 max-h-56 overflow-auto"></div>

      <div class="p-3 bg-slate-900 rounded-2xl text-white mt-3">
        <div class="flex justify-between items-center small-muted mb-1"><span>Total a pagar</span><span id="pos-items-count">0 items</span></div>
        <div style="font-size:28px;font-weight:800">S/ <span id="pos-total">0.00</span></div>
      </div>

      <div class="grid grid-cols-3 gap-2 mt-3">
        <button onclick="setPayMethod('EFECTIVO', event)" class="pay-btn active bg-indigo-50 border-2 border-indigo-600 p-3 rounded-xl">EFECTIVO</button>
        <button onclick="setPayMethod('YAPE', event)" class="pay-btn bg-slate-50 border-2 border-transparent p-3 rounded-xl">YAPE</button>
        <button onclick="setPayMethod('A_CREDITO', event)" class="pay-btn bg-slate-50 border-2 border-transparent p-3 rounded-xl">A CREDITO</button>
      </div>

      <input id="pos-customer" class="input-pro mt-3 hidden" placeholder="Nombre del cliente (Crédito)">

      <div class="flex gap-2 mt-3">
        <button onclick="completeSale()" class="btn-primary w-full py-3">FINALIZAR VENTA</button>
        <button onclick="startScanner()" class="px-3 py-3 bg-white border rounded"><i data-lucide="camera"></i></button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Product -->
<div id="modal-product" class="modal">
  <div class="modal-sheet">
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-bold text-lg">Gestionar Producto</h3>
      <button onclick="closeModal('modal-product')"><i data-lucide="x"></i></button>
    </div>

    <form id="form-p">
      <input type="hidden" id="p-id">
      <input id="p-name" class="input-pro" placeholder="Nombre del producto" required>
      <div class="grid grid-cols-2 gap-2 mt-2">
        <input id="p-barcode" class="input-pro" placeholder="Código">
        <input id="p-cat" class="input-pro" placeholder="Categoría">
      </div>

      <div class="grid grid-cols-2 gap-2 mt-2 p-2 bg-indigo-50 rounded">
        <div>
          <label class="small-muted">Costo total (factura)</label>
          <input id="p-cost" type="number" step="0.01" class="input-pro mt-1" value="0.00">
        </div>
        <div>
          <label class="small-muted">Precio venta</label>
          <input id="p-price" type="number" step="0.01" class="input-pro mt-1" value="0.00">
        </div>
      </div>

      <div class="grid grid-cols-2 gap-2 mt-2">
        <input id="p-stock" type="number" class="input-pro" placeholder="Stock actual">
        <button type="button" id="btn-delete-p" onclick="deleteProduct()" class="hidden bg-red-50 text-red-700 rounded px-3 py-2">Eliminar</button>
      </div>

      <div class="flex gap-2 mt-3">
        <button type="submit" class="btn-primary w-full">GUARDAR PRODUCTO</button>
        <button type="button" onclick="calculateUnitPrice()" class="px-3 py-2 border rounded">Calcular</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Scan -->
<div id="modal-scan" class="modal">
  <div class="modal-sheet" style="max-width:420px">
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-bold">Escáner</h3>
      <button onclick="closeModal('modal-scan')"><i data-lucide="x"></i></button>
    </div>
    <div id="scanner-preview" style="position:relative;height:44vh;background:#000;border-radius:12px;overflow:hidden;">
      <video id="video" autoplay muted playsinline style="width:100%;height:100%;object-fit:cover"></video>
      <canvas id="scan-canvas" style="position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:none"></canvas>
    </div>
    <div class="mt-2 flex gap-2">
      <button id="btn-scan-switch" onclick="switchScannerCamera()" class="px-3 py-2 border rounded text-sm">Cambiar cámara</button>
      <button onclick="restartScanner()" class="px-3 py-2 border rounded text-sm">Reiniciar</button>
    </div>
    <div class="mt-2 flex gap-2">
      <input id="scanned-code" class="input-pro" placeholder="Código detectado" readonly>
      <button onclick="registerScanned()" class="btn-primary px-4">Registrar</button>
    </div>
  </div>
</div>

<!-- Modal: Clients -->
<div id="modal-clients" class="modal">
  <div class="modal-sheet">
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-bold">Clientes y Créditos</h3>
      <button onclick="closeModal('modal-clients')"><i data-lucide="x"></i></button>
    </div>

    <form id="form-client" class="flex gap-2 mb-3">
      <input id="client-name" class="input-pro" placeholder="Nombre cliente">
      <input id="client-initial" type="number" step="0.01" class="input-pro w-36" placeholder="Saldo inicial">
      <button class="btn-primary">Agregar</button>
    </form>

    <div id="clients-list" style="max-height:50vh;overflow:auto"></div>
  </div>
</div>

<!-- Modal: Gestion -->
<div id="modal-gestion" class="modal">
  <div class="modal-sheet">
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-bold">Gestión de Ventas</h3>
      <div class="flex gap-2">
        <button onclick="exportSalesXLSX()" class="px-3 py-2 border rounded">Exportar Ventas</button>
        <button onclick="closeModal('modal-gestion')" class="px-3 py-2 border rounded">Cerrar</button>
      </div>
    </div>
    <div id="gestion-list" style="max-height:60vh;overflow:auto"></div>
  </div>
</div>

<!-- Modal: Login -->
<div id="login-screen" class="fixed inset-0 z-[200] bg-white flex flex-col items-center justify-center p-8">
  <div class="w-20 h-20 bg-indigo-600 rounded-2xl flex items-center justify-center mb-6">
    <i data-lucide="store" class="text-white w-10 h-10"></i>
  </div>
  <h2 class="text-2xl font-bold mb-1">TiendaSmart</h2>
  <p class="small-muted mb-4">Ingresa a tu punto de venta</p>
  <div class="w-full max-w-sm space-y-3">
    <input id="l-user" class="input-pro" placeholder="Usuario">
    <input id="l-pass" type="password" class="input-pro" placeholder="Contraseña">
    <div class="flex gap-2">
      <button id="btn-login" class="btn-primary w-full">ENTRAR</button>
      <button id="btn-demo" class="px-3 py-2 border rounded">Demo</button>
    </div>
    <div id="login-error" class="text-red-600 text-sm mt-2 hidden"></div>
  </div>
</div>

<!-- Toast root -->
<div id="toast-root" class="toast"></div>

<script>
/* ============================
   CONFIG / HELPERS / CONSTANTS
   ============================ */

/* Firebase config (tu proyecto) */
const firebaseConfig = {
  apiKey: "AIzaSyBh2WHinnQeRD9fsmdEMj9zkNVJNcixzS4",
  authDomain: "jhonatan-7ca7d.firebaseapp.com",
  projectId: "jhonatan-7ca7d",
  storageBucket: "jhonatan-7ca7d.firebasestorage.app",
  messagingSenderId: "248102422749",
  appId: "1:248102422749:web:097c4e553e610d27dff334"
};

/* DB path: contenedor que usas en Firestore (respeta formato del usuario)
   Nuevo modelo: MODO DE PREODUCCIÓN / MAGALY / {products, customers, sales}
   Legacy: MODO DE PREODUCCIÓN / DATOS (campo MAGALY) */
const DB = { col: "MODO DE PREODUCCIÓN", doc: "MAGALY", legacyDoc: "DATOS", field: "MAGALY" };

/* Shortcuts */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const uid = ()=> 'id-'+Math.random().toString(36).slice(2,9);
const money = v => Number(v||0).toFixed(2);
const todayYMD = ()=> { const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };
const isSameLocalDay = (dateStr, ref = new Date()) => {
  if(!dateStr) return false;
  const d = new Date(dateStr);
  if(Number.isNaN(d.getTime())) return false;
  return d.getFullYear() === ref.getFullYear() &&
         d.getMonth() === ref.getMonth() &&
         d.getDate() === ref.getDate();
};

/* Toast util (non-blocking) */
function showToast(msg, ms=1600){
  const root = document.getElementById('toast-root');
  if(!root) return;
  const el = document.createElement('div');
  el.className='bg-slate-900 text-white px-4 py-2 rounded-xl text-sm shadow-lg';
  el.style.marginTop='6px';
  el.textContent = msg;
  root.appendChild(el);
  setTimeout(()=> el.remove(), ms);
}

/* Simple escape for safety in HTML rendering */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;'); }
function escapeAttr(s){ return String(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }

/* =========
   APP STATE
   ========= */
let STATE = { products: [], sales: [], customers: [] }; // canonical app state
let cart = []; let payMethod = 'EFECTIVO'; let db = null; let cloudOn = false; let unsubscribe = null;

/* pendingOps: offline queue persistent in localStorage.
   Each op has shape { id, type: 'sale'|'product'|'customer', payload, ts, retries } */
let pendingOps = [];
const PENDING_KEY = 'tienda_pending_ops_v1';
const LOCAL_BACKUP_KEY = 'tienda_local_backup_v1';

/* Load persisted state and pending ops */
try { const b = localStorage.getItem(LOCAL_BACKUP_KEY); if(b) STATE = JSON.parse(b); } catch(e){ console.warn('local parse err', e); }
try { const p = localStorage.getItem(PENDING_KEY); if(p) pendingOps = JSON.parse(p) || []; } catch(e){ pendingOps = []; }

/* Persist helpers */
function saveLocalBackup(){ try { localStorage.setItem(LOCAL_BACKUP_KEY, JSON.stringify(STATE)); } catch(e){} }
function savePending(){ try { localStorage.setItem(PENDING_KEY, JSON.stringify(pendingOps)); } catch(e){} }

/* =========
   NORMALIZE REMOTE
   =========
   - Normalizes remote payloads to canonical STATE
   - Compatible with older formats
*/
function normalizeRemoteData(remote){
  const payload = (remote && remote[DB.field]) ? remote[DB.field] : (remote || {});
  const out = { products: [], sales: [], customers: [] };

  /* normalize product */
  function nProd(raw){
    if(!raw) return null;
    const p = Object.assign({}, raw);
    p.id = p.id || p._id || p.code || p.barcode || uid();
    p.name = String(p.name || p.title || '').trim();
    p.barcode = String(p.barcode || p.code || '').trim();
    p.category = String(p.category || '').trim();
    p.stock = Number(p.stock || p.qty || p.quantity || 0);
    p.price = Number(p.price || p.salePrice || p.valor || 0);
    p.costPrice = Number(p.costPrice || p.unitCost || p.cost || 0);
    p.createdAt = p.createdAt || new Date().toISOString();
    p.movements = Array.isArray(p.movements) ? p.movements : (p.movimientos || []);
    return p;
  }

  /* normalize sale items from various shapes */
  function normalizeSaleItems(raw){
    const items=[]; if(!raw) return items;
    if(Array.isArray(raw)){ for(const it of raw) items.push({ productId: it.productId || it.id || it.pid || null, qty: Number(it.qty||it.quantity||1), unitPrice: Number(it.unitPrice||it.price||0) }); return items; }
    if(typeof raw === 'object'){ for(const k of Object.keys(raw)){ const it = raw[k]; items.push({ productId: it.productId||it.id||k, qty: Number(it.qty||it.quantity||1), unitPrice: Number(it.unitPrice||it.price||0) }); } return items; }
    if(typeof raw === 'string'){ const parts = raw.split(/[|,;]/).map(p=>p.trim()).filter(Boolean); for(const p of parts){ const m = p.match(/(.+?)\s*x\s*(\d+)/i); if(m) items.push({ productId:null, name:m[1].trim(), qty:Number(m[2]), unitPrice:0 }); else items.push({ productId:null,name:p,qty:1,unitPrice:0 }); } return items; }
    return items;
  }

  const prodCand = payload.products || payload.inventory || payload.catalog || payload.items || [];
  if(Array.isArray(prodCand)) out.products = prodCand.map(nProd).filter(Boolean);
  else if(typeof prodCand === 'object') out.products = Object.values(prodCand).map(nProd).filter(Boolean);
  if(out.products.length === 0){
    for(const k of Object.keys(payload)){
      const v = payload[k];
      if(v && (v.name || v.barcode)){ const p = nProd(v); if(p) out.products.push(p); }
    }
  }

  const salesCand = payload.sales || payload.ventas || payload.transactions || payload.orders || [];
  if(Array.isArray(salesCand)){
    out.sales = salesCand.map(s => {
      const sale = Object.assign({}, s);
      sale.id = sale.id || sale._id || ('sale-'+Math.random().toString(36).slice(2,9));
      sale.date = sale.date || sale.created || new Date().toISOString();
      sale.total = Number(sale.total || sale.amount || 0);
      sale.paymentType = sale.paymentType || sale.payment || sale.method || 'EFECTIVO';
      sale.customerId = sale.customerId || sale.customerId || null; // preserve if present
      sale.customer = sale.customer || sale.cliente || null; // legacy
      sale.items = normalizeSaleItems(sale.items || sale.products || sale.itemsText);
      return sale;
    });
  } else if(typeof salesCand === 'object'){
    out.sales = Object.values(salesCand).map(s => {
      const sale = Object.assign({}, s);
      sale.id = sale.id || sale._id || ('sale-'+Math.random().toString(36).slice(2,9));
      sale.date = sale.date || sale.created || new Date().toISOString();
      sale.total = Number(sale.total || sale.amount || 0);
      sale.paymentType = sale.paymentType || sale.payment || sale.method || 'EFECTIVO';
      sale.customerId = sale.customerId || sale.customerId || null;
      sale.customer = sale.customer || sale.cliente || null;
      sale.items = normalizeSaleItems(sale.items || sale.products || []);
      return sale;
    });
  }

  const customersCand = payload.customers || payload.clientes || [];
  if(Array.isArray(customersCand)) out.customers = customersCand.map(c=>({ id: c.id || c._id || uid(), name:c.name||c.nombre||'', balance: Number(c.balance||c.saldo||0), createdAt: c.createdAt||new Date().toISOString() }));
  else if(typeof customersCand === 'object') out.customers = Object.values(customersCand).map(c=>({ id: c.id || c._id || uid(), name:c.name||c.nombre||'', balance: Number(c.balance||c.saldo||0), createdAt: c.createdAt||new Date().toISOString() }));

  /* link items to product IDs if possible */
  function linkItems(items){
    return items.map(it => {
      if(it.productId) return it;
      if(it.barcode){
        const m = out.products.find(p => p.barcode && p.barcode === String(it.barcode));
        if(m) return { productId: m.id, qty:Number(it.qty||1), unitPrice: Number(it.unitPrice||m.price||0) };
      }
      if(it.name){
        const nm = String(it.name).toLowerCase();
        const m = out.products.find(p => String(p.name||'').toLowerCase() === nm);
        if(m) return { productId: m.id, qty:Number(it.qty||1), unitPrice:Number(it.unitPrice||m.price||0) };
      }
      return { productId: it.productId || null, qty:Number(it.qty||1), unitPrice:Number(it.unitPrice||0), rawName: it.name || null };
    });
  }

  out.sales = out.sales.map(s => { s.items = linkItems(s.items||[]); if((!s.total||s.total===0) && Array.isArray(s.items)) s.total = s.items.reduce((a,b)=>a + (Number(b.unitPrice||0)*Number(b.qty||1)),0); return s; });
  out.products = out.products.map(p => { p.id = p.id || uid(); p.stock = Number(p.stock||0); p.price = Number(p.price||0); p.costPrice = Number(p.costPrice||0); p.movements = Array.isArray(p.movements)?p.movements:[]; return p; });

  return out;
}

/* =========
   MERGE STATE
   - merges remote normalized state with local STATE avoiding destructive overwrite
*/
function mergeState(remoteState){
  // Merge products: prefer more recent createdAt, merge movements by id
  const map = new Map(); (STATE.products||[]).forEach(p => map.set(p.id, JSON.parse(JSON.stringify(p))));
  for(const rp of (remoteState.products||[])){
    if(rp && rp.id && rp.deleted){
      map.delete(rp.id);
      continue;
    }
    const existing = map.get(rp.id);
    if(!existing) map.set(rp.id, rp);
    else {
      const ldt = new Date(existing.updatedAt || existing.createdAt || 0).getTime();
      const rdt = new Date(rp.updatedAt || rp.createdAt || 0).getTime();
      const base = rdt >= ldt ? rp : existing;
      // unify movements
      const mm = new Map(); (existing.movements||[]).forEach(m=> mm.set(m.id||JSON.stringify(m), m)); (rp.movements||[]).forEach(m=> mm.set(m.id||JSON.stringify(m), m));
      base.movements = Array.from(mm.values());
      // prefer non-zero stock? keep remote? we'll take the base (latest)
      map.set(base.id, base);
    }
  }
  const mergedProds = Array.from(map.values());

  // Merge sales: keep set union, prefer latest date on conflict
  const sMap = new Map(); (STATE.sales||[]).forEach(s=> sMap.set(s.id, s));
  for(const rs of (remoteState.sales||[])){
    if(rs && rs.id && rs.deleted){
      sMap.delete(rs.id);
      continue;
    }
    if(!sMap.has(rs.id)) sMap.set(rs.id, rs);
    else {
      const cur = sMap.get(rs.id);
      const cd = new Date(cur.updatedAt || cur.date || 0).getTime();
      const rd = new Date(rs.updatedAt || rs.date || 0).getTime();
      if(rd >= cd) sMap.set(rs.id, rs);
    }
  }
  const mergedSales = Array.from(sMap.values()).sort((a,b)=> new Date(b.date)-new Date(a.date));

  // Merge customers by normalized name or id, prefer latest updatedAt
  const cMap = new Map(); (STATE.customers||[]).forEach(c=> cMap.set((c.id||c.name||'').toString().toLowerCase(), c));
  for(const rc of (remoteState.customers||[])){
    if(rc && (rc.id || rc.name) && rc.deleted){
      const delKey = (rc.id || rc.name || '').toString().toLowerCase();
      cMap.delete(delKey);
      continue;
    }
    const key = (rc.id || rc.name || '').toString().toLowerCase();
    if(!cMap.has(key)) cMap.set(key, rc);
    else {
      const ex = cMap.get(key);
      const edt = new Date(ex.updatedAt || ex.createdAt || 0).getTime();
      const rdt = new Date(rc.updatedAt || rc.createdAt || 0).getTime();
      if(rdt >= edt) cMap.set(key, rc);
    }
  }
  const mergedCustomers = Array.from(cMap.values());

  STATE.products = mergedProds; STATE.sales = mergedSales; STATE.customers = mergedCustomers;
  try { localStorage.setItem(LOCAL_BACKUP_KEY, JSON.stringify(STATE)); } catch(e){}
}

/* ==========
   FIREBASE: init + sync (subcolecciones)
   - Nuevo modelo: /MODO DE PREODUCCIÓN/MAGALY/{products,customers,sales}
   - Mantiene offline-first con cola pendingOps
   - Incluye migración segura desde doc legacy
   ========== */
function initFirebase(){
  try{
    if(!window.firebase) { console.warn('Firebase SDK not loaded'); return; }
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
  }catch(e){ console.error('initFirebase', e); db = null; }
}

const SUBCOLS = { products: 'products', customers: 'customers', sales: 'sales' };
const MIGRATION_KEY = 'tienda_migration_v1';
let syncInProgress = false;
let unsubscribers = { products: null, customers: null, sales: null };

function parentDocRef(){
  return db.collection(DB.col).doc(DB.doc);
}
function subcolRef(name){
  return parentDocRef().collection(name);
}

async function upsertProduct(product){
  if(!db) return false;
  const id = product.id || uid();
  const payload = { ...product, id, updatedAt: new Date().toISOString() };
  if(payload.deleted && !payload.deletedAt) payload.deletedAt = new Date().toISOString();
  await subcolRef(SUBCOLS.products).doc(id).set(payload, { merge: true });
  return true;
}

async function upsertCustomer(customer){
  if(!db) return false;
  const id = customer.id || uid();
  const payload = { ...customer, id, updatedAt: new Date().toISOString() };
  if(payload.deleted && !payload.deletedAt) payload.deletedAt = new Date().toISOString();
  await subcolRef(SUBCOLS.customers).doc(id).set(payload, { merge: true });
  return true;
}

async function upsertSale(sale){
  if(!db) return false;
  const id = sale.id || uid();
  const payload = { ...sale, id, updatedAt: new Date().toISOString() };
  if(payload.deleted && !payload.deletedAt) payload.deletedAt = new Date().toISOString();
  await subcolRef(SUBCOLS.sales).doc(id).set(payload, { merge: true });
  return true;
}

async function fetchSubcollectionDocs(name){
  const snap = await subcolRef(name).get();
  return snap.docs.map(d => d.data());
}

async function migrateOldDataToSubcollections(){
  if(!db) return;
  if(localStorage.getItem(MIGRATION_KEY)) return;

  const legacyRef = db.collection(DB.col).doc(DB.legacyDoc);
  let legacySnap = null;
  try{ legacySnap = await legacyRef.get(); }catch(e){ console.warn('legacy read err', e); return; }
  if(!legacySnap || !legacySnap.exists) return;

  // Avoid migrating if target subcollections already have data
  try{
    const [p1, c1, s1] = await Promise.all([
      subcolRef(SUBCOLS.products).limit(1).get(),
      subcolRef(SUBCOLS.customers).limit(1).get(),
      subcolRef(SUBCOLS.sales).limit(1).get(),
    ]);
    if((p1 && !p1.empty) || (c1 && !c1.empty) || (s1 && !s1.empty)){
      localStorage.setItem(MIGRATION_KEY, 'skipped_existing');
      return;
    }
  }catch(e){ console.warn('pre-migration check err', e); }

  const raw = legacySnap.data() || {};
  const normalized = normalizeRemoteData(raw);
  const { products, customers, sales } = normalized;
  if((products||[]).length === 0 && (customers||[]).length === 0 && (sales||[]).length === 0) return;

  const batchWrite = async (name, items) => {
    if(!items || items.length === 0) return;
    let batch = db.batch();
    let count = 0;
    for(const item of items){
      const id = item.id || uid();
      const ref = subcolRef(name).doc(id);
      const payload = { ...item, id, migratedAt: new Date().toISOString() };
      batch.set(ref, payload, { merge: true });
      count += 1;
      if(count >= 450){
        await batch.commit();
        batch = db.batch();
        count = 0;
      }
    }
    if(count > 0) await batch.commit();
  };

  try{
    await batchWrite(SUBCOLS.products, products || []);
    await batchWrite(SUBCOLS.customers, customers || []);
    await batchWrite(SUBCOLS.sales, sales || []);
    await parentDocRef().set({ migration: { legacyDocId: DB.legacyDoc, migratedAt: new Date().toISOString() } }, { merge: true });
    localStorage.setItem(MIGRATION_KEY, 'done');
    showToast('Migración a subcolecciones completada');
  }catch(e){
    console.error('migration err', e);
    showToast('Error en migración, revisa consola');
  }
}

function mergeFromSubcollection(name, docs){
  const partial = { products: [], sales: [], customers: [] };
  if(name === SUBCOLS.products) partial.products = docs;
  if(name === SUBCOLS.sales) partial.sales = docs;
  if(name === SUBCOLS.customers) partial.customers = docs;
  mergeState(partial);
}

async function startFirestoreSync(){
  if(!db){ updateOnline(false); return; }

  await migrateOldDataToSubcollections();

  // initial fetch from subcollections
  try{
    const [products, customers, sales] = await Promise.all([
      fetchSubcollectionDocs(SUBCOLS.products),
      fetchSubcollectionDocs(SUBCOLS.customers),
      fetchSubcollectionDocs(SUBCOLS.sales),
    ]);
    mergeState({ products, customers, sales });
    renderAll();
    updateOnline(true);
  }catch(e){
    console.error('initial subcollection read error', e);
    updateOnline(false);
  }

  // realtime listeners
  try{
    if(unsubscribers.products) try{ unsubscribers.products(); }catch(_){}
    if(unsubscribers.customers) try{ unsubscribers.customers(); }catch(_){}
    if(unsubscribers.sales) try{ unsubscribers.sales(); }catch(_){}

    unsubscribers.products = subcolRef(SUBCOLS.products).onSnapshot(snap => {
      const docs = snap.docs.map(d => d.data());
      mergeFromSubcollection(SUBCOLS.products, docs);
      renderAll();
      updateOnline(true);
      processPendingOps();
    }, err => { console.error('products onSnapshot err', err); updateOnline(false); });

    unsubscribers.customers = subcolRef(SUBCOLS.customers).onSnapshot(snap => {
      const docs = snap.docs.map(d => d.data());
      mergeFromSubcollection(SUBCOLS.customers, docs);
      renderAll();
      updateOnline(true);
      processPendingOps();
    }, err => { console.error('customers onSnapshot err', err); updateOnline(false); });

    unsubscribers.sales = subcolRef(SUBCOLS.sales).onSnapshot(snap => {
      const docs = snap.docs.map(d => d.data());
      mergeFromSubcollection(SUBCOLS.sales, docs);
      renderAll();
      updateOnline(true);
      processPendingOps();
    }, err => { console.error('sales onSnapshot err', err); updateOnline(false); });
  }catch(e){ console.error('startFirestoreSync err', e); updateOnline(false); }
}

/* =========
   OFFLINE QUEUE (pendingOps)
   - addPendingOp(op): push op and persist
   - processPendingOps(): try to flush queue to Firestore in FIFO, with retries/backoff
*/
function addPendingOp(op){
  // op: { type, payload, id, ts, retries, silent }
  op.id = op.id || uid();
  op.ts = op.ts || new Date().toISOString();
  op.retries = op.retries || 0;
  pendingOps.push(op);
  savePending();
  if(!op.silent) showToast('Operación en cola (offline)');
}

/* Try to flush pending ops; updates STATE locally on success and removes op */
async function processPendingOps(){
  if(!db) return;
  if(pendingOps.length === 0) return;
  if(syncInProgress) return;
  syncInProgress = true;
  try{
    // We will attempt to apply ops sequentially
    for(let i = 0; i < pendingOps.length; ){
      const op = pendingOps[i];
      try{
        if(op.type === 'sale'){
          const sale = op.payload;
          await upsertSale(sale);
          // op succeeded -> remove
          pendingOps.splice(i,1);
          savePending();
          if(!op.silent) showToast('Operación pendiente enviada');
          // do not increment i: new element now at same index
          continue;
        } else if(op.type === 'product'){
          // product upsert
          const product = op.payload;
          await upsertProduct(product);
          pendingOps.splice(i,1);
          savePending();
          continue;
        } else if(op.type === 'customer'){
          const cust = op.payload;
          await upsertCustomer(cust);
          pendingOps.splice(i,1);
          savePending();
          continue;
        } else {
          // unknown op type -> remove (to avoid infinite loop)
          console.warn('Unknown pending op type, discarding', op.type);
          pendingOps.splice(i,1);
          savePending();
          continue;
        }
      }catch(err){
        // operation failed: increase retry counter and break to try later
        console.warn('Op failed, will retry later', pendingOps[i], err);
        pendingOps[i].retries = (pendingOps[i].retries || 0) + 1;
        savePending();
        // backoff behavior: break loop and wait for next reconnection
        break;
      }
    }
  }catch(e){
    console.error('processPendingOps err', e);
  } finally {
    syncInProgress = false;
    // save local state
    saveLocalBackup();
    renderAll();
  }
}

/* Try periodic flush when online */
setInterval(()=>{ if(cloudOn) processPendingOps(); }, 15000);

/* =========
   ONLINE UI
   ========= */
function updateOnline(on){
  cloudOn = !!on;
  $('#dot').style.background = on ? '#10b981' : '#ef4444';
  $('#cloud-text').textContent = on ? 'Online' : 'Desconectado';
  if(on) {
    processPendingOps();
  }
}

/* =========
   RENDERS (dashboard, inventory, cart, clients, gestion)
   ========= */
function renderAll(){
  renderDashboard();
  renderInventoryList();
  renderCart();
  renderClients();
  renderGestionList();
  updateReportsIfOpen();
}

function renderDashboard(){
  const now = new Date();
  const ventasHoy = (STATE.sales||[]).filter(s => !s.deleted && isSameLocalDay(s.date, now));
  const total = ventasHoy.reduce((a,b)=> a + Number(b.total||0), 0);
  $('#stat-ventas').textContent = `S/ ${money(total)}`;
  $('#stat-count').textContent = ventasHoy.length;

  const products = (STATE.products||[]);
  const outOfStock = products.filter(p => Number(p.stock) <= 0);
  const lowStock = products.filter(p => Number(p.stock) > 0 && Number(p.stock) <= 5);

  const container = $('#low-stock-container');
  if(!container) return;
  container.innerHTML = '';

  const summary = document.createElement('div');
  summary.className = 'stock-summary';
  summary.innerHTML = `
    <div class="stock-chip stock-out">Sin stock: ${outOfStock.length}</div>
    <div class="stock-chip stock-low">Stock bajo: ${lowStock.length}</div>
  `;
  container.appendChild(summary);

  if(outOfStock.length === 0 && lowStock.length === 0){
    const ok = document.createElement('div');
    ok.className = 'card stock-empty';
    ok.textContent = 'Todo en orden: no hay alertas de stock.';
    container.appendChild(ok);
    return;
  }

  const buildSection = (title, items, tone) => {
    if(items.length === 0) return;
    const card = document.createElement('div');
    card.className = 'card stock-section';
    card.innerHTML = `<div class="stock-title">${title}</div>`;
    const list = document.createElement('div');

    const display = items.slice(0,6);
    display.forEach(p => {
      const row = document.createElement('div');
      row.className = 'stock-row';
      row.innerHTML = `
        <div>
          <div class="font-bold">${escapeHtml(p.name||'')}</div>
          <div class="small-muted">S/ ${money(p.price)} • ${escapeHtml(p.category||'')}</div>
        </div>
        <div class="stock-badge ${tone}">${Number(p.stock)||0}</div>
      `;
      list.appendChild(row);
    });

    if(items.length > 6){
      const more = document.createElement('div');
      more.className = 'small-muted';
      more.textContent = `+${items.length - 6} productos más`;
      list.appendChild(more);
    }

    card.appendChild(list);
    container.appendChild(card);
  };

  buildSection('Sin stock', outOfStock, 'out');
  buildSection('Stock bajo', lowStock, 'low');
}

function renderInventoryList(){
  const container = $('#inventory-list'); if(!container) return; container.innerHTML='';
  const q = ($('#search-inv')?.value||'').toLowerCase();
  const list = (STATE.products||[]).filter(p => !q || (p.name||'').toLowerCase().includes(q) || (p.barcode||'').includes(q));
  if(list.length === 0) container.innerHTML = '<div class="small-muted">No hay productos</div>';
  list.forEach(p=>{
    const d = document.createElement('div'); d.className='card flex justify-between items-center'; d.style.padding='8px';
    d.onclick = ()=> editProduct(p.id);
    d.innerHTML = `<div><div style="font-weight:800">${escapeHtml(p.name)}</div><div class="small-muted">STOCK: ${p.stock} • S/ ${money(p.price)}</div></div><div class="text-indigo-600"><i data-lucide="edit-3"></i></div>`;
    container.appendChild(d);
  });
  lucide.createIcons();
}

/* POS search (coincide por letras) */
function normalizeForSearch(text){
  return String(text||'')
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9]/g,'');
}

function matchLettersOrdered(needle, hay){
  if(!needle) return true;
  let i = 0;
  for(const ch of hay){
    if(ch === needle[i]) i += 1;
    if(i >= needle.length) return true;
  }
  return false;
}

function getPosMatches(query){
  const q = normalizeForSearch(query);
  const qDigits = String(query||'').replace(/\D/g,'');
  if(!q && !qDigits) return [];
  const items = (STATE.products||[]);
  const scored = [];
  for(const p of items){
    const nameNorm = normalizeForSearch(p.name);
    const catNorm = normalizeForSearch(p.category);
    const codeNorm = String(p.barcode||'').replace(/\D/g,'');
    const nameMatch = q && (nameNorm.includes(q) || matchLettersOrdered(q, nameNorm));
    const catMatch = q && (catNorm.includes(q) || matchLettersOrdered(q, catNorm));
    const codeMatch = qDigits && codeNorm.includes(qDigits);
    if(!(nameMatch || catMatch || codeMatch)) continue;

    let score = 0;
    if(q && nameNorm.startsWith(q)) score += 4;
    else if(q && nameNorm.includes(q)) score += 3;
    else if(q && matchLettersOrdered(q, nameNorm)) score += 1;
    if(qDigits && codeNorm === qDigits) score += 3;
    else if(qDigits && codeNorm.includes(qDigits)) score += 2;
    if(Number(p.stock||0) <= 0) score -= 1;
    scored.push({ p, score });
  }
  scored.sort((a,b)=> b.score - a.score);
  return scored.slice(0, 8).map(s => s.p);
}

function renderPosSuggestions(matches){
  const list = $('#pos-suggestions');
  if(!list) return;
  list.innerHTML = '';
  if(!matches || matches.length === 0){
    list.classList.add('hidden');
    return;
  }
  matches.forEach(p => {
    const row = document.createElement('div');
    row.className = 'suggestion-item flex items-center justify-between gap-2';
    const stock = Number(p.stock||0);
    const stockText = stock <= 0 ? 'Sin stock' : `Stock ${stock}`;
    row.innerHTML = `
      <div>
        <div style="font-weight:700">${escapeHtml(p.name||'')}</div>
        <div class="small-muted">S/ ${money(p.price)} • ${escapeHtml(p.category||'')}</div>
      </div>
      <div class="small-muted">${stockText}</div>
    `;
    row.addEventListener('click', ()=> {
      addToCart(p);
      const input = $('#pos-search');
      if(input) input.value = '';
      list.classList.add('hidden');
      if(input) input.focus();
    });
    list.appendChild(row);
  });
  list.classList.remove('hidden');
}

function addToCart(prod){
  if(!prod) return;
  const maxStock = Number(prod.stock||0);
  const existing = cart.find(i => i.id === prod.id);
  const currentQty = existing ? Number(existing.qty||0) : 0;
  if(maxStock <= 0){
    showToast('Sin stock');
    return;
  }
  if(currentQty + 1 > maxStock){
    showToast('Stock insuficiente');
    return;
  }
  if(existing) existing.qty += 1;
  else cart.push({ id: prod.id, name: prod.name, price: Number(prod.price||0), qty: 1 });
  renderCart();
}

function queueProductSyncFromItems(items){
  const ids = new Set();
  (items||[]).forEach(it => { if(it && it.productId) ids.add(it.productId); });
  ids.forEach(id => {
    const p = (STATE.products||[]).find(x => x.id === id);
    if(p) addPendingOp({ type: 'product', payload: p, silent: true });
  });
}

function setupPosSearch(){
  const input = $('#pos-search');
  const list = $('#pos-suggestions');
  if(!input || !list) return;
  if(input.dataset.bound === '1') return;
  input.dataset.bound = '1';

  let lastMatches = [];
  const refresh = () => {
    const q = input.value.trim();
    lastMatches = getPosMatches(q);
    renderPosSuggestions(lastMatches);
  };

  input.addEventListener('input', refresh);
  input.addEventListener('focus', refresh);
  input.addEventListener('keydown', (ev) => {
    if(ev.key === 'Enter'){
      ev.preventDefault();
      const q = input.value.trim();
      if(!q) return;
      const qDigits = q.replace(/\D/g,'');
      if(qDigits){
        const exact = (STATE.products||[]).find(p => String(p.barcode||'').replace(/\D/g,'') === qDigits);
        if(exact){
          addToCart(exact);
          input.value = '';
          list.classList.add('hidden');
          return;
        }
      }
      const pick = lastMatches && lastMatches[0];
      if(pick){
        addToCart(pick);
        input.value = '';
        list.classList.add('hidden');
      }
    }
  });

  document.addEventListener('click', (ev) => {
    if(ev.target === input) return;
    if(list.contains(ev.target)) return;
    list.classList.add('hidden');
  });
}

/* CART render & operations */
function renderCart(){
  const container = $('#pos-cart'); if(!container) return; container.innerHTML='';
  let total = 0;
  cart.forEach((item, idx) => {
    total += item.price * item.qty;
    const subtotal = item.price * item.qty;
    const div = document.createElement('div'); div.className='card flex justify-between items-center'; div.style.padding='8px';
    div.innerHTML = `<div style="flex:1">
        <div style="font-weight:800">${escapeHtml(item.name)}</div>
        <div class="small-muted">Precio: S/ ${money(item.price)} • Subtotal: S/ ${money(subtotal)}</div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <button onclick="updateQty(${idx},-1)" class="px-2 py-1 border rounded">-</button>
        <input type="number" min="1" value="${item.qty}" oninput="setQty(${idx}, this.value)" class="input-pro qty-input">
        <button onclick="updateQty(${idx},1)" class="px-2 py-1 border rounded">+</button>
      </div>`;
    container.appendChild(div);
  });
  $('#pos-total').textContent = money(total);
  $('#pos-items-count').textContent = `${cart.reduce((s,i)=> s + (i.qty||0),0)} items`;
}

function setQty(idx, value){
  if(!cart[idx]) return;
  const prod = (STATE.products||[]).find(p => p.id === cart[idx].id);
  const maxStock = prod ? Number(prod.stock||0) : null;
  let qty = Math.floor(Number(value) || 1);
  if(qty <= 0) { cart.splice(idx,1); renderCart(); return; }
  if(maxStock !== null){
    if(maxStock <= 0){
      showToast('Sin stock');
      cart.splice(idx,1);
      renderCart();
      return;
    }
    if(qty > maxStock){
      showToast('Stock insuficiente');
      qty = maxStock;
    }
  }
  cart[idx].qty = qty;
  renderCart();
}

function updateQty(idx, delta){
  if(!cart[idx]) return;
  const next = Number(cart[idx].qty||0) + delta;
  if(next <= 0) { cart.splice(idx,1); renderCart(); return; }
  setQty(idx, next);
}

function setPayMethod(m, ev){
  payMethod = m;
  $$('.pay-btn').forEach(b=> b.classList.remove('active'));
  if(ev && ev.currentTarget) ev.currentTarget.classList.add('active');
  if(m === 'A_CREDITO') $('#pos-customer').classList.remove('hidden'); else $('#pos-customer').classList.add('hidden');
}

/* ==========
   completeSale() - OFFLINE-FIRST, customerId handling
   - validates stock locally
   - creates customer if not exists (assigns id)
   - updates customer's balance automatically on A_CREDITO
   - when offline: pushes op to pendingOps
   - when online: tries to push to Firestore and process pendingOps
   ========== */
async function completeSale(){
  try{
    if(cart.length === 0) return alert('El carrito está vacío');
    // validate stock locally
    for(const it of cart){
      const p = (STATE.products||[]).find(x => x.id === it.id);
      if(!p) return alert('Producto no encontrado: ' + it.name);
      if(Number(p.stock) < Number(it.qty)) return alert('Stock insuficiente para: ' + p.name);
    }

    // assemble sale object with customerId handling
    const sale = {
      id: 'V-' + Date.now(),
      date: new Date().toISOString(),
      total: cart.reduce((a,b)=> a + (b.price*b.qty), 0),
      paymentType: payMethod,
      customerId: null,
      customerName: null,
      items: cart.map(i=> ({ productId: i.id, qty: i.qty, unitPrice: i.price })),
      meta: { origin: 'pos', device: navigator.userAgent }
    };

    // handle credit: find or create customer and attach customerId
    if(payMethod === 'A_CREDITO'){
      const custName = ($('#pos-customer').value || '').trim();
      if(!custName) return alert('Ingrese nombre del cliente para A CREDITO');
      // find by exact name (case-insensitive) or by id
      let customer = STATE.customers.find(c => (c.name||'').toLowerCase() === custName.toLowerCase());
      if(!customer){
        // create local customer entry
        customer = { id: 'C-'+Date.now(), name: custName, balance: Number(sale.total), createdAt: new Date().toISOString() };
        // add locally
        STATE.customers.unshift(customer);
        // add pending op to create/update customer in cloud
        addPendingOp({ type: 'customer', payload: customer });
      } else {
        // update local balance immediately
        customer.balance = Number((Number(customer.balance||0) + Number(sale.total)).toFixed(2));
        // queue customer update
        addPendingOp({ type: 'customer', payload: { id: customer.id, name: customer.name, balance: customer.balance } });
      }
      sale.customerId = customer.id;
      sale.customerName = customer.name;
    } else {
      // for non-credit, optionally attach customerName if provided
      const custName = ($('#pos-customer').value || '').trim();
      if(custName){
        let customer = STATE.customers.find(c => (c.name||'').toLowerCase() === custName.toLowerCase());
        if(!customer){
          customer = { id: 'C-'+Date.now(), name: custName, balance: 0, createdAt: new Date().toISOString() };
          STATE.customers.unshift(customer);
          addPendingOp({ type: 'customer', payload: customer });
        }
        sale.customerId = customer.id;
        sale.customerName = customer.name;
      }
    }

    // update stock locally and movements
    for(const it of sale.items){
      const p = STATE.products.find(x => x.id === it.productId);
      if(p){
        p.stock = Number(p.stock) - Number(it.qty);
        p.movements = p.movements || [];
        p.movements.unshift({ id: uid(), type:'OUT', qty: it.qty, date: new Date().toISOString(), saleId: sale.id, unitPrice: it.unitPrice });
      }
    }

    // Add sale locally
    STATE.sales.unshift(sale);
    saveLocalBackup();

    // post-sale UI updates (close modal immediately)
    cart = [];
    renderCart();
    renderInventoryList();
    renderDashboard();
    closeModal('modal-sale');
    if($('#pos-customer')) $('#pos-customer').value = '';

    // Build op and either process immediately or queue
    const op = { type: 'sale', payload: sale };
    addPendingOp(op);
    queueProductSyncFromItems(sale.items);
    if(!cloudOn || !db){
      showToast('Venta guardada offline. Se sincronizará cuando haya conexión.');
    } else {
      processPendingOps();
      showToast('Venta registrada y sincronizada');
    }
  }catch(e){
    console.error('completeSale err', e);
    alert('Error registrando venta: ' + (e && e.message || ''));
  }
}

/* =======
   Gestion: list, edit, delete sale (delete reverses stock)
   ======= */
function renderGestionList(){
  const container = $('#gestion-list'); if(!container) return; container.innerHTML = '';
  const rows = (STATE.sales||[]).filter(s => !s.deleted).slice(0,500);
  if(rows.length === 0) { container.innerHTML = '<div class="small-muted">No hay ventas registradas</div>'; return; }
  const table = document.createElement('table');
  table.innerHTML = `<thead><tr><th>Fecha</th><th>ID</th><th>Cliente</th><th>Pago</th><th style="text-align:right">Total</th><th>Acciones</th></tr></thead><tbody></tbody>`;
  const tbody = table.querySelector('tbody');
  rows.forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${new Date(s.date).toLocaleString()}</td><td>${s.id}</td><td>${escapeHtml(s.customerName||s.customer||'-')}</td><td>${escapeHtml(s.paymentType||s.method||'EFECTIVO')}</td><td style="text-align:right">S/ ${money(s.total)}</td><td style="white-space:nowrap"><button onclick="openEditSale('${s.id}')" class="px-2 py-1 border rounded mr-2">Editar</button><button onclick="deleteSaleConfirm('${s.id}')" class="px-2 py-1 border rounded">Eliminar</button></td>`;
    tbody.appendChild(tr);
  });
  container.appendChild(table);
}

/* Open edit sale modal (allows editing qty per item and payment) */
function openEditSale(saleId){
  const s = (STATE.sales||[]).find(x=> x.id === saleId); if(!s) return alert('Venta no encontrada');
  const modal = document.createElement('div'); modal.className='modal visible'; modal.style.zIndex='120';
  const sheet = document.createElement('div'); sheet.className='modal-sheet';
  sheet.innerHTML = `<div class="flex justify-between items-center mb-3"><h3 class="font-bold">Editar Venta ${s.id}</h3><button id="close-edit">Cerrar</button></div>
    <div><label class="small-muted">Cliente</label><input id="edit-customer" class="input-pro mt-1" value="${escapeAttr(s.customerName||'')}" /></div>
    <div class="mt-2"><label class="small-muted">Pago</label><select id="edit-payment" class="input-pro mt-1"><option ${ (s.paymentType||s.method) === 'EFECTIVO' ? 'selected':'' }>EFECTIVO</option><option ${ (s.paymentType||s.method) === 'YAPE' ? 'selected':'' }>YAPE</option><option ${ (s.paymentType||s.method) === 'A_CREDITO' ? 'selected':'' }>A_CREDITO</option></select></div>
    <div class="mt-3"><label class="small-muted">Productos</label><div id="edit-items" style="max-height:220px;overflow:auto;border:1px solid #eee;padding:8px;border-radius:8px;"></div></div>
    <div class="mt-3 flex gap-2"><button id="save-edit" class="btn-primary">Guardar cambios</button><button id="cancel-edit" class="px-3 py-2 border rounded">Cancelar</button></div>`;
  modal.appendChild(sheet); document.body.appendChild(modal);
  const itemsContainer = sheet.querySelector('#edit-items');
  s.items.forEach((it, idx)=>{
    const prod = (STATE.products||[]).find(p=> p.id === it.productId) || { name: it.rawName || 'Producto' };
    const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.marginBottom='8px';
    row.innerHTML = `<div style="flex:1"><div style="font-weight:700">${escapeHtml(prod.name)}</div><div class="small-muted">Unit S/ ${money(it.unitPrice||0)}</div></div><div><input type="number" value="${it.qty}" min="1" data-idx="${idx}" class="input-pro edit-qty" style="width:90px"></div>`;
    itemsContainer.appendChild(row);
  });
  sheet.querySelector('#close-edit').addEventListener('click', ()=> modal.remove());
  sheet.querySelector('#cancel-edit').addEventListener('click', ()=> modal.remove());
  sheet.querySelector('#save-edit').addEventListener('click', async ()=>{
    const newCustomer = sheet.querySelector('#edit-customer').value.trim();
    const newPayment = sheet.querySelector('#edit-payment').value;
    const qtyInputs = Array.from(sheet.querySelectorAll('.edit-qty'));
    // compute diffs and adjust stock
    const oldMap = {}; s.items.forEach(it => { oldMap[it.productId || it.rawName || uid()] = Number(it.qty || 0); });
    const newMap = {};
    qtyInputs.forEach(inp => { const idx = Number(inp.getAttribute('data-idx')); const val = Number(inp.value) || 0; const key = s.items[idx].productId || s.items[idx].rawName || uid(); newMap[key] = val; });
    for(let i=0;i<s.items.length;i++){
      const it = s.items[i];
      const key = it.productId || it.rawName || uid();
      const oldQ = oldMap[key] || 0; const newQ = newMap[key] || 0;
      if(newQ <= 0){
        alert('La cantidad debe ser mayor que 0');
        return;
      }
      const diff = newQ - oldQ; // positive => sold more (reduce stock)
      if(it.productId){
        const p = (STATE.products||[]).find(x=> x.id === it.productId);
        if(p){
          const nextStock = Number(p.stock) - diff;
          if(nextStock < 0){
            alert('Stock insuficiente para: ' + p.name);
            return;
          }
          p.stock = nextStock;
          p.movements = p.movements || [];
          p.movements.unshift({ id: uid(), type:'EDIT_SALE', qty: diff, date: new Date().toISOString(), saleId: s.id });
        }
      }
      s.items[i].qty = newQ;
    }
    s.total = s.items.reduce((a,b)=> a + (Number(b.unitPrice||0) * Number(b.qty||0)), 0);
    s.customerName = newCustomer || s.customerName;
    s.paymentType = newPayment;
    // push change: update local and push to cloud / pending ops
    STATE.sales = STATE.sales.map(x => x.id === s.id ? s : x);
    saveLocalBackup();
    queueProductSyncFromItems(s.items);
    addPendingOp({ type: 'sale', payload: s }); // queue update as sale op
    await processPendingOps();
    showToast('Venta editada (cambios en cola si offline)');
    renderAll();
    modal.remove();
  });
}

/* delete sale with stock rollback */
function deleteSaleConfirm(saleId){
  if(!confirm('Eliminar venta y revertir stock?')) return;
  const sale = (STATE.sales||[]).find(s=> s.id === saleId); if(!sale) return alert('Venta no encontrada');
  for(const it of sale.items){
    const p = (STATE.products||[]).find(x=> x.id === it.productId);
    if(p){ p.stock = Number(p.stock) + Number(it.qty); p.movements = p.movements || []; p.movements.unshift({ id: uid(), type:'ROLLBACK', qty: it.qty, date: new Date().toISOString(), note: 'Eliminación venta ' + saleId }); }
  }
  STATE.sales = (STATE.sales||[]).filter(s=> s.id !== saleId);
  saveLocalBackup();
  // queue deletion as a sale op with a flag 'deleted': true (consumer on server side should handle if necessary)
  queueProductSyncFromItems(sale.items);
  addPendingOp({ type: 'sale', payload: { ...sale, deleted: true } });
  processPendingOps();
  showToast('Venta eliminada (sincronización pendiente)');
  renderAll();
}

/* =========
   IMPORT / EXPORT / REPORTS
   ========= */
function exportInventoryXLSX(){
  try{
    const rows = (STATE.products||[]).map(p=>({ id:p.id,name:p.name,category:p.category,barcode:p.barcode,stock:p.stock,price:p.price,costPrice:p.costPrice }));
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Inventario');
    XLSX.writeFile(wb, `inventario_${todayYMD()}.xlsx`);
    showToast('Inventario exportado');
  }catch(e){ console.error(e); alert('Error exportando inventario'); }
}

function exportSalesXLSX(){
  try{
    const rows = (STATE.sales||[]).filter(s => !s.deleted).map(s=>({ id:s.id, date:s.date, customerId:s.customerId||'', customerName:s.customerName||'', paymentType:s.paymentType||s.method||'', total:s.total, items:(s.items||[]).map(it=> ((STATE.products.find(p=>p.id===it.productId)||{name:it.rawName||it.productId}).name + ' x' + it.qty)).join(' | ') }));
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Ventas');
    XLSX.writeFile(wb, `ventas_${todayYMD()}.xlsx`);
    showToast('Ventas exportadas');
  }catch(e){ console.error(e); alert('Error exportando ventas'); }
}

function exportCombinedXLSX(){
  try{
    const from = todayYMD(), to = todayYMD();
    const salesRows = (STATE.sales||[]).filter(s => !s.deleted).map(s=>({ id:s.id, date:s.date, customerId:s.customerId||'', customerName:s.customerName||'', paymentType:s.paymentType||s.method||'', total:s.total, items:(s.items||[]).map(it=> ((STATE.products.find(p=>p.id===it.productId)||{name:it.rawName||it.productId}).name + ' x' + it.qty)).join(' | ') }));
    const invRows = (STATE.products||[]).map(p=>({ id:p.id, name:p.name, category:p.category, barcode:p.barcode, stock:p.stock, price:p.price, costPrice:p.costPrice }));
    const kardex = []; (STATE.products||[]).forEach(p=> (p.movements||[]).forEach(m=> kardex.push({ productId:p.id, productName:p.name, type:m.type||'', qty:m.qty||0, date:m.date||'', note:m.note||'' })));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(salesRows), 'Ventas');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(invRows), 'Inventario');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(kardex), 'Kardex');
    XLSX.writeFile(wb, `Ventas_Inventario_Kardex_${from}_a_${to}.xlsx`);
    showToast('Exportado Ventas + Inventario + Kardex');
  }catch(e){ console.error(e); alert('Error exportando combinado'); }
}

function exportReportRangeBothXLSX(){
  try{
    const from = $('#rep-from').value || todayYMD();
    const to = $('#rep-to').value || todayYMD();
    const sales = salesInRange(from,to);
    const salesRows = sales.map(s=>({
      id:s.id,
      date:s.date,
      customerId:s.customerId||'',
      customerName:s.customerName||'',
      paymentType:s.paymentType||s.method||'',
      total:s.total,
      items:(s.items||[]).map(it=> ((STATE.products.find(p=>p.id===it.productId)||{name:it.rawName||it.productId}).name + ' x' + it.qty)).join(' | ')
    }));
    const invRows = (STATE.products||[]).map(p=>({ id:p.id, name:p.name, category:p.category, barcode:p.barcode, stock:p.stock, price:p.price, costPrice:p.costPrice }));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(salesRows), 'Ventas');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(invRows), 'Inventario');
    XLSX.writeFile(wb, `Reporte_${from}_a_${to}.xlsx`);
    showToast('Reporte XLSX exportado');
  }catch(e){ console.error(e); alert('Error exportando reporte XLSX'); }
}

/* Reports: generate and preview */
function salesInRange(from,to){
  if(!from||!to) return [];
  const s = new Date(from + 'T00:00:00').getTime(), e = new Date(to + 'T23:59:59.999').getTime();
  return (STATE.sales||[]).filter(sale => {
    if(sale.deleted) return false;
    const t = new Date(sale.date).getTime();
    return t >= s && t <= e;
  });
}

function generateReportData(from,to){
  const sales = salesInRange(from,to);
  const groups = { EFECTIVO:{total:0,count:0,items:[]}, YAPE:{total:0,count:0,items:[]}, A_CREDITO:{total:0,count:0,items:[]}, OTHER:{total:0,count:0,items:[]} };
  let grand = 0;
  for(const s of sales){
    const key = (s.paymentType || s.method || 'EFECTIVO').toUpperCase();
    const cls = ['EFECTIVO','YAPE','A_CREDITO'].includes(key) ? key : 'OTHER';
    groups[cls].total += Number(s.total||0);
    groups[cls].count += 1;
    grand += Number(s.total||0);
    groups[cls].items.push(s);
  }
  return { groups, grand, totalOps: sales.length, sales };
}

function renderReportSummary(from,to){
  const { groups, grand, totalOps, sales } = generateReportData(from,to);
  const parts = [];
  parts.push(`<div style="display:flex;justify-content:space-between;align-items:center"><div><h2 style="margin:0">MINIMARKET — LA ESQUINA DEL AHORRO</h2><div class="small-muted">${from} → ${to}</div></div><div style="text-align:right"><div style="font-weight:800">Total S/ ${money(grand)}</div><div class="small-muted">${totalOps} ventas</div></div></div><hr/>`);
  parts.push(`<div style="display:flex;gap:8px;margin-top:8px">`);
  ['EFECTIVO','YAPE','A_CREDITO','OTHER'].forEach(k=>{
    const lbl = k==='A_CREDITO' ? 'A CREDITO' : (k==='OTHER' ? 'OTROS' : k);
    parts.push(`<div style="flex:1;padding:10px;background:#fff;border-radius:8px;border:1px solid #eee"><div class="small-muted">${lbl}</div><div style="font-weight:800;font-size:18px">S/ ${money(groups[k].total)}</div><div class="small-muted">${groups[k].count} ops</div></div>`);
  });
  parts.push(`</div><hr style="margin:12px 0"/>`);
  // sales table
  const rows = sales.map(s=>{
    const items = (s.items||[]).map(it => ((STATE.products.find(p=>p.id===it.productId)||{name:it.rawName||it.productId}).name) + ' x' + it.qty).join('; ');
    return `<tr><td>${new Date(s.date).toLocaleString()}</td><td>${s.id}</td><td>${escapeHtml(s.customerName||'-')}</td><td>${escapeHtml(s.paymentType||s.method||'EFECTIVO')}</td><td style="text-align:right">S/ ${money(s.total)}</td><td>${escapeHtml(items)}</td></tr>`;
  }).join('');
  const table = `<table style="width:100%;border-collapse:collapse;font-size:12px"><thead><tr><th>Fecha</th><th>ID</th><th>Cliente</th><th>Pago</th><th style="text-align:right">Total</th><th>Productos</th></tr></thead><tbody>${rows || '<tr><td colspan="6" class="small-muted">No hay ventas</td></tr>'}</tbody></table>`;
  $('#report-summary').innerHTML = parts.join('') + table + '<hr/>' + buildInventoryMiniHTML();
}

function buildInventoryMiniHTML(){
  const invRows = (STATE.products||[]).map(p=>`<tr><td>${escapeHtml(p.name)}</td><td>${escapeHtml(p.barcode||'')}</td><td style="text-align:right">${p.stock}</td><td style="text-align:right">S/ ${money(p.price||0)}</td></tr>`).join('');
  return `<h3 style="margin-top:10px">Inventario</h3><table style="width:100%;border-collapse:collapse;font-size:12px"><thead><tr><th>Producto</th><th>Cod</th><th style="text-align:right">Stock</th><th style="text-align:right">Precio</th></tr></thead><tbody>${invRows}</tbody></table>`;
}

function previewReportRange(){ const from = $('#rep-from').value || todayYMD(); const to = $('#rep-to').value || todayYMD(); renderReportSummary(from,to); }
function updateReportsIfOpen(){ if(!document.getElementById('tab-reports').classList.contains('hidden')) previewReportRange(); }

async function downloadReportPDF(){
  const from = $('#rep-from').value || todayYMD(); const to = $('#rep-to').value || todayYMD();
  renderReportSummary(from,to); // ensure content
  const el = document.getElementById('report-summary');
  if(!el) return alert('Generando PDF: no se encontró contenido del reporte');
  showToast('Generando PDF, espere...');
  try{
    const canvas = await html2canvas(el, { scale:2, useCORS:true, logging:false });
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jspdf.jsPDF('p','mm','a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgProps = pdf.getImageProperties(imgData);
    const pdfHeight = (imgProps.height * pageWidth) / imgProps.width;
    pdf.addImage(imgData, 'PNG', 10, 10, pageWidth-20, pdfHeight > (pageHeight-20) ? pageHeight-20 : pdfHeight);
    const filename = `Reporte del dia ${todayYMD()}.pdf`;
    pdf.save(filename);
    showToast('PDF descargado: ' + filename);
  }catch(e){ console.error(e); alert('Error generando PDF: ' + (e.message||e)); }
}

/* =========
   SCANNER (BarcodeDetector preferred; Quagga fallback)
   - auto-close camera when registered
   - if product not found -> open product modal with barcode pre-filled
   ========= */
let videoStream = null, detecting = false;
async function startScanner(){
  openModal('modal-scan');
  try{
    const constraints = { video: { facingMode: { ideal: 'environment' }, width: { ideal:1280 }, height: { ideal:720 } }, audio:false };
    videoStream = await navigator.mediaDevices.getUserMedia(constraints);
    $('#video').srcObject = videoStream;
    await $('#video').play();
    detecting = true;
    detectionLoop();
  }catch(e){
    console.warn('camera access err', e);
    alert('No se pudo acceder a la cámara: ' + (e && e.message || ''));
  }
}

async function stopScanner(){
  detecting = false;
  if(videoStream){ videoStream.getTracks().forEach(t=> t.stop()); videoStream = null; }
  if($('#video')) $('#video').srcObject = null;
}

async function detectionLoop(){
  const video = $('#video');
  while(detecting && video && !video.paused){
    try{
      if('BarcodeDetector' in window){
        const detector = new BarcodeDetector({ formats: ['ean_13','code_128','upc_e','upc_a','ean_8'] });
        const barcodes = await detector.detect(video);
        if(barcodes && barcodes.length){
          const code = barcodes[0].rawValue;
          $('#scanned-code').value = code;
          showToast('Código detectado: ' + code, 800);
          setTimeout(()=> registerScanned(), 400);
          break;
        }
      } else if(typeof Quagga !== 'undefined'){
        if(!Quagga.initialized){
          Quagga.init({
            inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#video') },
            decoder: { readers: ["code_128_reader","ean_reader","ean_8_reader","upc_reader","upc_e_reader"] },
            locate: true,
          }, function(err){
            if(err){ console.error(err); return; }
            Quagga.initialized = true; Quagga.start();
          });
          Quagga.onDetected(data => {
            const code = data.codeResult.code;
            $('#scanned-code').value = code;
            showToast('Código (Quagga): ' + code, 800);
            setTimeout(()=> registerScanned(), 400);
          });
        }
      }
    }catch(e){ console.warn('detect loop err', e); }
    await new Promise(r=>setTimeout(r, 300));
  }
}

function registerScanned(){
  const code = $('#scanned-code').value.trim();
  if(!code) return alert('No hay código detectado');
  const found = (STATE.products||[]).find(p=> p.barcode === code || (p.barcode||'').replace(/\D/g,'') === code.replace(/\D/g,''));
  if(found){
    addToCart(found);
    showToast('Agregado: ' + found.name);
    closeModal('modal-scan');
    stopScanner();
  } else {
    // open product modal with code prefilled
    closeModal('modal-scan');
    stopScanner();
    openModal('modal-product');
    $('#p-barcode').value = code;
    showToast('Código nuevo - complete registro');
  }
}

/* Scanner override: robust mobile camera + detector fallback */
const SCANNER = {
  stream: null,
  running: false,
  devices: [],
  index: 0,
  detector: null,
  lastCode: '',
  lastAt: 0,
  debounceMs: 1200,
  frameCanvas: document.createElement('canvas'),
  readers: ["code_128_reader","ean_reader","ean_8_reader","upc_reader","upc_e_reader"]
};

function scannerNormalize(code){
  return String(code || '').trim().replace(/\s+/g, '');
}

function scannerFindProductByCode(rawCode){
  const code = scannerNormalize(rawCode);
  if(!code) return null;
  const digits = code.replace(/\D/g,'');
  return (STATE.products||[]).find(p => {
    const bc = scannerNormalize(p.barcode);
    const bDigits = bc.replace(/\D/g,'');
    return bc === code || (digits && bDigits && bDigits === digits);
  }) || null;
}

function scannerHandleScannedCode(rawCode, source = 'scanner'){
  const code = scannerNormalize(rawCode);
  if(!code) return false;
  const found = scannerFindProductByCode(code);
  if(found){
    if(!$('#modal-sale')?.classList.contains('visible')){
      openModal('modal-sale');
    }
    addToCart(found);
    if($('#modal-scan')?.classList.contains('visible')){
      closeModal('modal-scan');
      window.stopScanner();
    }
    showToast(`Producto agregado (${source}): ${found.name}`);
    const posSearch = $('#pos-search');
    if(posSearch){
      posSearch.focus();
      posSearch.select?.();
    }
    return true;
  }

  if($('#modal-scan')?.classList.contains('visible')){
    closeModal('modal-scan');
    window.stopScanner();
  }
  openModal('modal-product');
  $('#p-barcode').value = code;
  $('#p-name')?.focus();
  showToast(`Código no registrado (${source}). Registrar producto.`);
  return false;
}

function scannerIsRepeated(code){
  const now = Date.now();
  if(code === SCANNER.lastCode && (now - SCANNER.lastAt) < SCANNER.debounceMs) return true;
  SCANNER.lastCode = code;
  SCANNER.lastAt = now;
  return false;
}

function scannerUpdateSwitchBtn(){
  const btn = $('#btn-scan-switch');
  if(!btn) return;
  btn.disabled = SCANNER.devices.length < 2;
  btn.style.opacity = btn.disabled ? '0.6' : '1';
}

async function scannerListDevices(){
  if(!navigator.mediaDevices?.enumerateDevices) return [];
  const devices = await navigator.mediaDevices.enumerateDevices();
  return devices.filter(d => d.kind === 'videoinput');
}

function scannerPreferredIndex(devices){
  if(!devices || devices.length === 0) return 0;
  const idx = devices.findIndex(d => /(back|rear|trase|ambiente|environment)/i.test(d.label || ''));
  return idx >= 0 ? idx : 0;
}

function scannerDrawGuide(){
  const video = $('#video');
  const canvas = $('#scan-canvas');
  if(!video || !canvas) return;
  const w = canvas.clientWidth || video.clientWidth || 0;
  const h = canvas.clientHeight || video.clientHeight || 0;
  if(w <= 0 || h <= 0) return;
  if(canvas.width !== w) canvas.width = w;
  if(canvas.height !== h) canvas.height = h;
  const ctx = canvas.getContext('2d');
  if(!ctx) return;
  ctx.clearRect(0, 0, w, h);
  const boxW = Math.floor(w * 0.78);
  const boxH = Math.floor(h * 0.28);
  const x = Math.floor((w - boxW) / 2);
  const y = Math.floor((h - boxH) / 2);
  ctx.strokeStyle = 'rgba(16,185,129,0.95)';
  ctx.lineWidth = 3;
  ctx.strokeRect(x, y, boxW, boxH);
}

function scannerStopTracks(){
  if(SCANNER.stream){
    SCANNER.stream.getTracks().forEach(t => t.stop());
    SCANNER.stream = null;
  }
  const video = $('#video');
  if(video) video.srcObject = null;
}

async function scannerStartVideo(deviceId){
  const video = $('#video');
  if(!video) throw new Error('No se encontro el elemento de video');
  const base = { width: { ideal: 1280 }, height: { ideal: 720 } };
  const preferred = deviceId ? { ...base, deviceId: { exact: deviceId } } : { ...base, facingMode: { ideal: 'environment' } };
  let stream = null;
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video: preferred, audio: false });
  }catch(_){
    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
  }
  SCANNER.stream = stream;
  video.srcObject = stream;
  await video.play();
}

function scannerOnDetected(raw, source){
  const code = scannerNormalize(raw);
  if(!code || scannerIsRepeated(code)) return;
  const input = $('#scanned-code');
  if(input) input.value = code;
  showToast(`Codigo detectado (${source}): ${code}`, 600);
  if(navigator.vibrate) try{ navigator.vibrate(60); }catch(_){}
  scannerHandleScannedCode(code, source);
}

async function scannerDetectWithNative(video){
  if(!('BarcodeDetector' in window)) return null;
  if(!SCANNER.detector){
    SCANNER.detector = new BarcodeDetector({ formats: ['ean_13','code_128','upc_e','upc_a','ean_8'] });
  }
  const list = await SCANNER.detector.detect(video);
  if(!list || list.length === 0) return null;
  return list[0]?.rawValue || null;
}

function scannerDetectWithQuagga(video){
  if(typeof Quagga === 'undefined') return Promise.resolve(null);
  const w = video.videoWidth || 0;
  const h = video.videoHeight || 0;
  if(w <= 0 || h <= 0) return Promise.resolve(null);
  const scanW = Math.floor(w * 0.82);
  const scanH = Math.floor(h * 0.34);
  const sx = Math.floor((w - scanW) / 2);
  const sy = Math.floor((h - scanH) / 2);
  SCANNER.frameCanvas.width = scanW;
  SCANNER.frameCanvas.height = scanH;
  const ctx = SCANNER.frameCanvas.getContext('2d');
  if(!ctx) return Promise.resolve(null);
  ctx.drawImage(video, sx, sy, scanW, scanH, 0, 0, scanW, scanH);
  const src = SCANNER.frameCanvas.toDataURL('image/jpeg', 0.85);
  return new Promise(resolve => {
    Quagga.decodeSingle({
      src,
      numOfWorkers: 0,
      locate: true,
      inputStream: { size: 1024 },
      decoder: { readers: SCANNER.readers }
    }, result => resolve(result?.codeResult?.code || null));
  });
}

async function scannerLoop(){
  const video = $('#video');
  if(!video) return;
  while(SCANNER.running){
    try{
      scannerDrawGuide();
      if(video.readyState >= 2){
        let code = null;
        if('BarcodeDetector' in window){
          code = await scannerDetectWithNative(video);
          if(code) scannerOnDetected(code, 'detector');
        } else {
          code = await scannerDetectWithQuagga(video);
          if(code) scannerOnDetected(code, 'quagga');
        }
      }
    }catch(e){
      console.warn('scan loop error', e);
    }
    await new Promise(r => setTimeout(r, ('BarcodeDetector' in window) ? 170 : 420));
  }
}

window.restartScanner = async function restartScanner(){
  try{
    await window.stopScanner();
    if(!navigator.mediaDevices?.getUserMedia){
      alert('Este navegador no soporta acceso a camara.');
      return;
    }
    SCANNER.devices = await scannerListDevices();
    if(SCANNER.devices.length > 0 && (SCANNER.index < 0 || SCANNER.index >= SCANNER.devices.length)){
      SCANNER.index = scannerPreferredIndex(SCANNER.devices);
    }
    const selectedId = SCANNER.devices[SCANNER.index]?.deviceId || null;
    await scannerStartVideo(selectedId);
    SCANNER.devices = await scannerListDevices();
    if(!selectedId && SCANNER.devices.length > 0){
      SCANNER.index = scannerPreferredIndex(SCANNER.devices);
    }
    scannerUpdateSwitchBtn();
    SCANNER.running = true;
    scannerLoop();
  }catch(e){
    console.warn('camera access err', e);
    alert('No se pudo acceder a la camara. Verifica permisos del navegador y usa HTTPS si aplica.');
  }
};

window.switchScannerCamera = async function switchScannerCamera(){
  SCANNER.devices = await scannerListDevices();
  if(SCANNER.devices.length < 2){
    showToast('Solo hay una camara disponible');
    scannerUpdateSwitchBtn();
    return;
  }
  SCANNER.index = (SCANNER.index + 1) % SCANNER.devices.length;
  await window.restartScanner();
};

window.startScanner = async function startScanner(){
  openModal('modal-scan');
  await window.restartScanner();
};

window.stopScanner = async function stopScanner(){
  SCANNER.running = false;
  SCANNER.detector = null;
  scannerStopTracks();
  const canvas = $('#scan-canvas');
  if(canvas){
    const ctx = canvas.getContext('2d');
    if(ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
};

window.registerScanned = function registerScanned(){
  const rawCode = $('#scanned-code')?.value || '';
  const code = scannerNormalize(rawCode);
  if(!code) return alert('No hay codigo detectado');
  scannerHandleScannedCode(code, 'manual');
};

// Ensure inline handlers and legacy references use the robust scanner implementation
startScanner = window.startScanner;
stopScanner = window.stopScanner;
registerScanned = window.registerScanned;

const HW_SCANNER = { buffer: '', lastTs: 0, maxGapMs: 65, minLen: 4, bound: false, lastCode: '', lastAt: 0, dedupeMs: 900 };
function setupHardwareScannerSupport(){
  if(HW_SCANNER.bound) return;
  HW_SCANNER.bound = true;
  document.addEventListener('keydown', (ev) => {
    const activeId = document.activeElement?.id || '';
    const activeTag = (document.activeElement?.tagName || '').toUpperCase();
    const isTypingContext = activeTag === 'INPUT' || activeTag === 'TEXTAREA' || activeTag === 'SELECT' || document.activeElement?.isContentEditable;
    const scannerInputs = activeId === 'pos-search' || activeId === 'scanned-code';
    if(isTypingContext && !scannerInputs) return;

    if(ev.key === 'Enter'){
      const candidate = HW_SCANNER.buffer;
      HW_SCANNER.buffer = '';
      if(candidate.length >= HW_SCANNER.minLen){
        ev.preventDefault();
        ev.stopPropagation();
        if(typeof ev.stopImmediatePropagation === 'function') ev.stopImmediatePropagation();
        const code = scannerNormalize(candidate);
        const now = Date.now();
        if(code === HW_SCANNER.lastCode && (now - HW_SCANNER.lastAt) < HW_SCANNER.dedupeMs){
          return;
        }
        HW_SCANNER.lastCode = code;
        HW_SCANNER.lastAt = now;
        scannerHandleScannedCode(code, 'lector');
      }
      return;
    }

    if(ev.key.length !== 1) return;
    if(!/[0-9A-Za-z\-_./]/.test(ev.key)) return;
    const now = Date.now();
    if(now - HW_SCANNER.lastTs > HW_SCANNER.maxGapMs){
      HW_SCANNER.buffer = '';
    }
    HW_SCANNER.lastTs = now;
    HW_SCANNER.buffer += ev.key;
    if(HW_SCANNER.buffer.length > 80){
      HW_SCANNER.buffer = HW_SCANNER.buffer.slice(-80);
    }
  }, true);
}

/* =========
   CLIENTS
   ========= */
$('#btn-open-clients')?.addEventListener('click', ()=> openModal('modal-clients'));
document.getElementById('form-client')?.addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const name = ($('#client-name').value||'').trim();
  const init = Number($('#client-initial').value) || 0;
  if(!name) return alert('Nombre requerido');
  const key = name.toLowerCase();
  const existing = (STATE.customers||[]).find(c=> (c.name||'').toLowerCase() === key);
  if(existing) {
    existing.balance = Number((Number(existing.balance||0) + init).toFixed(2));
    addPendingOp({ type: 'customer', payload: existing });
  } else {
    const customer = { id: 'C-'+Date.now(), name, balance: init, createdAt: new Date().toISOString() };
    STATE.customers.unshift(customer);
    addPendingOp({ type: 'customer', payload: customer });
  }
  $('#client-name').value=''; $('#client-initial').value='';
  saveLocalBackup();
  showToast('Cliente agregado/actualizado (cola si offline)');
  renderClients();
});

function renderClients(){
  const el = $('#clients-list'); if(!el) return; el.innerHTML='';
  const list = (STATE.customers||[]).sort((a,b)=> Number(b.balance||0) - Number(a.balance||0));
  if(list.length === 0) el.innerHTML = '<div class="small-muted">No hay clientes registrados</div>';
  list.forEach(c => {
    const row = document.createElement('div'); row.className='card flex justify-between items-center'; row.style.padding='8px';
    row.innerHTML = `<div><div style="font-weight:800">${escapeHtml(c.name)}</div><div class="small-muted">Saldo: S/ ${money(c.balance||0)}</div></div>
      <div style="display:flex;gap:6px">
        <button onclick="promptAddPayment('${escapeHtml(c.name)}')" class="px-3 py-1 border rounded">Abonar</button>
        <button onclick="clearDebt('${escapeHtml(c.name)}')" class="px-3 py-1 border rounded">Saldar</button>
      </div>`;
    el.appendChild(row);
  });
}

/* Abono and Clear debt */
async function promptAddPayment(name){
  const amt = prompt('Ingrese monto de abono para ' + name);
  if(!amt) return;
  const val = Number(amt);
  if(isNaN(val) || val <= 0) return alert('Monto inválido');
  const c = (STATE.customers||[]).find(x=> (x.name||'') === name);
  if(!c) return alert('Cliente no encontrado');
  c.balance = Number((Number(c.balance||0) - val).toFixed(2));
  if(c.balance < 0) c.balance = 0;
  addPendingOp({ type: 'customer', payload: c });
  saveLocalBackup();
  showToast('Abono registrado (cola si offline)');
  renderClients();
}

async function clearDebt(name){
  if(!confirm('Saldar deuda de: ' + name + ' ?')) return;
  const c = (STATE.customers||[]).find(x=> (x.name||'') === name);
  if(!c) return alert('Cliente no encontrado');
  c.balance = 0;
  addPendingOp({ type: 'customer', payload: c });
  saveLocalBackup();
  showToast('Deuda saldada (cola si offline)');
  renderClients();
}

/* =========
   PRODUCT CRUD
   ========= */
document.getElementById('form-p')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  try{
    const id = $('#p-id').value || uid();
    const prod = {
      id,
      name: $('#p-name').value.trim(),
      barcode: $('#p-barcode').value.trim(),
      category: $('#p-cat').value.trim(),
      costPrice: Number($('#p-cost').value) || 0,
      price: Number($('#p-price').value) || 0,
      stock: Number($('#p-stock').value) || 0,
      createdAt: new Date().toISOString(),
      movements: (STATE.products.find(p=>p.id===id)?.movements)||[]
    };
    const idx = (STATE.products||[]).findIndex(p=>p.id===id);
    if(idx >= 0) STATE.products[idx] = prod; else STATE.products.unshift(prod);
    saveLocalBackup();
    addPendingOp({ type: 'product', payload: prod });
    showToast('Producto guardado (cola si offline)');
    renderInventoryList(); renderDashboard();
    closeModal('modal-product');
  }catch(e){ console.error(e); alert('Error guardando producto: '+ (e.message||e)); }
});

function editProduct(id){
  const p = (STATE.products||[]).find(x=> x.id === id); if(!p) return alert('Producto no encontrado');
  $('#p-id').value = p.id; $('#p-name').value = p.name; $('#p-barcode').value = p.barcode; $('#p-cat').value = p.category;
  $('#p-cost').value = p.costPrice||0; $('#p-price').value = p.price||0; $('#p-stock').value = p.stock||0;
  $('#btn-delete-p').classList.remove('hidden'); openModal('modal-product');
}

function deleteProduct(){
  const id = $('#p-id').value; if(!id) return;
  if(!confirm('Eliminar producto?')) return;
  STATE.products = (STATE.products||[]).filter(p=>p.id !== id);
  saveLocalBackup();
  addPendingOp({ type: 'product', payload: { id, deleted: true } });
  renderInventoryList(); renderDashboard(); closeModal('modal-product'); showToast('Producto eliminado (cola si offline)');
}

function calculateUnitPrice(){
  const cost = Number($('#p-cost').value)||0; const stock = Number($('#p-stock').value)||1;
  if(stock <= 0) return alert('Stock debe ser mayor que 0');
  const unit = cost / stock;
  $('#p-price').value = (unit * 1.30).toFixed(2);
  showToast('Precio estimado calculado');
}

/* =========
   LOGIN (local)
   ========= */
const ALLOWED_PASS = 'magaly';
$('#btn-login')?.addEventListener('click', ()=> {
  const user = ($('#l-user').value||'').trim().toLowerCase();
  const pass = ($('#l-pass').value||'').trim();
  const err = $('#login-error'); err.classList.add('hidden'); err.textContent = '';
  if(!user || !pass){ err.textContent = 'Completa usuario y contraseña'; err.classList.remove('hidden'); return; }
  if((user === 'liz' || user === 'lismagaly' || user === 'lis') && pass === ALLOWED_PASS){
    localStorage.setItem('auth_token','ok'); $('#login-screen').style.display = 'none'; lucide.createIcons(); startApp();
  } else { err.textContent = 'Usuario o contraseña incorrectos'; err.classList.remove('hidden'); $('#l-pass').value = ''; $('#l-pass').focus(); }
});
$('#btn-demo')?.addEventListener('click', ()=> { localStorage.setItem('auth_token','ok'); $('#login-screen').style.display = 'none'; startApp(); });

function logout(){ localStorage.removeItem('auth_token'); location.reload(); }

/* Modal helpers with visualViewport handling to avoid keyboard overlapping on mobile */
function openModal(id){
  const m = document.getElementById(id);
  if(!m) return;
  m.classList.add('visible');
  if(id === 'modal-sale'){
    setTimeout(()=> { $('#pos-search')?.focus(); }, 40);
  }
  if(id === 'modal-product'){
    setTimeout(()=> { $('#p-name')?.focus(); }, 40);
  }
  // adjust modal position to center even with keyboard: set max-height to visualViewport.height - 40
  const sheet = m.querySelector('.modal-sheet');
  if(sheet){
    try{
      const vv = (window.visualViewport && window.visualViewport.height) ? window.visualViewport.height : window.innerHeight;
      sheet.style.maxHeight = (vv - 40) + 'px';
      // attach visualViewport resize handler
      const adjust = ()=> {
        const vh = (window.visualViewport && window.visualViewport.height) ? window.visualViewport.height : window.innerHeight;
        sheet.style.maxHeight = (vh - 40) + 'px';
        // keep sheet centered visually if keyboard open
        if(window.visualViewport){
          const offset = Math.max(0, (window.innerHeight - window.visualViewport.height));
          sheet.style.transform = `translateY(-${offset/4}px)`;
        }
      };
      // store handler reference for closure
      m._vvHandler = adjust;
      if(window.visualViewport) window.visualViewport.addEventListener('resize', adjust);
    }catch(e){}
  }
}

function closeModal(id){
  const m = document.getElementById(id);
  if(!m) return;
  m.classList.remove('visible');
  const sheet = m.querySelector('.modal-sheet');
  if(sheet && m._vvHandler && window.visualViewport) try{ window.visualViewport.removeEventListener('resize', m._vvHandler); }catch(e){}
  // stop scanner if closing scanner modal
  if(id === 'modal-scan' && window.stopScanner) window.stopScanner();
}

/* Utility to switch tabs */
function switchTab(tab){
  $('#tab-home').classList.add('hidden'); $('#tab-inventory').classList.add('hidden'); $('#tab-reports').classList.add('hidden');
  if(tab === 'home') $('#tab-home').classList.remove('hidden');
  if(tab === 'inventory') $('#tab-inventory').classList.remove('hidden');
  if(tab === 'reports') $('#tab-reports').classList.remove('hidden');
  lucide.createIcons();
  updateReportsIfOpen();
}

/* Bind header buttons */
$('#btn-gestion')?.addEventListener('click', ()=> { openModal('modal-gestion'); renderGestionList(); });
$('#btn-sync')?.addEventListener('click', ()=> { if(db) { forceSync(); } else { initFirebase(); startFirestoreSync(); } });

/* =========
   FORCE SYNC (admin action)
   - normalizes remote and writes back merged data
   ========= */
async function forceSync(){
  if(!db) return alert('Cloud no inicializado');
  if(!confirm('Forzar sincronización desde subcolecciones?')) return;
  try{
    await migrateOldDataToSubcollections();
    const [products, customers, sales] = await Promise.all([
      fetchSubcollectionDocs(SUBCOLS.products),
      fetchSubcollectionDocs(SUBCOLS.customers),
      fetchSubcollectionDocs(SUBCOLS.sales),
    ]);
    mergeState({ products, customers, sales });
    renderAll();
    processPendingOps();
    showToast('Sincronía forzada OK');
  }catch(e){ console.error(e); alert('forceSync error: ' + (e.message||e)); }
}

/* =========
   startApp
   ========= */
async function startApp(){
  lucide.createIcons();
  renderAll();
  initFirebase();
  startFirestoreSync();
  $('#rep-from').value = todayYMD(); $('#rep-to').value = todayYMD();
  $('#search-inv')?.addEventListener('input', renderInventoryList);
  setupPosSearch();
  setupHardwareScannerSupport();
  // expose some globals for debugging
  window.STATE = STATE; window.pendingOps = pendingOps;
  window.upsertProduct = upsertProduct; window.upsertCustomer = upsertCustomer; window.upsertSale = upsertSale;
  window.processPendingOps = processPendingOps; window.addPendingOp = addPendingOp;
}

/* DOM Ready */
document.addEventListener('DOMContentLoaded', ()=>{
  lucide.createIcons();
  if(localStorage.getItem('auth_token')){ $('#login-screen').style.display = 'none'; startApp(); } else { $('#login-screen').style.display = 'flex'; }
});

/* periodic local backup */
setInterval(()=> { try{ saveLocalBackup(); }catch(e){} }, 15000);

</script>
</body>
</html>

