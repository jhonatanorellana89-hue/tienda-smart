<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>MINIMARKET LA ESQUINA DEL AHORRO — TiendaSmart (Móvil)</title>
  <!-- Tailwind (CDN por prototipo) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Dependencias -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
    :root{ --bg:#f3f4f6; --card:#fff; --muted:#6b7280; --accent:#0ea5a2; --danger:#ef4444; }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);-webkit-user-select:none;user-select:none;}
    .app{height:100vh;display:flex;flex-direction:column;overflow:hidden;}
    header.mobile-top{height:76px;display:flex;align-items:center;padding:8px 12px;gap:10px;background:linear-gradient(90deg,#06b6d4,#3b82f6);color:white;}
    header .brand{display:flex;gap:10px;align-items:center}
    main.content{flex:1;overflow:auto;padding:10px;box-sizing:border-box;}
    .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(2,6,23,0.06);margin-bottom:10px;border:1px solid #e6e6e6;}
    .search-row{display:flex;gap:8px;position:relative}
    .search-row input[type="search"]{flex:1;padding:12px;border-radius:12px;border:1px solid #d1d5db;background:white}
    .big-btn{padding:12px;border-radius:12px;min-height:48px;font-weight:700;display:flex;align-items:center;justify-content:center}
    .action-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    .inventory-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(180deg,#fff,#fafafa);border:1px solid #d1d5db;margin-bottom:8px}
    .inventory-item .meta{font-size:15px;font-weight:700}
    .inventory-item .sub{font-size:12px;color:var(--muted)}
    .fixed-bottom{position:fixed;left:0;right:0;bottom:0;padding:10px;background:linear-gradient(180deg,rgba(255,255,255,0.98),rgba(255,255,255,0.98));box-shadow:0 -8px 30px rgba(2,6,23,0.06);display:flex;gap:8px;align-items:center;justify-content:space-between}
    .fixed-bottom .btn{flex:1;margin:0 6px;padding:12px;border-radius:12px;text-align:center;border:1px solid #d1d5db;background:white}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:12px;z-index:80;background:rgba(0,0,0,0.45)}
    .modal.visible{display:flex}
    .modal .modal-card{width:100%;max-width:420px;border-radius:12px;overflow:hidden}
    video#video{width:100%;height:100%;object-fit:cover;border-radius:6px}
    canvas#overlay-canvas{position:absolute;left:0;top:0;pointer-events:none}
    .suggestions{position:absolute;background:white;border:1px solid #e5e7eb;border-radius:8px;max-height:240px;overflow:auto;z-index:90;width:calc(100% - 24px)}
    .small-muted{font-size:12px;color:var(--muted)}
    .bordered{border:1px solid #cbd5e1;border-radius:8px}
    /* Mobile vertical fit: reduce paddings and use full height scroller */
    @media(max-width:420px){
      header.mobile-top{height:64px;padding:6px}
      .card{padding:8px;border-radius:10px}
      .big-btn{min-height:44px;padding:10px}
    }
    @media(min-width:420px){ .app{max-width:420px;margin:0 auto;} }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="TiendaSmart móvil">

    <!-- TOP -->
    <header class="mobile-top">
      <div class="brand">
        <div style="width:44px;height:44px;border-radius:8px;background:linear-gradient(180deg,#10b981,#3b82f6);display:flex;align-items:center;justify-content:center;color:white">TS</div>
        <div style="line-height:1">
          <div style="font-size:14px;font-weight:700">MINIMARKET LA ESQUINA DEL AHORRO</div>
          <div class="small-muted">TiendaSmart — Móvil</div>
        </div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <div id="cloud-label" class="small-muted" style="color:white">desconectado</div>
        <button id="btn-open-reports" class="big-btn bg-white text-slate-700">Reportes</button>
      </div>
    </header>

    <!-- MAIN -->
    <main class="content" id="app-content">

      <div class="card bordered">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div>
            <div class="small-muted">Encargado del día</div>
            <div id="responsible-display" style="font-weight:700">—</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="responsible-date" type="date" class="px-3 py-2 rounded border bg-white small-muted"/>
            <input id="responsible-name" placeholder="Nombre encargado" class="px-3 py-2 rounded border w-36" />
            <button id="save-responsible" class="bg-indigo-600 text-white px-3 py-2 rounded">Guardar</button>
          </div>
        </div>
      </div>

      <div class="card bordered">
        <div class="search-row">
          <input id="search" type="search" placeholder="Buscar producto o código..." />
        </div>

        <div class="action-grid mt-3">
          <button id="btn-add-product" class="big-btn bg-green-500 text-white">+ Producto</button>
          <button id="btn-open-scan" class="big-btn bg-yellow-400 text-white">Escanear</button>
          <button id="btn-open-quick" class="big-btn bg-red-600 text-white">Venta Rápida</button>
          <button id="btn-open-clients" class="big-btn bg-indigo-700 text-white">Clientes</button>
        </div>
      </div>

      <div id="inventory-list" class="mb-24"></div>

      <div class="card small-muted bordered">
        <!-- Removed statistical images by design (user requested) -->
        La app sincroniza con Firestore en <code>MODO DE PREODUCCIÓN / DATOS</code> → campo <code>MAGALY</code>. (Las ventas se guardan y sincronizan antes de generar reportes.)
      </div>

    </main>

    <!-- bottom -->
    <div class="fixed-bottom">
      <button id="btn-import-xlsx" class="btn">Importar</button>
      <button id="btn-export-xlsx" class="btn">Exportar</button>
      <button id="btn-sync-toggle" class="btn" style="background:#06b6d4;color:white">Cloud auto</button>
    </div>
    <input id="file-xlsx" type="file" accept=".xlsx,.xls" class="hidden" />

    <!-- MODALES -->
    <!-- PRODUCT -->
    <div id="modal-product" class="modal" aria-hidden="true">
      <div class="modal-card card p-3 bordered">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Producto</div>
          <button data-close class="text-xl">✕</button>
        </div>
        <form id="form-product" class="mt-3 space-y-2">
          <input type="hidden" id="product-id" />
          <input id="product-name" placeholder="Nombre" required class="w-full px-3 py-2 border rounded" />
          <div style="display:flex;gap:8px;">
            <input id="product-category" placeholder="Categoría" class="flex-1 px-3 py-2 border rounded" />
            <input id="product-price" placeholder="Precio" type="number" step="0.01" class="w-24 px-3 py-2 border rounded" />
          </div>
          <div style="display:flex;gap:8px;">
            <input id="product-barcode" placeholder="Código de barras" class="flex-1 px-3 py-2 border rounded" />
            <input id="product-stock" placeholder="Stock" type="number" class="w-24 px-3 py-2 border rounded" />
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;">
            <button data-close type="button" class="px-3 py-2 border rounded">Cancelar</button>
            <!-- Save moved inside modal (visible) -->
            <button id="btn-save-product" type="submit" class="px-3 py-2 bg-green-600 text-white rounded">Guardar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- QUICK SALE modal -->
    <div id="modal-quick" class="modal" aria-hidden="true">
      <div class="modal-card card p-3 bordered">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Venta Rápida</div>
          <button data-close class="text-xl">✕</button>
        </div>
        <div class="mt-3 space-y-2">
          <div style="display:flex;gap:8px;">
            <input id="quick-barcode" placeholder="Escanear o buscar código" class="flex-1 px-3 py-2 border rounded" />
            <button id="quick-scan-btn" class="px-3 py-2 bg-yellow-400 rounded">Escanear</button>
          </div>
          <div style="display:flex;gap:8px;">
            <input id="quick-qty" placeholder="Cant" type="number" value="1" class="w-24 px-3 py-2 border rounded" />
            <button id="quick-sell-btn" class="px-3 py-2 bg-red-600 text-white rounded">Vender</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SCAN modal -->
    <div id="modal-scan" class="modal" aria-hidden="true">
      <div class="modal-card card p-0 bordered">
        <div style="background:#000;color:white;padding:12px;display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Escanear código</div>
          <div>
            <button id="scan-register" class="px-3 py-2 bg-green-600 text-white rounded mr-2" style="display:none">Registrar</button>
            <button id="scan-close" data-close class="px-3 py-2 border rounded">Cerrar</button>
          </div>
        </div>
        <div style="position:relative;height:320px;">
          <video id="video"></video>
          <canvas id="overlay-canvas"></canvas>
        </div>
        <div style="padding:10px;display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div class="small-muted">Al detectar un código puedes editar/registrar o vincular a una venta.</div>
          <div>
            <button id="btn-scan-find" class="px-3 py-2 bg-indigo-600 text-white rounded">Buscar</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // ---------- CONFIG: rellena con tu firebaseConfig antes de usar ----------
    const firebaseConfig = {
      // apiKey: "...",
      // authDomain: "...",
      // projectId: "...",
      // storageBucket: "...",
      // messagingSenderId: "...",
      // appId: "..."
    };

    // Quick guard: user must paste config
    if (!firebaseConfig || !firebaseConfig.projectId) {
      console.warn('Por favor pega tu firebaseConfig en la variable firebaseConfig del archivo antes de usar la sincronización Cloud.');
    }

    // Inicializar Firebase (compat)
    try {
      firebase.initializeApp(firebaseConfig);
      var db = firebase.firestore();
    } catch (e) {
      console.warn('Firebase no inicializado. La app funcionará en modo local hasta que se agregue la configuración.');
    }

    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);
    const showModal = (id)=> document.getElementById(id).classList.add('visible');
    const hideModal = (id)=> document.getElementById(id).classList.remove('visible');

    // Local cache for faster UI
    let productsCache = {};
    let unsubscribeInventory = null;
    let autoSync = true;

    // ---------- UI bindings ----------
    document.addEventListener('click', (e)=>{ if (e.target.matches('[data-close]')) { e.target.closest('.modal').classList.remove('visible'); stopScanner(); } });

    $('save-responsible').addEventListener('click', ()=>{
      const name = $('responsible-name').value.trim(); const date = $('responsible-date').value;
      if (name) { localStorage.setItem('responsible_name', name); localStorage.setItem('responsible_date', date); $('responsible-display').textContent = name + (date?(' • '+date):''); }
    });
    // Load responsible
    if (localStorage.getItem('responsible_name')){
      $('responsible-display').textContent = localStorage.getItem('responsible_name') + (localStorage.getItem('responsible_date')?(' • '+localStorage.getItem('responsible_date')):'');
    }

    // Buttons
    $('btn-add-product').addEventListener('click', ()=>{ openProductModal(); });
    $('btn-open-scan').addEventListener('click', ()=>{ openScanModal(); });
    $('btn-open-quick').addEventListener('click', ()=>{ showModal('modal-quick'); });

    // IMPORT / EXPORT
    $('btn-import-xlsx').addEventListener('click', ()=> $('file-xlsx').click());
    $('file-xlsx').addEventListener('change', handleXlsxFile);
    $('btn-export-xlsx').addEventListener('click', exportProductsToXlsx);

    // Sync toggle
    $('btn-sync-toggle').addEventListener('click', ()=>{ autoSync = !autoSync; $('btn-sync-toggle').textContent = autoSync? 'Cloud auto' : 'Cloud OFF'; if (autoSync) startRealtimeInventory(); else stopRealtimeInventory(); });

    // PRODUCT FORM
    $('form-product').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const id = $('product-id').value || null;
      const p = {
        name: $('product-name').value.trim(),
        category: $('product-category').value.trim(),
        price: parseFloat($('product-price').value) || 0,
        barcode: $('product-barcode').value.trim(),
        stock: parseInt($('product-stock').value) || 0,
        updatedAt: firebase && firebase.firestore ? firebase.firestore.FieldValue.serverTimestamp() : new Date()
      };
      try { await saveProductToFirestore(p, id); hideModal('modal-product'); } catch(err){ console.error(err); alert('Error al guardar producto: '+err.message); }
    });

    // Quick sale handlers
    $('quick-scan-btn').addEventListener('click', ()=>{ openScanModal({forQuick:true}); });
    $('quick-sell-btn').addEventListener('click', async ()=>{
      const code = $('quick-barcode').value.trim(); const qty = parseInt($('quick-qty').value) || 1;
      if (!code) return alert('Ingresa o escanea un código');
      const prod = await findProductByBarcode(code);
      if (!prod) return alert('Producto no encontrado; escanéalo y regístralo primero.');
      await registerSale(prod, qty);
      hideModal('modal-quick');
    });

    // Scan modal actions
    let scanContext = {};
    function openScanModal(opts={}){
      scanContext = opts;
      showModal('modal-scan');
      startScanner();
      $('scan-register').style.display = 'none';
    }

    $('btn-scan-find').addEventListener('click', async ()=>{
      // take last detected code or value from quick modal
      const code = scanContext.lastCode || prompt('Introduce código para buscar:');
      if (!code) return;
      const prod = await findProductByBarcode(code);
      if (prod) { openProductModal(prod); hideModal('modal-scan'); stopScanner(); }
      else { // allow direct register
        openProductModal({barcode: code}); hideModal('modal-scan'); stopScanner();
      }
    });

    $('scan-register').addEventListener('click', ()=>{
      // opens registration prefilled with last code
      openProductModal({barcode: scanContext.lastCode});
      hideModal('modal-scan'); stopScanner();
    });

    $('scan-close').addEventListener('click', ()=>{ hideModal('modal-scan'); stopScanner(); });

    // ---------- Firestore helpers ----------
    async function saveProductToFirestore(product, id=null){
      if (!db) { // fallback local storage
        const key = 'local_products';
        const list = JSON.parse(localStorage.getItem(key)||'[]');
        if (id){ const idx = list.findIndex(x=>x.id===id); if (idx>=0) list[idx] = {...list[idx], ...product}; }
        else { list.push({...product, id:'local-'+Date.now()}); }
        localStorage.setItem(key, JSON.stringify(list)); renderInventory(list);
        return;
      }
      if (id){ await db.collection('products').doc(id).set(product, {merge:true}); }
      else{
        // If barcode exists, update existing doc
        if (product.barcode){
          const q = await db.collection('products').where('barcode','==',product.barcode).limit(1).get();
          if (!q.empty){ const doc = q.docs[0]; await doc.ref.set(product, {merge:true}); return; }
        }
        await db.collection('products').add(product);
      }
    }

    async function findProductByBarcode(barcode){
      // check cache first
      for (const id in productsCache){ if (productsCache[id].barcode === barcode) return {...productsCache[id], id}; }
      if (!db) return null;
      const q = await db.collection('products').where('barcode','==',barcode).limit(1).get();
      if (q.empty) return null;
      const d = q.docs[0]; return {...d.data(), id: d.id};
    }

    async function registerSale(product, qty=1){
      const amount = (product.price||0) * qty;
      if (!db){ // local fallback
        const sales = JSON.parse(localStorage.getItem('local_sales')||'[]');
        sales.push({productId: product.id||product.barcode, name: product.name, qty, amount, date: new Date().toISOString()});
        localStorage.setItem('local_sales', JSON.stringify(sales)); alert('Venta registrada (local)'); return;
      }
      // transaction: reduce stock and write sale and update daily report
      const productRef = db.collection('products').doc(product.id);
      await db.runTransaction(async (tx)=>{
        const doc = await tx.get(productRef);
        const currentStock = (doc.exists && doc.data().stock) ? doc.data().stock : 0;
        tx.update(productRef, {stock: currentStock - qty});
        const saleRef = db.collection('sales').doc();
        tx.set(saleRef, {productId: product.id, name: product.name, qty, amount, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
        const dateKey = new Date().toISOString().slice(0,10);
        const reportRef = db.collection('reports').doc(dateKey);
        tx.set(reportRef, { totalSales: firebase.firestore.FieldValue.increment(amount), totalItems: firebase.firestore.FieldValue.increment(qty) }, {merge:true});
      });
      alert('Venta registrada y reportada.');
    }

    // Realtime inventory
    function startRealtimeInventory(){
      if (!db) return loadInventoryFromLocal();
      if (unsubscribeInventory) return; // already
      unsubscribeInventory = db.collection('products').onSnapshot(snapshot=>{
        productsCache = {};
        const list = [];
        snapshot.forEach(doc=>{ const d = doc.data(); d.id = doc.id; productsCache[doc.id] = d; list.push({...d, id: doc.id}); });
        renderInventory(list);
        $('cloud-label').textContent = 'conectado';
      }, err=>{ console.error(err); $('cloud-label').textContent = 'error cloud'; });
    }
    function stopRealtimeInventory(){ if (unsubscribeInventory) { unsubscribeInventory(); unsubscribeInventory=null; } }

    function loadInventoryFromLocal(){ const list = JSON.parse(localStorage.getItem('local_products')||'[]'); renderInventory(list); }

    function renderInventory(list){
      const container = $('inventory-list'); container.innerHTML='';
      list.forEach(p=>{
        const el = document.createElement('div'); el.className='inventory-item bordered';
        el.innerHTML = `<div><div class="meta">${p.name||'—'}</div><div class="sub">${p.category||''} • ${p.barcode||'—'}</div></div><div style="text-align:right"><div style="font-weight:700">S/${(p.price||0).toFixed(2)}</div><div class="sub">stock: ${p.stock||0}</div><div style="margin-top:6px"><button data-id="${p.id||''}" class="edit-btn px-2 py-1 border rounded">Editar</button> <button data-id="${p.id||''}" class="sell-btn px-2 py-1 bg-red-600 text-white rounded">Vender</button></div></div>`;
        container.appendChild(el);
      });
      // attach handlers
      container.querySelectorAll('.edit-btn').forEach(b=> b.addEventListener('click', async (ev)=>{
        const id = ev.target.dataset.id; const prod = await loadProductById(id); openProductModal(prod);
      }));
      container.querySelectorAll('.sell-btn').forEach(b=> b.addEventListener('click', async (ev)=>{
        const id = ev.target.dataset.id; const prod = await loadProductById(id); const qty = parseInt(prompt('Cantidad a vender', '1'))||1; if (prod) await registerSale(prod, qty);
      }));
    }

    async function loadProductById(id){ if (!id) return null; if (productsCache[id]) return {...productsCache[id], id}; if (!db) return null; const d = await db.collection('products').doc(id).get(); if (!d.exists) return null; return {...d.data(), id:d.id}; }

    // open product modal with optional prefill
    function openProductModal(prefill={}){
      $('product-id').value = prefill.id || '';
      $('product-name').value = prefill.name || '';
      $('product-category').value = prefill.category || '';
      $('product-price').value = prefill.price || '';
      $('product-barcode').value = prefill.barcode || '';
      $('product-stock').value = prefill.stock || 0;
      showModal('modal-product');
    }

    // ---------- SCANNER (QuaggaJS) ----------
    function startScanner(){
      if (!navigator.mediaDevices) return alert('Tu navegador no soporta la cámara.');
      Quagga.init({ inputStream: { name: 'Live', type: 'LiveStream', target: document.querySelector('#modal-scan video'), constraints:{ facingMode: 'environment' } }, decoder: { readers: ["ean_reader","ean_8_reader","code_128_reader","upc_reader","upc_e_reader"] }, locate: true }, function(err) {
        if (err) { console.error(err); return; }
        Quagga.start();
      });
      Quagga.onDetected(handleDetected);
    }
    function stopScanner(){ try{ Quagga.offDetected(handleDetected); Quagga.stop(); }catch(e){}
    }
    function handleDetected(result){
      const code = result.codeResult && result.codeResult.code;
      if (!code) return;
      scanContext.lastCode = code;
      // show register option if not found
      findProductByBarcode(code).then(p=>{
        if (!p){ $('scan-register').style.display = 'inline-block'; }
        else { $('scan-register').style.display = 'none'; }
      });
      // quick visual overlay: draw box
      const canvas = document.getElementById('overlay-canvas'); const ctx = canvas.getContext('2d');
      canvas.width = document.querySelector('#modal-scan video').videoWidth || 320; canvas.height = document.querySelector('#modal-scan video').videoHeight || 240;
      if (result.box){ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.strokeStyle='lime'; ctx.lineWidth=3; ctx.beginPath(); const b = result.box; ctx.moveTo(b[0][0], b[0][1]); for (let i=1;i<b.length;i++) ctx.lineTo(b[i][0], b[i][1]); ctx.closePath(); ctx.stroke(); }
    }

    // ---------- XLSX import/export connected to Firestore ----------
    async function handleXlsxFile(e){
      const f = e.target.files[0]; if (!f) return; const data = await f.arrayBuffer(); const wb = XLSX.read(data); const ws = wb.Sheets[wb.SheetNames[0]]; const json = XLSX.utils.sheet_to_json(ws, {defval: ''});
      // Expect columns: name, category, price, barcode, stock
      for (const row of json){
        const p = { name: row.name||row.Nombre||row.nombre, category: row.category||row.Categoria||'', price: parseFloat(row.price||row.Precio||0)||0, barcode: String(row.barcode||row.Codigo||row.codigo||''), stock: parseInt(row.stock||row.Stock||0)||0 };
        try{ await saveProductToFirestore(p, null); }catch(err){ console.error('error import row', err); }
      }
      alert('Importación finalizada.');
      e.target.value = '';
    }

    async function exportProductsToXlsx(){
      if (!db){ // local export
        const list = JSON.parse(localStorage.getItem('local_products')||'[]'); const ws = XLSX.utils.json_to_sheet(list); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Productos'); XLSX.writeFile(wb, 'productos.xlsx'); return;
      }
      const snap = await db.collection('products').get(); const arr = []; snap.forEach(d=> arr.push({ id:d.id, ...d.data() })); const ws = XLSX.utils.json_to_sheet(arr); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Productos'); XLSX.writeFile(wb, 'productos_firestone.xlsx');
    }

    // ---------- Boot ----------
    function boot(){ if (db) startRealtimeInventory(); else loadInventoryFromLocal(); }
    boot();
  </script>
</body>
</html>

</body>
</html>
