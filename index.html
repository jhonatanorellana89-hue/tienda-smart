<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>MINIMARKET LA ESQUINA DEL AHORRO â€” TiendaSmart (MÃ³vil)</title>

<!-- Tailwind (prototipo) -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Dependencias -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
  :root{
    --bg-900:#071127; --bg-800:#0f172a; --card:#0f172a; --muted:#9aa4b2; --accent-1:#06b6d4; --accent-2:#3b82f6; --success:#10b981; --danger:#ef4444;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg-900),var(--bg-800));color:#e6eef8;-webkit-font-smoothing:antialiased}
  .app{min-height:100vh;display:flex;flex-direction:column;overflow:hidden}

  /* Header */
  header.mobile-top{height:90px;display:flex;align-items:center;gap:12px;padding:14px;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:white;box-sizing:border-box;border-bottom-left-radius:18px;border-bottom-right-radius:18px}
  .brand{display:flex;gap:12px;align-items:center}
  .brand .logo{width:56px;height:56px;border-radius:14px;background:linear-gradient(135deg,#10b981,#3b82f6);display:flex;justify-content:center;align-items:center;box-shadow:0 8px 30px rgba(11,20,32,0.6)}
  .brand h1{font-size:16px;margin:0;font-weight:800;letter-spacing:0.2px}
  .brand p{margin:0;font-size:12px;color:rgba(255,255,255,0.95)}

  /* Content */
  .content{flex:1;overflow:auto;padding:18px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 8px 28px rgba(2,6,23,0.5);border:1px solid rgba(255,255,255,0.03)}

  /* Search and actions */
  .search{display:flex;gap:10px}
  input[type="search"], input, select, textarea {padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#e6eef8;outline:none;font-size:14px}
  input::placeholder{color:rgba(255,255,255,0.36)}
  .actions-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
  .btn-big{padding:12px;border-radius:12px;text-align:center;font-weight:800;box-shadow:0 6px 14px rgba(2,6,23,0.25);border:none;cursor:pointer;transition:transform .12s ease,box-shadow .12s ease}
  .btn-big:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(2,6,23,0.5)}

  /* Inventory list */
  .inventory-grid{display:grid;grid-template-columns:repeat(1,1fr);gap:12px}
  .inventory-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.03);gap:12px}
  .inventory-item .left{display:flex;gap:12px;align-items:center}
  .thumb{width:56px;height:56px;border-radius:10px;background:linear-gradient(180deg,#e6eef8, #dbeafe);display:flex;align-items:center;justify-content:center;color:#0b1220;font-weight:800}
  .meta-wrap{min-width:0}
  .meta{font-weight:800;color:#e6eef8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .sub{font-size:12px;color:var(--muted);margin-top:6px}
  .price-stock{display:flex;flex-direction:column;align-items:flex-end;gap:4px}
  .price{font-weight:800;color:#dbeafe}
  .stock{font-size:12px;color:var(--muted)}

  /* Buttons small */
  .btn-sm{padding:8px 10px;border-radius:10px;border:none;cursor:pointer;font-weight:800}
  .btn-danger{background:linear-gradient(90deg,var(--danger),#ff6b6b);color:white}
  .btn-primary{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:white}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#e6eef8}

  /* Fixed bottom */
  .fixed-bottom{position:fixed;left:16px;right:16px;bottom:20px;padding:12px;background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:16px;border:1px solid rgba(255,255,255,0.03);display:flex;gap:12px;justify-content:space-between;box-shadow:0 18px 40px rgba(2,6,23,0.6)}
  .fixed-bottom .btn{flex:1;padding:12px;border-radius:12px;text-align:center;font-weight:800;border:none;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:white}

  /* Modal improvements */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:18px;z-index:80}
  .modal.visible{display:flex}
  .modal .modal-card{width:100%;max-width:560px;border-radius:14px;overflow:hidden;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));backdrop-filter: blur(8px);border:1px solid rgba(255,255,255,0.03);animation:pop .18s ease}
  @keyframes pop{from{transform:translateY(8px) scale(.995);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}
  .modal .modal-card .header{padding:12px 14px;background:transparent;display:flex;justify-content:space-between;align-items:center}
  .modal .modal-card .content{padding:14px}

  /* Scanner mini cart */
  .scan-mini-cart{position:absolute;left:12px;bottom:12px;background:linear-gradient(180deg,white,#f6fbff);padding:10px;border-radius:10px;box-shadow:0 8px 24px rgba(2,6,23,0.12);z-index:95;color:#0b1220}

  /* Quick sale layout */
  .quick-grid{display:grid;grid-template-columns:1fr 320px;gap:12px}
  .quick-left{min-height:120px}
  .quick-right{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.005));padding:12px;border-radius:12px}
  .cart-list{max-height:280px;overflow:auto}
  .cart-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px dashed rgba(255,255,255,0.02)}

  /* Reports and tables */
  table{width:100%;border-collapse:collapse;color:#cfe8ff}
  th,td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.02)}

  /* Toast */
  .toast-wrap{position:fixed;left:14px;right:14px;top:18px;display:flex;justify-content:center;pointer-events:none;z-index:1000}
  .toast{pointer-events:auto;min-width:260px;background:linear-gradient(90deg,#071127,#061025);color:#e6eef8;padding:12px 14px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.6);display:flex;align-items:center;gap:12px}
  .toast .msg{flex:1;font-weight:700}

  /* Responsive */
  @media(max-width:780px){
    .quick-grid{grid-template-columns:1fr}
    .modal .modal-card{max-width:92%;}
  }
</style>
</head>
<body>

<div class="app" role="application">

  <!-- HEADER -->
  <header class="mobile-top">
    <div class="brand">
      <div class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="white" style="width:22px;height:22px"><path d="M3 3h2l.4 2M7 13h10l-1.2 6H6L5 13z"/></svg>
      </div>
      <div style="line-height:1">
        <div style="font-weight:800;font-size:14px">MINIMARKET LA ESQUINA DEL AHORRO</div>
        <div class="small-muted" style="color:rgba(255,255,255,0.9)">TiendaSmart â€” MÃ³vil</div>
      </div>
    </div>

    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <!-- Reportes visible y ordenado -->
      <button id="btn-open-reports" class="btn-big bg-white text-slate-700">Reportes</button>
      <div id="cloud-label" class="small-muted" style="color:white">desconectado</div>
    </div>
  </header>

  <!-- CONTENT -->
  <main class="content">
    <div class="card">
      <div class="search">
        <input id="search" type="search" placeholder="Buscar producto o cÃ³digo..." />
      </div>
      <div class="actions-grid">
        <button id="btn-add-product" class="btn-big bg-green-500 text-white">+ Producto</button>
        <button id="btn-open-scan" class="btn-big bg-yellow-400 text-white">Escanear</button>
        <button id="btn-open-quick" class="btn-big bg-red-600 text-white">Venta RÃ¡pida</button>
        <button id="btn-open-clients" class="btn-big bg-indigo-700 text-white">Clientes</button>
      </div>
    </div>

    <div id="inventory-list"></div>

    <div class="card small-muted">Sincroniza con Firestore: <code>MODO DE PRODUCCIÃ“N / DATOS / MAGALY</code></div>
  </main>

  <!-- BOTTOM -->
  <div class="fixed-bottom">
    <button id="btn-import-xlsx" class="btn bg-gray-800 text-white">Importar</button>
    <button id="btn-export-xlsx" class="btn border">Exportar</button>
    <button id="btn-sync-toggle" class="btn bg-indigo-600 text-white">Cloud automÃ¡tico</button>
  </div>

  <input id="file-xlsx" type="file" accept=".xlsx,.xls" class="hidden"/>

  <!-- TOAST container -->
  <div class="toast-wrap" id="toast-wrap" aria-live="polite"></div>

  <!-- MODALES -->
  <!-- PRODUCT -->
  <div id="modal-product" class="modal" aria-hidden="true">
    <div class="modal-card card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Producto</div>
        <button data-close class="text-xl">âœ•</button>
      </div>
      <form id="form-product" class="mt-3 space-y-2">
        <input type="hidden" id="product-id"/>
        <label class="small-muted">Nombre</label>
        <input id="product-name" placeholder="Nombre" required />
        <div style="display:flex;gap:8px">
          <input id="product-category" placeholder="CategorÃ­a" class="flex-1"/>
          <input id="product-price" placeholder="Precio" type="number" step="0.01" style="width:110px"/>
        </div>
        <div style="display:flex;gap:8px">
          <input id="product-barcode" placeholder="CÃ³digo de barras" class="flex-1"/>
          <input id="product-stock" placeholder="Stock" type="number" style="width:110px"/>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button data-close type="button" class="px-3 py-2 border rounded">Cancelar</button>
          <button type="submit" class="px-3 py-2 bg-green-600 text-white rounded">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- SCANNER -->
  <div id="modal-scan" class="modal" aria-hidden="true">
    <div class="modal-card card p-0">
      <div style="background:#000;color:white;padding:10px;display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">EscÃ¡ner</div>
        <div>
          <button id="btn-toggle-torch" class="px-2 py-1 rounded hidden">ðŸ”¦</button>
          <button data-close class="text-xl">âœ•</button>
        </div>
      </div>
      <div id="video-wrap" style="position:relative;height:44vh;background:#000">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="overlay-canvas"></canvas>
        <div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:60%;height:24%;border:2px dashed rgba(255,255,255,0.5);border-radius:8px;pointer-events:none"></div>
        <!-- mini cart -->
        <div id="scan-mini-cart" class="scan-mini-cart hidden">
          <div style="font-weight:700">Carrito rÃ¡pido</div>
          <div id="scan-mini-count">Items: 0</div>
          <div id="scan-mini-total">Total: S/ 0.00</div>
          <div style="margin-top:6px;display:flex;gap:6px">
            <button id="scan-open-quick" class="px-2 py-1 border rounded">Abrir venta</button>
            <button id="scan-clear-cart" class="px-2 py-1 border rounded">Vaciar</button>
          </div>
        </div>
      </div>
      <div style="padding:8px;background:white;display:flex;flex-direction:column;gap:8px">
        <input id="scanned-code" class="px-3 py-2 border rounded" placeholder="CÃ³digo detectado" readonly/>
        <div style="display:flex;gap:8px;align-items:center">
          <div style="flex:1">
            <div class="small-muted">Producto</div>
            <div id="scanned-product-name" style="font-weight:700">â€”</div>
            <div id="scanned-product-price" class="small-muted">Precio: â€”</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <button id="btn-scan-add-to-quick" class="px-3 py-2 bg-emerald-600 text-white rounded">Agregar a Venta</button>
            <button id="btn-register-from-scan" class="px-3 py-2 bg-indigo-600 text-white rounded">Registrar producto</button>
            <button id="btn-stop-camera" class="px-3 py-2 border rounded">Detener</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- QUICK SALE -->
  <div id="modal-quick" class="modal" aria-hidden="true">
    <div class="modal-card card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Venta RÃ¡pida</div>
        <button data-close class="text-xl">âœ•</button>
      </div>
      <form id="form-quick" class="mt-3 space-y-2">
        <div style="position:relative">
          <input id="quick-search" placeholder="Buscar por letras o cÃ³digo..." />
          <div id="quick-suggestions" class="suggestions hidden"></div>
        </div>
        <div style="display:flex;gap:8px">
          <select id="quick-product" class="flex-1"></select>
          <input id="quick-qty" type="number" value="1" min="1" style="width:80px"/>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <label class="small-muted">Pago</label>
          <select id="quick-payment" class="px-3 py-2 rounded border">
            <option value="EFECTIVO">EFECTIVO</option>
            <option value="YAPE">YAPE</option>
            <option value="A_CREDITO">A CREDITO</option>
          </select>
          <input id="quick-customer" placeholder="Cliente (si A CREDITO)" class="flex-1"/>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>Seleccion: <span id="quick-line-total">S/ 0.00</span></div>
          <div style="display:flex;gap:8px">
            <button type="button" id="quick-scan-inside" class="px-3 py-2 border rounded">Escanear</button>
            <button type="button" id="quick-add" class="px-3 py-2 border rounded">Agregar</button>
            <button type="submit" class="px-3 py-2 bg-red-600 text-white rounded">Cobrar</button>
          </div>
        </div>
        <div>
          <div style="font-weight:800">Carrito</div>
          <div id="quick-cart" class="mt-2 space-y-2"></div>
          <div style="margin-top:8px;font-weight:800">Total carrito: <span id="quick-cart-total">S/ 0.00</span></div>
        </div>
      </form>
    </div>
  </div>

  <!-- CLIENT DETAIL -->
  <div id="modal-client-detail" class="modal" aria-hidden="true">
    <div class="modal-card card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Detalle Cliente</div>
        <button data-close class="text-xl">âœ•</button>
      </div>
      <div id="client-detail-body" class="mt-3"></div>
    </div>
  </div>

  <!-- CLIENTS -->
  <div id="modal-clients" class="modal" aria-hidden="true">
    <div class="modal-card card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Clientes (A CREDITO)</div>
        <button data-close class="text-xl">âœ•</button>
      </div>
      <div class="mt-2">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="client-name" placeholder="Nuevo cliente" class="flex-1"/>
          <button id="btn-add-client" class="px-3 py-2 bg-green-600 text-white rounded">Agregar</button>
        </div>
        <div id="clients-list" class="max-h-64 overflow-auto"></div>
      </div>
    </div>
  </div>

  <!-- REPORTS -->
  <div id="modal-reports" class="modal" aria-hidden="true">
    <div class="modal-card card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Reportes</div>
        <button data-close class="text-xl">âœ•</button>
      </div>
      <div class="mt-2">
        <div style="display:flex;gap:8px;align-items:end">
          <div style="flex:1"><label class="small-muted">Fecha</label><input id="report-date" type="date" class="w-full" /></div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <button id="btn-preview-day" class="px-3 py-2 bg-indigo-600 text-white rounded">Vista</button>
            <button id="btn-download-day" class="px-3 py-2 bg-gray-800 text-white rounded">Descargar PDF</button>
            <button id="btn-print-day" class="px-3 py-2 border rounded">Imprimir</button>
          </div>
        </div>
        <div id="report-preview" class="mt-3 max-h-72 overflow-auto card small-muted"></div>
      </div>
    </div>
  </div>

  <!-- LOGIN (unchanged) -->
  <div id="modal-login" class="modal visible" aria-hidden="false" style="background:linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.6))">
    <div class="modal-card card p-4" style="max-width:420px">
      <h2 style="font-weight:800">Ingresar â€” TiendaSmart</h2>
      <p class="small-muted">Usuario: <strong>LIZ</strong></p>
      <form id="form-login" class="mt-2 space-y-3">
        <input id="login-user" placeholder="Usuario" class="w-full"/>
        <input id="login-pass" placeholder="ContraseÃ±a" type="password" class="w-full"/>
        <div style="display:flex;gap:8px">
          <button type="submit" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded font-semibold">Entrar</button>
          <button type="button" id="login-guest" class="flex-1 px-4 py-3 border rounded">Demo</button>
        </div>
      </form>
    </div>
  </div>

</div>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBh2WHinnQeRD9fsmdEMJ9zkNVJNcixzS4",
  authDomain: "jhonatan-7ca7d.firebaseapp.com",
  projectId: "jhonatan-7ca7d",
  storageBucket: "jhonatan-7ca7d.firebasestorage.app",
  messagingSenderId: "248102422749",
  appId: "1:248102422749:web:097c4e553e610d27dff334"
};
/* ================================================== */

/* Helpers */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const uid = () => 'id-' + Math.random().toString(36).slice(2,9);
const money = v => Number(v||0).toFixed(2);
const todayYMD = ()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* State */
let STATE = { products: [], sales: [], customers: [] };
let cloudEnabled = false, db = null;
const COLLECTION = "MODO DE PRODUCCIÃ“N", DOC_ID = "DATOS", FIELD = "MAGALY";

/* Toast utilities */
let toastTimeout = null;
function showToast(message, actions = [], ttl = 8000){
  const wrap = $('#toast-wrap'); wrap.innerHTML = '';
  const t = document.createElement('div'); t.className = 'toast';
  const msg = document.createElement('div'); msg.className='msg'; msg.textContent = message;
  const act = document.createElement('div'); act.className='actions';
  actions.forEach(a=>{
    const b = document.createElement('button'); b.textContent = a.label;
    b.addEventListener('click', ()=> { try{ a.onClick(); }catch(e){ console.error(e); } hideToast(); });
    act.appendChild(b);
  });
  t.appendChild(msg); if(actions.length>0) t.appendChild(act);
  wrap.appendChild(t);
  if(toastTimeout) clearTimeout(toastTimeout);
  if(ttl > 0) toastTimeout = setTimeout(()=> hideToast(), ttl);
}
function hideToast(){ const wrap = $('#toast-wrap'); wrap.innerHTML = ''; if(toastTimeout){ clearTimeout(toastTimeout); toastTimeout = null; } }

/* Firestore init + sync */
function initFirebaseAuto(){
  try{
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    const docRef = db.collection(COLLECTION).doc(DOC_ID);
    docRef.get().then(snap=>{
      if(!snap.exists) docRef.set({ [FIELD]: { products:[], sales:[], customers:[] } });
      else {
        const remote = snap.data() && snap.data()[FIELD];
        if(remote){
          STATE.products = remote.products || []; STATE.sales = remote.sales || []; STATE.customers = remote.customers || [];
          renderInventory(); renderQuickSelect(); renderClients();
        }
      }
    });
    docRef.onSnapshot(snap=>{
      const remote = snap.exists ? snap.data()[FIELD] : null;
      if(remote){
        STATE.products = remote.products || []; STATE.sales = remote.sales || []; STATE.customers = remote.customers || [];
        renderInventory(); renderQuickSelect(); renderClients();
        $('#cloud-label').textContent = 'conectado';
      }
    }, err => { console.warn('onSnapshot', err); $('#cloud-label').textContent = 'error'; });
    cloudEnabled = true; $('#cloud-label').textContent = 'conectado';
  }catch(e){ console.warn('firebase init', e); $('#cloud-label').textContent = 'error'; }
}

async function pushStateToCloud(){ if(!cloudEnabled || !db) return; try{ const docRef = db.collection(COLLECTION).doc(DOC_ID); await docRef.set({ [FIELD]: STATE }, { merge:true }); }catch(e){ console.warn('push err', e); } }

// Debounced push to avoid many writes
let pushTimeout = null;
function schedulePushStateToCloud(delay = 1500){
  if(!cloudEnabled || !db) return;
  if(pushTimeout) clearTimeout(pushTimeout);
  pushTimeout = setTimeout(async () => { try{ await pushStateToCloud(); }catch(e){ console.warn(e); } pushTimeout = null; }, delay);
}

/* Local backup */
function saveLocalBackup(){ try{ localStorage.setItem('tienda_local_backup', JSON.stringify(STATE)); }catch(e){} }

/* AUTH simple */
const AUTH_USER='LIZ', AUTH_PASS='MAGALY', AUTH_KEY='ts_user';
function isAuth(){ return !!localStorage.getItem(AUTH_KEY); }
function setAuth(u){ localStorage.setItem(AUTH_KEY,u); $('#modal-login') && ($('#modal-login').classList.remove('visible')); }
$('#form-login').addEventListener('submit', e=>{ e.preventDefault(); const u=$('#login-user').value.trim(), p=$('#login-pass').value; if(u===AUTH_USER && p===AUTH_PASS){ setAuth(u); startApp(); } else alert('Credenciales invÃ¡lidas'); });
$('#login-guest').addEventListener('click', ()=>{ setAuth('GUEST'); startApp(); });

/* Modals helpers */
function openModal(id){ const m = $('#'+id); if(!m) return; m.classList.add('visible'); m.setAttribute('aria-hidden','false'); }
function closeModalId(id){ const m = $('#'+id); if(!m) return; if(id === 'modal-scan') stopCamera(); m.classList.remove('visible'); m.setAttribute('aria-hidden','true'); }
document.addEventListener('click', e=>{ const b = e.target.closest('[data-close]'); if(b){ const modal = b.closest('.modal'); if(modal) closeModalId(modal.id); } });

/* Inventory render */
function renderInventory(filter=''){
  const container = $('#inventory-list'); container.innerHTML = '';
  const q = (filter||'').trim().toLowerCase();
  let list = STATE.products.slice();
  if(q) list = list.filter(p => (p.name||'').toLowerCase().includes(q) || (p.barcode||'').includes(q));
  if(list.length === 0){ container.innerHTML = '<div class="card small-muted">No hay productos</div>'; return; }
  for(const p of list){
    const low = (p.stock||0) <= 5;
    const node = document.createElement('div'); node.className='inventory-item';
    node.innerHTML = `<div class="left">
        <div class="meta">${escapeHtml(p.name)} ${low?'<span style="color:#b91c1c"> â€¢ STOCK BAJO</span>':''}</div>
        <div class="sub">${escapeHtml(p.category||'')} â€¢ ${escapeHtml(p.barcode||'')}</div>
        <div class="small-muted">S/ ${money(p.price)} Â· Stock: ${p.stock||0}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
        <button class="px-3 py-2 bg-red-500 text-white rounded sell-btn" data-id="${p.id}">Vender</button>
        <button class="px-3 py-2 border rounded income-btn" data-id="${p.id}">+Stock</button>
        <button class="px-3 py-2 border rounded edit-btn" data-id="${p.id}">Editar</button>
      </div>`;
    container.appendChild(node);
  }
  $$('.sell-btn').forEach(b=> b.onclick = ()=> openQuickWithProduct(b.dataset.id));
  $$('.income-btn').forEach(b=> b.onclick = ()=> openIncome(b.dataset.id));
  $$('.edit-btn').forEach(b=> b.onclick = ()=> openProductModal(STATE.products.find(x=>x.id===b.dataset.id)));
}

/* Product CRUD */
$('#btn-add-product').addEventListener('click', ()=> openProductModal());
function openProductModal(product, afterSaveCallback){
  $('#form-product').reset(); $('#product-id').value='';
  if(product){
    $('#product-id').value = product.id || '';
    $('#product-name').value = product.name || '';
    $('#product-category').value = product.category||'';
    $('#product-price').value = product.price||0;
    $('#product-barcode').value = product.barcode||'';
    $('#product-stock').value = product.stock||0;
  }
  const form = $('#form-product');
  form._afterSave = afterSaveCallback || null;
  openModal('modal-product');
}
$('#form-product').addEventListener('submit', async e=>{
  e.preventDefault();
  const id = $('#product-id').value || uid();
  const prod = { id, name: $('#product-name').value.trim(), category: $('#product-category').value.trim(), price: Number($('#product-price').value)||0, barcode: $('#product-barcode').value.trim(), stock: Number($('#product-stock').value)||0, createdAt: new Date().toISOString() };
  const idx = STATE.products.findIndex(x=>x.id===id);
  if(idx >= 0) STATE.products[idx] = prod; else STATE.products.unshift(prod);
  renderInventory(); renderQuickSelect(); saveLocalBackup(); schedulePushStateToCloud();
  const form = $('#form-product');
  if(form && form._afterSave){ try{ form._afterSave(prod); }catch(e){} form._afterSave = null; }
  closeModalId('modal-product');
});

/* Stock income */
function openIncome(productId){
  const qtyStr = prompt('Cantidad a agregar (ingreso):','1'); if(!qtyStr) return;
  const qty = Math.max(1, Number(qtyStr));
  const p = STATE.products.find(x=>x.id===productId); if(!p) return alert('Producto no encontrado');
  p.stock = (p.stock||0) + qty; STATE.products = STATE.products.map(x=> x.id===p.id ? p : x);
  saveLocalBackup(); schedulePushStateToCloud(); renderInventory();
}

/* Sales / Quick sale */
let quickCart = [];
function renderQuickSelect(){
  const sel = $('#quick-product'); if(!sel) return;
  sel.innerHTML = ''; STATE.products.forEach(p=>{ const o = document.createElement('option'); o.value = p.id; o.textContent = `${p.name} (stock ${p.stock||0})`; sel.appendChild(o); });
  updateQuickTotal();
}
$('#btn-open-quick').addEventListener('click', ()=>{ renderQuickSelect(); openModal('modal-quick'); });

$('#quick-search').addEventListener('input', (e)=>{
  const q = e.target.value.trim().toLowerCase();
  showQuickSuggestions(q);
  if(q.length >= 1){
    const found = STATE.products.find(p => p.name.toLowerCase().includes(q) || (p.barcode||'').includes(q));
    if(found) $('#quick-product').value = found.id;
  }
  updateQuickTotal();
});
function showQuickSuggestions(q){
  const box = $('#quick-suggestions'); if(!box) return; box.innerHTML=''; box.classList.add('hidden'); if(!q) return;
  const results = STATE.products.filter(p => p.name.toLowerCase().includes(q) || (p.barcode||'').includes(q)).slice(0,8);
  if(results.length===0) return;
  for(const p of results){
    const d = document.createElement('div'); d.className='px-3 py-2'; d.innerHTML = `<div style="font-weight:700">${escapeHtml(p.name)}</div><div class="small-muted">${escapeHtml(p.barcode||'')} â€¢ ${escapeHtml(p.category||'')}</div>`;
    d.onclick = ()=>{ $('#quick-product').value = p.id; $('#quick-suggestions').classList.add('hidden'); $('#quick-search').value = ''; updateQuickTotal(); };
    box.appendChild(d);
  }
  box.classList.remove('hidden');
}
$('#quick-product') && $('#quick-product').addEventListener('change', updateQuickTotal);
$('#quick-qty') && $('#quick-qty').addEventListener('input', updateQuickTotal);
function updateQuickTotal(){ const pid = $('#quick-product')? $('#quick-product').value : null; const qty = Number($('#quick-qty')? $('#quick-qty').value : 0)||0; const p = STATE.products.find(x=>x.id===pid); $('#quick-line-total') && ($('#quick-line-total').textContent = money(p ? p.price * qty : 0));
  const cartTotal = quickCart.reduce((s,i)=> s + (i.qty*i.price),0);
  $('#quick-cart-total') && ($('#quick-cart-total').textContent = `S/ ${money(cartTotal)}`);
}

$('#quick-add').addEventListener('click', ()=>{
  const pid = $('#quick-product').value; const qty = Number($('#quick-qty').value)||1; const p = STATE.products.find(x=>x.id===pid); if(!p) return alert('Selecciona producto'); quickCart.push({ productId: pid, qty, price: p.price }); renderQuickCart(); saveLocalBackup(); schedulePushStateToCloud();
});
function renderQuickCart(){
  const el = $('#quick-cart'); if(!el) return; el.innerHTML = '';
  quickCart.forEach((it, idx)=>{
    const p = STATE.products.find(x=>x.id===it.productId);
    const row = document.createElement('div'); row.className='flex justify-between items-center';
    row.innerHTML = `<div>${escapeHtml(p.name)} x ${it.qty}</div><div>S/ ${money(it.qty*it.price)} <button data-idx="${idx}" class="text-red-600 ml-2">Quitar</button></div>`;
    el.appendChild(row);
  });
  $$('#quick-cart button').forEach(b=> b.onclick = ()=> { quickCart.splice(Number(b.dataset.idx),1); renderQuickCart(); });
  // update cart total
  $('#quick-cart-total').textContent = `S/ ${money(quickCart.reduce((s,i)=> s + i.qty*i.price, 0))}`;
}

$('#form-quick').addEventListener('submit', async e=>{
  e.preventDefault();
  if(quickCart.length===0) return alert('Agregar productos al carrito');
  const customer = $('#quick-customer').value.trim(); const payment = $('#quick-payment').value;
  for(const it of quickCart){ const p = STATE.products.find(x=>x.id===it.productId); if(p) p.stock = (p.stock||0) - it.qty; }
  const total = quickCart.reduce((s,i)=>s + i.qty*i.price,0);
  const sale = { id: uid(), items: quickCart.slice(), total, date: new Date().toISOString(), customerName: customer||null, paid: (payment !== 'A_CREDITO'), paymentType: payment, responsible: null };
  STATE.sales.unshift(sale);
  if(payment === 'A_CREDITO' && customer){
    const existing = STATE.customers.find(c=>c.name === customer);
    if(existing) existing.balance = (existing.balance||0) + total; else STATE.customers.push({ name: customer, balance: total, createdAt: new Date().toISOString() });
  }
  quickCart = []; renderQuickCart(); renderInventory(); renderClients(); saveLocalBackup(); schedulePushStateToCloud();
  closeModalId('modal-quick'); alert('Venta registrada correctamente');
});

function openQuickWithProduct(productId){
  renderQuickSelect(); openModal('modal-quick');
  $('#quick-product').value = productId;
  $('#quick-qty').value = 1;
  updateQuickTotal();
}

/* Clients */
$('#btn-open-clients').addEventListener('click', ()=> openModal('modal-clients'));
$('#btn-add-client').addEventListener('click', async ()=>{ const name = $('#client-name').value.trim(); if(!name) return alert('Ingresa nombre'); const existing = STATE.customers.find(c=>c.name === name); if(existing) return alert('Cliente ya existe'); STATE.customers.push({ name, balance:0, createdAt: new Date().toISOString() }); $('#client-name').value=''; renderClients(); saveLocalBackup(); schedulePushStateToCloud(); });
function renderClients(){ const el = $('#clients-list'); if(!el) return; el.innerHTML=''; if((STATE.customers||[]).length===0) el.innerHTML = '<div class="small-muted">No hay clientes</div>'; for(const c of STATE.customers){ const div = document.createElement('div'); div.className='p-2 border rounded mb-2 bg-white flex justify-between items-center'; div.innerHTML = `<div><div style="font-weight:700">${escapeHtml(c.name)}</div><div class="small-muted">Saldo: S/ ${money(c.balance||0)}</div></div><div style="display:flex;gap:8px"><button data-name="${escapeHtml(c.name)}" class="px-3 py-1 border btn-abono">Abono</button><button data-name="${escapeHtml(c.name)}" class="px-3 py-1 bg-green-600 text-white btn-saldar">Saldar</button><button data-name="${escapeHtml(c.name)}" class="px-3 py-1 border btn-detalle">Ver</button></div>`; el.appendChild(div); } $$('.btn-abono').forEach(b=> b.onclick = async ()=>{ const name=b.dataset.name; const amt = Number(prompt(`Abono para ${name} - monto:`, '0'))||0; if(amt<=0) return; const c = STATE.customers.find(x=>x.name===name); c.balance = Math.max(0,(c.balance||0) - amt); saveLocalBackup(); schedulePushStateToCloud(); renderClients(); }); $$('.btn-saldar').forEach(b=> b.onclick = async ()=>{ const name=b.dataset.name; if(!confirm(`Saldar cuenta de ${name}?`)) return; const c=STATE.customers.find(x=>x.name===name); c.balance=0; saveLocalBackup(); schedulePushStateToCloud(); renderClients(); }); $$('.btn-detalle').forEach(b=> b.onclick = ()=> openClientDetail(b.dataset.name)); }

function openClientDetail(name){
  const body = $('#client-detail-body'); body.innerHTML = '';
  const client = STATE.customers.find(c=>c.name === name);
  if(!client){ body.innerHTML = '<div>No encontrado</div>'; openModal('modal-client-detail'); return; }
  const owedSales = (STATE.sales||[]).filter(s=> s.paymentType === 'A_CREDITO' && s.customerName === name && !s.paid);
  const html = document.createElement('div');
  html.innerHTML = `<div style="font-weight:700">${escapeHtml(name)}</div><div class="small-muted">Saldo: S/ ${money(client.balance||0)}</div><div style="margin-top:8px;font-weight:700">Ventas pendientes</div>`;
  if(owedSales.length===0) html.appendChild(Object.assign(document.createElement('div'),{innerHTML:'<div class="small-muted">No hay ventas pendientes</div>'}));
  else{
    owedSales.forEach(s=>{
      const container = document.createElement('div'); container.className='p-2 border rounded mb-2 bg-white';
      const items = s.items.map(it=>{ const p = STATE.products.find(pp=>pp.id===it.productId); return `${escapeHtml(p? p.name: it.productId)} (${it.qty} x S/ ${money(it.price)})`; }).join('<br>');
      container.innerHTML = `<div><strong>Venta</strong> ${escapeHtml(s.id)} - ${new Date(s.date).toLocaleString()}</div><div class="small-muted">${items}</div><div style="margin-top:6px;display:flex;gap:8px"><button data-id="${s.id}" class="px-3 py-1 bg-green-600 text-white btn-pagar">Marcar como Pagada</button><button data-id="${s.id}" class="px-3 py-1 border btn-abonar-venta">Registrar Abono</button></div>`;
      html.appendChild(container);
    });
  }
  body.appendChild(html);
  openModal('modal-client-detail');
  $$('.btn-pagar').forEach(b=> b.onclick = ()=>{ const id=b.dataset.id; if(!confirm('Marcar esta venta como pagada?')) return; const sale = STATE.sales.find(x=>x.id===id); if(!sale) return; sale.paid = true; const client = STATE.customers.find(c=>c.name === sale.customerName); if(client) client.balance = Math.max(0, (client.balance||0) - sale.total); saveLocalBackup(); schedulePushStateToCloud(); renderClients(); $('#client-detail-body').innerHTML = '<div class="small-muted">OperaciÃ³n realizada</div>'; });
  $$('.btn-abonar-venta').forEach(b=> b.onclick = ()=>{ const id=b.dataset.id; const amt = Number(prompt('Monto de abono:','0'))||0; if(amt<=0) return; const sale = STATE.sales.find(x=>x.id===id); if(!sale) return; sale.partialPayments = sale.partialPayments || []; sale.partialPayments.push({ amount: amt, date: new Date().toISOString() }); const client = STATE.customers.find(c=>c.name === sale.customerName); if(client) client.balance = Math.max(0,(client.balance||0) - amt); saveLocalBackup(); schedulePushStateToCloud(); renderClients(); $('#client-detail-body').innerHTML = '<div class="small-muted">Abono registrado</div>'; });
}

/* Import/Export XLSX */
$('#btn-export-xlsx').addEventListener('click', ()=>{
  const headers = ['name','category','price','barcode','stock'];
  const rows = STATE.products.map(p => ({ name: p.name, category: p.category||'', price: p.price||0, barcode: p.barcode||'', stock: p.stock||0 }));
  const ws = XLSX.utils.json_to_sheet(rows, { header: headers });
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Inventario');
  XLSX.writeFile(wb, `inventario_${new Date().toISOString().slice(0,10)}.xlsx`);
});
$('#btn-import-xlsx').addEventListener('click', ()=> $('#file-xlsx').click());
$('#file-xlsx').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const data = await f.arrayBuffer();
  const workbook = XLSX.read(data, { type: 'array' });
  const sheet = workbook.Sheets[workbook.SheetNames[0]];
  const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
  if(json.length === 0) return alert('Hoja vacÃ­a');
  const keys = Object.keys(json[0]).map(k => k.toString().toLowerCase());
  const required = ['name','category','price','barcode','stock'];
  const missing = required.filter(r => !keys.includes(r));
  if(missing.length > 0) return alert('Formato invÃ¡lido. Columnas requeridas: ' + required.join(', '));
  if(!confirm(`Importar ${json.length} productos (se actualizarÃ¡n/crearÃ¡n)?`)) return;
  // build index
  const byBarcode = new Map(); const byName = new Map();
  for(const p of STATE.products){ if(p.barcode) byBarcode.set((p.barcode||'').replace(/\D/g,''), p); if(p.name) byName.set(p.name.trim().toLowerCase(), p); }
  for(const row of json){
    const name = String(row.name || '').trim(); const category = row.category || ''; const price = Number(row.price) || 0; const barcode = String(row.barcode || '').trim(); const stock = Number(row.stock) || 0;
    const normalizedBarcode = barcode.replace(/\D/g,'');
    let existing = normalizedBarcode ? byBarcode.get(normalizedBarcode) : null;
    if(!existing && name) existing = byName.get(name.toLowerCase());
    if(existing){ existing.name = name; existing.category = category; existing.price = price; existing.barcode = barcode; existing.stock = stock; }
    else{ const newP = { id: uid(), name, category, price, barcode, stock, createdAt: new Date().toISOString() }; STATE.products.push(newP); if(newP.barcode) byBarcode.set(newP.barcode.replace(/\D/g,''), newP); if(newP.name) byName.set(newP.name.trim().toLowerCase(), newP); }
  }
  saveLocalBackup(); schedulePushStateToCloud(); renderInventory(); renderQuickSelect(); alert('ImportaciÃ³n finalizada'); e.target.value = '';
});

/* ------------------ SCANNER (with toast + improved behaviors) ------------------ */
const video = $('#video'); let videoStream=null, currentTrack=null;
let detectionLoop=false, quaggaActive=false, readBuffer=[];
const READ_CONFIRM=3, WINDOW_MS=2000;
const overlay = $('#overlay-canvas'); let octx;

function resizeOverlay(){ if(!overlay || !video) return; overlay.width = video.clientWidth; overlay.height = video.clientHeight; octx = overlay.getContext('2d'); }
function clearOverlay(){ if(!octx) resizeOverlay(); octx && octx.clearRect(0,0,overlay.width,overlay.height); }
function pushRead(code){ const now = Date.now(); readBuffer = readBuffer.filter(r => now - r.t < WINDOW_MS); readBuffer.push({ code, t: now }); const last = readBuffer.slice(-READ_CONFIRM); if(last.length >= READ_CONFIRM && last.every(x=> x.code === last[0].code)) return last[0].code; return null; }

async function startCameraHighRes(){
  const constraints = { video: { facingMode: { ideal:'environment' }, width: { ideal:1280 }, height: { ideal:720 } }, audio:false };
  videoStream = await navigator.mediaDevices.getUserMedia(constraints);
  video.srcObject = videoStream; currentTrack = videoStream.getTracks()[0];
  await video.play(); resizeOverlay();
  const caps = currentTrack.getCapabilities ? currentTrack.getCapabilities() : {};
  if(caps && caps.torch) $('#btn-toggle-torch').classList.remove('hidden'); else $('#btn-toggle-torch').classList.add('hidden');
}

// mini cart UI helpers
function updateScanMiniCart(){ const el = $('#scan-mini-cart'); if(!el) return; const count = quickCart.reduce((s,i)=> s + i.qty,0); const total = quickCart.reduce((s,i)=> s + i.qty*i.price,0); if(count === 0){ el.classList.add('hidden'); } else { el.classList.remove('hidden'); $('#scan-mini-count').textContent = `Items: ${count}`; $('#scan-mini-total').textContent = `Total: S/ ${money(total)}`; } }
$('#scan-open-quick').addEventListener('click', ()=>{ openModal('modal-quick'); });
$('#scan-clear-cart').addEventListener('click', ()=>{ if(!confirm('Vaciar carrito rÃ¡pido?')) return; quickCart = []; renderQuickCart(); updateScanMiniCart(); });

async function startDetection(){
  $('#scanned-code').value = ''; $('#scanned-product-name').textContent = 'â€”'; $('#scanned-product-price').textContent = 'Precio: â€”'; readBuffer = [];
  try{
    if('BarcodeDetector' in window){
      const detector = new BarcodeDetector({ formats: ['ean_13','code_128','upc_e','upc_a','ean_8'] });
      await startCameraHighRes();
      detectionLoop = true;

      // reuse a canvas to reduce GC
      const loopCanvas = document.createElement('canvas'); const loopCtx = loopCanvas.getContext('2d');

      while(detectionLoop){
        if(!video || video.readyState < 2){ await new Promise(r=>setTimeout(r,100)); continue; }
        try{
          loopCanvas.width = video.videoWidth; loopCanvas.height = video.videoHeight;
          loopCtx.drawImage(video,0,0,loopCanvas.width,loopCanvas.height);
          const roi = { sx: Math.floor(loopCanvas.width*0.2), sy: Math.floor(loopCanvas.height*0.36), sw: Math.floor(loopCanvas.width*0.6), sh: Math.floor(loopCanvas.height*0.28) };
          const bitmap = await createImageBitmap(loopCanvas);
          const cropped = await createImageBitmap(bitmap, roi.sx, roi.sy, roi.sw, roi.sh);
          const barcodes = await detector.detect(cropped);
          clearOverlay(); drawROI(roi);
          if(barcodes && barcodes.length > 0){
            const code = (barcodes[0].rawValue || '').trim();
            const confirmed = pushRead(code);
            if(confirmed){
              $('#scanned-code').value = confirmed;
              const found = STATE.products.find(x => (x.barcode||'') === confirmed || ((x.barcode||'').replace(/\D/g,'') === confirmed.replace(/\D/g,'')));
              if(found){
                $('#scanned-product-name').textContent = found.name;
                $('#scanned-product-price').textContent = `Precio: S/ ${money(found.price)} Â· Stock: ${found.stock||0}`;
                // show toast with Add action (keeps camera running)
                showToast(`Detectado: ${found.name}`, [
                  { label: 'AÃ±adir', onClick: () => { quickCart.push({ productId: found.id, qty: 1, price: found.price }); renderQuickCart(); saveLocalBackup(); schedulePushStateToCloud(); updateScanMiniCart(); } },
                  { label: 'Registrar', onClick: () => { /* close camera and open register */ stopCamera().then(()=>{ closeModalId('modal-scan'); openProductModal({ barcode: confirmed, name:'', category:'', price:0, stock:0 }, null); }); } }
                ], 8000);
              } else {
                $('#scanned-product-name').textContent = 'No registrado';
                $('#scanned-product-price').textContent = 'Precio: â€”';
                showToast(`CÃ³digo no registrado: ${confirmed}`, [
                  { label: 'Registrar', onClick: () => { stopCamera().then(()=>{ closeModalId('modal-scan'); openProductModal({ barcode: confirmed, name:'', category:'', price:0, stock:0 }, null); }); } },
                  { label: 'Cerrar', onClick: ()=>{} }
                ], 8000);
              }
              showConfirmation(confirmed);
              await new Promise(r=>setTimeout(r,600));
            }
          }
          bitmap.close(); cropped.close();
        }catch(err){ console.warn('detector loop err', err); detectionLoop=false; fallbackQuagga(); break; }
        await new Promise(r=>setTimeout(r,80));
      }
    } else fallbackQuagga();
  }catch(err){ console.warn('startDetection err', err); fallbackQuagga(); }
}

function drawROI(roi){ if(!octx) resizeOverlay(); const scaleX = overlay.width / (video.videoWidth||1); const scaleY = overlay.height / (video.videoHeight||1); octx.strokeStyle='rgba(0,255,100,0.9)'; octx.lineWidth=3; octx.strokeRect(roi.sx*scaleX, roi.sy*scaleY, roi.sw*scaleX, roi.sh*scaleY); }
function showConfirmation(text){ if(!octx) resizeOverlay(); octx.font='20px monospace'; octx.fillStyle='rgba(0,0,0,0.6)'; const x=10,y=30,w=octx.measureText(text).width+20; octx.fillRect(x,y-22,w,28); octx.fillStyle='white'; octx.fillText(text,x+8,y); }

function fallbackQuagga(){
  startCameraHighRes().then(()=>{
    if(!window.Quagga){ alert('Quagga no disponible'); return; }
    quaggaActive = true;
    Quagga.init({
      inputStream:{ name:'Live', type:'LiveStream', target:'#video', constraints:{ facingMode:'environment', width:1280, height:720 } },
      decoder:{ readers:['ean_reader','ean_8_reader','code_128_reader','upc_reader','upc_e_reader'] },
      locate:true
    }, err => { if(err) { console.error(err); return; } Quagga.start(); });
    Quagga.onProcessed(result => { clearOverlay(); if(!result) return; if(result.boxes) result.boxes.filter(b=>b!==result.box).forEach(b=> drawBox(b,'rgba(255,255,255,0.2)')); if(result.box) drawBox(result.box,'lime'); });
    Quagga.onDetected(data => { const code = data && data.codeResult && data.codeResult.code; if(code){ const confirmed = pushRead(code); if(confirmed){ $('#scanned-code').value = confirmed; const found = STATE.products.find(x => (x.barcode||'') === confirmed || ((x.barcode||'').replace(/\D/g,'') === confirmed.replace(/\D/g,''))); if(found){
          $('#scanned-product-name').textContent = found.name;
          $('#scanned-product-price').textContent = `Precio: S/ ${money(found.price)} Â· Stock: ${found.stock||0}`;
          showToast(`Detectado: ${found.name}`, [
            { label: 'AÃ±adir', onClick: () => { quickCart.push({ productId: found.id, qty: 1, price: found.price }); renderQuickCart(); saveLocalBackup(); schedulePushStateToCloud(); updateScanMiniCart(); } },
            { label: 'Registrar', onClick: () => { try{ Quagga.stop(); }catch(e){} stopCamera().then(()=>{ closeModalId('modal-scan'); openProductModal({ barcode: confirmed, name:'', category:'', price:0, stock:0 }, null); }); } }
          ], 8000);
        } else {
          $('#scanned-product-name').textContent = 'No registrado';
          $('#scanned-product-price').textContent = 'Precio: â€”';
          showToast(`CÃ³digo no registrado: ${confirmed}`, [
            { label: 'Registrar', onClick: () => { try{ Quagga.stop(); }catch(e){} stopCamera().then(()=>{ closeModalId('modal-scan'); openProductModal({ barcode: confirmed, name:'', category:'', price:0, stock:0 }, null); }); } },
            { label: 'Cerrar', onClick: ()=>{} }
          ], 8000);
        } try{ Quagga.stop(); }catch(e){}
      } } });
    function drawBox(path,color){ if(!octx) resizeOverlay(); octx.strokeStyle=color; octx.lineWidth=3; octx.beginPath(); octx.moveTo(path[0].x,path[0].y); for(let i=1;i<path.length;i++) octx.lineTo(path[i].x,path[i].y); octx.closePath(); octx.stroke(); }
  }).catch(e=>console.warn('quagga camera err', e));
}

async function stopCamera(){ detectionLoop = false; if(quaggaActive && window.Quagga){ try{ Quagga.stop(); }catch(e){} quaggaActive=false; } if(videoStream) videoStream.getTracks().forEach(t=>t.stop()); video.srcObject = null; videoStream = null; currentTrack = null; clearOverlay(); readBuffer=[]; hideToast(); }

/* Scanner buttons */
$('#btn-open-scan').addEventListener('click', ()=>{ openModal('modal-scan'); startDetection().catch(()=>{}); });
$('#btn-stop-camera').addEventListener('click', ()=> stopCamera());
$('#btn-register-from-scan').addEventListener('click', ()=> {
  const code = $('#scanned-code').value.trim(); if(!code) return alert('No hay cÃ³digo detectado');
  // close camera and open register modal for user to fill
  stopCamera().then(()=>{ closeModalId('modal-scan'); openProductModal({ barcode: code, name:'', category:'', price:0, stock:0 }, null); });
});
$('#btn-scan-add-to-quick').addEventListener('click', ()=> {
  const code = $('#scanned-code').value.trim(); if(!code) return alert('No hay cÃ³digo detectado');
  const p = STATE.products.find(x => (x.barcode||'') === code || ((x.barcode||'').replace(/\D/g,'') === code.replace(/\D/g,'')));
  if(p){
    quickCart.push({ productId: p.id, qty:1, price: p.price }); renderQuickCart(); saveLocalBackup(); schedulePushStateToCloud(); updateScanMiniCart(); showToast('Agregado al carrito (cÃ¡mara abierta)', [], 2000);
  } else {
    // open register but keep camera open? user wanted camera closed when registering, so we'll close
    stopCamera().then(()=>{ closeModalId('modal-scan'); openProductModal({ barcode: code, name:'', category:'', price:0, stock:0 }, (saved)=>{ quickCart.push({ productId: saved.id, qty:1, price: saved.price }); renderQuickCart(); saveLocalBackup(); schedulePushStateToCloud(); updateScanMiniCart(); }); });
  }
});

/* Quick modal scan button: open scanner (user will add via toast) */
$('#quick-scan-inside').addEventListener('click', ()=>{ openModal('modal-scan'); startDetection().catch(()=>{}); });

/* Reports (reactivated) */
async function buildDailyWithInventoryHTML(date){
  const daySales = (STATE.sales||[]).filter(s=> s.date && s.date.slice(0,10) === date).sort((a,b)=>a.date.localeCompare(b.date));
  const creditSales = daySales.filter(s=> s.paymentType === 'A_CREDITO' || !s.paid);
  let rows = ''; let total = 0;
  for(const s of daySales){
    total += Number(s.total||0);
    const t = s.date ? new Date(s.date).toLocaleTimeString() : '-';
    const payment = s.paymentType || (s.paid? 'EFECTIVO':'A_CREDITO');
    const items = s.items.map(it=>{ const p = STATE.products.find(pp=>pp.id===it.productId); return `${escapeHtml(p? p.name: it.productId)} (${it.qty} x S/ ${money(it.price)})`; }).join('<br>');
    rows += `<tr><td style="padding:6px">${escapeHtml(t)}</td><td style="padding:6px">${escapeHtml(s.id)}</td><td style="padding:6px">${escapeHtml(s.customerName||'-')}</td><td style="padding:6px">${escapeHtml(s.responsible||'-')}</td><td style="padding:6px">${escapeHtml(payment)}</td><td style="padding:6px">${items}</td><td style="padding:6px;text-align:right">S/ ${money(s.total)}</td></tr>`;
  }
  const creditRows = creditSales.map(s=>{ const t = s.date ? new Date(s.date).toLocaleTimeString() : '-'; const items = s.items.map(it=>{ const p = STATE.products.find(pp=>pp.id===it.productId); return `${escapeHtml(p? p.name: it.productId)} (${it.qty} x S/ ${money(it.price)})`; }).join('<br>'); return `<tr><td style="padding:6px">${escapeHtml(t)}</td><td style="padding:6px">${escapeHtml(s.id)}</td><td style="padding:6px">${escapeHtml(s.customerName||'-')}</td><td style="padding:6px">${escapeHtml(s.responsible||'-')}</td><td style="padding:6px">${escapeHtml(s.paymentType||'A_CREDITO')}</td><td style="padding:6px">${items}</td><td style="padding:6px;text-align:right">S/ ${money(s.total)}</td></tr>`; }).join('');
  const products = (STATE.products||[]).slice().sort((a,b)=>a.name.localeCompare(b.name));
  let invRows = ''; for(const p of products){ invRows += `<tr><td style="padding:6px">${escapeHtml(p.name)}</td><td style="padding:6px">${escapeHtml(p.category||'')}</td><td style="padding:6px">${escapeHtml(p.barcode||'')}</td><td style="padding:6px;text-align:right">${p.stock||0}</td><td style="padding:6px;text-align:right">S/ ${money(p.price)}</td></tr>`; }
  const html = `<div style="font-family:Arial,Helvetica,sans-serif;color:#111;padding:8mm;font-size:12px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><h1 style="margin:0;font-size:18px">MINIMARKET LA ESQUINA DEL AHORRO</h1><div style="font-size:12px">Reporte del dia: <strong>${escapeHtml(date)}</strong></div></div>
      <div style="text-align:right;font-size:12px">Generado: ${escapeHtml(new Date().toLocaleString())}</div>
    </div><hr style="margin:8px 0">
    <h3 style="margin-bottom:6px">Ventas del dÃ­a</h3>
    <table style="width:100%;border-collapse:collapse;font-size:12px"><thead><tr><th style="background:#f3f4f6;padding:6px;text-align:left">Hora</th><th style="background:#f3f4f6;padding:6px;text-align:left">ID</th><th style="background:#f3f4f6;padding:6px;text-align:left">Cliente</th><th style="background:#f3f4f6;padding:6px;text-align:left">Encargado</th><th style="background:#f3f4f6;padding:6px;text-align:left">Pago</th><th style="background:#f3f4f6;padding:6px;text-align:left">Items</th><th style="background:#f3f4f6;padding:6px;text-align:right">Total</th></tr></thead><tbody>${rows || '<tr><td colspan="7" style="padding:12px;text-align:center;color:#666">No hay ventas</td></tr>'}</tbody></table>
    <div style="text-align:right;font-weight:bold;margin-top:8px">Total (dÃ­a): S/ ${money(total)}</div><hr style="margin:8px 0">
    <h3 style="margin-bottom:6px">Ventas por cobrar (A CREDITO)</h3>
    <table style="width:100%;border-collapse:collapse;font-size:12px"><thead><tr><th style="background:#f3f4f6;padding:6px">Hora</th><th style="background:#f3f4f6;padding:6px">ID</th><th style="background:#f3f4f6;padding:6px">Cliente</th><th style="background:#f3f4f6;padding:6px">Encargado</th><th style="background:#f3f4f6;padding:6px">Pago</th><th style="background:#f3f4f6;padding:6px">Items</th><th style="background:#f3f4f6;padding:6px;text-align:right">Total</th></tr></thead><tbody>${creditRows.length? creditRows: '<tr><td colspan="7" style="padding:12px;text-align:center;color:#666">No hay ventas por cobrar</td></tr>'}</tbody></table>
    <hr style="margin:12px 0"><h3 style="margin-bottom:6px">Reporte de Inventario</h3>
    <table style="width:100%;border-collapse:collapse;font-size:12px"><thead><tr><th style="background:#f3f4f6;padding:6px;text-align:left">Nombre</th><th style="background:#f3f4f6;padding:6px;text-align:left">CategorÃ­a</th><th style="background:#f3f4f6;padding:6px;text-align:left">CÃ³digo</th><th style="background:#f3f4f6;padding:6px;text-align:right">Stock</th><th style="background:#f3f4f6;padding:6px;text-align:right">Precio</th></tr></thead><tbody>${invRows || '<tr><td colspan="5" style="padding:12px;text-align:center;color:#666">No hay productos</td></tr>'}</tbody></table>
    <div style="font-size:11px;color:#666;margin-top:10px">Reporte generado por TiendaSmart â€” MINIMARKET LA ESQUINA DEL AHORRO</div>
  </div>`;
  return html;
}

async function downloadCombinedPDF(date){
  if(!date) return alert('Selecciona fecha');
  const html = await buildDailyWithInventoryHTML(date);
  const wrapper = document.createElement('div'); wrapper.style.width='1123px'; wrapper.style.background='#fff'; wrapper.innerHTML = html; document.body.appendChild(wrapper);
  try{
    const scale = 2.2;
    const canvas = await html2canvas(wrapper, { scale, useCORS:true, logging:false, windowWidth: wrapper.scrollWidth, windowHeight: wrapper.scrollHeight });
    const imgData = canvas.toDataURL('image/png',1.0);
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p','mm','a4');
    const pageW = 210, pageH = 297, margin = 10;
    const usableW = pageW - margin*2;
    const pxToMm = usableW / canvas.width;
    const imgHeightMM = canvas.height * pxToMm;
    if(imgHeightMM <= (pageH - margin*2)){
      pdf.addImage(imgData,'PNG',margin,margin,usableW,imgHeightMM);
    } else {
      const pxPerPage = Math.floor((pageH - margin*2) / pxToMm);
      let pos = 0, remaining = canvas.height, page=0;
      while(remaining > 0){
        const h = Math.min(pxPerPage, remaining);
        const tmp = document.createElement('canvas'); tmp.width = canvas.width; tmp.height = h;
        const tctx = tmp.getContext('2d'); tctx.fillStyle='#fff'; tctx.fillRect(0,0,tmp.width,tmp.height);
        tctx.drawImage(canvas, 0, pos, canvas.width, h, 0, 0, tmp.width, tmp.height);
        const data = tmp.toDataURL('image/png');
        const hMM = h * pxToMm;
        if(page>0) pdf.addPage();
        pdf.addImage(data,'PNG',margin,margin,usableW,hMM);
        remaining -= h; pos += h; page++;
      }
    }
    const filename = `Reporte del dia ${date}.pdf`;
    pdf.save(filename);
  }catch(e){ console.error('pdf err', e); alert('Error generando PDF'); }
  wrapper.remove();
}

/* Reports binds */
$('#btn-open-reports') && $('#btn-open-reports').addEventListener('click', ()=> { $('#report-date').value = todayYMD(); openModal('modal-reports'); });
$('#btn-preview-day') && $('#btn-preview-day').addEventListener('click', async ()=> { const d = $('#report-date').value || todayYMD(); const html = await buildDailyWithInventoryHTML(d); $('#report-preview').innerHTML = html; });
$('#btn-download-day') && $('#btn-download-day').addEventListener('click', async ()=> { const d = $('#report-date').value || todayYMD(); await downloadCombinedPDF(d); });
$('#btn-print-day') && $('#btn-print-day').addEventListener('click', async ()=> { const d = $('#report-date').value || todayYMD(); const html = await buildDailyWithInventoryHTML(d); printHTML(html, `Reporte del dia ${d}`); });
function printHTML(html, title='Reporte'){ const w = window.open('','_blank'); if(!w) return alert('Permite popups'); w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial,Helvetica,sans-serif;margin:10mm;font-size:12px} table{width:100%;border-collapse:collapse} th{background:#f3f4f6;padding:6px;text-align:left} td{padding:6px;border-bottom:1px solid #eee}</style></head><body>${html}</body></html>`); w.document.close(); w.focus(); setTimeout(()=>w.print(),700); }

/* Search header */
$('#search').addEventListener('input', (e)=>{ renderInventory(e.target.value); });

/* UI init / start */
function initUI(){ $$('.modal').forEach(m=> m.classList.remove('visible')); if(!isAuth()) $('#modal-login').classList.add('visible'); else { $('#modal-login').classList.remove('visible'); startApp(); } document.addEventListener('keydown', e=>{ if(e.key === 'Escape') $$('.modal.visible').forEach(m=> closeModalId(m.id)); }); }
async function startApp(){
  try{ const cached = localStorage.getItem('tienda_local_backup'); if(cached){ const obj = JSON.parse(cached); STATE = Object.assign(STATE, obj); } }catch(e){ console.warn('cache read err', e); }
  renderInventory(); renderQuickSelect(); renderClients();
  try{ initFirebaseAuto(); }catch(e){ console.warn('auto firebase err', e); }
}

/* sync toggle */
$('#btn-sync-toggle').addEventListener('click', ()=> {
  if(cloudEnabled){ cloudEnabled = false; $('#cloud-label').textContent = 'desconectado'; $('#btn-sync-toggle').textContent = 'Cloud OFF'; alert('Cloud desactivado (local)'); }
  else initFirebaseAuto();
});

/* periodic backup */
setInterval(()=> saveLocalBackup(), 10000);

/* start UI */
initUI();
if(isAuth()){ $('#modal-login').classList.remove('visible'); startApp(); }
</script>
</body>
</html>



