<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>MINIMARKET LA ESQUINA DEL AHORRO — TiendaSmart</title>

<!-- Tailwind (CDN) + Lucide Icons -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<!-- Utilities: XLSX, html2canvas, jsPDF -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- QuaggaJS (fallback scanner) -->
<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>

<!-- Firebase Compat SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
  /* --- Tipografía y diseño base --- */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');
  :root{
    --primary:#4f46e5;
    --accent:#10b981;
    --bg:#f6f8fb;
    --card:#ffffff;
    --maxw:420px;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;background:var(--bg);margin:0;color:#0f172a;-webkit-font-smoothing:antialiased}
  .app-shell{max-width:var(--maxw);margin:0 auto;min-height:100vh;display:flex;flex-direction:column;position:relative;padding-bottom:120px}
  header{position:sticky;top:0;z-index:40;background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9));backdrop-filter:blur(6px);padding:12px;border-bottom:1px solid rgba(0,0,0,0.04);display:flex;justify-content:space-between;align-items:center}
  h1.app-title{font-size:14px;font-weight:800;letter-spacing:0.06em}
  p.app-sub{margin:0;font-weight:700;font-size:18px}
  .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06);margin-bottom:12px}
  .input-pro{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e8eb;background:#fbfcfe;outline:none}
  .btn-primary{background:var(--primary);color:white;padding:10px;border-radius:10px;font-weight:700;display:inline-flex;align-items:center;justify-content:center;gap:8px}
  .modal{position:fixed;inset:0;background:rgba(3,7,18,0.5);display:none;align-items:center;justify-content:center;padding:12px;z-index:80}
  .modal.visible{display:flex}
  .modal-sheet{width:100%;max-width:760px;background:white;border-radius:12px;padding:16px;max-height:92vh;overflow:auto}
  .bottom-nav{position:fixed;left:0;right:0;bottom:0;display:flex;justify-content:space-around;padding:10px;background:rgba(255,255,255,0.96);border-top:1px solid rgba(0,0,0,0.04);z-index:60}
  .nav-btn{display:flex;flex-direction:column;align-items:center;font-size:12px}
  .dropdown-suggestions{position:absolute;background:white;border:1px solid #eef2ff;width:100%;max-height:220px;overflow:auto;border-radius:8px;z-index:90}
  .suggestion-item{padding:8px;border-radius:8px;cursor:pointer}
  .suggestion-item:hover{background:#f1f5f9}
  .toast{position:fixed;left:50%;transform:translateX(-50%);top:18px;z-index:100}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #f1f5f9;font-size:13px}
  .small-muted{font-size:12px;color:#6b7280}
  @media (max-width:420px){ :root{--maxw:100vw} .modal-sheet{max-width:100%;border-radius:10px} }
</style>
</head>
<body>

<div class="app-shell">

  <!-- HEADER -->
  <header>
    <div>
      <div class="app-title">MINIMARKET</div>
      <p class="app-sub">LA ESQUINA DEL AHORRO</p>
    </div>
    <div class="flex items-center gap-2">
      <div id="cloud-status" class="flex items-center gap-2 bg-slate-100 px-3 py-1.5 rounded-full">
        <span id="dot" style="width:10px;height:10px;border-radius:999px;background:#ef4444;display:inline-block"></span>
        <span id="cloud-text" class="small-muted">Desconectado</span>
      </div>
      <button id="btn-gestion" class="px-3 py-2 bg-white rounded-lg border small-muted">GESTIÓN</button>
      <button id="btn-open-clients" class="px-3 py-2 bg-white rounded-lg border small-muted">CLIENTES</button>
      <button id="btn-sync" class="px-3 py-2 bg-white rounded-lg border small-muted">SYNC</button>
    </div>
  </header>

  <!-- HOME -->
  <main id="tab-home" class="px-4 pt-6">
    <div class="grid grid-cols-2 gap-3">
      <div class="card" style="background:linear-gradient(180deg,var(--primary),#7c3aed);color:#fff">
        <div class="small-muted">Ventas Hoy</div>
        <div style="font-weight:800;font-size:22px" id="stat-ventas">S/ 0.00</div>
        <div class="small-muted mt-2">Resumen del día</div>
      </div>
      <div class="card">
        <div class="small-muted">Transacciones</div>
        <div style="font-weight:800;font-size:22px" id="stat-count">0</div>
        <div class="small-muted mt-2">POS activo</div>
      </div>
    </div>

    <div class="mt-4">
      <div class="small-muted uppercase font-bold text-xs mb-2">Acciones rápidas</div>
      <div class="grid grid-cols-4 gap-3">
        <button onclick="openModal('modal-sale')" class="flex flex-col items-center gap-2">
          <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center text-indigo-600"><i data-lucide="shopping-cart"></i></div>
          <span class="small-muted">Vender</span>
        </button>
        <button onclick="openModal('modal-product')" class="flex flex-col items-center gap-2">
          <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center text-emerald-600"><i data-lucide="package-plus"></i></div>
          <span class="small-muted">Producto</span>
        </button>
        <button onclick="switchTab('reports')" class="flex flex-col items-center gap-2">
          <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center text-amber-600"><i data-lucide="file-text"></i></div>
          <span class="small-muted">Reportes</span>
        </button>
        <button onclick="exportCombinedXLSX()" class="flex flex-col items-center gap-2">
          <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center text-slate-600"><i data-lucide="download"></i></div>
          <span class="small-muted">Exportar</span>
        </button>
      </div>
    </div>

    <div class="mt-4">
      <div class="flex justify-between items-center mb-2">
        <div class="small-muted uppercase font-bold text-xs">Alertas de stock</div>
        <button onclick="switchTab('inventory')" class="small-muted">Ver inventario</button>
      </div>
      <div id="low-stock-container"></div>
    </div>
  </main>

  <!-- INVENTARIO -->
  <main id="tab-inventory" class="hidden px-4 pt-6">
    <div class="flex gap-2">
      <div class="relative flex-1">
        <i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-slate-400"></i>
        <input id="search-inv" class="input-pro pl-10" placeholder="Buscar producto (nombre o código)...">
        <div id="inv-suggestions" class="dropdown-suggestions hidden"></div>
      </div>
      <button onclick="startScanner()" class="bg-white p-3 rounded-xl border"><i data-lucide="scan-barcode" class="w-5 h-5 text-indigo-600"></i></button>
    </div>
    <div id="inventory-list" class="mt-4"></div>
  </main>

  <!-- REPORTES -->
  <main id="tab-reports" class="hidden px-4 pt-6">
    <h2 class="font-bold text-lg mb-3">Reportes</h2>
    <div class="card">
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="small-muted">Desde</label>
          <input type="date" id="rep-from" class="input-pro mt-1">
        </div>
        <div>
          <label class="small-muted">Hasta</label>
          <input type="date" id="rep-to" class="input-pro mt-1">
        </div>
      </div>
      <div class="flex gap-2 mt-3">
        <button onclick="previewReportRange()" class="btn-primary">Vista previa</button>
        <button onclick="exportReportRangeBothXLSX()" class="px-3 py-2 border rounded">Exportar XLSX</button>
        <button onclick="downloadReportPDF()" class="px-3 py-2 border rounded">Exportar PDF (A4)</button>
      </div>
    </div>

    <div id="report-summary" class="mt-4"></div>
  </main>

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav">
    <button onclick="switchTab('home')" class="nav-btn" data-tab="home"><i data-lucide="layout-grid"></i><span>Inicio</span></button>
    <button onclick="switchTab('inventory')" class="nav-btn" data-tab="inventory"><i data-lucide="box"></i><span>Stock</span></button>
    <button onclick="openModal('modal-sale')" class="nav-btn"><div class="w-14 h-14 bg-indigo-600 rounded-2xl text-white flex items-center justify-center -mt-6 shadow-lg"><i data-lucide="plus"></i></div><span>Vender</span></button>
    <button onclick="switchTab('reports')" class="nav-btn" data-tab="reports"><i data-lucide="bar-chart-big"></i><span>Reportes</span></button>
    <button onclick="logout()" class="nav-btn"><i data-lucide="log-out"></i><span>Salir</span></button>
  </nav>
</div>

<!-- MODALS -->

<!-- MODAL: SALE (POS) -->
<div id="modal-sale" class="modal" aria-hidden="true">
  <div class="modal-sheet">
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-bold text-lg">Nueva Venta</h3>
      <button onclick="closeModal('modal-sale')"><i data-lucide="x"></i></button>
    </div>

    <div>
      <div class="relative">
        <i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-slate-400"></i>
        <input id="pos-search" class="input-pro pl-10" placeholder="Escribe o escanea producto... (coincide por letras)">
        <div id="pos-suggestions" class="dropdown-suggestions hidden"></div>
      </div>

      <div id="pos-cart" class="mt-3 max-h-56 overflow-auto"></div>

      <div class="p-3 bg-slate-900 rounded-2xl text-white mt-3">
        <div class="flex justify-between items-center small-muted mb-1"><span>Total a pagar</span><span id="pos-items-count">0 items</span></div>
        <div style="font-size:28px;font-weight:800">S/ <span id="pos-total">0.00</span></div>
      </div>

      <div class="grid grid-cols-3 gap-2 mt-3">
        <button onclick="setPayMethod('EFECTIVO', event)" class="pay-btn active bg-indigo-50 border-2 border-indigo-600 p-3 rounded-xl">EFECTIVO</button>
        <button onclick="setPayMethod('YAPE', event)" class="pay-btn bg-slate-50 border-2 border-transparent p-3 rounded-xl">YAPE</button>
        <button onclick="setPayMethod('A_CREDITO', event)" class="pay-btn bg-slate-50 border-2 border-transparent p-3 rounded-xl">A CREDITO</button>
      </div>

      <input id="pos-customer" class="input-pro mt-3 hidden" placeholder="Nombre del cliente (Crédito)">

      <div class="flex gap-2 mt-3">
        <button onclick="completeSale()" class="btn-primary w-full py-3">FINALIZAR VENTA</button>
        <button onclick="openModal('modal-scan')" class="px-3 py-3 bg-white border rounded"><i data-lucide="camera"></i></button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: PRODUCT -->
<div id="modal-product" class="modal">
  <div class="modal-sheet">
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-bold text-lg">Gestionar Producto</h3>
      <button onclick="closeModal('modal-product')"><i data-lucide="x"></i></button>
    </div>

    <form id="form-p">
      <input type="hidden" id="p-id">
      <input id="p-name" class="input-pro" placeholder="Nombre del producto" required>
      <div class="grid grid-cols-2 gap-2 mt-2">
        <input id="p-barcode" class="input-pro" placeholder="Código">
        <input id="p-cat" class="input-pro" placeholder="Categoría">
      </div>

      <div class="grid grid-cols-2 gap-2 mt-2 p-2 bg-indigo-50 rounded">
        <div>
          <label class="small-muted">Costo total (factura)</label>
          <input id="p-cost" type="number" step="0.01" class="input-pro mt-1" value="0.00">
        </div>
        <div>
          <label class="small-muted">Precio venta</label>
          <input id="p-price" type="number" step="0.01" class="input-pro mt-1" value="0.00">
        </div>
      </div>

      <div class="grid grid-cols-2 gap-2 mt-2">
        <input id="p-stock" type="number" class="input-pro" placeholder="Stock actual">
        <button type="button" id="btn-delete-p" onclick="deleteProduct()" class="hidden bg-red-50 text-red-700 rounded px-3 py-2">Eliminar</button>
      </div>

      <div class="flex gap-2 mt-3">
        <button type="submit" class="btn-primary w-full">GUARDAR PRODUCTO</button>
        <button type="button" onclick="calculateUnitPrice()" class="px-3 py-2 border rounded">Calcular</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: SCAN -->
<div id="modal-scan" class="modal">
  <div class="modal-sheet" style="max-width:420px">
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-bold">Escáner</h3>
      <button onclick="closeModal('modal-scan')"><i data-lucide="x"></i></button>
    </div>
    <div style="position:relative;height:44vh;background:#000;border-radius:12px;overflow:hidden;">
      <video id="video" autoplay muted playsinline style="width:100%;height:100%;object-fit:cover"></video>
      <canvas id="scan-canvas" style="position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:none"></canvas>
    </div>
    <div class="mt-3 flex gap-2">
      <input id="scanned-code" class="input-pro" placeholder="Código detectado" readonly>
      <button onclick="registerScanned()" class="btn-primary px-4">Registrar</button>
    </div>
  </div>
</div>

<!-- MODAL: CLIENTS -->
<div id="modal-clients" class="modal">
  <div class="modal-sheet">
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-bold">Clientes y Créditos</h3>
      <button onclick="closeModal('modal-clients')"><i data-lucide="x"></i></button>
    </div>

    <form id="form-client" class="flex gap-2 mb-3">
      <input id="client-name" class="input-pro" placeholder="Nombre cliente">
      <input id="client-initial" type="number" step="0.01" class="input-pro w-36" placeholder="Saldo inicial">
      <button class="btn-primary">Agregar</button>
    </form>

    <div id="clients-list" style="max-height:50vh;overflow:auto"></div>
  </div>
</div>

<!-- MODAL: GESTION -->
<div id="modal-gestion" class="modal">
  <div class="modal-sheet">
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-bold">Gestión de Ventas</h3>
      <div class="flex gap-2">
        <button onclick="exportSalesXLSX()" class="px-3 py-2 border rounded">Exportar Ventas</button>
        <button onclick="closeModal('modal-gestion')" class="px-3 py-2 border rounded">Cerrar</button>
      </div>
    </div>
    <div id="gestion-list" style="max-height:60vh;overflow:auto"></div>
  </div>
</div>

<!-- MODAL: LOGIN -->
<div id="login-screen" class="fixed inset-0 z-[200] bg-white flex flex-col items-center justify-center p-8">
  <div class="w-20 h-20 bg-indigo-600 rounded-2xl flex items-center justify-center mb-6">
    <i data-lucide="store" class="text-white w-10 h-10"></i>
  </div>
  <h2 class="text-2xl font-bold mb-1">TiendaSmart</h2>
  <p class="small-muted mb-4">Ingresa a tu punto de venta</p>
  <div class="w-full max-w-sm space-y-3">
    <input id="l-user" class="input-pro" placeholder="Usuario">
    <input id="l-pass" type="password" class="input-pro" placeholder="Contraseña">
    <div class="flex gap-2">
      <button id="btn-login" class="btn-primary w-full">ENTRAR</button>
      <button id="btn-demo" class="px-3 py-2 border rounded">Demo</button>
    </div>
    <div id="login-error" class="text-red-600 text-sm mt-2 hidden"></div>
  </div>
</div>

<!-- Toast root -->
<div id="toast-root" class="toast"></div>

<script>
/* ========================
   CONFIG / HELPERS / STATE
   ======================== */
const firebaseConfig = {
  apiKey: "AIzaSyBh2WHinnQeRD9fsmdEMj9zkNVJNcixzS4",
  authDomain: "jhonatan-7ca7d.firebaseapp.com",
  projectId: "jhonatan-7ca7d",
  storageBucket: "jhonatan-7ca7d.firebasestorage.app",
  messagingSenderId: "248102422749",
  appId: "1:248102422749:web:097c4e553e610d27dff334"
};
const DB = { col: "MODO DE PREODUCCIÓN", doc: "DATOS", field: "MAGALY" };

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const uid = ()=> 'id-'+Math.random().toString(36).slice(2,9);
const money = v => Number(v||0).toFixed(2);
const todayYMD = ()=> { const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };

function showToast(msg, ms=1600){
  const root = document.getElementById('toast-root');
  const el = document.createElement('div'); el.className='bg-slate-900 text-white px-4 py-2 rounded-xl text-sm shadow-lg'; el.style.marginTop='6px'; el.textContent = msg;
  root.appendChild(el); setTimeout(()=> el.remove(), ms);
}
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

/* App state */
let STATE = { products: [], sales: [], customers: [] };
let cart = []; let payMethod = 'EFECTIVO'; let db = null; let cloudOn = false;
let unsubscribe = null;

/* load local backup */
try { const b = localStorage.getItem('tienda_local_backup'); if(b) STATE = JSON.parse(b); } catch(e){ console.warn('local parse err', e); }

/* ========================
   NORMALIZE / MERGE / FIRESTORE SYNC
   ======================== */
function normalizeRemoteData(remote){
  const payload = (remote && remote[DB.field]) ? remote[DB.field] : (remote || {});
  const out = { products: [], sales: [], customers: [] };

  function nProd(raw){
    if(!raw) return null;
    const p = Object.assign({}, raw);
    p.id = p.id || p._id || p.code || p.barcode || uid();
    p.name = String(p.name || p.title || '').trim();
    p.barcode = String(p.barcode || p.code || '').trim();
    p.category = String(p.category || '').trim();
    p.stock = Number(p.stock || p.qty || p.quantity || 0);
    p.price = Number(p.price || p.salePrice || p.valor || 0);
    p.costPrice = Number(p.costPrice || p.unitCost || p.cost || 0);
    p.createdAt = p.createdAt || new Date().toISOString();
    p.movements = Array.isArray(p.movements) ? p.movements : (p.movimientos || []);
    return p;
  }

  function normalizeSaleItems(raw){
    const items=[]; if(!raw) return items;
    if(Array.isArray(raw)){ for(const it of raw) items.push({ productId: it.productId || it.id || it.pid || null, qty: Number(it.qty||it.quantity||1), unitPrice: Number(it.unitPrice||it.price||0) }); return items; }
    if(typeof raw === 'object'){ for(const k of Object.keys(raw)){ const it = raw[k]; items.push({ productId: it.productId||it.id||k, qty: Number(it.qty||it.quantity||1), unitPrice: Number(it.unitPrice||it.price||0) }); } return items; }
    if(typeof raw === 'string'){ const parts = raw.split(/[|,;]/).map(p=>p.trim()).filter(Boolean); for(const p of parts){ const m = p.match(/(.+?)\s*x\s*(\d+)/i); if(m) items.push({ productId:null, name:m[1].trim(), qty:Number(m[2]), unitPrice:0 }); else items.push({ productId:null,name:p,qty:1,unitPrice:0 }); } return items; }
    return items;
  }

  const prodCand = payload.products || payload.inventory || payload.catalog || payload.items || [];
  if(Array.isArray(prodCand)) out.products = prodCand.map(nProd).filter(Boolean);
  else if(typeof prodCand === 'object') out.products = Object.values(prodCand).map(nProd).filter(Boolean);

  if(out.products.length === 0){
    for(const k of Object.keys(payload)){
      const v = payload[k];
      if(v && (v.name || v.barcode)){ const p = nProd(v); if(p) out.products.push(p); }
    }
  }

  const salesCand = payload.sales || payload.ventas || payload.transactions || payload.orders || [];
  if(Array.isArray(salesCand)){
    out.sales = salesCand.map(s => {
      const sale = Object.assign({},s);
      sale.id = sale.id || sale._id || ('sale-'+Math.random().toString(36).slice(2,9));
      sale.date = sale.date || sale.created || new Date().toISOString();
      sale.total = Number(sale.total || sale.amount || 0);
      sale.paymentType = sale.paymentType || sale.payment || sale.method || 'EFECTIVO';
      sale.items = normalizeSaleItems(sale.items || sale.products || sale.itemsText);
      return sale;
    });
  } else if(typeof salesCand === 'object'){
    out.sales = Object.values(salesCand).map(s => {
      const sale = Object.assign({},s);
      sale.id = sale.id || sale._id || ('sale-'+Math.random().toString(36).slice(2,9));
      sale.date = sale.date || sale.created || new Date().toISOString();
      sale.total = Number(sale.total || sale.amount || 0);
      sale.paymentType = sale.paymentType || sale.payment || sale.method || 'EFECTIVO';
      sale.items = normalizeSaleItems(sale.items || sale.products || []);
      return sale;
    });
  }

  const customersCand = payload.customers || payload.clientes || [];
  if(Array.isArray(customersCand)) out.customers = customersCand.map(c=>({ name:c.name||c.nombre||'', balance: Number(c.balance||c.saldo||0), createdAt: c.createdAt||new Date().toISOString() }));
  else if(typeof customersCand === 'object') out.customers = Object.values(customersCand).map(c=>({ name:c.name||c.nombre||'', balance: Number(c.balance||c.saldo||0), createdAt: c.createdAt||new Date().toISOString() }));

  function linkItems(items){
    return items.map(it => {
      if(it.productId) return it;
      if(it.barcode){
        const m = out.products.find(p => p.barcode && p.barcode === String(it.barcode));
        if(m) return { productId: m.id, qty:Number(it.qty||1), unitPrice: Number(it.unitPrice||m.price||0) };
      }
      if(it.name){
        const nm = String(it.name).toLowerCase();
        const m = out.products.find(p => String(p.name||'').toLowerCase() === nm);
        if(m) return { productId: m.id, qty:Number(it.qty||1), unitPrice:Number(it.unitPrice||m.price||0) };
      }
      return { productId: it.productId || null, qty:Number(it.qty||1), unitPrice:Number(it.unitPrice||0), rawName: it.name || null };
    });
  }
  out.sales = out.sales.map(s => { s.items = linkItems(s.items||[]); if((!s.total||s.total===0) && Array.isArray(s.items)) s.total = s.items.reduce((a,b)=>a + (Number(b.unitPrice||0)*Number(b.qty||1)),0); return s; });
  out.products = out.products.map(p => { p.id = p.id || uid(); p.stock = Number(p.stock||0); p.price = Number(p.price||0); p.costPrice = Number(p.costPrice||0); p.movements = Array.isArray(p.movements)?p.movements:[]; return p; });

  return out;
}

function mergeState(remoteState){
  const map = new Map(); (STATE.products||[]).forEach(p => map.set(p.id, JSON.parse(JSON.stringify(p))));
  for(const rp of (remoteState.products||[])){
    const existing = map.get(rp.id);
    if(!existing) map.set(rp.id, rp);
    else {
      const ldt = new Date(existing.createdAt||0).getTime(), rdt = new Date(rp.createdAt||0).getTime();
      const base = rdt >= ldt ? rp : existing;
      const mm = new Map(); (existing.movements||[]).forEach(m=> mm.set(m.id||JSON.stringify(m), m)); (rp.movements||[]).forEach(m=> mm.set(m.id||JSON.stringify(m), m));
      base.movements = Array.from(mm.values());
      map.set(base.id, base);
    }
  }
  const mergedProds = Array.from(map.values());

  const sMap = new Map(); (STATE.sales||[]).forEach(s=> sMap.set(s.id, s));
  for(const rs of (remoteState.sales||[])){
    if(!sMap.has(rs.id)) sMap.set(rs.id, rs);
    else {
      const cur = sMap.get(rs.id);
      const cd = new Date(cur.date||0).getTime(), rd = new Date(rs.date||0).getTime();
      if(rd > cd) sMap.set(rs.id, rs);
    }
  }
  const mergedSales = Array.from(sMap.values()).sort((a,b)=> new Date(b.date)-new Date(a.date));

  const cMap = new Map(); (STATE.customers||[]).forEach(c=> cMap.set((c.name||'').toLowerCase(), c));
  for(const rc of (remoteState.customers||[])){
    const key = (rc.name||'').toLowerCase();
    if(!cMap.has(key)) cMap.set(key, rc);
    else { const ex = cMap.get(key); ex.balance = Number((Number(ex.balance||0) + Number(rc.balance||0)).toFixed(2)); }
  }
  const mergedCustomers = Array.from(cMap.values());

  STATE.products = mergedProds; STATE.sales = mergedSales; STATE.customers = mergedCustomers;
  try { localStorage.setItem('tienda_local_backup', JSON.stringify(STATE)); } catch(e){}
}

/* ========================
   FIREBASE: init + sync
   ======================== */
function initFirebase(){
  try{
    if(!window.firebase) { console.warn('Firebase SDK missing'); return; }
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
  }catch(e){ console.error('initFirebase err', e); db = null; }
}

function startFirestoreSync(){
  if(!db) { updateOnline(false); return; }
  const ref = db.collection(DB.col).doc(DB.doc);
  // unsubscribe previous
  if(typeof unsubscribe === 'function') try{ unsubscribe(); }catch(e){}
  unsubscribe = ref.onSnapshot(docSnap => {
    if(docSnap.exists){
      const raw = docSnap.data() || {};
      // normalize remote
      const normalized = normalizeRemoteData(raw);
      mergeState(normalized);
      renderAll();
      updateOnline(true);
      console.log('✅ Datos sincronizados desde Firestore');
    } else {
      // create document with current STATE
      ref.set({ [DB.field]: STATE }, { merge:true }).then(()=> updateOnline(true)).catch(e=>{ console.warn('set doc err', e); updateOnline(false); });
    }
  }, err => {
    console.error('onSnapshot error', err);
    updateOnline(false);
  });
}

async function pushStateToCloud(){
  if(!db){ try{ localStorage.setItem('tienda_local_backup', JSON.stringify(STATE)); showToast('Guardado local (offline)'); } catch(e){}; return; }
  try{
    await db.collection(DB.col).doc(DB.doc).set({ [DB.field]: STATE }, { merge:true });
    updateOnline(true);
    showToast('Sincronizado con Cloud');
  }catch(e){
    console.error('pushStateToCloud err', e);
    updateOnline(false);
    showToast('Error guardando en Cloud');
  }
}

/* Force sync (normalize & write back) */
async function forceSync(){
  if(!db) return alert('Cloud no inicializado');
  if(!confirm('Forzar sincronización y normalización del documento remoto?')) return;
  try{
    const ref = db.collection(DB.col).doc(DB.doc);
    const snap = await ref.get();
    if(!snap.exists){ await ref.set({ [DB.field]: STATE }, { merge:true }); showToast('Documento creado en Firestore'); return; }
    const normalized = normalizeRemoteData(snap.data()||{});
    mergeState(normalized);
    await ref.set({ [DB.field]: STATE }, { merge:true });
    showToast('Sincronía forzada OK');
    renderAll();
  }catch(e){ console.error(e); alert('forceSync error: ' + (e.message||e)); }
}

/* update UI online/offline */
function updateOnline(on){
  cloudOn = !!on;
  $('#dot').style.background = on ? '#10b981' : '#ef4444';
  $('#cloud-text').textContent = on ? 'Online' : 'Desconectado';
}

/* ========================
   RENDERS & UI FUNCTIONS
   ======================== */
function renderAll(){ renderDashboard(); renderInventoryList(); renderCart(); renderClients(); renderGestionList(); updateReportsIfOpen(); }
function renderDashboard(){
  const hoy = new Date().toISOString().split('T')[0];
  const ventasHoy = (STATE.sales||[]).filter(s => (s.date||'').startsWith && (s.date||'').startsWith(hoy));
  const total = ventasHoy.reduce((a,b)=> a + Number(b.total||0), 0);
  $('#stat-ventas').textContent = `S/ ${money(total)}`;
  $('#stat-count').textContent = ventasHoy.length;
  const low = (STATE.products||[]).filter(p=> Number(p.stock) <= 5).slice(0,4);
  const container = $('#low-stock-container'); container.innerHTML = '';
  low.forEach(p => {
    const card = document.createElement('div'); card.className='card flex justify-between items-center';
    card.style.padding='8px'; card.innerHTML = `<div><div style="font-weight:700">${escapeHtml(p.name)}</div><div class="small-muted">S/ ${money(p.price)} • ${p.category||''}</div></div><div class="small-muted">Quedan ${p.stock}</div>`;
    container.appendChild(card);
  });
}

function renderInventoryList(){
  const container = $('#inventory-list'); if(!container) return; container.innerHTML='';
  const q = ($('#search-inv').value||'').toLowerCase();
  const list = (STATE.products||[]).filter(p => !q || (p.name||'').toLowerCase().includes(q) || (p.barcode||'').includes(q));
  if(list.length === 0) container.innerHTML = '<div class="small-muted">No hay productos</div>';
  list.forEach(p=>{
    const d = document.createElement('div'); d.className='card flex justify-between items-center';
    d.onclick = ()=> editProduct(p.id);
    d.innerHTML = `<div><div style="font-weight:800">${escapeHtml(p.name)}</div><div class="small-muted">STOCK: ${p.stock} • S/ ${money(p.price)}</div></div><div class="text-indigo-600"><i data-lucide="edit-3"></i></div>`;
    container.appendChild(d);
  });
  lucide.createIcons();
}

/* ========================
   PRODUCT CRUD
   ======================== */
document.getElementById('form-p').addEventListener('submit', async (e)=>{
  e.preventDefault();
  try{
    const id = $('#p-id').value || uid();
    const prod = {
      id,
      name: $('#p-name').value.trim(),
      barcode: $('#p-barcode').value.trim(),
      category: $('#p-cat').value.trim(),
      costPrice: Number($('#p-cost').value) || 0,
      price: Number($('#p-price').value) || 0,
      stock: Number($('#p-stock').value) || 0,
      createdAt: new Date().toISOString(),
      movements: (STATE.products.find(p=>p.id===id)?.movements)||[]
    };
    const idx = (STATE.products||[]).findIndex(p=>p.id===id);
    if(idx >= 0) STATE.products[idx] = prod; else STATE.products.unshift(prod);
    await pushStateToCloud();
    showToast('Producto guardado');
    renderInventoryList(); renderDashboard();
    closeModal('modal-product');
  }catch(e){ console.error(e); alert('Error guardando producto: '+ (e.message||e)); }
});

function editProduct(id){
  const p = (STATE.products||[]).find(x=> x.id === id); if(!p) return alert('Producto no encontrado');
  $('#p-id').value = p.id; $('#p-name').value = p.name; $('#p-barcode').value = p.barcode; $('#p-cat').value = p.category;
  $('#p-cost').value = p.costPrice||0; $('#p-price').value = p.price||0; $('#p-stock').value = p.stock||0;
  $('#btn-delete-p').classList.remove('hidden'); openModal('modal-product');
}

function deleteProduct(){
  const id = $('#p-id').value; if(!id) return;
  if(!confirm('Eliminar producto?')) return;
  STATE.products = (STATE.products||[]).filter(p=>p.id !== id);
  pushStateToCloud();
  renderInventoryList(); renderDashboard(); closeModal('modal-product'); showToast('Producto eliminado');
}

function calculateUnitPrice(){
  const cost = Number($('#p-cost').value)||0; const stock = Number($('#p-stock').value)||1;
  if(stock <= 0) return alert('Stock debe ser mayor que 0');
  const unit = cost / stock;
  $('#p-price').value = (unit * 1.30).toFixed(2);
  showToast('Precio estimado calculado');
}

/* ========================
   IMPORT / EXPORT XLSX
   ======================== */
function exportInventoryXLSX(){
  try{
    const rows = (STATE.products||[]).map(p=>({ id:p.id,name:p.name,category:p.category,barcode:p.barcode,stock:p.stock,price:p.price,costPrice:p.costPrice }));
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Inventario');
    XLSX.writeFile(wb, `inventario_${todayYMD()}.xlsx`);
    showToast('Inventario exportado');
  }catch(e){ console.error(e); alert('Error exportando inventario'); }
}

function exportSalesXLSX(){
  try{
    const rows = (STATE.sales||[]).map(s=>({ id:s.id, date:s.date, customer:s.customer||'', paymentType:s.paymentType||s.method||'', total:s.total, items:(s.items||[]).map(it=> ((STATE.products.find(p=>p.id===it.productId)||{name:it.rawName||it.productId}).name + ' x' + it.qty)).join(' | ') }));
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Ventas');
    XLSX.writeFile(wb, `ventas_${todayYMD()}.xlsx`);
    showToast('Ventas exportadas');
  }catch(e){ console.error(e); alert('Error exportando ventas'); }
}

function exportCombinedXLSX(){
  try{
    const from = todayYMD(), to = todayYMD();
    const salesRows = (STATE.sales||[]).map(s=>({ id:s.id, date:s.date, customer:s.customer||'', paymentType:s.paymentType||s.method||'', total:s.total, items:(s.items||[]).map(it=> ((STATE.products.find(p=>p.id===it.productId)||{name:it.rawName||it.productId}).name + ' x' + it.qty)).join(' | ') }));
    const invRows = (STATE.products||[]).map(p=>({ id:p.id, name:p.name, category:p.category, barcode:p.barcode, stock:p.stock, price:p.price, costPrice:p.costPrice }));
    const kardex = []; (STATE.products||[]).forEach(p=> (p.movements||[]).forEach(m=> kardex.push({ productId:p.id, productName:p.name, type:m.type||'', qty:m.qty||0, date:m.date||'', note:m.note||'' })));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(salesRows), 'Ventas');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(invRows), 'Inventario');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(kardex), 'Kardex');
    XLSX.writeFile(wb, `Ventas_Inventario_Kardex_${from}_a_${to}.xlsx`);
    showToast('Exportado Ventas + Inventario + Kardex');
  }catch(e){ console.error(e); alert('Error exportando combinado'); }
}

/* ========================
   REPORTES (AGRUPADOS POR TIPO)
   ======================== */
function salesInRange(from,to){
  if(!from||!to) return [];
  const s = new Date(from + 'T00:00:00').getTime(), e = new Date(to + 'T23:59:59.999').getTime();
  return (STATE.sales||[]).filter(sale => { const t = new Date(sale.date).getTime(); return t >= s && t <= e; });
}

function generateReportData(from,to){
  const sales = salesInRange(from,to);
  const groups = { EFECTIVO:{total:0,count:0,items:[]}, YAPE:{total:0,count:0,items:[]}, A_CREDITO:{total:0,count:0,items:[]}, OTHER:{total:0,count:0,items:[]} };
  let grand = 0;
  for(const s of sales){
    const key = (s.paymentType || s.method || 'EFECTIVO').toUpperCase();
    const cls = ['EFECTIVO','YAPE','A_CREDITO'].includes(key) ? key : 'OTHER';
    groups[cls].total += Number(s.total||0);
    groups[cls].count += 1;
    grand += Number(s.total||0);
    groups[cls].items.push(s);
  }
  return { groups, grand, totalOps: sales.length, sales };
}

function renderReportSummary(from,to){
  const { groups, grand, totalOps, sales } = generateReportData(from,to);
  const parts = [];
  parts.push(`<div style="display:flex;justify-content:space-between;align-items:center"><div><h2 style="margin:0">MINIMARKET — LA ESQUINA DEL AHORRO</h2><div class="small-muted">${from} → ${to}</div></div><div style="text-align:right"><div style="font-weight:800">Total S/ ${money(grand)}</div><div class="small-muted">${totalOps} ventas</div></div></div><hr/>`);
  parts.push(`<div style="display:flex;gap:8px;margin-top:8px">`);
  ['EFECTIVO','YAPE','A_CREDITO','OTHER'].forEach(k=>{
    const lbl = k==='A_CREDITO' ? 'A CREDITO' : (k==='OTHER' ? 'OTROS' : k);
    parts.push(`<div style="flex:1;padding:10px;background:#fff;border-radius:8px;border:1px solid #eee"><div class="small-muted">${lbl}</div><div style="font-weight:800;font-size:18px">S/ ${money(groups[k].total)}</div><div class="small-muted">${groups[k].count} ops</div></div>`);
  });
  parts.push(`</div><hr style="margin:12px 0"/>`);
  // sales table
  const rows = sales.map(s=>{
    const items = (s.items||[]).map(it => ((STATE.products.find(p=>p.id===it.productId)||{name:it.rawName||it.productId}).name) + ' x' + it.qty).join('; ');
    return `<tr><td>${new Date(s.date).toLocaleString()}</td><td>${s.id}</td><td>${escapeHtml(s.customer||'-')}</td><td>${escapeHtml(s.paymentType||s.method||'EFECTIVO')}</td><td style="text-align:right">S/ ${money(s.total)}</td><td>${escapeHtml(items)}</td></tr>`;
  }).join('');
  const table = `<table style="width:100%;border-collapse:collapse;font-size:12px"><thead><tr><th>Fecha</th><th>ID</th><th>Cliente</th><th>Pago</th><th style="text-align:right">Total</th><th>Productos</th></tr></thead><tbody>${rows || '<tr><td colspan="6" class="small-muted">No hay ventas</td></tr>'}</tbody></table>`;
  $('#report-summary').innerHTML = parts.join('') + table + '<hr/>' + buildInventoryMiniHTML();
}

function buildInventoryMiniHTML(){
  const invRows = (STATE.products||[]).map(p=>`<tr><td>${escapeHtml(p.name)}</td><td>${escapeHtml(p.barcode||'')}</td><td style="text-align:right">${p.stock}</td><td style="text-align:right">S/ ${money(p.price||0)}</td></tr>`).join('');
  return `<h3 style="margin-top:10px">Inventario</h3><table style="width:100%;border-collapse:collapse;font-size:12px"><thead><tr><th>Producto</th><th>Cod</th><th style="text-align:right">Stock</th><th style="text-align:right">Precio</th></tr></thead><tbody>${invRows}</tbody></table>`;
}

function previewReportRange(){ const from = $('#rep-from').value || todayYMD(); const to = $('#rep-to').value || todayYMD(); renderReportSummary(from,to); }
function updateReportsIfOpen(){ if(document.getElementById('tab-reports') && !document.getElementById('tab-reports').classList.contains('hidden')) previewReportRange(); }

async function downloadReportPDF(){
  const from = $('#rep-from').value || todayYMD(); const to = $('#rep-to').value || todayYMD();
  renderReportSummary(from,to); // ensure content
  const el = document.getElementById('report-summary');
  if(!el) return alert('Generando PDF: no se encontró contenido del reporte');
  showToast('Generando PDF, espere...');
  try{
    const canvas = await html2canvas(el, { scale:2, useCORS:true, logging:false });
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jspdf.jsPDF('p','mm','a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgProps = pdf.getImageProperties(imgData);
    const pdfHeight = (imgProps.height * pageWidth) / imgProps.width;
    pdf.addImage(imgData, 'PNG', 10, 10, pageWidth-20, pdfHeight > (pageHeight-20) ? pageHeight-20 : pdfHeight);
    const filename = `Reporte del dia ${todayYMD()}.pdf`;
    pdf.save(filename);
    showToast('PDF descargado: ' + filename);
  }catch(e){ console.error(e); alert('Error generando PDF: ' + (e.message||e)); }
}

/* ========================
   POS / CART / SALES
   ======================== */
$('#pos-search')?.addEventListener('input', (e)=>{
  const val = e.target.value.trim().toLowerCase();
  const sug = $('#pos-suggestions'); if(!sug) return; sug.innerHTML='';
  if(!val){ sug.classList.add('hidden'); return; }
  const matches = (STATE.products||[]).filter(p => (p.name||'').toLowerCase().includes(val) || (p.barcode||'').includes(val)).slice(0,12);
  if(matches.length === 0){ sug.classList.add('hidden'); return; }
  matches.forEach(m => {
    const div = document.createElement('div'); div.className='suggestion-item';
    div.innerHTML = `<div style="font-weight:700">${escapeHtml(m.name)}</div><div class="small-muted">S/ ${money(m.price)} • Stock: ${m.stock}</div>`;
    div.onclick = ()=> { addToCart(m); sug.classList.add('hidden'); $('#pos-search').value = ''; };
    sug.appendChild(div);
  });
  sug.classList.remove('hidden');
});

function addToCart(p){
  const ex = cart.find(i=> i.id === p.id);
  if(ex) ex.qty++; else cart.push({ id:p.id, name:p.name, price:p.price||0, qty:1 });
  renderCart();
}

function renderCart(){
  const container = $('#pos-cart');
  container.innerHTML = '';
  let total = 0;
  cart.forEach((item, idx) => {
    total += item.price * item.qty;
    const div = document.createElement('div'); div.className='card flex justify-between items-center';
    div.style.padding = '8px'; div.innerHTML = `<div><div style="font-weight:800">${escapeHtml(item.name)}</div><div class="small-muted">S/ ${money(item.price)}</div></div>
      <div style="display:flex;align-items:center;gap:8px">
        <button onclick="updateQty(${idx},-1)" class="px-2 py-1 border rounded">-</button>
        <div style="font-weight:800">${item.qty}</div>
        <button onclick="updateQty(${idx},1)" class="px-2 py-1 border rounded">+</button>
      </div>`;
    container.appendChild(div);
  });
  $('#pos-total').textContent = money(total);
  $('#pos-items-count').textContent = `${cart.reduce((s,i)=> s + (i.qty||0),0)} items`;
}

function updateQty(idx, delta){ cart[idx].qty += delta; if(cart[idx].qty <= 0) cart.splice(idx,1); renderCart(); }

function setPayMethod(m, ev){
  payMethod = m;
  $$('.pay-btn').forEach(b=> b.classList.remove('active'));
  if(ev && ev.currentTarget) ev.currentTarget.classList.add('active');
  if(m === 'A_CREDITO') $('#pos-customer').classList.remove('hidden'); else $('#pos-customer').classList.add('hidden');
}

async function completeSale(){
  try{
    if(cart.length === 0) return alert('El carrito está vacío');
    // validate stock
    for(const it of cart){
      const p = (STATE.products||[]).find(x => x.id === it.id);
      if(!p) return alert('Producto no encontrado: ' + it.name);
      if(Number(p.stock) < Number(it.qty)) return alert(`Stock insuficiente para: ${p.name}`);
    }
    const total = cart.reduce((a,b) => a + (b.price * b.qty), 0);
    const sale = { id: 'V-' + Date.now(), date: new Date().toISOString(), total, paymentType: payMethod, customer: $('#pos-customer').value || null, items: cart.map(i=> ({ productId: i.id, qty: i.qty, unitPrice: i.price })) };

    // update stocks and movements
    for(const it of sale.items){
      const p = (STATE.products||[]).find(x => x.id === it.productId);
      if(p){
        p.stock = Number(p.stock) - Number(it.qty);
        p.movements = p.movements || [];
        p.movements.unshift({ id: uid(), type:'OUT', qty: it.qty, date: new Date().toISOString(), saleId: sale.id, unitPrice: it.unitPrice });
      }
    }

    // credit handling
    if(sale.paymentType === 'A_CREDITO' && sale.customer){
      const key = (sale.customer||'').toLowerCase();
      const c = (STATE.customers||[]).find(x => (x.name||'').toLowerCase() === key);
      if(c) c.balance = Number((Number(c.balance||0) + Number(sale.total)).toFixed(2));
      else STATE.customers.unshift({ name: sale.customer, balance: Number(sale.total), createdAt: new Date().toISOString() });
    }

    STATE.sales.unshift(sale);
    await pushStateToCloud();
    showToast('Venta registrada con éxito');

    // after sale: reset POS
    cart = []; renderCart(); renderInventoryList(); renderDashboard(); closeModal('modal-sale');
  }catch(e){ console.error(e); alert('Error registrando venta: ' + (e.message||e)); }
}

/* ========================
   GESTIÓN: listar ventas, editar y eliminar
   ======================== */
function renderGestionList(){
  const container = $('#gestion-list'); if(!container) return; container.innerHTML = '';
  const rows = (STATE.sales||[]).slice(0,500);
  if(rows.length === 0) { container.innerHTML = '<div class="small-muted">No hay ventas registradas</div>'; return; }
  const table = document.createElement('table');
  table.innerHTML = `<thead><tr><th>Fecha</th><th>ID</th><th>Cliente</th><th>Pago</th><th style="text-align:right">Total</th><th>Acciones</th></tr></thead><tbody></tbody>`;
  const tbody = table.querySelector('tbody');
  rows.forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${new Date(s.date).toLocaleString()}</td><td>${s.id}</td><td>${escapeHtml(s.customer||'-')}</td><td>${escapeHtml(s.paymentType||s.method||'EFECTIVO')}</td><td style="text-align:right">S/ ${money(s.total)}</td><td style="white-space:nowrap"><button onclick="openEditSale('${s.id}')" class="px-2 py-1 border rounded mr-2">Editar</button><button onclick="deleteSaleConfirm('${s.id}')" class="px-2 py-1 border rounded">Eliminar</button></td>`;
    tbody.appendChild(tr);
  });
  container.appendChild(table);
}

/* open edit sale modal */
function openEditSale(saleId){
  const s = (STATE.sales||[]).find(x=> x.id === saleId); if(!s) return alert('Venta no encontrada');
  const modal = document.createElement('div'); modal.className='modal visible'; modal.style.zIndex='120';
  const sheet = document.createElement('div'); sheet.className='modal-sheet';
  sheet.innerHTML = `<div class="flex justify-between items-center mb-3"><h3 class="font-bold">Editar Venta ${s.id}</h3><button id="close-edit">Cerrar</button></div>
    <div><label class="small-muted">Cliente</label><input id="edit-customer" class="input-pro mt-1" value="${escapeHtml(s.customer||'')}" /></div>
    <div class="mt-2"><label class="small-muted">Pago</label><select id="edit-payment" class="input-pro mt-1"><option ${ (s.paymentType||s.method) === 'EFECTIVO' ? 'selected':'' }>EFECTIVO</option><option ${ (s.paymentType||s.method) === 'YAPE' ? 'selected':'' }>YAPE</option><option ${ (s.paymentType||s.method) === 'A_CREDITO' ? 'selected':'' }>A_CREDITO</option></select></div>
    <div class="mt-3"><label class="small-muted">Productos</label><div id="edit-items" style="max-height:220px;overflow:auto;border:1px solid #eee;padding:8px;border-radius:8px;"></div></div>
    <div class="mt-3 flex gap-2"><button id="save-edit" class="btn-primary">Guardar cambios</button><button id="cancel-edit" class="px-3 py-2 border rounded">Cancelar</button></div>`;
  modal.appendChild(sheet); document.body.appendChild(modal);
  const itemsContainer = sheet.querySelector('#edit-items');
  s.items.forEach((it, idx)=>{
    const prod = (STATE.products||[]).find(p=> p.id === it.productId) || { name: it.rawName || 'Producto' };
    const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.marginBottom='8px';
    row.innerHTML = `<div style="flex:1"><div style="font-weight:700">${escapeHtml(prod.name)}</div><div class="small-muted">Unit S/ ${money(it.unitPrice||0)}</div></div><div><input type="number" value="${it.qty}" min="1" data-idx="${idx}" class="input-pro edit-qty" style="width:90px"></div>`;
    itemsContainer.appendChild(row);
  });
  sheet.querySelector('#close-edit').addEventListener('click', ()=> modal.remove());
  sheet.querySelector('#cancel-edit').addEventListener('click', ()=> modal.remove());
  sheet.querySelector('#save-edit').addEventListener('click', async ()=>{
    const newCustomer = sheet.querySelector('#edit-customer').value.trim();
    const newPayment = sheet.querySelector('#edit-payment').value;
    const qtyInputs = Array.from(sheet.querySelectorAll('.edit-qty'));
    // compute diffs and adjust stock
    const oldMap = {}; s.items.forEach(it => { oldMap[it.productId || it.rawName || uid()] = Number(it.qty || 0); });
    const newMap = {};
    qtyInputs.forEach(inp => { const idx = Number(inp.getAttribute('data-idx')); const val = Number(inp.value) || 0; const key = s.items[idx].productId || s.items[idx].rawName || uid(); newMap[key] = val; });
    for(let i=0;i<s.items.length;i++){
      const it = s.items[i];
      const key = it.productId || it.rawName || uid();
      const oldQ = oldMap[key] || 0; const newQ = newMap[key] || 0;
      const diff = newQ - oldQ; // positive => sold more (reduce stock)
      if(it.productId){
        const p = (STATE.products||[]).find(x=> x.id === it.productId);
        if(p) p.stock = Number(p.stock) - diff;
      }
      s.items[i].qty = newQ;
    }
    s.total = s.items.reduce((a,b)=> a + (Number(b.unitPrice||0) * Number(b.qty||0)), 0);
    s.customer = newCustomer || s.customer;
    s.paymentType = newPayment;
    await pushStateToCloud();
    showToast('Venta editada');
    renderAll();
    modal.remove();
  });
}

/* delete sale with stock rollback */
function deleteSaleConfirm(saleId){
  if(!confirm('Eliminar venta y revertir stock?')) return;
  const sale = (STATE.sales||[]).find(s=> s.id === saleId); if(!sale) return alert('Venta no encontrada');
  for(const it of sale.items){
    const p = (STATE.products||[]).find(x=> x.id === it.productId);
    if(p){ p.stock = Number(p.stock) + Number(it.qty); p.movements = p.movements || []; p.movements.unshift({ id: uid(), type:'ROLLBACK', qty: it.qty, date: new Date().toISOString(), note: 'Eliminación venta ' + saleId }); }
  }
  STATE.sales = (STATE.sales||[]).filter(s=> s.id !== saleId);
  pushStateToCloud();
  showToast('Venta eliminada y stock revertido');
  renderAll();
}

/* ========================
   SCANNER (camera, BarcodeDetector + Quagga fallback)
   ======================== */
let videoStream = null; let detecting = false;
async function startScanner(){
  openModal('modal-scan');
  try{
    const constraints = { video: { facingMode: { ideal: 'environment' }, width: { ideal:1280 }, height: { ideal:720 } }, audio:false };
    videoStream = await navigator.mediaDevices.getUserMedia(constraints);
    $('#video').srcObject = videoStream;
    await $('#video').play();
    detecting = true;
    detectionLoop();
  }catch(e){ console.warn('camera access err', e); alert('No se pudo acceder a la cámara'); }
}

async function stopScanner(){
  detecting = false;
  if(videoStream){ videoStream.getTracks().forEach(t=> t.stop()); videoStream = null; }
  if($('#video')) $('#video').srcObject = null;
}

async function detectionLoop(){
  const video = $('#video');
  while(detecting && video && !video.paused){
    try{
      if('BarcodeDetector' in window){
        const detector = new BarcodeDetector({ formats: ['ean_13','code_128','upc_e','upc_a','ean_8'] });
        const barcodes = await detector.detect(video);
        if(barcodes && barcodes.length){
          const code = barcodes[0].rawValue;
          $('#scanned-code').value = code;
          showToast('Código detectado: ' + code, 800);
          setTimeout(()=> registerScanned(), 400);
          break;
        }
      } else if(typeof Quagga !== 'undefined'){
        // Quagga fallback (live stream)
        if(!Quagga.initialized){
          Quagga.init({
            inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#video') },
            decoder: { readers: ["code_128_reader","ean_reader","ean_8_reader","upc_reader","upc_e_reader"] },
            locate: true,
          }, function(err){
            if(err){ console.error(err); return; }
            Quagga.initialized = true; Quagga.start();
          });
          Quagga.onDetected(data => {
            const code = data.codeResult.code;
            $('#scanned-code').value = code;
            showToast('Código (Quagga): ' + code, 800);
            setTimeout(()=> registerScanned(), 400);
          });
        }
      }
    }catch(e){ console.warn('detect loop err', e); }
    await new Promise(r=>setTimeout(r, 300));
  }
}

function registerScanned(){
  const code = $('#scanned-code').value.trim();
  if(!code) return alert('No hay código detectado');
  const found = (STATE.products||[]).find(p=> p.barcode === code || (p.barcode||'').replace(/\D/g,'') === code.replace(/\D/g,''));
  if(found){ addToCart(found); showToast('Agregado: ' + found.name); closeModal('modal-scan'); stopScanner(); }
  else { closeModal('modal-scan'); stopScanner(); openModal('modal-product'); $('#p-barcode').value = code; showToast('Código nuevo - completar registro'); }
}

/* ========================
   CLIENTES (add, abono, saldar)
   ======================== */
$('#btn-open-clients').addEventListener('click', ()=> openModal('modal-clients'));
document.getElementById('form-client').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const name = ($('#client-name').value||'').trim();
  const init = Number($('#client-initial').value) || 0;
  if(!name) return alert('Nombre requerido');
  const key = name.toLowerCase();
  const existing = (STATE.customers||[]).find(c=> (c.name||'').toLowerCase() === key);
  if(existing) existing.balance = Number((Number(existing.balance||0) + init).toFixed(2));
  else STATE.customers.unshift({ name, balance: init, createdAt: new Date().toISOString() });
  $('#client-name').value = ''; $('#client-initial').value = '';
  await pushStateToCloud();
  showToast('Cliente agregado/actualizado');
  renderClients();
});

function renderClients(){
  const el = $('#clients-list'); if(!el) return; el.innerHTML='';
  const list = (STATE.customers||[]).sort((a,b)=> Number(b.balance||0) - Number(a.balance||0));
  if(list.length === 0) el.innerHTML = '<div class="small-muted">No hay clientes registrados</div>';
  list.forEach(c => {
    const row = document.createElement('div'); row.className='card flex justify-between items-center'; row.style.padding='8px';
    row.innerHTML = `<div><div style="font-weight:800">${escapeHtml(c.name)}</div><div class="small-muted">Saldo: S/ ${money(c.balance||0)}</div></div>
      <div style="display:flex;gap:6px">
        <button onclick="promptAddPayment('${escapeHtml(c.name)}')" class="px-3 py-1 border rounded">Abonar</button>
        <button onclick="clearDebt('${escapeHtml(c.name)}')" class="px-3 py-1 border rounded">Saldar</button>
      </div>`;
    el.appendChild(row);
  });
}

async function promptAddPayment(name){
  const amt = prompt('Ingrese monto de abono para ' + name);
  if(!amt) return;
  const val = Number(amt);
  if(isNaN(val) || val <= 0) return alert('Monto inválido');
  const c = (STATE.customers||[]).find(x=> (x.name||'') === name);
  if(!c) return alert('Cliente no encontrado');
  c.balance = Number((Number(c.balance||0) - val).toFixed(2));
  if(c.balance < 0) c.balance = 0;
  await pushStateToCloud();
  showToast('Abono registrado');
  renderClients();
}

async function clearDebt(name){
  if(!confirm('Saldar deuda de: ' + name + ' ?')) return;
  const c = (STATE.customers||[]).find(x=> (x.name||'') === name);
  if(!c) return alert('Cliente no encontrado');
  c.balance = 0;
  await pushStateToCloud();
  showToast('Deuda saldada');
  renderClients();
}

/* ========================
   LOGIN / AUTH (local)
   ======================== */
const ALLOWED_PASS = 'magaly';
$('#btn-login').addEventListener('click', ()=> {
  const user = ($('#l-user').value||'').trim().toLowerCase();
  const pass = ($('#l-pass').value||'').trim();
  const err = $('#login-error'); err.classList.add('hidden'); err.textContent = '';
  if(!user || !pass){ err.textContent = 'Completa usuario y contraseña'; err.classList.remove('hidden'); return; }
  if((user === 'liz' || user === 'lismagaly' || user === 'lis') && pass === ALLOWED_PASS){
    localStorage.setItem('auth_token','ok'); $('#login-screen').style.display = 'none'; lucide.createIcons(); startApp();
  } else { err.textContent = 'Usuario o contraseña incorrectos'; err.classList.remove('hidden'); $('#l-pass').value = ''; $('#l-pass').focus(); }
});
$('#btn-demo').addEventListener('click', ()=> { localStorage.setItem('auth_token','ok'); $('#login-screen').style.display = 'none'; startApp(); });

function logout(){ localStorage.removeItem('auth_token'); location.reload(); }
function openModal(id){ const m = document.getElementById(id); if(m){ m.classList.add('visible'); m.setAttribute('aria-hidden','false'); } }
function closeModal(id){ const m = document.getElementById(id); if(m){ m.classList.remove('visible'); m.setAttribute('aria-hidden','true'); if(id==='modal-scan') stopScanner(); } }
function switchTab(tab){
  document.getElementById('tab-home').classList.add('hidden'); document.getElementById('tab-inventory').classList.add('hidden'); document.getElementById('tab-reports').classList.add('hidden');
  if(tab === 'home') document.getElementById('tab-home').classList.remove('hidden');
  if(tab === 'inventory') document.getElementById('tab-inventory').classList.remove('hidden');
  if(tab === 'reports') document.getElementById('tab-reports').classList.remove('hidden');
  lucide.createIcons(); updateReportsIfOpen();
}

/* Bind botones de header */
$('#btn-gestion').addEventListener('click', ()=> { openModal('modal-gestion'); renderGestionList(); });
$('#btn-sync').addEventListener('click', ()=> { if(db) { forceSync(); } else { initFirebase(); startFirestoreSync(); } });

/* ========================
   START APP
   ======================== */
async function startApp(){
  lucide.createIcons();
  renderAll();
  // init firebase and sync
  initFirebase();
  startFirestoreSync();
  $('#rep-from').value = todayYMD(); $('#rep-to').value = todayYMD();
  $('#search-inv').addEventListener('input', renderInventoryList);
  // expose global functions used inline
  window.openModal = openModal; window.closeModal = closeModal; window.switchTab = switchTab;
  window.startScanner = startScanner; window.completeSale = completeSale; window.exportInventoryXLSX = exportInventoryXLSX; window.exportSalesXLSX = exportSalesXLSX;
  window.exportCombinedXLSX = exportCombinedXLSX; window.exportReportRangeBothXLSX = exportReportRangeBothXLSX; window.exportSalesXLSX = exportSalesXLSX;
}

/* DOM ready */
document.addEventListener('DOMContentLoaded', ()=>{
  lucide.createIcons();
  if(localStorage.getItem('auth_token')){ $('#login-screen').style.display = 'none'; startApp(); } else { $('#login-screen').style.display = 'flex'; }
  // expose for console debugging
  window.STATE = STATE; window.pushStateToCloud = pushStateToCloud; window.forceSync = forceSync; window.initFirebase = initFirebase; window.startFirestoreSync = startFirestoreSync;
});

/* periodic local backup */
setInterval(()=> { try{ localStorage.setItem('tienda_local_backup', JSON.stringify(STATE)); }catch(e){} }, 15000);

</script>
</body>
</html>
